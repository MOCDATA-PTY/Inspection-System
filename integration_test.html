<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Test - KM and Hours Functions</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .input-group { margin: 10px 0; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .test-button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .test-button:hover { background: #0056b3; }
        .result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Integration Test - KM and Hours Functions</h1>
        
        <div class="test-section">
            <h3>üìä Function Availability Test</h3>
            <button class="test-button" onclick="testFunctionAvailability()">Test Function Availability</button>
            <div id="availabilityResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üîß Input Field Test</h3>
            <div class="input-group">
                <label for="kmInput">Kilometers Traveled:</label>
                <input type="number" id="kmInput" data-group-id="test-group-123" 
                       placeholder="Enter kilometers" step="0.1" min="0"
                       onchange="testKmFunction(this)" onblur="testKmFunction(this)">
            </div>
            <div class="input-group">
                <label for="hoursInput">Hours Worked:</label>
                <input type="number" id="hoursInput" data-group-id="test-group-123" 
                       placeholder="Enter hours" step="0.1" min="0"
                       onchange="testHoursFunction(this)" onblur="testHoursFunction(this)">
            </div>
            <div id="inputResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üåê Network Test</h3>
            <button class="test-button" onclick="testNetworkRequests()">Test Network Requests</button>
            <div id="networkResults"></div>
        </div>
        
        <div class="test-section">
            <h3>üìã Test Summary</h3>
            <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            <div id="summaryResults"></div>
        </div>
    </div>

    <!-- Load the minimal fix first -->
    <script src="fix_km_hours_functions.js"></script>
    
    <!-- Then load the main file (this might have errors, but our functions should still work) -->
    <script>
        // Try to load the main file, but don't let errors break our test
        const mainScript = document.createElement('script');
        mainScript.src = '/static/current_rendered_js.js';
        mainScript.onerror = function() {
            console.warn('Main JavaScript file failed to load, but minimal fix should still work');
        };
        document.head.appendChild(mainScript);
    </script>
    
    <script>
        function testFunctionAvailability() {
            const result = document.getElementById('availabilityResults');
            let html = '<h4>Function Availability:</h4>';
            
            const functions = ['updateGroupKmTraveled', 'updateGroupHours', 'getCSRFToken'];
            let allAvailable = true;
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    html += '<div class="result success">‚úÖ ' + funcName + ' is available</div>';
                } else {
                    html += '<div class="result error">‚ùå ' + funcName + ' is not available</div>';
                    allAvailable = false;
                }
            });
            
            if (allAvailable) {
                html += '<div class="result success">üéâ All required functions are available!</div>';
            } else {
                html += '<div class="result error">‚ö†Ô∏è Some functions are missing</div>';
            }
            
            result.innerHTML = html;
        }
        
        function testKmFunction(input) {
            const result = document.getElementById('inputResults');
            try {
                if (typeof updateGroupKmTraveled === 'function') {
                    updateGroupKmTraveled(input);
                    result.innerHTML = '<div class="result success">‚úÖ KM function called successfully! Value: ' + input.value + '</div>';
                } else {
                    result.innerHTML = '<div class="result error">‚ùå updateGroupKmTraveled function is not available</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="result error">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        function testHoursFunction(input) {
            const result = document.getElementById('inputResults');
            try {
                if (typeof updateGroupHours === 'function') {
                    updateGroupHours(input);
                    result.innerHTML = '<div class="result success">‚úÖ Hours function called successfully! Value: ' + input.value + '</div>';
                } else {
                    result.innerHTML = '<div class="result error">‚ùå updateGroupHours function is not available</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="result error">‚ùå Error: ' + error.message + '</div>';
            }
        }
        
        function testNetworkRequests() {
            const result = document.getElementById('networkResults');
            result.innerHTML = '<div class="result info">üîÑ Testing network requests...</div>';
            
            // Test CSRF token
            try {
                if (typeof getCSRFToken === 'function') {
                    const token = getCSRFToken();
                    result.innerHTML = '<div class="result success">‚úÖ CSRF token retrieved: ' + (token ? 'Found' : 'Empty') + '</div>';
                } else {
                    result.innerHTML = '<div class="result error">‚ùå getCSRFToken function not available</div>';
                }
            } catch (error) {
                result.innerHTML = '<div class="result error">‚ùå Error getting CSRF token: ' + error.message + '</div>';
            }
        }
        
        function runAllTests() {
            const result = document.getElementById('summaryResults');
            let html = '<h4>Test Summary:</h4>';
            
            // Run all tests
            testFunctionAvailability();
            testNetworkRequests();
            
            // Check if functions are working
            const functions = ['updateGroupKmTraveled', 'updateGroupHours', 'getCSRFToken'];
            let workingFunctions = 0;
            
            functions.forEach(funcName => {
                if (typeof window[funcName] === 'function') {
                    workingFunctions++;
                }
            });
            
            if (workingFunctions === functions.length) {
                html += '<div class="result success">üéâ ALL TESTS PASSED! Functions are working correctly.</div>';
                html += '<div class="result info">‚úÖ You can now use the KM and Hours input fields without JavaScript errors.</div>';
            } else {
                html += '<div class="result error">‚ùå Some tests failed. ' + workingFunctions + '/' + functions.length + ' functions are working.</div>';
            }
            
            result.innerHTML = html;
        }
        
        // Auto-run tests when page loads
        window.addEventListener('load', function() {
            setTimeout(runAllTests, 1000);
        });
    </script>
</body>
</html>