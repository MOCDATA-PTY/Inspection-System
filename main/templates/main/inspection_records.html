<!DOCTYPE html>
<html lang="en">

<head>
    {% load static %}
    {% load group_filters %}
    {% load inspector_extras %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- CACHE BUSTER: 20251109-OCCURRENCE-MOBILE-FIX -->

    <!-- Favicon - Food Safety Agency Logo -->
    <link rel="icon" type="image/png" href="{% static 'img/Food safetyagencylogo.png' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'img/Food safetyagencylogo.png' %}">
    <link rel="apple-touch-icon" href="{% static 'img/Food safetyagencylogo.png' %}">

    <title>Claims Records Management</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#007890',
                        'primary-light': '#e6f3f7',
                        'primary-dark': '#005a6b',
                        secondary: '#EC343C',
                        danger: '#EC343C',
                        warning: '#f59e0b',
                        background: '#f9fafb',
                        'card-bg': '#ffffff',
                        text: '#1f2937',
                        'text-light': '#6b7280',
                        border: '#e5e7eb',
                        'light-black': '#333333',
                        'import-color': '#446f1e',
                        grey: '#777777',
                        analytics: '#7c3aed'
                    },
                    borderRadius: {
                        'custom': '6px'
                    },
                    boxShadow: {
                        'custom': '0 1px 3px rgba(0,0,0,0.05)',
                        'custom-lg': '0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06)'
                    }
                }
            }
        }

        // Global toggleSidebar function - available immediately for onclick
        function toggleSidebar() {
            console.log('üçî ===== GLOBAL MENU TOGGLE STARTED =====');
            console.log('üçî Menu button clicked!');

            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const mobileBtn = document.getElementById('mobile-menu-btn');

            console.log('üçî Elements found:', {
                sidebar: !!sidebar,
                overlay: !!overlay,
                mobileBtn: !!mobileBtn
            });

            if (sidebar && overlay && mobileBtn) {
                console.log('üçî All elements found, proceeding with toggle...');

                // Check current state before toggle
                const wasOpen = sidebar.classList.contains('show');
                console.log('üçî Current state - Sidebar open:', wasOpen);
                console.log('üçî Current sidebar classes:', sidebar.className);
                console.log('üçî Current overlay classes:', overlay.className);

                // Toggle classes
                sidebar.classList.toggle('show');
                overlay.classList.toggle('show');

                console.log('üçî After toggle - Sidebar classes:', sidebar.className);
                console.log('üçî After toggle - Overlay classes:', overlay.className);

                // Check new state
                const isNowOpen = sidebar.classList.contains('show');
                console.log('üçî New state - Sidebar open:', isNowOpen);

                // Update icon
                const icon = mobileBtn.querySelector('i');
                console.log('üçî Icon element found:', !!icon);
                console.log('üçî Current icon classes:', icon ? icon.className : 'N/A');

                if (isNowOpen) {
                    if (icon) {
                        icon.className = 'fas fa-times';
                        console.log('üçî ‚úÖ SIDEBAR OPENED - Icon changed to X');
                        console.log('üçî New icon classes:', icon.className);
                    }

                    // Check computed styles
                    const sidebarStyles = getComputedStyle(sidebar);
                    console.log('üçî Sidebar computed styles:', {
                        transform: sidebarStyles.transform,
                        display: sidebarStyles.display,
                        visibility: sidebarStyles.visibility,
                        opacity: sidebarStyles.opacity,
                        zIndex: sidebarStyles.zIndex
                    });

                    const overlayStyles = getComputedStyle(overlay);
                    console.log('üçî Overlay computed styles:', {
                        display: overlayStyles.display,
                        visibility: overlayStyles.visibility,
                        opacity: overlayStyles.opacity,
                        zIndex: overlayStyles.zIndex
                    });
                } else {
                    if (icon) {
                        icon.className = 'fas fa-bars';
                        console.log('üçî ‚ùå SIDEBAR CLOSED - Icon changed to hamburger');
                        console.log('üçî New icon classes:', icon.className);
                    }
                }

                console.log('üçî ===== GLOBAL MENU TOGGLE COMPLETED =====');
            } else {
                console.error('üçî ‚ùå MISSING ELEMENTS FOR MENU TOGGLE');
                console.error('üçî Sidebar found:', !!sidebar);
                console.error('üçî Overlay found:', !!overlay);
                console.error('üçî Mobile button found:', !!mobileBtn);
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-light: #e6f3f7;
            --secondary: #EC343C;
            --danger: #EC343C;
            --warning: #f59e0b;
            --background: #f9fafb;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 6px;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --spacing: 5px;
            --light-black: #333333;
            --import-color: #446f1e;
            --grey: #777777;
            --analytics: #7c3aed;
        }

        /* Dark mode variables */
        [data-theme="dark"] {
            --background: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #ffffff;
            --text-light: #b0b0b0;
            --border: #404040;
            --primary-light: #1a3a40;
            --light-black: #ffffff;
            --grey: #b0b0b0;
            --sidebar-bg: #0f172a;
            --sidebar-text: #f1f5f9;
            --sidebar-hover: #1e293b;
        }

        /* Force all document type buttons to be full width */
        button[id^="composition-"],
        button[id^="occurrence-"],
        button[id^="composition-"].btn,
        button[id^="occurrence-"].btn {
            width: 100% !important;
            display: block !important;
            max-width: 100% !important;
            min-width: 100% !important;
            box-sizing: border-box !important;
        }

        /* Dark mode specific overrides */
        [data-theme="dark"] tr:nth-child(even) {
            background-color: #363636;
        }

        [data-theme="dark"] tr:hover {
            background-color: var(--primary-light);
        }

        [data-theme="dark"] .view-btn {
            background: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }

        [data-theme="dark"] .tooltip:hover::after {
            background-color: #000;
            color: white;
        }

        [data-theme="dark"] .detail-content h4 {
            color: white !important;
        }

        [data-theme="dark"] .detail-table th {
            color: white !important;
        }

        [data-theme="dark"] .main-table th {
            color: white !important;
        }

        /* Dark mode support for file status buttons */
        [data-theme="dark"] .btn-files-complete {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-files-partial {
            background-color: #f59e0b !important;
            border-color: #d97706 !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-files-none {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }

        [data-theme="dark"] .btn-files-checking {
            background-color: #6b7280 !important;
            border-color: #4b5563 !important;
            color: white !important;
        }

        /* Responsive filter form styles */
        .filter-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .filter-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-field {
            flex: 1;
            min-width: 200px;
        }

        .filter-field.full-width {
            flex: 1 1 100%;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            padding-top: 10px;
            border-top: 1px solid #e5e7eb;
            flex-wrap: wrap;
        }

        /* Mobile responsiveness for filter form */
        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
                gap: 10px;
            }

            .filter-field {
                min-width: 100%;
                flex: 1 1 100%;
            }

            .filter-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-actions .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        @media (max-width: 480px) {
            .filter-form {
                gap: 10px;
            }

            .filter-row {
                gap: 8px;
            }
        }

        /* Dark mode for main content areas */
        [data-theme="dark"] body {
            background: var(--background) !important;
            color: var(--text) !important;
        }

        [data-theme="dark"] .container {
            background: var(--background) !important;
        }

        [data-theme="dark"] .header {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .form-group {
            background: var(--card-bg) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .form-control {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .form-control:focus {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--primary) !important;
        }

        [data-theme="dark"] .form-label {
            color: var(--text) !important;
        }

        [data-theme="dark"] .card {
            background: var(--card-bg) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .card-header {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .card-body {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        [data-theme="dark"] .table {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        [data-theme="dark"] .table th {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .table td {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .btn {
            color: var(--text) !important;
        }

        [data-theme="dark"] .btn-primary {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
        }

        [data-theme="dark"] .btn-secondary {
            background: #6b7280 !important;
            border-color: #4b5563 !important;
        }

        [data-theme="dark"] .pagination {
            background: var(--card-bg) !important;
        }

        [data-theme="dark"] .pagination a {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        /* Mobile Table Responsive Styles */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Mobile card animations */
        .group-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
            display: none;
            /* Hide by default */
        }

        .group-details.expanded {
            max-height: 2000px;
            /* Increased for better scrolling */
            opacity: 1;
            transition: max-height 0.3s ease-in, opacity 0.3s ease-in;
            overflow: visible;
            /* Allow content to be visible when expanded */
            display: block;
            /* Show when expanded */
        }

        .expand-btn i {
            transition: transform 0.3s ease;
        }

        .expand-btn.expanded i {
            transform: rotate(180deg);
        }

        /* Mobile responsive design using Tailwind classes */
        @media (max-width: 1024px) {
            #shipmentsTable {
                @apply block w-full;
            }

            #shipmentsTable thead {
                @apply hidden;
            }

            #shipmentsTable tbody {
                @apply block w-full;
            }

            #shipmentsTable tbody tr {
                @apply block w-full mb-4 bg-white border border-gray-200 rounded-lg shadow-sm p-4;
            }

            #shipmentsTable tbody tr:hover {
                @apply shadow-md transform -translate-y-1 transition-all duration-200;
            }

            #shipmentsTable tbody tr td {
                @apply block w-full py-2 border-b border-gray-100 last:border-b-0;
            }

            #shipmentsTable tbody tr td:before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                top: 12px;
                width: 130px;
                font-weight: 600;
                color: var(--primary);
                font-size: 0.9rem;
                line-height: 1.3;
                word-wrap: break-word;
                text-decoration: none !important;
                border-bottom: none !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Remove any underlines from mobile labels */
            #shipmentsTable tbody tr td {
                text-decoration: none !important;
                border-bottom: none !important;
            }

            #shipmentsTable tbody tr td * {
                text-decoration: none !important;
                border-bottom: none !important;
            }

            /* Hide expand button on mobile - not needed in card layout */
            #shipmentsTable tbody tr td.col-expand {
                display: none;
            }

            /* Special handling for client name */
            #shipmentsTable tbody tr td.col-client-name {
                padding-left: 0 !important;
                font-weight: 700 !important;
                font-size: 1.2rem !important;
                color: var(--primary) !important;
                border-bottom: 3px solid var(--primary-light) !important;
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
                background: linear-gradient(135deg, var(--primary-light), transparent) !important;
                border-radius: 8px !important;
                padding: 15px !important;
                text-align: center !important;
            }

            #shipmentsTable tbody tr td.col-client-name:before {
                display: none !important;
            }

            /* Compliance status styling */
            #shipmentsTable tbody tr td.col-compliance {
                padding-left: 0;
                text-align: center;
                margin: 10px 0;
            }

            #shipmentsTable tbody tr td.col-compliance:before {
                display: none;
            }

            /* Email fields styling */
            #shipmentsTable tbody tr td.col-email,
            #shipmentsTable tbody tr td.col-additional-email {
                padding-left: 0;
                margin-bottom: 15px;
            }

            #shipmentsTable tbody tr td.col-email:before,
            #shipmentsTable tbody tr td.col-additional-email:before {
                display: none;
            }

            /* Email input styling for mobile */
            #shipmentsTable tbody tr td .email-input-row {
                margin-bottom: 8px;
            }

            #shipmentsTable tbody tr td .form-control {
                width: 100%;
                margin-bottom: 5px;
            }

            /* Action buttons styling */
            #shipmentsTable tbody tr td.col-view-files,
            #shipmentsTable tbody tr td.col-rfi,
            #shipmentsTable tbody tr td.col-invoice,
            #shipmentsTable tbody tr td.col-send {
                padding-left: 0;
                text-align: center;
                margin: 5px 0;
            }

            #shipmentsTable tbody tr td.col-view-files:before,
            #shipmentsTable tbody tr td.col-rfi:before,
            #shipmentsTable tbody tr td.col-invoice:before,
            #shipmentsTable tbody tr td.col-send:before {
                display: none;
            }

            /* Make buttons full width on mobile */
            #shipmentsTable tbody tr td .btn {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 12px 16px !important;
                font-size: 0.9rem !important;
                display: block !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
                transition: all 0.3s ease !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }

            #shipmentsTable tbody tr td .btn:hover {
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            }

            #shipmentsTable tbody tr td .btn:active {
                transform: translateY(0) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }

            /* Ensure all buttons in mobile layout are properly styled */
            #shipmentsTable tbody tr td button,
            #shipmentsTable tbody tr td .btn,
            #shipmentsTable tbody tr td input[type="button"],
            #shipmentsTable tbody tr td select {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 12px 16px !important;
                font-size: 0.9rem !important;
                display: block !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
                transition: all 0.3s ease !important;
                min-height: 44px !important;
            }

            /* Product details styling */
            .product-details {
                margin-top: 15px;
                padding: 10px;
                background: var(--background);
                border-radius: var(--radius);
                border: 1px solid var(--border);
            }

            .product-details h4 {
                margin: 0 0 10px 0;
                color: var(--primary);
                font-size: 1rem;
            }

            .product-details table {
                width: 100%;
                font-size: 0.85rem;
            }

            .product-details table th,
            .product-details table td {
                padding: 4px 8px;
                border: 1px solid var(--border);
            }

            .product-details table th {
                background: var(--primary-light);
                font-weight: bold;
            }

            /* Detail table responsive styling */
            .detail-table-wrapper {
                width: 100%;
                border-radius: var(--radius);
                max-width: 100%;
                margin: 0;
                padding: 0;
                overflow-x: visible;
                /* Changed from auto - no horizontal scroll on desktop */
                -webkit-overflow-scrolling: touch;
            }

            .detail-table {
                width: 100%;
                /* Fit to container width */
                font-size: 0.75rem;
                table-layout: fixed;
                /* Fixed layout for consistent column widths */
            }

            .detail-table th,
            .detail-table td {
                padding: 6px 4px;
                white-space: nowrap;
                text-align: center;
            }

            .detail-table th {
                background: var(--primary-light);
                font-weight: bold;
                font-size: 0.75rem;
            }

            .detail-table .col-km,
            .detail-table .col-test,
            .detail-table .col-bought-sample,
            .detail-table .col-lab-dropdown {
                min-width: 80px;
            }

            .detail-table .product-name-text {
                max-width: 150px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                display: inline-block;
            }

            .detail-table .form-control {
                font-size: 0.75rem;
                padding: 2px 4px;
            }

            .detail-table .sampled-badge {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            /* Inspector role: Hide columns 6-14 on all screen sizes */
            body.user-role-inspector .detail-table th:nth-child(6),
            body.user-role-inspector .detail-table td:nth-child(6),
            body.user-role-inspector .detail-table th:nth-child(7),
            body.user-role-inspector .detail-table td:nth-child(7),
            body.user-role-inspector .detail-table th:nth-child(8),
            body.user-role-inspector .detail-table td:nth-child(8),
            body.user-role-inspector .detail-table th:nth-child(9),
            body.user-role-inspector .detail-table td:nth-child(9),
            body.user-role-inspector .detail-table th:nth-child(10),
            body.user-role-inspector .detail-table td:nth-child(10),
            body.user-role-inspector .detail-table th:nth-child(11),
            body.user-role-inspector .detail-table td:nth-child(11),
            body.user-role-inspector .detail-table th:nth-child(12),
            body.user-role-inspector .detail-table td:nth-child(12),
            body.user-role-inspector .detail-table th:nth-child(13),
            body.user-role-inspector .detail-table td:nth-child(13),
            body.user-role-inspector .detail-table th:nth-child(14),
            body.user-role-inspector .detail-table td:nth-child(14) {
                display: none !important;
            }

            /* Inspector role: Hide Lab and Retest buttons everywhere (detail table, mobile cards, all views) */
            /* Inspectors should only see Lab Form button */
            body.user-role-inspector .btn-lab,
            body.user-role-inspector .btn-retest,
            body.user-role-inspector button[title*="retest" i],
            body.user-role-inspector button[title*="Lab result" i],
            body.user-role-inspector button[title*="Lab upload" i],
            body.user-role-inspector button[onclick*="uploadLab(" i],
            body.user-role-inspector button[onclick*="uploadRetest(" i],
            body.user-role-inspector button:has(i.fa-flask):not(:has(i.fa-file-alt)),
            body.user-role-inspector button:has(i.fa-redo) {
                display: none !important;
            }

            .detail-table .compliance-status {
                font-size: 0.7rem;
                padding: 2px 6px;
            }

            /* Actions column - stack buttons vertically on mobile */
            .detail-table td:last-child {
                min-width: 100px !important;
                max-width: 120px !important;
            }

            .detail-table .btn-lab,
            .detail-table .btn-lab-form,
            .detail-table .btn-retest {
                display: block !important;
                width: 100% !important;
                margin: 2px 0 !important;
                font-size: 0.65rem !important;
                padding: 3px 2px !important;
                white-space: nowrap !important;
            }

            .detail-table .btn-lab i,
            .detail-table .btn-lab-form i,
            .detail-table .btn-retest i {
                font-size: 0.6rem;
                margin-right: 2px;
            }
        }

        /* Tablet responsive adjustments */
        @media (max-width: 1024px) and (min-width: 769px) {
            .table-responsive {
                overflow-x: auto;
            }

            #shipmentsTable {
                min-width: 1000px;
            }

            #shipmentsTable th,
            #shipmentsTable td {
                padding: 8px 6px;
                font-size: 0.85rem;
            }

            .col-client-name {
                min-width: 150px;
            }

            .col-email,
            .col-additional-email {
                min-width: 120px;
            }
        }

        /* Force mobile layout for all screens under 1024px */
        @media (max-width: 1024px) {
            .table-responsive {
                overflow-x: visible !important;
                padding: 0 5px !important;
            }

            #shipmentsTable {
                display: block !important;
                width: 100% !important;
            }

            #shipmentsTable thead {
                display: none !important;
            }

            #shipmentsTable tbody {
                display: block !important;
                width: 100% !important;
            }

            /* Override any JavaScript that sets table-row */
            #shipmentsTable tbody tr {
                display: block !important;
                width: 100% !important;
                margin-bottom: 20px !important;
                background: var(--card-bg) !important;
                border: 1px solid var(--border) !important;
                border-radius: 12px !important;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
                padding: 20px !important;
                position: relative !important;
                transition: all 0.3s ease !important;
            }

            #shipmentsTable tbody tr:hover {
                transform: translateY(-2px) !important;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            }

            #shipmentsTable tbody tr.group-row {
                display: block !important;
                width: 100% !important;
            }

            #shipmentsTable tbody tr td {
                display: block !important;
                width: 100% !important;
                padding: 12px 0 !important;
                border: none !important;
                text-align: left !important;
                position: relative !important;
                padding-left: 140px !important;
                min-height: 44px !important;
                margin-bottom: 10px !important;
                border-bottom: 1px solid #f0f0f0 !important;
            }

            #shipmentsTable tbody tr td:last-child {
                border-bottom: none !important;
            }

            #shipmentsTable tbody tr td:before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                top: 12px;
                width: 130px;
                font-weight: 600;
                color: var(--primary);
                font-size: 0.9rem;
                line-height: 1.3;
                word-wrap: break-word;
                text-decoration: none !important;
                border-bottom: none !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Special handling for client name */
            #shipmentsTable tbody tr td.col-client-name {
                padding-left: 0 !important;
                font-weight: 700 !important;
                font-size: 1.2rem !important;
                color: var(--primary) !important;
                border-bottom: 3px solid var(--primary-light) !important;
                margin-bottom: 15px !important;
                padding-bottom: 15px !important;
                background: linear-gradient(135deg, var(--primary-light), transparent) !important;
                border-radius: 8px !important;
                padding: 15px !important;
                text-align: center !important;
            }

            #shipmentsTable tbody tr td.col-client-name:before {
                display: none !important;
            }

            /* Make buttons full width on mobile for 1024px breakpoint */
            #shipmentsTable tbody tr td .btn {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 12px 16px !important;
                font-size: 0.9rem !important;
                display: block !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
                transition: all 0.3s ease !important;
                text-transform: uppercase !important;
                letter-spacing: 0.5px !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }

            #shipmentsTable tbody tr td .btn:hover {
                transform: translateY(-1px) !important;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
            }

            #shipmentsTable tbody tr td .btn:active {
                transform: translateY(0) !important;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
            }

            /* Ensure all buttons in mobile layout are properly styled */
            #shipmentsTable tbody tr td button,
            #shipmentsTable tbody tr td .btn,
            #shipmentsTable tbody tr td input[type="button"],
            #shipmentsTable tbody tr td select {
                width: 100% !important;
                margin: 4px 0 !important;
                padding: 12px 16px !important;
                font-size: 0.9rem !important;
                display: block !important;
                border-radius: 8px !important;
                font-weight: 600 !important;
                transition: all 0.3s ease !important;
                min-height: 44px !important;
            }

            /* Detail table responsive styling for 1024px breakpoint - ENABLE horizontal scrolling on tablets/mobile */
            .detail-table-wrapper {
                width: 100%;
                border-radius: var(--radius);
                max-width: calc(100vw - 40px);
                margin: 0;
                padding: 0;
                overflow-x: auto !important;
                /* Enable horizontal scroll on mobile/tablet */
                -webkit-overflow-scrolling: touch;
            }

            .detail-table {
                min-width: 2000px !important;
                /* Force wide table on mobile - requires horizontal scroll */
                font-size: 0.75rem !important;
                table-layout: auto !important;
            }

            .detail-table th,
            .detail-table td {
                padding: 6px 4px !important;
                white-space: nowrap !important;
                text-align: center !important;
            }

            .detail-table th {
                background: var(--primary-light) !important;
                font-weight: bold !important;
                font-size: 0.75rem !important;
            }

            .detail-table .product-name-text {
                max-width: 150px !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                display: inline-block !important;
            }

            .detail-table .form-control {
                font-size: 0.75rem !important;
                padding: 2px 4px !important;
            }

            .detail-table .sampled-badge {
                font-size: 0.7rem !important;
                padding: 2px 6px !important;
            }

            .detail-table .compliance-status {
                font-size: 0.7rem !important;
                padding: 2px 6px !important;
            }
        }

        /* Small mobile adjustments */
        @media (max-width: 480px) {
            .table-responsive {
                padding: 0 2px !important;
            }

            #shipmentsTable tbody tr {
                padding: 15px !important;
                margin-bottom: 15px !important;
                border-radius: 10px !important;
            }

            #shipmentsTable tbody tr td {
                padding: 10px 0 !important;
                font-size: 0.9rem !important;
                padding-left: 120px !important;
                min-height: 40px !important;
                margin-bottom: 8px !important;
            }

            #shipmentsTable tbody tr td:before {
                width: 110px !important;
                font-size: 0.8rem !important;
                left: 0 !important;
                top: 10px !important;
            }

            #shipmentsTable tbody tr td.col-client-name {
                font-size: 1.1rem !important;
                padding: 12px !important;
            }

            #shipmentsTable tbody tr td .btn {
                padding: 10px 12px !important;
                font-size: 0.85rem !important;
                min-height: 40px !important;
            }

            /* Detail table styling for small mobile */
            .detail-table {
                min-width: 800px !important;
                font-size: 0.7rem !important;
            }

            .detail-table th,
            .detail-table td {
                padding: 4px 2px !important;
                font-size: 0.7rem !important;
            }

            .detail-table th {
                font-size: 0.65rem !important;
            }

            .detail-table .product-name-text {
                max-width: 120px !important;
            }

            .detail-table .form-control {
                font-size: 0.65rem !important;
                padding: 1px 2px !important;
            }

            .detail-table .sampled-badge,
            .detail-table .compliance-status {
                font-size: 0.6rem !important;
                padding: 1px 4px !important;
            }
        }

        /* Hide action-bar navigation on mobile devices since sidebar already has these options */
        @media (max-width: 1024px) {
            .action-bar {
                display: none !important;
            }
        }

        /* Dark mode for responsive filter form */
        [data-theme="dark"] .filter-actions {
            border-top-color: var(--border) !important;
        }

        [data-theme="dark"] .filter-field .form-label {
            color: var(--text) !important;
        }

        [data-theme="dark"] .filter-field .form-control {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .filter-field .form-control:focus {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--primary) !important;
        }

        /* Dark mode for mobile table */
        [data-theme="dark"] #shipmentsTable tbody tr {
            background: var(--card-bg) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] #shipmentsTable tbody tr td:before {
            color: var(--text-light) !important;
        }

        [data-theme="dark"] #shipmentsTable tbody tr td.col-client-name {
            color: var(--primary) !important;
            border-bottom-color: var(--primary-light) !important;
        }

        [data-theme="dark"] .product-details {
            background: var(--background) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .product-details h4 {
            color: var(--primary) !important;
        }

        [data-theme="dark"] .product-details table th {
            background: var(--primary-light) !important;
            color: var(--text) !important;
        }

        [data-theme="dark"] .product-details table th,
        [data-theme="dark"] .product-details table td {
            border-color: var(--border) !important;
        }

        /* Dark mode for detail tables */
        [data-theme="dark"] .detail-table {
            background: var(--card-bg) !important;
            color: var(--text) !important;
        }

        [data-theme="dark"] .detail-table th {
            background: var(--primary-light) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .detail-table td {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .detail-table .form-control {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--border) !important;
        }

        [data-theme="dark"] .detail-table .form-control:focus {
            background: var(--card-bg) !important;
            color: var(--text) !important;
            border-color: var(--primary) !important;
        }

        [data-theme="dark"] .pagination .current {
            background: var(--primary) !important;
            color: white !important;
        }

        /* Force mobile layout - override any JavaScript */
        @media (max-width: 1024px) {
            #shipmentsTable tbody tr[style*="display: table-row"] {
                display: block !important;
            }

            #shipmentsTable tbody tr[style*="display: table-row"] td {
                display: block !important;
            }

            /* Additional override for any inline styles */
            #shipmentsTable tbody tr {
                display: block !important;
            }

            #shipmentsTable tbody tr td {
                display: block !important;
            }
        }

        /* Additional mobile override with higher specificity */
        @media screen and (max-width: 1024px) {
            .table-responsive #shipmentsTable tbody tr {
                display: block !important;
            }

            .table-responsive #shipmentsTable tbody tr td {
                display: block !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: url("{% static 'img/food_safety_background.jpg' %}?v=2") no-repeat center center;

            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.5;
            padding: var(--spacing);
            position: relative;
        }

        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .container {
            width: calc(100% - var(--spacing)*2);
            margin: 0 auto;
            padding: 5px 0;
            position: relative;
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .logo {
            text-align: center;
            margin-bottom: 10px;
        }

        .logo img {
            max-height: 80px;
        }

        .header {
            padding: 10px 5px 20px;
            margin-bottom: var(--spacing);
            width: 100%;
            text-align: center;
        }

        .header h1 {
            color: white;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .header h2 {
            color: white;
            font-size: 1rem;
            font-weight: 400;
        }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing);
            border: 1px solid var(--border);
            width: 100%;
        }

        /* Completion status styling - bright green */
        .inspection-complete {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        .inspection-complete td {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        .inspection-complete .detail-content {
            background-color: #22c55e !important;
            color: white !important;
        }

        .inspection-complete .detail-table {
            background-color: #22c55e !important;
        }

        .inspection-complete .detail-table th,
        .inspection-complete .detail-table td {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        /* Dark mode completion styling - bright green */
        [data-theme="dark"] .inspection-complete {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        [data-theme="dark"] .inspection-complete td {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        [data-theme="dark"] .inspection-complete .detail-content {
            background-color: #15803d !important;
            color: white !important;
        }

        [data-theme="dark"] .inspection-complete .detail-table {
            background-color: #15803d !important;
        }

        [data-theme="dark"] .inspection-complete .detail-table th,
        [data-theme="dark"] .inspection-complete .detail-table td {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }

        /* Make client/facility name white when row is marked as sent */
        .inspection-complete td.col-client-name,
        .inspection-complete td.col-client-name span,
        .inspection-complete .text-primary,
        .inspection-complete td span {
            color: white !important;
        }

        [data-theme="dark"] .inspection-complete td.col-client-name,
        [data-theme="dark"] .inspection-complete td.col-client-name span,
        [data-theme="dark"] .inspection-complete .text-primary,
        [data-theme="dark"] .inspection-complete td span {
            color: white !important;
        }

        .card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 16px;
            overflow-x: auto;
            /* Allow horizontal scrolling */
        }

        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: var(--spacing);
            width: 100%;
            flex-wrap: wrap;
            /* Allow wrapping on narrower laptop screens */
        }

        .btn-danger {
            background-color: red;
            color: white;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: var(--radius);
            border: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            box-shadow: var(--shadow);
        }

        .btn-analytics {
            background-color: #ef4444;
            /* Red color */
            color: white;
        }

        .btn-analytics:hover {
            background-color: #dc2626;
            /* Darker red on hover */
        }

        .btn-remote {
            background-color: #059669;
            /* Green color for remote data */
            color: white;
        }

        .btn-remote:hover {
            background-color: #047857;
            /* Darker green on hover */
        }

        .btn-allocation {
            background-color: #7c3aed;
            /* Purple color for client allocation */
            color: white;
        }

        .btn-allocation:hover {
            background-color: #6d28d9;
            /* Darker purple on hover */
        }



        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
            width: 100%;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-control {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.15s ease;
            color: var(--text);
            background-color: var(--card-bg);
            width: 100%;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        /* Autocomplete dropdown styles */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: var(--shadow-lg);
            min-height: 100px;
        }

        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.15s ease;
            font-weight: 500;
            color: var(--text);
        }

        .autocomplete-item:hover {
            background-color: var(--primary-light);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Dark mode autocomplete styles */
        [data-theme="dark"] .autocomplete-dropdown {
            background: var(--card-bg);
            border-color: var(--border);
        }

        [data-theme="dark"] .autocomplete-item:hover {
            background-color: var(--primary-light);
        }

        [data-theme="dark"] .autocomplete-item {
            color: var(--text);
        }

        .btn-primary {
            background-color: #0d6efd;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0b5ed7;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-analytics {
            background-color: #8b5cf6;
            color: white;
        }

        .btn-analytics:hover {
            background-color: #7c3aed;
            color: white;
        }

        /* Dark mode button overrides */
        [data-theme="dark"] .btn-secondary {
            background-color: #4b5563;
            color: white;
        }

        [data-theme="dark"] .btn-secondary:hover {
            background-color: #374151;
        }

        [data-theme="dark"] .btn-analytics {
            background-color: #7c3aed;
            color: white;
        }

        [data-theme="dark"] .btn-analytics:hover {
            background-color: #6d28d9;
        }

        .messages {
            margin-bottom: var(--spacing);
            width: 100%;
        }

        .message {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .message.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            border-left: 3px solid var(--secondary);
        }

        .message.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }

        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
            -webkit-overflow-scrolling: touch;
            /* Smooth scrolling on iOS */
            position: relative;
            padding-right: 20px;
        }

        /* Add scroll indicators for mobile */
        .table-responsive::before,
        .table-responsive::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 20px;
            pointer-events: none;
            z-index: 10;
        }

        .table-responsive::before {
            left: 0;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.8), transparent);
        }

        .table-responsive::after {
            right: 0;
            background: linear-gradient(to left, rgba(255, 255, 255, 0.8), transparent);
        }

        /* Touch improvements for mobile */
        @media (max-width: 1024px) {
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
            }

            .btn,
            button {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            /* Improve scrolling on mobile */
            .table-responsive {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
        }

        /* Loading state for mobile */
        @media (max-width: 1024px) {
            .loading-mobile {
                position: relative;
                overflow: hidden;
            }

            .loading-mobile::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
                animation: loading-shimmer 1.5s infinite;
            }

            @keyframes loading-shimmer {
                0% {
                    left: -100%;
                }

                100% {
                    left: 100%;
                }
            }
        }

        /* Mobile-specific table responsive improvements */

        /* Enhanced mobile data display */
        @media (max-width: 1024px) {

            /* Better spacing for mobile cards */
            .container {
                padding: 10px !important;
            }

            /* Improved filter form on mobile */
            .filter-row {
                flex-direction: column !important;
                gap: 10px !important;
            }

            .filter-field {
                width: 100% !important;
                margin-bottom: 10px !important;
            }

            /* Better mobile table info display */
            .table-info {
                text-align: center !important;
                margin-bottom: 15px !important;
                font-size: 0.9rem !important;
                color: var(--text-light) !important;
            }

            /* Enhanced compliance status display */
            #shipmentsTable tbody tr td.col-compliance {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 15px 0 !important;
                background: var(--background) !important;
                border-radius: 8px !important;
                padding: 10px !important;
            }

            #shipmentsTable tbody tr td.col-compliance:before {
                display: none !important;
            }

            /* Better email field display */
            #shipmentsTable tbody tr td.col-email,
            #shipmentsTable tbody tr td.col-additional-email {
                padding-left: 0 !important;
                margin-bottom: 15px !important;
                background: #f8f9fa !important;
                border-radius: 6px !important;
                padding: 10px !important;
            }

            #shipmentsTable tbody tr td.col-email:before,
            #shipmentsTable tbody tr td.col-additional-email:before {
                display: none !important;
            }

            /* Inspector field styling */
            #shipmentsTable tbody tr td.col-inspector {
                padding-left: 0 !important;
                text-align: center !important;
                font-weight: 500 !important;
                font-size: 0.75rem !important;
                color: var(--primary) !important;
                background: var(--primary-light) !important;
                border-radius: 6px !important;
                padding: 10px !important;
            }

            #shipmentsTable tbody tr td.col-inspector:before {
                display: none !important;
            }

            /* Date field styling */
            #shipmentsTable tbody tr td.col-date {
                padding-left: 0 !important;
                text-align: center !important;
                font-weight: 600 !important;
                color: var(--text) !important;
                background: #e9ecef !important;
                border-radius: 6px !important;
                padding: 10px !important;
            }

            #shipmentsTable tbody tr td.col-date:before {
                display: none !important;
            }

            /* Account code styling */
            #shipmentsTable tbody tr td.col-account-code {
                padding-left: 0 !important;
                text-align: center !important;
                font-family: monospace !important;
                font-weight: 600 !important;
                color: var(--secondary) !important;
                background: #fff3cd !important;
                border-radius: 6px !important;
                padding: 10px !important;
            }

            #shipmentsTable tbody tr td.col-account-code:before {
                display: none !important;
            }

            /* Distance and hours styling */
            #shipmentsTable tbody tr td.col-km,
            #shipmentsTable tbody tr td.col-hours {
                padding-left: 0 !important;
                text-align: center !important;
                font-weight: 600 !important;
                color: var(--text) !important;
                background: #e3f2fd !important;
                border-radius: 6px !important;
                padding: 10px !important;
                margin: 5px 0 !important;
            }

            #shipmentsTable tbody tr td.col-km:before,
            #shipmentsTable tbody tr td.col-hours:before {
                display: none !important;
            }

            /* Approved status styling */
            #shipmentsTable tbody tr td.col-approved {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 10px 0 !important;
            }

            #shipmentsTable tbody tr td.col-approved:before {
                display: none !important;
            }

            /* Sent status styling */
            #shipmentsTable tbody tr td.col-send {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 10px 0 !important;
            }

            #shipmentsTable tbody tr td.col-send:before {
                display: none !important;
            }

            /* RFI styling */
            #shipmentsTable tbody tr td.col-rfi {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 10px 0 !important;
            }

            #shipmentsTable tbody tr td.col-rfi:before {
                display: none !important;
            }

            /* View files styling */
            #shipmentsTable tbody tr td.col-view-files {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 10px 0 !important;
            }

            #shipmentsTable tbody tr td.col-view-files:before {
                display: none !important;
            }

            /* Invoice styling (if visible) */
            #shipmentsTable tbody tr td.col-invoice {
                padding-left: 0 !important;
                text-align: center !important;
                margin: 10px 0 !important;
            }

            #shipmentsTable tbody tr td.col-invoice:before {
                display: none !important;
            }

            /* Mobile-specific action button grouping */
            .mobile-action-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 8px !important;
                margin-top: 15px !important;
                padding: 15px !important;
                background: #f8f9fa !important;
                border-radius: 8px !important;
                border: 1px solid #dee2e6 !important;
            }

            /* Mobile card header */
            .mobile-card-header {
                background: linear-gradient(135deg, var(--primary), var(--primary-light)) !important;
                color: white !important;
                padding: 15px !important;
                border-radius: 8px 8px 0 0 !important;
                margin: -20px -20px 20px -20px !important;
                text-align: center !important;
                font-weight: 700 !important;
                font-size: 1.1rem !important;
            }
        }

        .table-responsive::before {
            left: 0;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.8), transparent);
        }

        .table-responsive::after {
            right: 0;
            background: linear-gradient(to left, rgba(255, 255, 255, 0.8), transparent);
        }

        /* Hide scroll indicators on desktop */
        @media (min-width: 1025px) {

            .table-responsive::before,
            .table-responsive::after {
                display: none;
            }
        }

        /* Dark theme scroll indicators */
        [data-theme="dark"] .table-responsive::before {
            background: linear-gradient(to right, rgba(30, 41, 59, 0.8), transparent);
        }

        [data-theme="dark"] .table-responsive::after {
            background: linear-gradient(to left, rgba(30, 41, 59, 0.8), transparent);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            min-width: 1200px;
            /* Increased to match expanded detail table width */
        }

        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                border-radius: 8px;
            }

            table {
                min-width: 1200px;
                /* Ensure all columns are visible on mobile */
                font-size: 0.65rem;
            }

            th,
            td {
                padding: 3px 4px;
                font-size: 0.65rem;
            }

            /* Adjust column widths for mobile */
            .col-expand {
                width: 20px;
                min-width: 20px;
                max-width: 20px;
            }

            .col-client-name {
                width: 90px;
                min-width: 90px;
                max-width: 90px;
            }

            .col-account-code {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-date {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-compliance {
                width: 75px;
                min-width: 75px;
                max-width: 75px;
                text-align: center;
            }

            .col-email {
                width: 90px;
                min-width: 90px;
                max-width: 90px;
            }

            .col-inspector {
                width: 160px;
                min-width: 160px;
                max-width: 160px;
            }

            .col-view-files {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
            }

            .col-rfi {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-invoice {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-km {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-hours {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-additional-email {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
            }

            .col-send {
                width: 110px;
                min-width: 110px;
                max-width: 110px;
            }

            /* Mobile-specific button adjustments */
            .btn-sm {
                padding: 2px 4px;
                font-size: 0.6rem;
            }

            /* Ensure expanded content is mobile-friendly */
            .detail-content {
                padding: 8px;
                font-size: 0.7rem;
                margin: 4px;
                border-radius: 6px;
            }

            .detail-table {
                font-size: 0.65rem;
                min-width: 100%;
                overflow-x: auto;
            }

            .detail-table th,
            .detail-table td {
                padding: 4px 6px;
                font-size: 0.65rem;
            }

            .detail-table-wrapper {
                border-radius: 6px;
                margin: 4px 0;
            }

            /* Mobile-specific detail table column adjustments */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                width: 35px;
                min-width: 35px;
                max-width: 35px;
            }

            /* Inspection No */
            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                width: 180px;
                min-width: 180px;
                max-width: 200px;
            }

            /* Client Name */
            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            /* Commodity */
            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                width: 150px;
                min-width: 150px;
                max-width: 150px;
                overflow: visible !important;
            }

            /* Compliance */
            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                width: 200px;
                min-width: 200px;
                max-width: 250px;
            }

            /* Product Name */
            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
            }

            /* Sampled */
            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            /* Needs Retest */
            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                width: 200px;
                min-width: 200px;
                max-width: 250px;
            }

            /* Class */
            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }

            /* Fat */
            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }

            /* Protein */
            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }

            /* Calcium */
            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }

            /* DNA */
            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            /* Bought Sample */
            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            /* Lab */
            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                width: 350px;
                min-width: 350px;
                max-width: 350px;
            }

            /* Actions - increased for Lab, Lab Form, Retest buttons */

            /* Inspector role: Hide columns 6-14 (Sampled, Needs Retest, Class, Fat, Protein, Calcium, DNA, Bought Sample, Lab) */
            body.user-role-inspector .detail-table th:nth-child(6),
            body.user-role-inspector .detail-table td:nth-child(6),
            body.user-role-inspector .detail-table th:nth-child(7),
            body.user-role-inspector .detail-table td:nth-child(7),
            body.user-role-inspector .detail-table th:nth-child(8),
            body.user-role-inspector .detail-table td:nth-child(8),
            body.user-role-inspector .detail-table th:nth-child(9),
            body.user-role-inspector .detail-table td:nth-child(9),
            body.user-role-inspector .detail-table th:nth-child(10),
            body.user-role-inspector .detail-table td:nth-child(10),
            body.user-role-inspector .detail-table th:nth-child(11),
            body.user-role-inspector .detail-table td:nth-child(11),
            body.user-role-inspector .detail-table th:nth-child(12),
            body.user-role-inspector .detail-table td:nth-child(12),
            body.user-role-inspector .detail-table th:nth-child(13),
            body.user-role-inspector .detail-table td:nth-child(13),
            body.user-role-inspector .detail-table th:nth-child(14),
            body.user-role-inspector .detail-table td:nth-child(14) {
                display: none !important;
            }
        }

        @media (max-width: 480px) {
            table {
                min-width: 1400px;
                /* Extra space for very small screens */
                font-size: 0.6rem;
            }

            th,
            td {
                padding: 2px 3px;
                font-size: 0.6rem;
            }

            /* Even more compact columns for very small screens */
            .col-expand {
                width: 18px;
                min-width: 18px;
                max-width: 18px;
            }

            .col-client-name {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
            }

            .col-account-code {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-date {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-compliance {
                width: 65px;
                min-width: 65px;
                max-width: 65px;
                text-align: center;
            }

            .col-email {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
            }

            .col-inspector {
                width: 140px;
                min-width: 140px;
                max-width: 140px;
            }

            .col-view-files {
                width: 40px;
                min-width: 40px;
                max-width: 40px;
            }

            .col-rfi {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
            }

            .col-invoice {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
            }

            .col-km {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-hours {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-additional-email {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-approved {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-send {
                width: 95px;
                min-width: 95px;
                max-width: 95px;
            }

            .btn-sm {
                padding: 1px 3px;
                font-size: 0.55rem;
            }

            /* Ultra-compact detail content for very small screens */
            .detail-content {
                padding: 4px;
                font-size: 0.6rem;
                margin: 2px;
            }

            .detail-table {
                font-size: 0.55rem;
            }

            .detail-table th,
            .detail-table td {
                padding: 2px 3px;
                font-size: 0.55rem;
            }

            /* Even more compact detail table columns */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }

            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                width: 150px;
                min-width: 150px;
                max-width: 180px;
            }

            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                width: 140px;
                min-width: 140px;
                max-width: 140px;
                overflow: visible !important;
            }

            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                width: 180px;
                min-width: 180px;
                max-width: 220px;
            }

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 35px;
                min-width: 35px;
                max-width: 35px;
            }

            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
            }

            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                width: 180px;
                min-width: 180px;
                max-width: 220px;
            }

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                width: 20px;
                min-width: 20px;
                max-width: 20px;
            }

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                width: 20px;
                min-width: 20px;
                max-width: 20px;
            }

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                width: 20px;
                min-width: 20px;
                max-width: 20px;
            }

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                width: 20px;
                min-width: 20px;
                max-width: 20px;
            }

            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                width: 350px;
                min-width: 350px;
                max-width: 350px;
            }

            /* Actions - increased for Lab, Lab Form, Retest buttons */

            /* Inspector role: Hide columns 6-14 (Sampled, Needs Retest, Class, Fat, Protein, Calcium, DNA, Bought Sample, Lab) */
            body.user-role-inspector .detail-table th:nth-child(6),
            body.user-role-inspector .detail-table td:nth-child(6),
            body.user-role-inspector .detail-table th:nth-child(7),
            body.user-role-inspector .detail-table td:nth-child(7),
            body.user-role-inspector .detail-table th:nth-child(8),
            body.user-role-inspector .detail-table td:nth-child(8),
            body.user-role-inspector .detail-table th:nth-child(9),
            body.user-role-inspector .detail-table td:nth-child(9),
            body.user-role-inspector .detail-table th:nth-child(10),
            body.user-role-inspector .detail-table td:nth-child(10),
            body.user-role-inspector .detail-table th:nth-child(11),
            body.user-role-inspector .detail-table td:nth-child(11),
            body.user-role-inspector .detail-table th:nth-child(12),
            body.user-role-inspector .detail-table td:nth-child(12),
            body.user-role-inspector .detail-table th:nth-child(13),
            body.user-role-inspector .detail-table td:nth-child(13),
            body.user-role-inspector .detail-table th:nth-child(14),
            body.user-role-inspector .detail-table td:nth-child(14) {
                display: none !important;
            }
        }

        /* Tablet responsive design */
        @media (min-width: 769px) and (max-width: 1024px) {
            table {
                min-width: 1100px;
                font-size: 0.68rem;
            }

            th,
            td {
                padding: 4px 5px;
                font-size: 0.68rem;
            }

            .col-expand {
                width: 22px;
                min-width: 22px;
                max-width: 22px;
            }

            .col-client-name {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
            }

            .col-account-code {
                width: 110px;
                min-width: 110px;
                max-width: 110px;
                white-space: nowrap;
            }

            .col-date {
                width: 62px;
                min-width: 62px;
                max-width: 62px;
            }

            .col-compliance {
                width: 85px;
                min-width: 85px;
                max-width: 85px;
                text-align: center;
            }

            .col-email {
                width: 160px;
                min-width: 160px;
                max-width: 160px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .col-inspector {
                width: 180px;
                min-width: 180px;
                max-width: 180px;
            }

            .col-view-files {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-rfi {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-invoice {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-km {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-hours {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-additional-email {
                width: 90px;
                min-width: 90px;
                max-width: 90px;
            }

            .col-approved {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
            }

            .col-send {
                width: 120px;
                min-width: 120px;
                max-width: 120px;
            }

            /* Tablet-specific detail content optimizations */
            .detail-content {
                padding: 12px;
                font-size: 0.75rem;
                margin: 6px;
            }

            .detail-table {
                font-size: 0.7rem;
            }

            .detail-table th,
            .detail-table td {
                padding: 5px 7px;
                font-size: 0.7rem;
            }

            /* Tablet detail table column adjustments */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                width: 200px;
                min-width: 200px;
                max-width: 240px;
            }

            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                width: 65px;
                min-width: 65px;
                max-width: 65px;
            }

            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                width: 160px;
                min-width: 160px;
                max-width: 160px;
                overflow: visible !important;
            }

            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                width: 240px;
                min-width: 240px;
                max-width: 280px;
            }

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
            }

            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                width: 240px;
                min-width: 240px;
                max-width: 280px;
            }

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
            }

            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                width: 350px;
                min-width: 350px;
                max-width: 350px;
            }

            /* Actions - increased for Lab, Lab Form, Retest buttons */
        }

        /* Wide desktop screens (>1620px) - NO horizontal scrolling */
        @media (min-width: 1621px) {
            .detail-table-wrapper {
                width: 100%;
                overflow-x: visible !important;
                /* No horizontal scroll on wide screens */
            }

            .detail-table {
                width: 100% !important;
                table-layout: fixed !important;
            }
        }

        /* Laptop screens (15-inch) - 1366px to 1620px */
        @media (min-width: 1025px) and (max-width: 1620px) {
            .detail-table-wrapper {
                width: 100%;
                border-radius: var(--radius);
                max-width: 100%;
                margin: 0;
                padding: 0;
                overflow-x: visible !important;
                /* No horizontal scroll on laptop screens */
                -webkit-overflow-scrolling: touch;
            }

            .detail-table {
                width: 100% !important;
                min-width: auto !important;
                font-size: 0.58rem !important;
                table-layout: fixed !important;
            }

            .detail-table th,
            .detail-table td {
                padding: 3px 2px !important;
                white-space: nowrap !important;
                text-align: center !important;
                font-size: 0.58rem !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .detail-table th {
                background: var(--primary-light) !important;
                font-weight: bold !important;
                font-size: 0.56rem !important;
            }

            /* Optimized column widths for 15-inch laptops - more width for readability */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                width: 3% !important;
            }

            /* Inspection No */

            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                width: 9% !important;
            }

            /* Client Name */

            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                width: 5% !important;
            }

            /* Commodity */

            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                width: 7% !important;
                overflow: visible !important;
            }

            /* Compliance */

            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                width: 10% !important;
            }

            /* Product Name */

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 16% !important;
                min-width: 250px !important;
                text-align: left !important;
            }

            /* Sampled */

            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                width: 7% !important;
                text-align: center !important;
            }

            /* Needs Retest */

            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                width: 11% !important;
                text-align: center !important;
            }

            /* Class */

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                width: 10% !important;
                text-align: center !important;
            }

            /* Fat */

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                width: 15% !important;
                text-align: center !important;
                white-space: normal !important;
            }

            /* Protein */

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                width: 15% !important;
                text-align: center !important;
                white-space: normal !important;
            }

            /* Calcium */

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                width: 15% !important;
                text-align: center !important;
                white-space: normal !important;
            }

            /* DNA */

            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                width: 8% !important;
            }

            /* Bought Sample */

            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                width: 6% !important;
            }

            /* Lab */

            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                width: 10% !important;
            }

            /* Actions/Lab Form */

            .detail-table .product-name-text {
                max-width: 100% !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                white-space: nowrap !important;
                display: inline-block !important;
            }

            .detail-table .form-control {
                font-size: 0.56rem !important;
                padding: 2px 2px !important;
                width: 100% !important;
            }

            .detail-table .sampled-badge {
                font-size: 0.54rem !important;
                padding: 1px 3px !important;
            }

            .detail-table .compliance-status {
                font-size: 0.54rem !important;
                padding: 2px 4px !important;
                min-width: auto !important;
            }

            /* Buttons in actions column for laptops - more compact */
            .detail-table .btn-lab,
            .detail-table .btn-lab-form,
            .detail-table .btn-retest {
                display: inline-block !important;
                width: auto !important;
                margin: 1px 0 !important;
                font-size: 0.54rem !important;
                padding: 2px 4px !important;
                white-space: nowrap !important;
            }

            .detail-table .btn-lab i,
            .detail-table .btn-lab-form i,
            .detail-table .btn-retest i {
                font-size: 0.5rem;
                margin-right: 1px;
            }
        }

        /* Large desktop optimization */
        @media (min-width: 1621px) {
            table {
                min-width: 1000px;
                font-size: 0.75rem;
            }

            th,
            td {
                padding: 5px 7px;
                font-size: 0.75rem;
            }

            /* Restore original column widths for large screens */
            .col-expand {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }

            .col-client-name {
                width: 450px;
                min-width: 450px;
                max-width: 450px;
                white-space: nowrap !important;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .col-account-code {
                width: 140px;
                min-width: 140px;
                max-width: 140px;
                white-space: nowrap;
            }

            .col-date {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-compliance {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                text-align: center;
            }

            .col-email {
                width: 200px;
                min-width: 200px;
                max-width: 200px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .col-inspector {
                width: 200px;
                min-width: 200px;
                max-width: 200px;
            }

            .col-view-files {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-rfi {
                width: 55px;
                min-width: 55px;
                max-width: 55px;
            }

            .col-invoice {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-km {
                width: 75px;
                min-width: 75px;
                max-width: 75px;
            }

            .col-hours {
                width: 75px;
                min-width: 75px;
                max-width: 75px;
            }

            .col-additional-email {
                width: 110px;
                min-width: 110px;
                max-width: 110px;
            }

            .col-approved {
                width: 90px;
                min-width: 90px;
                max-width: 90px;
            }

            .col-send {
                width: 140px;
                min-width: 140px;
                max-width: 140px;
            }

            /* Large desktop detail content */
            .detail-content {
                padding: 16px;
                font-size: 0.8rem;
                margin: 8px;
            }

            .detail-table {
                font-size: 0.75rem;
            }

            .detail-table th,
            .detail-table td {
                padding: 6px 8px;
                font-size: 0.75rem;
            }
        }

        /* Additional specific column width overrides for 1024px to 1600px screens */
        @media (min-width: 1024px) and (max-width: 1600px) {

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 16% !important;
                min-width: 250px !important;
                max-width: 0 !important;
                padding: 8px 12px !important;
                font-size: 0.85rem !important;
                text-align: left !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                overflow-wrap: break-word !important;
                position: relative !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                border-bottom: 1px solid var(--border);
                z-index: 5;
            }
        }

        @media (min-width: 1024px) and (max-width: 1600px) {

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                text-align: center !important;
                width: 16% !important;
            }
        }

        @media (min-width: 1024px) and (max-width: 1600px) {

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                text-align: center !important;
                width: 15% !important;
                white-space: normal !important;
            }
        }

        @media (min-width: 1024px) and (max-width: 1600px) {

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                text-align: center !important;
                width: 15% !important;
                white-space: normal !important;
            }
        }

        @media (min-width: 1024px) and (max-width: 1600px) {

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                text-align: center !important;
                width: 15% !important;
                white-space: normal !important;
            }
        }

        /* Enhanced touch interactions for mobile */
        @media (max-width: 768px) {
            .expand-btn {
                min-width: 32px;
                min-height: 32px;
                touch-action: manipulation;
            }

            .btn-sm {
                min-width: 28px;
                min-height: 28px;
                touch-action: manipulation;
            }

            /* Better touch targets for mobile */
            .detail-table .btn-sm {
                min-width: 24px;
                min-height: 24px;
                padding: 4px;
            }

            /* Improve scroll behavior on mobile */
            .table-responsive {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }

            .detail-table-wrapper {
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Landscape mobile optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            table {
                min-width: 1100px;
                /* Slightly less width in landscape */
            }

            th,
            td {
                padding: 2px 4px;
                font-size: 0.6rem;
            }

            .detail-content {
                padding: 6px;
                font-size: 0.65rem;
            }

            .detail-table {
                font-size: 0.6rem;
            }
        }

        th {
            background-color: var(--primary-light);
            color: var(--primary);
            text-align: left;
            padding: 4px 6px;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Enhanced sticky header for mobile */
        @media (max-width: 768px) {
            th {
                position: sticky;
                top: 0;
                z-index: 15;
                background-color: var(--primary-light);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
        }

        tr:nth-child(even) {
            background-color: #f8fafc;
        }

        tr:hover {
            background-color: var(--primary-light);
        }

        td {
            padding: 4px 6px;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }

        /* Main table layout - efficient space usage */
        #shipmentsTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            min-width: 800px;
        }

        #shipmentsTable th {
            background-color: var(--primary-light);
            color: var(--primary);
            text-align: left;
            padding: 6px 8px;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #shipmentsTable td {
            padding: 6px 8px;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
        }

        /* Removed fixed 300px constraints - let column widths be controlled by specific rules below */

        @media (min-width: 1024px) {

            #shipmentsTable th,
            #shipmentsTable td {
                white-space: nowrap !important;
                padding: 8px 12px !important;
                text-align: center !important;
            }

            #shipmentsTable th:nth-child(1),
            #shipmentsTable td:nth-child(1) {
                width: auto;
                text-align: center !important;
            }

            #shipmentsTable th:nth-child(6),
            #shipmentsTable td:nth-child(6) {
                text-align: left !important;
            }

            #shipmentsTable th:nth-child(7),
            #shipmentsTable td:nth-child(7) {
                text-align: left !important;
                font-size: 0.85rem !important;
            }
        }

        /* Ensure table maintains its structure when expanded */
        #shipmentsTable tbody {
            position: relative;
        }

        /* Keep main table rows stable */
        #shipmentsTable tbody tr.group-row {
            position: relative;
            z-index: 5;
        }

        /* Main table column widths - MATCHED TO DETAIL TABLE WIDTHS */
        .col-expand {
            width: 25px !important;
            min-width: 25px !important;
            max-width: 25px !important;
            flex: none !important;
        }

        .col-client-name {
            width: auto !important;
            min-width: 250px !important;
            max-width: none !important;
            flex: none !important;
            white-space: normal !important;
            word-wrap: break-word !important;
        }

        .col-account-code {
            width: 140px !important;
            min-width: 140px !important;
            max-width: 140px !important;
            text-align: center;
            flex: none !important;
            white-space: nowrap !important;
            overflow: visible !important;
        }

        .col-date {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            flex: none !important;
        }

        .col-email {
            width: 200px !important;
            min-width: 200px !important;
            max-width: 200px !important;
            flex: none !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            position: relative;
        }

        /* Email line styling to prevent overflow */
        .email-line {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            display: block;
        }

        .col-compliance {
            width: auto !important;
            min-width: 120px !important;
            max-width: none !important;
            text-align: center;
            flex: none !important;
            white-space: normal !important;
            word-wrap: break-word !important;
        }

        .col-inspector {
            width: 160px !important;
            min-width: 160px !important;
            max-width: 160px !important;
            flex: none !important;
        }

        .col-view-files {
            width: 70px !important;
            min-width: 70px !important;
            max-width: 70px !important;
            text-align: center;
            flex: none !important;
        }

        .col-rfi {
            width: 80px !important;
            min-width: 80px !important;
            max-width: 80px !important;
            text-align: center;
            flex: none !important;
        }

        .col-invoice {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: center;
            flex: none !important;
        }

        /* Hide invoice column for inspectors */
        .hide-invoice .col-invoice {
            display: none !important;
        }

        .col-composition {
            width: 120px !important;
            min-width: 120px !important;
            max-width: 120px !important;
            text-align: center;
            flex: none !important;
        }

        .col-km {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: center;
            flex: none !important;
        }

        .col-hours {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: center;
            flex: none !important;
        }

        .col-additional-email {
            width: 250px !important;
            min-width: 250px !important;
            max-width: 250px !important;
            text-align: center;
            flex: none !important;
        }

        /* Multiple email inputs styling */
        .additional-emails-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .email-inputs {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .email-input-row {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .email-input-row .group-additional-email-input {
            flex: 1;
            font-size: 0.7rem;
            padding: 2px 4px;
        }

        .remove-email-btn {
            width: 20px;
            height: 20px;
            padding: 0;
            font-size: 12px;
            line-height: 1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-email-btn {
            font-size: 0.65rem;
            padding: 2px 6px;
            margin-top: 2px;
            align-self: flex-start;
        }

        /* Additional email inputs - no colored borders */
        .group-additional-email-input {
            border: 1px solid var(--border) !important;
        }

        .group-additional-email-input:not(:placeholder-shown),
        .group-additional-email-input[value]:not([value=""]) {
            border-color: var(--border) !important;
        }

        /* Date picker styling for DD/MM/YYYY format */
        .date-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .date-picker {
            font-family: monospace;
            text-align: center;
            letter-spacing: 1px;
            padding-right: 40px;
            background-color: #F9F9FA;
            border: 1px solid #E5E7EB;
            border-radius: var(--radius) 0 0 var(--radius);
        }

        .date-picker::placeholder {
            color: #999;
            font-style: italic;
            font-size: 0.9em;
        }

        .date-picker:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }

        .date-picker-btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 0 var(--radius) var(--radius) 0;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .date-picker-btn:hover {
            background: #005a6b;
        }

        .date-picker-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.3);
        }

        /* Calendar popup styling */
        .calendar-popup {
            position: fixed;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: var(--radius);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            padding: 15px;
            min-width: 280px;
            max-width: 320px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-nav {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }

        .calendar-nav:hover {
            background: #005a6b;
        }

        .calendar-month-year {
            font-weight: bold;
            font-size: 14px;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }

        .calendar-day-header {
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: #666;
            padding: 5px 0;
        }

        .calendar-day {
            text-align: center;
            padding: 8px 4px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .calendar-day:hover {
            background: var(--primary-light);
        }

        .calendar-day.selected {
            background: var(--primary);
            color: white;
        }

        .calendar-day.other-month {
            color: #ccc;
        }

        .calendar-day.today {
            background: #f0f0f0;
            font-weight: bold;
        }

        /* Approved column styling */
        .approved-dropdown {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.65rem;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
        }

        .approved-dropdown:hover {
            border-color: var(--primary);
        }

        .approved-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }

        .approved-badge {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.65rem;
            font-weight: 500;
            text-align: center;
        }

        .approved-yes {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .approved-pending {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .col-approved {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: center;
            flex: none !important;
        }

        .col-send {
            width: 200px !important;
            min-width: 200px !important;
            max-width: 200px !important;
            text-align: center;
            flex: none !important;
        }

        /* Ensure KM and Hours headers are fully visible */
        #shipmentsTable thead th.col-km,
        #shipmentsTable thead th.col-hours {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
        }

        .col-send {
            width: 200px;
            min-width: 200px;
            max-width: 200px;
            text-align: center;
        }

        /* Allow text to display fully by default */
        #shipmentsTable td {
            white-space: nowrap;
            padding: 8px 4px;
        }

        /* Allow client name to wrap if needed since it's variable width */
        .col-client-name {
            white-space: normal;
            word-wrap: break-word;
        }

        /* Compliance status styling - Ensuring badge fits properly with maximum specificity */
        .compliance-status,
        span.compliance-status,
        .detail-table .compliance-status,
        .detail-table span.compliance-status,
        td .compliance-status {
            font-size: 0.75rem !important;
            padding: 6px 14px !important;
            border-radius: 4px !important;
            font-weight: bold !important;
            white-space: nowrap !important;
            display: inline-block !important;
            text-align: center !important;
            min-width: 135px !important;
            width: auto !important;
            max-width: none !important;
            overflow: visible !important;
            text-overflow: clip !important;
            box-sizing: border-box !important;
            line-height: 1.3 !important;
        }

        /* Ensure proper sizing for compliance cells - increased further */
        .detail-table td:nth-child(4) {
            min-width: 150px !important;
            width: auto !important;
            max-width: none !important;
            padding: 10px 14px !important;
            overflow: visible !important;
            white-space: normal !important;
            text-overflow: clip !important;
        }

        /* Force compliance header to be wide enough */
        .detail-table th:nth-child(4) {
            min-width: 150px !important;
            width: auto !important;
            max-width: none !important;
            overflow: visible !important;
            text-overflow: clip !important;
        }

        .compliance-status.compliant {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .compliance-status.non-compliant {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Dark mode compliance status */
        [data-theme="dark"] .compliance-status.compliant {
            background-color: #1e4d2b;
            color: #d4edda;
            border: 1px solid #2d5a3d;
        }

        [data-theme="dark"] .compliance-status.non-compliant {
            background-color: #4d1a1a;
            color: #f8d7da;
            border: 1px solid #5c2a2a;
        }

        /* Action columns specific styling */
        .col-rfi,
        .col-invoice,
        .col-km,
        .col-hours,
        .col-send {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
        }

        /* View Files button color coding */
        .btn-files-complete {
            background-color: #22c55e !important;
            /* Green */
            border-color: #16a34a !important;
            color: white !important;
        }

        .btn-files-partial {
            background-color: #f59e0b !important;
            /* Yellow/Orange */
            border-color: #d97706 !important;
            color: white !important;
        }

        .btn-files-none {
            background-color: #ef4444 !important;
            /* Red */
            border-color: #dc2626 !important;
            color: white !important;
        }

        .btn-files-checking {
            background-color: #6b7280 !important;
            /* Gray */
            border-color: #4b5563 !important;
            color: white !important;
        }

        /* Additional classes for JavaScript compatibility */
        .btn-view-files[style*="rgb(255, 193, 7)"],
        .btn-view-files[style*="#ffc107"],
        .btn-view-files[style*="rgb(245, 158, 11)"],
        .btn-view-files[style*="#f59e0b"] {
            background-color: #f59e0b !important;
            /* Yellow - partial files */
            border-color: #d97706 !important;
            color: white !important;
        }

        .btn-view-files[style*="rgb(34, 197, 94)"],
        .btn-view-files[style*="#22c55e"],
        .btn-view-files[style*="rgb(40, 167, 69)"],
        .btn-view-files[style*="#28a745"] {
            background-color: #22c55e !important;
            /* Green - complete */
            border-color: #16a34a !important;
            color: white !important;
        }

        /* REMOVED - This CSS was preventing JavaScript from changing button colors after file upload
        .btn-view-files[style*="rgb(239, 68, 68)"],
        .btn-view-files[style*="#ef4444"],
        .btn-view-files[style*="rgb(220, 53, 69)"],
        .btn-view-files[style*="#dc3545"] {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        */

        /* Hover effects removed for file status buttons */

        /* Special styling for the client reference */
        .client-reference {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: var(--secondary);
            background-color: rgba(16, 185, 129, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
        }

        .client-reference.empty {
            color: var(--text-light);
            background-color: rgba(107, 114, 128, 0.05);
            font-style: italic;
        }

        /* Tooltip for truncated text */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* Compact table controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }

        .table-info {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        .empty-message {
            text-align: center;
            color: var(--text-light);
            padding: 40px 20px;
            background-color: #f8fafc;
        }

        .action-cell {
            white-space: nowrap;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.65rem;
            margin: 1px;
        }

        .btn-edit {
            background-color: var(--primary);
            color: white;
        }

        .btn-edit:hover {
            background-color: #005a6b;
        }


        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #d42e35;
        }

        .btn-upload {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            margin: 1px;
            border: none;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
            font-weight: 500;
            padding: 4px 8px !important;
            font-size: 0.65rem !important;
        }

        .btn-upload:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }

        .btn-upload:active {
            transform: translateY(0);
        }

        .btn-upload.uploaded {
            background: linear-gradient(135deg, #10B981, #059669);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .btn-upload.uploaded:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }

        .btn-lab {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }

        .btn-lab:hover {
            background-color: #4b5563;
        }

        .btn-lab.uploaded {
            background-color: #059669;
        }

        .btn-lab.uploaded:hover {
            background-color: #047857;
        }

        .btn-lab-form {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }

        .btn-lab-form:hover {
            background-color: #4b5563;
            color: white;
        }

        .btn-lab-form.uploaded {
            background-color: #059669;
        }

        .btn-lab-form.uploaded:hover {
            background-color: #047857;
        }

        /* Disabled button styling for administrators */
        .btn:disabled:hover,
        button[disabled]:hover {
            cursor: not-allowed !important;
        }

        /* Group actions styling - inline, no wrapping */
        .group-actions {
            display: flex;
            flex-direction: row;
            gap: 3px;
            align-items: center;
            flex-wrap: nowrap;
            width: 100%;
        }

        .group-inputs {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            margin-left: 4px;
            flex-wrap: nowrap;
        }

        .input-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .input-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
            margin-right: 2px;
        }

        .group-km-input,
        .group-hours-input {
            width: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 3px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .group-additional-email-input {
            width: 170px;
            min-width: 170px;
            max-width: 170px;
            padding: 3px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: left;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .group-comment-input {
            width: 250px;
            min-width: 250px;
            max-width: 250px;
            padding: 3px 6px;
            border: 1px solid var(--border) !important;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: left;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .group-km-input:focus,
        .group-hours-input:focus,
        .group-additional-email-input:focus,
        .group-comment-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }

        .group-buttons {
            display: flex;
            gap: 1px;
            flex-wrap: nowrap;
            align-items: center;
        }

        .group-buttons .btn {
            font-size: 8px;
            padding: 2px 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        /* Red border by default for group inputs */
        .group-km-input,
        .group-hours-input {
            border: 1px solid #dc3545 !important;
        }

        /* Green border when group input has value */
        .group-km-input:not(:placeholder-shown),
        .group-hours-input:not(:placeholder-shown),
        .group-km-input[value]:not([value=""]),
        .group-hours-input[value]:not([value=""]) {
            border-color: #28a745 !important;
        }

        .upload-info {
            margin-top: 4px;
            margin-bottom: 2px;
        }

        .uploader-text {
            font-size: 0.6rem;
            color: #6b7280;
            line-height: 1.2;
            margin-bottom: 1px;
        }

        .uploader-text small {
            font-size: 0.6rem;
            color: #6b7280;
        }

        .button-with-uploader {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 4px;
            flex-shrink: 0;
            min-width: 50px;
            min-height: 40px;
            justify-content: flex-start;
        }

        .button-with-uploader .uploader-text {
            margin-top: 2px;
            text-align: center;
            white-space: nowrap;
            width: 100%;
            height: 12px;
            line-height: 12px;
        }

        .btn-retest {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }

        .btn-retest:hover {
            background-color: #4b5563;
        }

        .btn-retest.uploaded {
            background-color: #059669;
        }

        .btn-retest.uploaded:hover {
            background-color: #047857;
        }

        .btn-rfi {
            background-color: #28a745;
            color: white !important;
            margin: 1px;
            transition: all 0.3s ease;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }

        .btn-rfi:hover {
            background-color: #1e7e34;
        }

        .btn-rfi.uploaded {
            background-color: #d4edda;
            color: #155724 !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }

        .btn-rfi.uploaded:hover {
            background-color: #c3e6cb;
        }

        .btn-invoice {
            background-color: #28a745;
            color: white !important;
            margin: 1px;
            transition: all 0.3s ease;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .btn-invoice:hover {
            background-color: #1e7e34;
        }

        .btn-invoice.uploaded {
            background-color: #d4edda;
            color: #155724 !important;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }

        .btn-invoice.uploaded:hover {
            background-color: #c3e6cb;
        }

        /* Desktop RFI buttons - fixed width for table */
        button[id^="rfi-"]:not([id*="mobile"]) {
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.55rem !important;
            color: white !important;
        }

        /* Desktop Invoice buttons - fixed width for table */
        button[id^="invoice-"]:not([id*="mobile"]) {
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.55rem !important;
            color: white !important;
        }

        /* Desktop Occurrence buttons - fixed width for table with smaller font */
        button[id^="occurrence-"]:not([id*="mobile"]) {
            width: 85px !important;
            max-width: 85px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.55rem !important;
            color: white !important;
        }

        /* Desktop Composition buttons - fixed width for table */
        button[id^="composition-"]:not([id*="mobile"]) {
            width: 80px !important;
            max-width: 80px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.55rem !important;
            color: white !important;
        }

        /* Mobile buttons - full width */
        button[id*="-mobile-"] {
            width: 100% !important;
            max-width: 100% !important;
        }

        /* Keep icons white in Invoice buttons */
        button[id^="invoice-"] i {
            color: white !important;
        }

        /* Complete redesign of View Files button - isolated from all other styles */
        .files-button-custom {
            /* Reset all inherited styles */
            all: unset !important;

            /* Core button styling */
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;

            /* Size and spacing */
            padding: 6px 12px !important;
            margin: 1px !important;
            min-width: 60px !important;
            height: auto !important;

            /* Typography */
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            text-align: center !important;
            text-decoration: none !important;
            white-space: nowrap !important;

            /* Default appearance (red - no files) */
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;

            /* Border and shape */
            border: none !important;
            border-radius: 6px !important;

            /* Effects */
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;

            /* Prevent text selection */
            user-select: none !important;
            -webkit-user-select: none !important;
        }


        .files-button-custom:active {
            transform: translateY(0) !important;
        }

        /* Color variants for compliance status */
        .files-button-custom.status-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3) !important;
        }


        .files-button-custom.status-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3) !important;
        }


        .files-button-custom.status-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }


        .files-button-custom.status-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3) !important;
        }


        .btn-view-files-blue {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            background-color: #fbbf24 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }


        /* More specific selectors to override inline styles and btn-danger class */
        .btn.btn-view-files.btn-view-files-green,
        .btn-sm.btn-view-files.btn-view-files-green,
        .btn-danger.btn-view-files-green,
        button.btn.btn-view-files.btn-view-files-green,
        button.btn-sm.btn-view-files.btn-view-files-green,
        button.btn-danger.btn-view-files-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
        }

        .btn.btn-view-files.btn-view-files-red,
        .btn-sm.btn-view-files.btn-view-files-red,
        .btn-danger.btn-view-files-red,
        button.btn.btn-view-files.btn-view-files-red,
        button.btn-sm.btn-view-files.btn-view-files-red,
        button.btn-danger.btn-view-files-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
        }

        /* ORANGE must come AFTER RED to override in cascade */
        .btn.btn-view-files.btn-view-files-orange,
        .btn-sm.btn-view-files.btn-view-files-orange,
        .btn-danger.btn-view-files-orange,
        button.btn.btn-view-files.btn-view-files-orange,
        button.btn-sm.btn-view-files.btn-view-files-orange,
        button.btn-danger.btn-view-files-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
        }

        .btn.btn-view-files.btn-view-files-blue,
        .btn-sm.btn-view-files.btn-view-files-blue,
        .btn-danger.btn-view-files-blue,
        button.btn.btn-view-files.btn-view-files-blue,
        button.btn-sm.btn-view-files.btn-view-files-blue,
        button.btn-danger.btn-view-files-blue {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            background-color: #fbbf24 !important;
            color: white !important;
        }

        .btn-view-files-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }


        .btn-view-files-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }


        .btn-view-files-orange,
        .files-button-custom.btn-view-files-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }



        .btn-send {
            background-color: #10b981;
            color: white;
            margin: 1px;
            transition: all 0.3s ease;
        }

        .btn-send:hover {
            background-color: #059669;
        }

        .btn-send.sent {
            background-color: #6366f1;
        }

        .btn-send.sent:hover {
            background-color: #4f46e5;
        }

        .btn-send-ready {
            background-color: #10b981 !important;
            color: white !important;
            cursor: pointer !important;
        }

        .btn-send-ready:hover {
            background-color: #059669 !important;
        }

        .btn-send-disabled {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }

        .btn-send-disabled:hover {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }

        /* Sent status dropdown styling */
        .sent-status-dropdown {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.65rem;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
        }

        .sent-status-dropdown:hover {
            border-color: var(--primary);
        }

        .sent-status-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }


        /* Inline button layout styling */
        .group-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .group-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .button-with-uploader {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .uploader-text {
            margin-top: 2px;
            text-align: center;
        }

        .uploader-text small {
            font-size: 0.6rem;
            line-height: 1;
        }

        .input-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
            text-align: center;
        }

        /* Responsive design for inline buttons */
        @media (max-width: 768px) {

            .group-buttons,
            .group-inputs {
                gap: 4px;
            }

            .button-with-uploader,
            .input-group {
                min-width: 50px;
            }

            .input-label {
                font-size: 0.65rem;
            }
        }

        /* Read-only sent status styling for inspectors */
        .sent-status-readonly {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 32px;
        }

        .sent-status-readonly .badge {
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }

        .sent-status-readonly .badge-success {
            background-color: #10b981 !important;
            color: white !important;
        }

        .sent-status-readonly .badge-danger {
            background-color: #ef4444 !important;
            color: white !important;
        }

        .sent-status-readonly .badge-secondary {
            background-color: #6b7280 !important;
            color: white !important;
        }

        /* Sampled badges */

        /* Disabled row styling for sent items */
        .shipment-row.disabled-row {
            opacity: 0.4 !important;
            pointer-events: none !important;
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }

        .shipment-row.disabled-row td {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }

        .shipment-row.disabled-row .btn,
        .shipment-row.disabled-row .form-control,
        .shipment-row.disabled-row .expand-btn {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }

        .shipment-row.disabled-row .expand-btn {
            pointer-events: none !important;
        }

        /* Dark mode disabled row styling */
        [data-theme="dark"] .shipment-row.disabled-row {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }

        [data-theme="dark"] .shipment-row.disabled-row td {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }

        /* 15-minute countdown styling */
        .fifteen-minute-countdown {
            font-size: 0.6rem !important;
            margin-top: 2px !important;
            text-align: center !important;
            color: #f59e0b !important;
            font-weight: bold !important;
            background-color: rgba(245, 158, 11, 0.1) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            border: 1px solid rgba(245, 158, 11, 0.3) !important;
        }

        .fifteen-minute-countdown[style*="color: #ef4444"] {
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }

        /* Dark mode countdown styling */
        [data-theme="dark"] .fifteen-minute-countdown {
            background-color: rgba(245, 158, 11, 0.2) !important;
            border-color: rgba(245, 158, 11, 0.4) !important;
        }

        [data-theme="dark"] .fifteen-minute-countdown[style*="color: #ef4444"] {
            background-color: rgba(239, 68, 68, 0.2) !important;
            border-color: rgba(239, 68, 68, 0.4) !important;
        }

        .sampled-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .sampled-yes {
            background-color: #d1fae5;
            color: #065f46;
        }

        .sampled-no {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* Disabled button styling */
        .btn-lab:disabled,
        .btn-lab-form:disabled,
        .btn-retest:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }

        .btn-lab:disabled:hover,
        .btn-lab-form:disabled:hover,
        .btn-retest:disabled:hover {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }

        /* Override disabled styling for uploaded buttons - they should be green when disabled */
        .btn-lab.uploaded:disabled,
        .btn-lab-form.uploaded:disabled,
        .btn-retest.uploaded:disabled {
            background-color: #059669 !important;
            color: #ffffff !important;
            opacity: 1 !important;
            cursor: not-allowed !important;
        }

        .btn-lab.uploaded:disabled:hover,
        .btn-lab-form.uploaded:disabled:hover,
        .btn-retest.uploaded:disabled:hover {
            background-color: #047857 !important;
            color: #ffffff !important;
        }

        /* Success state for disabled buttons - override the disabled styling */
        .btn-success.success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }

        .btn-success.success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
        }

        /* Also target buttons with specific IDs for lab, lab-form, and retest */
        button[id^="lab-"].success:disabled,
        button[id^="lab-form-"].success:disabled,
        button[id^="retest-"].success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }

        button[id^="lab-"].success:disabled:hover,
        button[id^="lab-form-"].success:disabled:hover,
        button[id^="retest-"].success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
        }

        /* Override any default disabled button styling with higher specificity */
        button.btn-success.success:disabled,
        button[id^="lab-"].btn-success.success:disabled,
        button[id^="lab-form-"].btn-success.success:disabled,
        button[id^="retest-"].btn-success.success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
            cursor: not-allowed !important;
        }

        button.btn-success.success:disabled:hover,
        button[id^="lab-"].btn-success.success:disabled:hover,
        button[id^="lab-form-"].btn-success.success:disabled:hover,
        button[id^="retest-"].btn-success.success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }

        .fa-check-circle {
            color: var(--secondary);
        }

        .fa-times-circle {
            color: var(--text-light);
        }

        /* Status badges */
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-open {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-pending {
            background-color: #fef3c7;
            color: #d97706;
        }

        .status-active {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-closed {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .status-under-review {
            background-color: #f3e8ff;
            color: #7c3aed;
        }

        .settlement-settled {
            background-color: #d1fae5;
            color: #065f46;
        }

        .settlement-not-settled {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .settlement-partial {
            background-color: #fef3c7;
            color: #d97706;
        }

        /* Compact the main table columns on laptop screens */
        @media (max-width: 1440px) {

            #shipmentsTable th,
            #shipmentsTable td {
                padding: 2px 4px;
                font-size: 0.65rem;
            }

            .col-client-name {
                min-width: 70px;
                max-width: 70px;
            }

            .col-compliance {
                min-width: 80px;
                max-width: 80px;
            }

            /* Mobile compliance status adjustments */
            .compliance-status {
                font-size: 0.6rem;
                padding: 1px 4px;
                min-width: 60px;
            }

            .col-date {
                min-width: 50px;
            }

            .col-rfi,
            .col-invoice,
            .col-km,
            .col-hours {
                min-width: 60px;
            }

            .col-send {
                min-width: 180px;
            }
        }

        /* Expandable table styles */
        .expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 0.8rem;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 20px;
            min-height: 20px;
            position: relative;
            z-index: 10;
        }

        .expand-btn:hover {
            background: var(--primary-light);
            transform: scale(1.1);
        }

        .expand-btn.expanded {
            transform: rotate(90deg);
        }

        .group-row {
            background-color: var(--card-bg);
            border-left: 3px solid var(--primary);
        }

        .group-row:hover {
            background-color: var(--primary-light);
        }

        .detail-row {
            background-color: #f8f9fa;
            width: 100%;
        }

        [data-theme="dark"] .detail-row {
            background-color: #363636;
        }

        .detail-cell {
            padding: 0;
            border: none;
            width: 100%;
        }

        .detail-content {
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .detail-content h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 100%;
            /* Use 100% instead of fixed pixel width */
            max-width: 100%;
            /* Prevent overflow beyond container */
            table-layout: auto;
        }

        /* Large desktop optimizations for screens wider than 1600px */
        @media (min-width: 1601px) {
            .detail-table {
                min-width: 100% !important;
                font-size: 0.8rem !important;
            }

            .detail-table th,
            .detail-table td {
                padding: 6px 5px !important;
                font-size: 0.8rem !important;
            }

            /* Larger column widths for big screens */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                width: 80px !important;
            }

            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                width: 260px !important;
            }

            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                width: 100px !important;
            }

            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                width: 180px !important;
                overflow: visible !important;
            }

            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                width: 320px !important;
            }

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                width: 16% !important;
                min-width: 250px !important;
            }

            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                width: 100px !important;
            }

            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                width: 320px !important;
            }

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                width: 45px !important;
            }

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                width: 45px !important;
            }

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                width: 45px !important;
            }

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                width: 45px !important;
            }

            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                width: 100px !important;
            }

            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                width: 130px !important;
            }

            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                width: 350px !important;
            }
        }

        /* Detail table specific column widths - increased for better use of expanded space */
        /* These are base widths for large screens - will be overridden by media queries for smaller screens */
        .detail-table th:nth-child(1) {
            width: 80px;
        }

        /* Inspection No */
        .detail-table th:nth-child(2) {
            width: 260px;
        }

        /* Client Name */
        .detail-table th:nth-child(3) {
            width: 100px;
        }

        /* Commodity */
        .detail-table th:nth-child(4) {
            width: 180px;
            overflow: visible !important;
        }

        /* Compliance */
        .detail-table th:nth-child(5) {
            width: 320px;
        }

        /* Product Name - increased width */
        /* Columns 6-12 widths controlled by media queries below */
        /* .detail-table th:nth-child(6), .detail-table td:nth-child(6) { width: 80px; min-width: 80px; } */
        /* Sampled - now controlled by media queries */
        /* .detail-table th:nth-child(7) { width: 120px; min-width: 120px; } */
        /* Needs Retest - now controlled by media queries */
        .detail-table th:nth-child(8),
        .detail-table td:nth-child(8) {
            width: 320px;
            min-width: 320px;
        }

        /* Class - same as Product Name */
        .detail-table td:nth-child(8) select {
            width: 100% !important;
        }

        /* Class dropdown - full width of column */
        /* .detail-table th:nth-child(9) { width: 40px; } */
        /* Fat - now controlled by media queries */
        /* .detail-table th:nth-child(10) { width: 40px; } */
        /* Protein - now controlled by media queries */
        /* .detail-table th:nth-child(11) { width: 40px; } */
        /* Calcium - now controlled by media queries */
        /* .detail-table th:nth-child(12) { width: 40px; } */
        /* DNA - now controlled by media queries */
        .detail-table th:nth-child(13) {
            width: 100px;
        }

        /* Bought Sample */
        .detail-table th:nth-child(14) {
            width: 100px;
        }

        /* Lab */
        .detail-table th:nth-child(15) {
            width: 350px;
            min-width: 350px;
            white-space: normal;
        }

        /* Actions - Edit, Lab, Lab Form, Retest - increased for full visibility */

        /* Laptop-specific optimizations for 15-inch screens (1366px - 1600px) */
        @media (min-width: 1024px) and (max-width: 1600px) {
            .detail-table {
                width: 100% !important;
                max-width: 100% !important;
                font-size: 0.65rem !important;
                table-layout: fixed !important;
            }

            .detail-table th,
            .detail-table td {
                padding: 4px 2px !important;
                font-size: 0.65rem !important;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            /* Percentage-based column widths to fit without horizontal scroll - Full names visible */
            .detail-table th:nth-child(1),
            .detail-table td:nth-child(1) {
                text-align: center !important;
                width: 7% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(2),
            .detail-table td:nth-child(2) {
                text-align: center !important;
                width: 8% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(3),
            .detail-table td:nth-child(3) {
                text-align: center !important;
                width: 7% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(4),
            .detail-table td:nth-child(4) {
                text-align: center !important;
                width: 7% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(5),
            .detail-table td:nth-child(5) {
                text-align: left !important;
                width: 10% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(6),
            .detail-table td:nth-child(6) {
                text-align: center !important;
                width: 6% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(7),
            .detail-table td:nth-child(7) {
                text-align: center !important;
                width: 7% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(8),
            .detail-table td:nth-child(8) {
                text-align: center !important;
                width: 6% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(9),
            .detail-table td:nth-child(9) {
                text-align: center !important;
                width: 5% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(10),
            .detail-table td:nth-child(10) {
                text-align: center !important;
                width: 5% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(11),
            .detail-table td:nth-child(11) {
                text-align: center !important;
                width: 5% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(12),
            .detail-table td:nth-child(12) {
                text-align: center !important;
                width: 4% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(13),
            .detail-table td:nth-child(13) {
                text-align: center !important;
                width: 8% !important;
                white-space: normal !important;
            }

            .detail-table th:nth-child(14),
            .detail-table td:nth-child(14) {
                text-align: center !important;
                width: 6% !important;
            }

            .detail-table th:nth-child(15),
            .detail-table td:nth-child(15) {
                text-align: center !important;
                width: 13% !important;
            }

            /* Compact form controls for laptop */
            .detail-table .form-control {
                font-size: 0.6rem !important;
                padding: 2px 2px !important;
                width: 100% !important;
            }

            .detail-table .btn-sm {
                font-size: 0.6rem !important;
                padding: 2px 4px !important;
                margin: 1px !important;
            }

            /* Remove horizontal scroll */
            .detail-table-wrapper {
                overflow-x: hidden !important;
                overflow-y: visible !important;
            }
        }

        /* Hide actions column for inspectors */
        .hide-actions .detail-table th:nth-child(15),
        .hide-actions .detail-table td:nth-child(15) {
            display: none !important;
        }

        .detail-table-wrapper {
            width: 100%;
            border-radius: var(--radius);
            max-width: 100%;
            /* Allow expanded table to take more width */
            max-width: calc(100vw - 40px);
            /* Reduced margin for more width */
        }

        .detail-table {
            width: 100%;
            table-layout: auto;
            margin: 0;
        }

        /* Ensure expanded content aligns with main table */
        .expanded-content {
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .expanded-content .detail-table-wrapper {
            margin-left: 0;
            margin-right: 0;
        }

        /* Fix detail row alignment */
        .detail-row {
            width: 100%;
        }

        .detail-cell {
            padding: 0;
            width: 100%;
        }

        .detail-content {
            width: 100%;
            margin: 0;
            padding: 10px;
        }

        /* Prevent main table from being affected by expanded content */
        #shipmentsTable tbody tr:not(.detail-row) {
            position: relative;
            z-index: 5;
        }

        /* Ensure main table rows maintain their layout */
        #shipmentsTable tbody tr:not(.detail-row) td {
            position: relative;
            z-index: 5;
        }

        /* Lock main table header dimensions - prevent any changes when expanded */
        #shipmentsTable thead {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--primary-light) !important;
        }

        #shipmentsTable thead th {
            position: sticky;
            top: 0;
            z-index: 100;
            /* Force exact column widths to prevent any changes */
            box-sizing: border-box;
            overflow: visible !important;
            text-overflow: initial !important;
            white-space: nowrap !important;
            line-height: 1.3;
        }

        /* Sticky footer at bottom of viewport - matches thead styling */
        #shipmentsTable tfoot {
            position: sticky;
            bottom: 0;
            z-index: 100;
            background-color: var(--primary-light) !important;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }

        #shipmentsTable tfoot th {
            position: sticky;
            bottom: 0;
            z-index: 100;
            background-color: var(--primary-light) !important;
            box-sizing: border-box;
            overflow: visible !important;
            text-overflow: initial !important;
            white-space: nowrap !important;
            line-height: 1.3;
        }

        /* Ensure main table maintains its exact layout when detail rows are shown */
        #shipmentsTable {
            table-layout: auto;
            width: 100%;
            position: relative;
        }

        /* Prevent detail table from affecting main table column widths */
        .detail-row {
            position: relative;
            z-index: 1;
            width: 100%;
        }

        .detail-cell {
            position: relative;
            z-index: 1;
            width: 100%;
            padding: 0;
        }

        /* Ensure detail content doesn't push main table around */
        .detail-content {
            width: 100%;
            margin: 0;
            padding: 10px;
            position: relative;
            z-index: 1;
            overflow-x: auto;
        }

        /* Lock detail table wrapper to prevent main table shifting */
        .detail-table-wrapper {
            position: relative;
            z-index: 1;
            width: 100%;
            border-radius: var(--radius);
            max-width: calc(100vw - 40px);
            /* Prevent this from affecting main table */
            margin: 0;
            padding: 0;
        }

        /* Tailwind responsive enhancements for detail table */
        @media (max-width: 640px) {
            .detail-table-wrapper {
                border-radius: 0.5rem;
            }

            .detail-table th,
            .detail-table td {
                font-size: 0.65rem !important;
                padding: 0.25rem !important;
            }
        }

        @media (min-width: 641px) and (max-width: 1024px) {

            .detail-table th,
            .detail-table td {
                font-size: 0.75rem !important;
                padding: 0.5rem !important;
            }
        }

        @media (min-width: 1025px) {

            .detail-table th,
            .detail-table td {
                font-size: 0.875rem !important;
                padding: 0.75rem !important;
            }
        }

        /* Medium screens: 1024px to 1600px - Show all content, allow horizontal scroll */
        @media (min-width: 1024px) and (max-width: 1600px) {
            .detail-table {
                width: auto !important;
                table-layout: auto !important;
            }

            .detail-table th,
            .detail-table td {
                white-space: nowrap !important;
                padding: 0.5rem 0.5rem !important;
            }

            .detail-table-wrapper {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
            }
        }

        /* Keep actions inline on desktop and tablets */
        @media (max-width: 1024px) and (min-width: 769px) {

            .col-rfi,
            .col-invoice {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-km {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-hours {
                width: 70px;
                min-width: 70px;
                max-width: 70px;
            }

            .col-send {
                width: 180px;
                min-width: 180px;
                max-width: 180px;
            }

            .group-buttons .btn {
                font-size: 7px;
                padding: 2px 3px;
            }

            .group-km-input,
            .group-hours-input {
                width: 40px;
                font-size: 0.6rem;
                padding: 2px 3px;
            }
        }

        .detail-table th {
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 2px 4px;
            font-weight: 600;
            font-size: 0.65rem;
            border-bottom: 1px solid var(--border);
        }

        .detail-table td {
            padding: 2px 4px;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
        }

        /* Specific styling for test columns in detail table */
        .detail-table .col-test {
            max-width: 35px !important;
            padding: 2px 3px !important;
        }

        .detail-table tr:hover {
            background-color: var(--primary-light);
        }

        .product-count {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
        }

        .col-expand {
            width: 30px;
            text-align: center;
        }


        /* Test checkbox styling */
        .test-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
            border: 2px solid var(--border);
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .test-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .test-checkbox:hover {
            border-color: var(--primary);
        }

        /* Test column styling */
        .col-test {
            text-align: center;
            max-width: 30px;
            padding: 2px 2px !important;
        }

        /* Visible but disabled test columns when no sample was taken */
        .col-test.blurred {
            opacity: 1;
            pointer-events: none;
        }

        .col-test.blurred input[type="checkbox"] {
            opacity: 0.7;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #f5f5f5;
            border: 2px solid #d1d5db;
            filter: grayscale(100%);
        }

        .col-test.blurred input[type="checkbox"]:checked {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            filter: grayscale(100%);
        }

        .col-bought-sample.blurred {
            opacity: 1;
            pointer-events: none;
        }

        .col-bought-sample.blurred input[type="number"] {
            opacity: 0.7;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #f5f5f5;
            border: 2px solid #d1d5db;
            filter: grayscale(100%);
        }

        /* New column styling */
        .col-km {
            text-align: center;
            min-width: 60px;
            max-width: 70px;
        }

        .col-bought-sample {
            text-align: center;
            min-width: 80px;
            max-width: 100px;
        }

        .col-hours {
            text-align: center;
            min-width: 50px;
            max-width: 60px;
        }

        .col-lab-dropdown {
            text-align: center;
            min-width: 70px;
            max-width: 80px;
        }

        /* Inspection number column - increased width for expanded table */
        .detail-table th:first-child,
        .detail-table td:first-child {
            min-width: 60px;
            max-width: 80px;
            text-align: center;
        }

        /* Client name column - made much wider */
        .detail-table th:nth-child(2),
        .detail-table td:nth-child(2) {
            min-width: 250px !important;
            width: 250px !important;
            max-width: 300px !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            padding: 8px 15px !important;
        }

        /* Commodity column - increased width */
        .detail-table th:nth-child(3),
        .detail-table td:nth-child(3) {
            min-width: 80px;
            max-width: 100px;
        }

        /* Compliance column - made much wider to fit "Non-Compliant" badge */
        .detail-table th:nth-child(4),
        .detail-table td:nth-child(4) {
            min-width: 180px !important;
            width: 180px !important;
            max-width: 200px !important;
            text-align: center !important;
            padding: 8px 15px !important;
            overflow: visible !important;
        }

        /* Product Name column - made much wider */
        .detail-table th:nth-child(5),
        .detail-table td:nth-child(5) {
            min-width: 300px !important;
            width: 300px !important;
            max-width: 350px !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            padding: 8px 15px !important;
        }

        /* Needs retest dropdown styling */
        .needs-retest-dropdown {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.65rem;
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
            max-width: 70px;
        }

        /* Sampled column */
        .detail-table th:nth-child(6),
        .detail-table td:nth-child(6) {
            text-align: center;
        }

        /* Needs retest column */
        .detail-table th:nth-child(7),
        .detail-table td:nth-child(7) {
            text-align: center;
        }

        /* Class column - made much wider */
        .detail-table th:nth-child(8),
        .detail-table td:nth-child(8) {
            min-width: 300px !important;
            width: 300px !important;
            max-width: 350px !important;
            text-align: center !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            padding: 8px 15px !important;
        }

        /* Class dropdown styling - matching lab dropdown exactly (no special border colors) */

        /* Test columns (Fat, Protein, Calcium, DNA) - increased width */
        .detail-table th:nth-child(9),
        .detail-table td:nth-child(9),
        .detail-table th:nth-child(10),
        .detail-table td:nth-child(10),
        .detail-table th:nth-child(11),
        .detail-table td:nth-child(11),
        .detail-table th:nth-child(12),
        .detail-table td:nth-child(12) {
            min-width: 30px;
            max-width: 40px;
            text-align: center;
        }

        /* Bought Sample column - increased width */
        .detail-table th:nth-child(13),
        .detail-table td:nth-child(13) {
            min-width: 80px;
            max-width: 100px;
            text-align: center;
        }

        /* Lab column - increased width */
        .detail-table th:nth-child(14),
        .detail-table td:nth-child(14) {
            min-width: 80px;
            max-width: 100px;
            text-align: center;
        }

        /* Actions column - significantly increased width */
        .detail-table th:nth-child(15),
        .detail-table td:nth-child(15) {
            min-width: 220px;
            max-width: 280px;
            text-align: center;
        }

        /* New input and dropdown styling */
        .km-input,
        .hours-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #dc3545;
            /* Red border by default (empty) */
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: #d4edda;
            /* Match compliant span background color */
            color: var(--text);
            text-align: center;
            transition: all 0.2s ease;
        }

        .bought-sample-input {
            width: 100%;
            padding: 4px 6px;
            border: none;
            /* No border */
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: #d4edda;
            /* Match compliant span background color */
            color: var(--text);
            text-align: center;
            transition: all 0.2s ease;
        }

        /* Green border when input has value */
        .km-input:not(:placeholder-shown),
        .hours-input:not(:placeholder-shown),
        .km-input[value]:not([value=""]),
        .hours-input[value]:not([value=""]) {
            border-color: #28a745;
            /* Green border when has value */
        }

        /* Dark mode overrides for input background colors */
        [data-theme="dark"] .km-input,
        [data-theme="dark"] .hours-input,
        [data-theme="dark"] .bought-sample-input {
            background-color: #1e4d2b;
            /* Match dark mode compliant span background color */
        }

        /* Focus state */
        .km-input:focus,
        .hours-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* Focus state for bought-sample-input (no border, only outline) */
        .bought-sample-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* Override km-input styling for class-dropdown to match lab-dropdown exactly */
        .class-dropdown {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 10;
        }

        .class-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
            z-index: 100;
        }

        /* Ensure class column cell has relative positioning for z-index to work */
        .col-class-dropdown {
            position: relative;
            z-index: 1;
        }

        .col-class-dropdown:has(.class-dropdown:focus) {
            z-index: 100;
        }

        /* Product name text styling - read-only from SQL Server - centered */
        .product-name-text {
            font-size: 0.7rem;
            color: var(--text);
            /* Black text like client name */
            font-weight: 500;
            text-align: center !important;
            padding: 4px 6px;
            display: inline-block;
            min-width: 120px;
            max-width: none;
            white-space: normal;
            word-wrap: break-word;
            width: 100%;
        }

        /* Manual input styling - editable when no product name */
        .manual-input {
            background-color: #d4edda !important;
            /* Light green background color */
            border-color: #446f1e !important;
        }

        .manual-input:focus {
            background-color: #d4edda !important;
            /* Light green background color */
            border-color: #446f1e !important;
            box-shadow: 0 0 0 0.2rem #446f1e;
        }

        /* Greyed out groups for "New" clients */
        .greyed-out-group {
            opacity: 0.5;
            background-color: #f5f5f5 !important;
            pointer-events: none !important;
        }

        .greyed-out-group:hover {
            opacity: 0.7;
        }

        /* Disable all input fields in greyed out groups */
        .greyed-out-group input,
        .greyed-out-group select,
        .greyed-out-group button,
        .greyed-out-group .form-control,
        .greyed-out-group .km-input,
        .greyed-out-group .hours-input,
        .greyed-out-group .manual-input,
        .greyed-out-group .bought-sample-input,
        .greyed-out-group .needs-retest-dropdown,
        .greyed-out-group .lab-dropdown,
        .greyed-out-group .test-checkbox {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            pointer-events: none !important;
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }

        /* Dark mode styling for greyed out groups */
        [data-theme="dark"] .greyed-out-group {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }

        [data-theme="dark"] .greyed-out-group input,
        [data-theme="dark"] .greyed-out-group select,
        [data-theme="dark"] .greyed-out-group button,
        [data-theme="dark"] .greyed-out-group .form-control,
        [data-theme="dark"] .greyed-out-group .km-input,
        [data-theme="dark"] .greyed-out-group .hours-input,
        [data-theme="dark"] .greyed-out-group .manual-input,
        [data-theme="dark"] .greyed-out-group .bought-sample-input,
        [data-theme="dark"] .greyed-out-group .needs-retest-dropdown,
        [data-theme="dark"] .greyed-out-group .lab-dropdown,
        [data-theme="dark"] .greyed-out-group .test-checkbox {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }

        /* Ensure table headers are visible */
        #shipmentsTable thead {
            display: table-header-group !important;
            visibility: visible !important;
        }

        #shipmentsTable thead th {
            display: table-cell !important;
            visibility: visible !important;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            padding: 10px 16px;
            text-align: left;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
            vertical-align: middle;
            position: relative;
            line-height: 1.3;
            font-size: 0.75rem;
        }

        /* Ensure table footer is visible and matches header */
        #shipmentsTable tfoot {
            display: table-footer-group !important;
            visibility: visible !important;
        }

        #shipmentsTable tfoot th {
            display: table-cell !important;
            visibility: visible !important;
            font-weight: bold;
            border-top: 2px solid #dee2e6;
            padding: 10px 16px;
            text-align: left;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
            vertical-align: middle;
            position: relative;
            line-height: 1.3;
            font-size: 0.75rem;
        }

        /* Force table to respect column widths */
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
        }

        /* Ensure all table cells respect their column widths */
        #shipmentsTable th,
        #shipmentsTable td {
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Fix main table header positioning when expanded */
        #shipmentsTable thead tr {
            position: relative;
            z-index: 10;
        }

        #shipmentsTable thead th {
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
            line-height: 1.3;
        }

        /* Fix main table footer positioning when expanded */
        #shipmentsTable tfoot tr {
            position: relative;
            z-index: 10;
        }

        #shipmentsTable tfoot th {
            position: sticky;
            bottom: 0;
            z-index: 10;
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
            line-height: 1.3;
        }

        /* Ensure main table headers don't move when detail rows are shown */
        .detail-row {
            position: relative;
            z-index: 1;
        }

        .detail-cell {
            position: relative;
            z-index: 1;
        }

        /* Force table to maintain its layout */
        #shipmentsTable {
            position: relative;
            min-width: 1400px;
        }

        /* Prevent any layout shifts */
        .table-responsive {
            position: relative;
            overflow-x: auto;
        }

        /* Lock header positions */
        #shipmentsTable thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }

        /* Prevent main table from being affected by detail table overflow */
        #shipmentsTable {
            position: relative;
            overflow: visible;
            min-width: 1400px;
        }

        /* Ensure detail rows don't push main table around */
        .detail-row {
            position: relative;
            overflow: hidden;
        }

        .detail-cell {
            position: relative;
            overflow: hidden;
            padding: 0;
        }

        /* Manual input styling */
        .km-input.manual-input {
            background-color: transparent;
            border-color: var(--border);
        }

        .km-input.manual-input:focus {
            background-color: transparent;
            border-color: var(--primary);
        }

        .lab-dropdown {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .km-input:focus,
        .hours-input:focus,
        .lab-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }

        .needs-retest-dropdown:hover {
            border-color: var(--primary);
        }

        .needs-retest-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }

        .needs-retest-dropdown option {
            background-color: var(--card-bg);
            color: var(--text);
        }

        /* Dark mode adjustments for dropdown */
        [data-theme="dark"] .needs-retest-dropdown {
            background-color: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }

        [data-theme="dark"] .needs-retest-dropdown option {
            background-color: var(--card-bg);
            color: var(--text);
        }

        /* Disabled dropdown styling */
        .needs-retest-dropdown:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f5f5f5;
            color: #999;
        }

        [data-theme="dark"] .needs-retest-dropdown:disabled {
            background-color: #404040;
            color: #666;
        }

        /* Search input styling */
        .search-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            overflow: visible;
        }

        /* Ensure form field allows dropdown to extend */
        .form-field {
            overflow: visible !important;
        }

        /* Ensure form group allows dropdown to extend */
        .form-group {
            overflow: visible !important;
        }

        .search-input {
            transition: all 0.2s ease;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--card-bg);
            color: var(--text);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 144, 0.1);
        }

        .search-input:hover {
            border-color: var(--primary);
        }

        .search-icon {
            pointer-events: none;
            transition: color 0.2s ease;
        }

        .search-input:focus+.search-icon {
            color: var(--primary);
        }

        /* Dark mode search input */
        [data-theme="dark"] .search-input {
            background-color: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }

        [data-theme="dark"] .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 144, 0.2);
        }




        /* Mobile menu button */
        .mobile-menu-btn {
            display: flex;
            position: fixed;
            top: 12px;
            left: 12px;
            z-index: 9999;
            background-color: #1e293b;
            color: #f1f5f9;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            width: 48px;
            height: 48px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* Hide mobile menu button on desktop */
        @media (min-width: 1025px) {
            .mobile-menu-btn {
                display: none !important;
            }
        }

        .mobile-menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Sidebar */
        #sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 256px;
            background-color: #1e293b;
            color: #f1f5f9;
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        /* Tailwind utility class for sidebar background */
        .bg-sidebar-bg {
            background-color: #1e293b !important;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #334155;
            text-align: center;
        }

        .sidebar-header img {
            max-height: 60px;
            margin-bottom: 0.5rem;
        }

        .company-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: #f1f5f9;
        }

        /* Force all table cells to stay within their columns */
        #shipmentsTable td {
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 0 !important;
            white-space: normal !important;
        }

        #shipmentsTable th {
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            max-width: 0 !important;
            white-space: normal !important;
        }

        /* Mobile close button for sidebar */
        .sidebar-close-btn {
            display: none;
            position: absolute;
            top: 12px;
            right: 12px;
            background-color: #1e293b;
            color: #f1f5f9;
            border: none;
            border-radius: 8px;
            width: 48px;
            height: 48px;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            z-index: 1001;
        }

        .sidebar-close-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Show close button only on mobile */
        @media (max-width: 1024px) {
            .sidebar-header {
                position: relative;
            }

            .sidebar-close-btn {
                display: flex;
            }
        }

        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-item {
            margin: 0;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.375rem 0.625rem;
            color: #f1f5f9;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            font-size: 0.875rem;
            font-weight: 500;
            min-height: 32px;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-left-color: var(--primary);
        }

        .nav-link.active {
            background-color: var(--primary);
            border-left-color: #ffffff;
        }

        .nav-link i {
            margin-right: 0.75rem;
            width: 20px;
            text-align: center;
        }

        .logout-section {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            border-top: 1px solid #334155;
        }

        .logout-btn {
            width: 100%;
            padding: 0.75rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .sidebar-overlay.show {
            display: block;
        }

        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: flex;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .container {
                padding-top: 60px;
            }
        }

        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }

            /* Mobile Table Styles */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            #shipmentsTable {
                min-width: 800px;
                font-size: 12px;
            }

            #shipmentsTable th,
            #shipmentsTable td {
                padding: 8px 4px;
                font-size: 11px;
            }

            /* Hide less important columns on mobile */
            .col-compliance {
                display: none;
            }

            .col-account-code {
                display: none;
            }

            /* Adjust important columns for mobile */
            .col-client-name {
                min-width: 120px;
                max-width: 150px;
            }

            .col-date {
                min-width: 80px;
            }

            .col-inspector {
                min-width: 160px;
            }

            .col-email {
                min-width: 120px;
            }


            .col-view-files {
                min-width: 90px;
            }

            .col-rfi,
            .col-invoice {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-km {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-hours {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }

            .col-send {
                width: 160px;
                min-width: 160px;
                max-width: 160px;
            }

            /* Keep buttons inline but smaller */
            .group-buttons {
                flex-wrap: nowrap;
                gap: 1px;
            }

            .group-buttons .btn {
                font-size: 8px;
                padding: 2px 4px;
                white-space: nowrap;
            }

            /* Ensure group inputs are visible on mobile */
            .group-inputs {
                gap: 6px;
                flex-wrap: nowrap;
            }

            .group-km-input,
            .group-hours-input {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
                font-size: 0.6rem;
                padding: 2px 3px;
                flex-shrink: 0;
            }

            .input-label {
                font-size: 0.6rem;
            }

            /* Filter section mobile styles */
            .card {
                margin: 10px 5px;
            }

            .card-body {
                padding: 15px;
            }

            .form-group {
                gap: 10px;
            }

            .form-field {
                margin-bottom: 15px;
            }

            .form-control {
                font-size: 14px;
                padding: 10px;
            }

            /* Mobile detail table */
            .detail-table {
                font-size: 10px;
                overflow-x: auto;
            }

            .detail-table th,
            .detail-table td {
                padding: 4px 2px;
                font-size: 10px;
            }

            /* Button adjustments */
            .btn-sm {
                padding: 4px 6px;
                font-size: 10px;
            }
        }

        @media (max-width: 480px) {

            /* Extra small mobile devices */
            .container {
                padding: 5px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header h2 {
                font-size: 14px;
            }

            /* Stack filter fields vertically on very small screens */
            .form-group {
                display: block;
            }

            .form-field {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Further reduce table font size */
            #shipmentsTable {
                font-size: 10px;
            }

            #shipmentsTable th,
            #shipmentsTable td {
                padding: 4px 2px;
                font-size: 9px;
            }

            /* Hide even more columns on very small screens */
            .col-email:nth-child(5),
            .col-email:nth-child(6) {
                display: none;
            }

            /* Make action buttons even smaller but keep inline */
            .col-rfi,
            .col-invoice {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-km {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-hours {
                width: 50px;
                min-width: 50px;
                max-width: 50px;
            }

            .col-send {
                width: 140px;
                min-width: 140px;
                max-width: 140px;
            }

            .group-buttons {
                flex-wrap: nowrap;
                gap: 1px;
            }

            .group-buttons .btn {
                font-size: 7px;
                padding: 1px 3px;
                white-space: nowrap;
            }

            /* Ensure group inputs remain visible on very small screens */
            .group-km-input,
            .group-hours-input {
                width: 40px;
                font-size: 0.55rem;
                padding: 1px 2px;
            }

            .input-label {
                font-size: 0.55rem;
            }

            .btn-sm {
                padding: 3px 4px;
                font-size: 8px;
            }
        }

        @media (max-width: 1024px) and (min-width: 769px) {

            /* Tablet styles */
            .action-bar {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }

            .action-bar .btn {
                flex: 0 1 auto;
                min-width: 140px;
            }

            #shipmentsTable {
                font-size: 13px;
            }

            #shipmentsTable th,
            #shipmentsTable td {
                padding: 10px 6px;
                font-size: 12px;
            }

            .col-test {
                max-width: 30px !important;
            }

            .col-km {
                min-width: 60px;
                max-width: 70px;
            }

            .col-hours {
                min-width: 50px;
                max-width: 60px;
            }

            .col-lab-dropdown {
                min-width: 80px;
                max-width: 90px;
            }

            /* Make dropdowns smaller on mobile */
            .needs-retest-dropdown,
            .km-input,
            .hours-input,
            .lab-dropdown {
                font-size: 0.6rem;
                padding: 1px 2px;
            }
        }

        @media (max-width: 480px) {

            /* Even smaller adjustments for very small screens */
            .detail-table {
                font-size: 0.55rem;
            }

            .detail-table th,
            .detail-table td {
                padding: 1px 2px;
                font-size: 0.55rem;
            }

            .needs-retest-dropdown,
            .km-input,
            .hours-input,
            .lab-dropdown {
                font-size: 0.55rem;
                padding: 1px;
            }
        }

        /* Ensure desktop table takes full width */
        #shipmentsTable {
            width: auto !important;
            table-layout: auto !important;
        }

        /* Ensure table container takes full width */
        .hidden.lg\\:block {
            width: 100% !important;
        }

        /* Desktop-only table cell styling */
        @media (min-width: 1024px) {

            #shipmentsTable th,
            #shipmentsTable td {
                white-space: nowrap !important;
                padding: 8px 12px !important;
                text-align: left !important;
                vertical-align: middle !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }
        }

        /* Add more spacing between columns for desktop view */

        /* Desktop-only column width and alignment rules */
        @media (min-width: 1024px) {
            #shipmentsTable th {
                white-space: normal !important;
                text-align: center !important;
                position: relative !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                font-size: 0.75rem !important;
                font-weight: normal !important;
                overflow: visible !important;
                word-wrap: break-word !important;
                line-height: 1.4 !important;
            }

            #shipmentsTable td {
                white-space: nowrap !important;
                text-align: center !important;
                position: relative !important;
                vertical-align: middle !important;
                box-sizing: border-box !important;
                font-size: 0.85rem !important;
            }

            #shipmentsTable th:nth-child(1),
            #shipmentsTable td:nth-child(1) {
                text-align: left !important;
                /* min-width: 180px !important; */
            }

            /* Client Name */
            #shipmentsTable th:nth-child(2),
            #shipmentsTable td:nth-child(2) {
                text-align: left !important;
                min-width: 220px !important;
            }

            /* Account Code */
            #shipmentsTable th:nth-child(3),
            #shipmentsTable td:nth-child(3) {
                text-align: left !important;
                min-width: 180px !important;
                padding-left: 5px !important;
                padding-right: 5px !important;
            }

            /* Inspection Date */
            #shipmentsTable th:nth-child(4),
            #shipmentsTable td:nth-child(4) {
                min-width: 190px !important;
            }

            /* Compliant/Non-Compliant */
            #shipmentsTable td:nth-child(4) span {
                min-width: 120px !important;
                display: inline-block !important;
                text-align: center !important;
                padding: 6px 12px !important;
            }

            /* Make compliance badge wider */
            #shipmentsTable th:nth-child(5) {
                text-align: center !important;
                min-width: 200px !important;
            }

            /* Email header */
            #shipmentsTable td:nth-child(5) {
                text-align: left !important;
                min-width: 200px !important;
            }

            /* Email data */
            #shipmentsTable th:nth-child(6),
            #shipmentsTable td:nth-child(6) {
                text-align: left !important;
                min-width: 200px !important;
            }

            /* Additional Email */
            #shipmentsTable th:nth-child(7),
            #shipmentsTable td:nth-child(7) {
                text-align: left !important;
                min-width: 160px !important;
                font-size: 0.85rem !important;
            }

            /* Inspector */
            #shipmentsTable th:nth-child(8),
            #shipmentsTable td:nth-child(8) {
                min-width: 150px !important;
            }

            /* View Files */
            #shipmentsTable th:nth-child(9),
            #shipmentsTable td:nth-child(9) {
                min-width: 100px !important;
            }

            /* RFI */
            #shipmentsTable th:nth-child(10),
            #shipmentsTable td:nth-child(10) {
                min-width: 100px !important;
            }

            /* Invoice */
            #shipmentsTable th:nth-child(11),
            #shipmentsTable td:nth-child(11) {
                min-width: 130px !important;
            }

            /* Occurrence */
            #shipmentsTable th:nth-child(12),
            #shipmentsTable td:nth-child(12) {
                min-width: 120px !important;
            }

            /* Composition */
            #shipmentsTable th:nth-child(13),
            #shipmentsTable td:nth-child(13) {
                min-width: 280px !important;
            }

            /* Comment */
            #shipmentsTable th:nth-child(14),
            #shipmentsTable td:nth-child(14) {
                min-width: 130px !important;
            }

            /* Distance (Km) */
            #shipmentsTable th:nth-child(15),
            #shipmentsTable td:nth-child(15) {
                min-width: 150px !important;
            }

            /* Hours Worked */
            #shipmentsTable th:nth-child(16),
            #shipmentsTable td:nth-child(16) {
                min-width: 110px !important;
            }

            /* Approved */
            #shipmentsTable th:nth-child(17),
            #shipmentsTable td:nth-child(17) {
                min-width: 160px !important;
            }

            /* Sent Status */
        }

        @media (min-width: 1024px) {
            #shipmentsTable td:nth-child(5) {
                text-align: left !important;
                min-width: 340px !important;
            }

            #shipmentsTable th:nth-child(6),
            #shipmentsTable td:nth-child(6) {
                text-align: center !important;
                min-width: 190px !important;
            }

            #shipmentsTable th:nth-child(8),
            #shipmentsTable td:nth-child(8) {
                min-width: 250px !important;
            }

            #shipmentsTable th:nth-child(9),
            #shipmentsTable td:nth-child(9) {
                min-width: 120px !important;
            }

            #shipmentsTable th:nth-child(10),
            #shipmentsTable td:nth-child(10) {
                min-width: 200px !important;
            }

            #shipmentsTable th:nth-child(11),
            #shipmentsTable td:nth-child(11) {
                min-width: 120px !important;
            }

            #shipmentsTable th:nth-child(12),
            #shipmentsTable td:nth-child(12) {
                min-width: 274px !important;
            }

            #shipmentsTable th:nth-child(13),
            #shipmentsTable td:nth-child(13) {
                min-width: 274px !important;
            }

            #shipmentsTable th:nth-child(14),
            #shipmentsTable td:nth-child(14) {
                width: 200px !important;
                text-align: center !important;
                /* padding-right: 50px !important; */
            }

            #shipmentsTable th:nth-child(15),
            #shipmentsTable td:nth-child(15) {
                min-width: 290px !important;
            }
        }

        /* Ensure table takes maximum available width */
        .container {
            max-width: 100% !important;
            padding-left: 1rem !important;
            padding-right: 2rem !important;
        }

        /* Desktop table specific width optimization */
        @media (min-width: 1024px) {
            .container {
                max-width: 100% !important;
                width: 100% !important;
            }

            .hidden.lg\\:block {
                width: 100% !important;
                max-width: 100% !important;
            }

            #shipmentsTable {
                width: auto !important;
                table-layout: auto !important;
            }
        }

        /* Fix mobile scrolling issues */
        .mobile-grid-container {
            max-height: none !important;
            overflow: visible !important;
        }

        .group-card {
            max-height: none !important;
            overflow: visible !important;
        }

        /* Fix pagination positioning on mobile */
        .pagination {
            position: relative !important;
            margin-top: 2rem !important;
            margin-bottom: 2rem !important;
            padding: 1rem !important;
            clear: both !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            gap: 0.5rem !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 10 !important;
        }

        .pagination .page-info {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        @media (max-width: 1024px) {
            .pagination {
                margin-top: 2rem !important;
                padding: 1.5rem 1rem !important;
                display: flex !important;
                visibility: visible !important;
                position: relative !important;
                z-index: 1 !important;
            }

            /* Ensure pagination doesn't overlap with mobile cards */
            .group-card {
                z-index: 2 !important;
                position: relative !important;
            }
        }

        /* Remove conflicting overflow settings for group-details */
        .group-details {
            max-height: 0 !important;
            overflow: hidden !important;
        }

        .group-details.expanded {
            max-height: 2000px !important;
            overflow: visible !important;
        }

        /* Ensure body and html can scroll */
        html,
        body {
            overflow-x: hidden !important;
            overflow-y: auto !important;
        }

        /* Fix container height issues */
        .container {
            min-height: 100vh !important;
            overflow: visible !important;
        }

        /* Desktop-specific rules - hide sidebar and overlay on large screens */
        @media (min-width: 1025px) {
            #sidebar {
                display: none !important;
            }

            .sidebar-overlay {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
            }
        }
    </style>

    <!-- CRITICAL: Define core functions in HEAD so they're available for onclick handlers -->
    <script>
        // These functions MUST be defined before body content loads
        // Otherwise onclick handlers will fail with "function not defined"

        window.openFilesPopup = function (groupId, clientName, inspectionDate) {
            console.log('openFilesPopup called:', groupId, clientName, inspectionDate);
            const modal = document.getElementById('filesModal');
            if (modal) {
                modal.style.display = 'block';
                const modalTitle = document.getElementById('modalTitle');
                if (modalTitle) modalTitle.textContent = 'Files for ' + clientName + ' - ' + inspectionDate;
                window.currentFilesClient = clientName;
                window.currentFilesDate = inspectionDate;
                window.currentFilesGroupId = groupId;
                if (typeof window.loadInspectionFiles === 'function') {
                    window.loadInspectionFiles(groupId, clientName, inspectionDate);
                }
            } else {
                console.error('filesModal not found');
            }
        };

        window.viewFilesForGroup = function (groupId, clientName, inspectionDate) {
            console.log('viewFilesForGroup called:', groupId, clientName, inspectionDate);
            window.openFilesPopup(groupId, clientName, inspectionDate);
        };

        // Generic upload function for all document types
        window.uploadDocumentForInspection = function (productId, groupId, documentType) {
            console.log('='.repeat(80));
            console.log('[UPLOAD DEBUG] uploadDocumentForInspection CALLED');
            console.log('='.repeat(80));
            console.log('[UPLOAD DEBUG] Parameters received:');
            console.log('[UPLOAD DEBUG]   productId:', productId);
            console.log('[UPLOAD DEBUG]   productId type:', typeof productId);
            console.log('[UPLOAD DEBUG]   productId is null:', productId === null);
            console.log('[UPLOAD DEBUG]   productId is undefined:', productId === undefined);
            console.log('[UPLOAD DEBUG]   productId stringified:', JSON.stringify(productId));
            console.log('[UPLOAD DEBUG]   groupId:', groupId);
            console.log('[UPLOAD DEBUG]   groupId type:', typeof groupId);
            console.log('[UPLOAD DEBUG]   groupId length:', groupId ? groupId.length : 'N/A');
            console.log('[UPLOAD DEBUG]   documentType:', documentType);
            console.log('-'.repeat(80));

            // Validate that at least one ID is provided
            if (!productId && !groupId) {
                alert('Error: Unable to upload ' + documentType + ' - missing group or inspection ID. Please refresh the page and try again.');
                console.error('[UPLOAD DEBUG] Missing both productId and groupId for ' + documentType);
                return;
            }

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';

            fileInput.onchange = function (e) {
                const file = e.target.files[0];
                console.log('[UPLOAD DEBUG] File selected:', file ? file.name : 'NO FILE');

                if (file) {
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only PDF files are allowed. Please select a PDF document.');
                        return;
                    }

                    console.log('[UPLOAD DEBUG] Building FormData...');
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('document_type', documentType);
                    // Only send values if they're truthy (not empty string, null, undefined)
                    if (productId) formData.append('inspection_id', productId);
                    if (groupId) formData.append('group_id', groupId);

                    // Log what we're sending
                    console.log('[UPLOAD DEBUG] FormData contents:');
                    console.log('[UPLOAD DEBUG]   file:', file.name, '(' + file.size + ' bytes)');
                    console.log('[UPLOAD DEBUG]   inspection_id being sent:', productId);
                    console.log('[UPLOAD DEBUG]   inspection_id type:', typeof productId);
                    console.log('[UPLOAD DEBUG]   document_type:', documentType);
                    console.log('[UPLOAD DEBUG]   group_id:', groupId);

                    // Extra validation check
                    if (productId && typeof productId === 'string' && !/^\d+$/.test(productId)) {
                        console.error('[UPLOAD DEBUG] WARNING: inspection_id is NOT numeric!');
                        console.error('[UPLOAD DEBUG] inspection_id value:', productId);
                        console.error('[UPLOAD DEBUG] This will cause an error on the server!');
                    }

                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    console.log('[UPLOAD DEBUG] Sending POST to /upload-document/...');

                    fetch('/upload-document/', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                        .then(response => {
                            console.log('[UPLOAD DEBUG] Response status:', response.status);
                            console.log('[UPLOAD DEBUG] Response ok:', response.ok);
                            return response.json();
                        })
                        .then(data => {
                            console.log('[UPLOAD DEBUG] Response data:', JSON.stringify(data));
                            if (data.success) {
                                console.log('[UPLOAD DEBUG] SUCCESS! ' + documentType + ' uploaded for inspection ' + productId);

                                // Update button color to green immediately - no page reload
                                // All buttons use data-upload-btn attribute pattern
                                const btn = document.querySelector('[data-upload-btn="' + documentType + '-' + productId + '"]');
                                if (btn) {
                                    btn.style.background = '#22c55e';
                                    // Keep original label but add checkmark
                                    const originalText = btn.textContent.replace(' ‚úì', '');
                                    btn.innerHTML = originalText + ' ‚úì';
                                }

                                // Also update RFI/Invoice buttons in Facility section by groupId
                                if (groupId && (documentType === 'rfi' || documentType === 'invoice')) {
                                    // Update desktop button
                                    const groupBtn = document.getElementById(documentType + '-btn-' + groupId);
                                    if (groupBtn) {
                                        groupBtn.style.backgroundColor = '#22c55e';
                                        groupBtn.style.borderColor = '#22c55e';
                                        groupBtn.style.color = 'white';
                                        groupBtn.disabled = true;
                                        groupBtn.style.cursor = 'not-allowed';
                                        const label = documentType === 'rfi' ? 'RFI' : 'Invoice';
                                        groupBtn.innerHTML = label + ' ‚úì';
                                        groupBtn.title = label + ' file exists';
                                        console.log('‚úÖ Updated ' + documentType + ' desktop button to GREEN');
                                    }
                                    // Update mobile button
                                    const mobileBtn = document.getElementById(documentType + '-mobile-' + groupId);
                                    if (mobileBtn) {
                                        mobileBtn.style.backgroundColor = '#22c55e';
                                        mobileBtn.style.borderColor = '#22c55e';
                                        mobileBtn.style.color = 'white';
                                        mobileBtn.disabled = true;
                                        mobileBtn.style.cursor = 'not-allowed';
                                        const label = documentType === 'rfi' ? 'RFI' : 'Invoice';
                                        mobileBtn.innerHTML = '<i class="fas fa-check mr-1"></i> ' + label + ' ‚úì';
                                        mobileBtn.title = label + ' file exists';
                                        console.log('‚úÖ Updated ' + documentType + ' mobile button to GREEN');
                                    }
                                }

                                // Show toast notification instead of alert
                                const toast = document.createElement('div');
                                toast.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #22c55e; color: white; padding: 12px 20px; border-radius: 6px; z-index: 9999; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                                toast.textContent = documentType.charAt(0).toUpperCase() + documentType.slice(1) + ' uploaded successfully!';
                                document.body.appendChild(toast);
                                setTimeout(() => toast.remove(), 3000);
                            } else {
                                console.error('[UPLOAD DEBUG] UPLOAD FAILED!');
                                console.error('[UPLOAD DEBUG] Error message:', data.error);
                                console.error('[UPLOAD DEBUG] Full response:', JSON.stringify(data));
                                if (data.traceback) {
                                    console.error('[UPLOAD DEBUG] SERVER TRACEBACK:');
                                    console.error(data.traceback);
                                }
                                console.error('[UPLOAD DEBUG] Original parameters:');
                                console.error('[UPLOAD DEBUG]   productId was:', productId);
                                console.error('[UPLOAD DEBUG]   groupId was:', groupId);
                                console.error('[UPLOAD DEBUG]   documentType was:', documentType);
                                alert('Error uploading ' + documentType + ': ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            console.error('[UPLOAD DEBUG] FETCH ERROR!');
                            console.error('[UPLOAD DEBUG] Error:', error);
                            console.error('[UPLOAD DEBUG] Error message:', error.message);
                            console.error('[UPLOAD DEBUG] Error stack:', error.stack);
                            alert('Error uploading ' + documentType + ': ' + error.message);
                        });
                }
            };

            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        };

        window.uploadComplianceForInspection = function (productId, groupId) {
            console.log('[UPLOAD DEBUG] uploadComplianceForInspection called with productId:', productId, 'groupId:', groupId);
            window.uploadDocumentForInspection(productId, groupId, 'compliance');
        };

        window.uploadCompositionForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'composition');
        };

        window.uploadLabForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'lab');
        };

        window.uploadOccurrenceForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'occurrence');
        };

        window.uploadInvoiceForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'invoice');
        };

        window.uploadRfiForInspection = function (productId, groupId) {
            console.log('[UPLOAD DEBUG] uploadRfiForInspection called with productId:', productId, 'groupId:', groupId);
            window.uploadDocumentForInspection(productId, groupId, 'rfi');
        };

        window.uploadRetestForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'retest');
        };

        window.uploadOtherForInspection = function (productId, groupId) {
            window.uploadDocumentForInspection(productId, groupId, 'other');
        };

        window.viewDocForInspection = function (productId, docType) {
            console.log('viewDocForInspection called:', productId, docType);
        };

        window.deleteDocForInspection = function (productId, docType) {
            console.log('deleteDocForInspection called:', productId, docType);
        };

        console.log('‚úÖ Critical functions defined in HEAD');
    </script>
</head>

<body class="user-role-{{ request.user.role }}">
    <!-- Loading overlay for large datasets -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">Loading {{ total_shipments }} records... Please wait...</div>
    </div>


    <!-- Mobile Menu Button -->
    <button id="mobile-menu-btn"
        class="mobile-menu-btn fixed top-4 left-4 z-50 bg-sidebar-bg text-white p-3 rounded-lg shadow-lg lg:hidden hover:bg-opacity-90 transition-all duration-200 active:scale-95"
        aria-label="Toggle menu" onclick="toggleSidebar(); console.log('üçî DIRECT ONCLICK TRIGGERED');"
        style="pointer-events: auto !important;">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Sidebar Overlay -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <div class="page-container">
        <!-- Sidebar -->
        <div id="sidebar">
            <div class="sidebar-header">
                <img src="{% static 'img/Food safetyagencylogo.png' %}" alt="Food Safety Agency Logo">
                <div class="company-name">Food Safety Agency (Pty) Ltd</div>
                <!-- Mobile close button -->
                <button id="sidebar-close-btn" class="sidebar-close-btn" onclick="toggleSidebar()"
                    aria-label="Close menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <ul class="nav-menu">
                {% if request.user.role == 'inspector' %}
                <!-- Inspector-specific menu: Only Dashboard, Inspections, Settings, Expand/Collapse -->
                <li class="nav-item">
                    <a href="{% url 'inspector_dashboard' %}" class="nav-link">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'shipment_list' %}" class="nav-link active">
                        <i class="fas fa-clipboard-check"></i>
                        Inspections
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'submit_ticket' %}" class="nav-link">
                        <i class="fas fa-ticket-alt" style="color: #f87171;"></i>
                        Submit Ticket
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'settings' %}" class="nav-link">
                        <i class="fas fa-cog"></i>
                        Inspector Settings
                    </a>
                </li>
                <li class="nav-item">
                    <button onclick="expandAll()" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer;">
                        <i class="fas fa-expand-alt"></i>
                        Expand All
                    </button>
                </li>
                <li class="nav-item">
                    <button onclick="collapseAll()" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer;">
                        <i class="fas fa-compress-alt"></i>
                        Collapse All
                    </button>
                </li>
                {% else %}
                <!-- Full menu for non-inspector users -->
                <li class="nav-item">
                    <a href="{% url 'home' %}" class="nav-link">
                        <i class="fas fa-home"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'client_list' %}" class="nav-link">
                        <i class="fas fa-users"></i>
                        Clients
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'shipment_list' %}" class="nav-link active">
                        <i class="fas fa-clipboard-check"></i>
                        Inspections
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'user_management' %}" class="nav-link">
                        <i class="fas fa-users-cog"></i>
                        User Management
                    </a>
                </li>
                {% if request.user.role == 'developer' or request.user.role == 'super_admin' %}
                <li class="nav-item">
                    <a href="{% url 'system_logs' %}" class="nav-link">
                        <i class="fas fa-list-alt"></i>
                        System Logs
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'fsa_operations_board' %}" class="nav-link">
                        <i class="fas fa-ticket-alt" style="color: #22d3ee;"></i>
                        Support Tickets
                    </a>
                </li>
                {% endif %}
                {% if request.user.role == 'developer' %}
                <li class="nav-item">
                    <a href="{% url 'onedrive_view' %}" class="nav-link">
                        <i class="fas fa-cloud"></i>
                        OneDrive View
                    </a>
                </li>
                {% endif %}
                {% if request.user.role == 'developer' or request.user.role == 'super_admin' %}
                <li class="nav-item">
                    <a href="{% url 'server_view' %}" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        Server View
                    </a>
                </li>
                {% endif %}
                <li class="nav-item">
                    <a href="{% url 'submit_ticket' %}" class="nav-link">
                        <i class="fas fa-ticket-alt" style="color: #f87171;"></i>
                        Submit Ticket
                    </a>
                </li>
                <li class="nav-item">
                    <a href="{% url 'settings' %}" class="nav-link">
                        <i class="fas fa-cog"></i>
                        Settings
                    </a>
                </li>

                <!-- Shipment-specific functionality -->
                {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
                <li class="nav-item">
                    <button onclick="syncInspectionsFromShipmentList()" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer;">
                        <i class="fas fa-sync-alt"></i>
                        Sync Inspections
                    </button>
                </li>

                {% if request.user.role == 'developer' or request.user.role == 'super_admin' or request.user.role == 'financial_admin' %}
                <li class="nav-item">
                    <a href="{% url 'export_sheet' %}" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer; text-decoration: none;">
                        <i class="fas fa-file-export"></i>
                        Export Sheet
                    </a>
                </li>
                {% endif %}

                <li class="nav-item">
                    <button onclick="expandAll()" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer;">
                        <i class="fas fa-expand-alt"></i>
                        Expand All
                    </button>
                </li>

                <li class="nav-item">
                    <button onclick="collapseAll()" class="nav-link"
                        style="width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; color: #f1f5f9; cursor: pointer;">
                        <i class="fas fa-compress-alt"></i>
                        Collapse All
                    </button>
                </li>
                {% endif %}
            </ul>

            <div class="logout-section">
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Hidden CSRF token for AJAX requests -->
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token|escapejs }}">

            <div class="container mx-auto px-4 py-6 w-full">
                <div class="logo">
                    <img src="{% static 'img/Food safetyagencylogo.png' %}" alt="Food Safety Agency Logo">
                </div>

                <div class="header">
                    <h1>Food Safety Agency (Pty) Ltd</h1>
                    <h2>Claims Records Management</h2>
                </div>


                <!-- Messages Section - Disabled -->

                <!-- User Context Message - Removed to hide status reset notifications -->

                <div class="action-bar">
                    <!-- Home Button (FIRST) -->
                    {% if request.user.role == 'inspector' %}
                    <a href="{% url 'inspector_dashboard' %}" class="btn btn-primary">
                        <i class="fas fa-home"></i> My Home
                    </a>
                    {% else %}
                    <a href="{% url 'home' %}" class="btn btn-primary">
                        <i class="fas fa-home"></i> Home
                    </a>
                    {% endif %}

                    <!-- Analytics Button -->
                    {% if request.user.role != 'inspector' %}
                    <a href="{% url 'analytics_dashboard' %}" class="btn btn-secondary">
                        <i class="fas fa-chart-line"></i> Analytics
                    </a>
                    {% endif %}

                    <!-- Export Sheet Button -->
                    {% if request.user.role == 'developer' or request.user.role == 'super_admin' or request.user.role == 'financial_admin' %}
                    <a href="{% url 'export_sheet' %}" class="btn btn-secondary">
                        <i class="fas fa-file-export"></i> Export Sheet
                    </a>
                    {% endif %}

                    <!-- Expand All Button (SECOND) -->
                    <button type="button" class="btn btn-secondary" onclick="expandAll()">
                        <i class="fas fa-expand-alt"></i> Expand All
                    </button>

                    <!-- Collapse All Button -->
                    <button type="button" class="btn btn-secondary" onclick="collapseAll()">
                        <i class="fas fa-compress-alt"></i> Collapse All
                    </button>

                    <!-- Add Inspection Button -->
                    {% if request.user.role == 'developer' or request.user.role == 'super_admin' or request.user.role == 'admin' %}
                    <a href="{% url 'add_fsa_inspection' %}" class="btn" style="background: #22c55e; color: white;"
                        onmouseover="this.style.background='#16a34a'" onmouseout="this.style.background='#22c55e'">
                        <i class="fas fa-plus"></i> Add Inspection
                    </a>
                    {% endif %}

                    <!-- Sync Shipments Button - Hidden for administrators -->
                    {% if request.user.role != 'inspector' and request.user.role != 'scientist' and request.user.role != 'admin' %}
                    <form action="{% url 'refresh_inspections' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn" style="background: #007890; color: white;"
                            onmouseover="this.style.background='#005a6b'" onmouseout="this.style.background='#007890'">
                            <i class="fas fa-sync-alt"></i> Sync Inspections
                        </button>
                    </form>
                    {% endif %}

                    <!-- Manage Clients Button -->
                    {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
                    <a href="{% url 'client_allocation' %}" class="btn btn-allocation">
                        <i class="fas fa-users"></i> Manage Clients
                    </a>
                    {% endif %}

                    <!-- System Logs Button - Available for super_admin and developer -->
                    {% if request.user.role == 'super_admin' or request.user.role == 'developer' %}
                    <a href="{% url 'system_logs' %}" class="btn" style="background: #6b7280; color: white;"
                        onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                        <i class="fas fa-list-alt"></i> System Logs
                    </a>
                    {% endif %}


                    <!-- Logout Button (Matching Other Buttons) -->
                    <form action="{% url 'logout' %}" method="post" class="logout-form" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-logout"
                            style="background-color: white; color: var(--danger); border: 1px solid #ddd;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </form>
                </div>

                <!-- Filter Card -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-filter"></i> Filter Inspections
                        </div>
                    </div>
                    <div class="card-body">
                        <form method="get" action="" class="filter-form">
                            <!-- First Row: Search and Selection Fields -->
                            <div class="filter-row">
                                <div class="filter-field" style="position: relative;">
                                    <label class="form-label">Client Search</label>
                                    <div class="search-input-wrapper" style="position: relative;">
                                        <input type="text" class="form-control search-input" name="client"
                                            id="clientSearchInput" value="{{ request.GET.client }}"
                                            placeholder="Search client name..." autocomplete="off"
                                            style="padding-left: 35px;">
                                        <i class="fas fa-search search-icon"
                                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 14px;"></i>
                                        <div id="clientSuggestions" class="autocomplete-dropdown"
                                            style="display: none;">
                                            <!-- Suggestions will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="filter-field">
                                    <label class="form-label">Inspector</label>
                                    <select class="form-control" name="branch">
                                        <option value="">All Inspectors</option>
                                        {% for inspector in inspectors %}
                                        <option value="{{ inspector }}" {% if request.GET.branch == inspector %}selected{% endif %}>{{ inspector }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <!-- Second Row: Date Range and Status Filters -->
                            <div class="filter-row">
                                <div class="filter-field">
                                    <label class="form-label">Date From</label>
                                    <div class="date-input-container">
                                        <input type="text" class="form-control date-picker"
                                            name="inspection_date_from_display" placeholder="DD/MM/YYYY"
                                            value="{% if request.GET.inspection_date_from %}{{ request.GET.inspection_date_from|date:" d/m/Y" }}{% endif %}" readonly>
                                        <input type="hidden" name="inspection_date_from"
                                            value="{{ request.GET.inspection_date_from }}">
                                        <button type="button" class="date-picker-btn"
                                            onclick="openDatePicker('inspection_date_from_display')">
                                            <i class="fas fa-calendar-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="filter-field">
                                    <label class="form-label">Date To</label>
                                    <div class="date-input-container">
                                        <input type="text" class="form-control date-picker"
                                            name="inspection_date_to_display" placeholder="DD/MM/YYYY"
                                            value="{% if request.GET.inspection_date_to %}{{ request.GET.inspection_date_to|date:" d/m/Y" }}{% endif %}" readonly>
                                        <input type="hidden" name="inspection_date_to"
                                            value="{{ request.GET.inspection_date_to }}">
                                        <button type="button" class="date-picker-btn"
                                            onclick="openDatePicker('inspection_date_to_display')">
                                            <i class="fas fa-calendar-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="filter-field">
                                    <label class="form-label">Sent Status</label>
                                    <select class="form-control" name="sent_status">
                                        <option value="">Not Sent</option>
                                        <option value="YES" {% if request.GET.sent_status == 'YES' %}selected{% endif %}>
                                            Sent Only</option>
                                        <option value="NO" {% if request.GET.sent_status == 'NO' %}selected{% endif %}>Not
                                            Sent Only</option>
                                    </select>
                                </div>
                                <!-- RFI Status filter removed - show all inspections regardless of files -->
                                <div class="filter-field">
                                    <label class="form-label">Compliance Status</label>
                                    <select class="form-control" name="compliance_status">
                                        <option value="">All Inspections</option>
                                        <option value="COMPLIANT" {% if request.GET.compliance_status == 'COMPLIANT' %}selected{% endif %}>Compliant Only</option>
                                        <option value="NON_COMPLIANT" {% if request.GET.compliance_status == 'NON_COMPLIANT' %}selected{% endif %}>Non-Compliant Only</option>
                                    </select>
                                </div>
                                <!-- Lab Form Status filter removed - show all inspections regardless of lab forms -->
                            </div>

                            <!-- Action Buttons Row -->
                            <div class="filter-actions">
                                <button type="submit" class="btn btn-primary"
                                    style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <a href="?" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-times"></i> Clear All
                                </a>
                                {% if not show_all %}
                                <a href="?show_all=true" class="btn btn-secondary"
                                    style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-list"></i> Show All ({{ total_shipments }})
                                </a>
                                {% else %}
                                <a href="?" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                                    <i class="fas fa-list"></i> Show Paginated
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Claims Table -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-clipboard-check"></i> Inspections List
                        </div>

                    </div>
                    <div class="card-body">
                        <div class="table-controls">
                            <div class="table-info">
                                {% if show_all %}
                                Showing all {{ total_shipments }} inspection{{ total_shipments|pluralize }}
                                {% else %}
                                Showing {{ shipments|length }} of {{ total_shipments }} inspection{{ total_shipments|pluralize }}
                                {% endif %}
                            </div>
                        </div>
                        <!-- Mobile Card Grid Layout -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 lg:hidden">
                            {% for shipment in shipments %}
                            <!-- Generate fallback group_id for this shipment -->
                            {% with client_slug=shipment.client_name|sanitize_group_id %}
                            {% with date_str=shipment.date_of_inspection|date:"Ymd" %}
                            {% with fallback_group_id=client_slug|add:"_"|add:date_str %}

                            <!-- Mobile Group Card -->
                            <div class="group-card bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 border border-gray-200 overflow-hidden"
                                data-group-id="{{ fallback_group_id }}" data-client-name="{{ shipment.client_name }}"
                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}" {% if shipment.sent_date %}data-sent-timestamp="{{ shipment.sent_date|date:'c' }}" {% endif %}>

                                <!-- Card Header -->
                                <div class="bg-gradient-to-r from-primary to-primary-light p-4 text-white">
                                    <div class="flex items-center justify-between gap-3">
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-bold text-lg truncate">{{ shipment.client_name|default:"-" }}</h3>
                                            <p class="text-sm opacity-90">{{ shipment.date_of_inspection|date:"d/m/Y"|default:"-" }}</p>
                                        </div>
                                        <button
                                            class="expand-btn p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-colors duration-200 flex-shrink-0"
                                            data-group-id="{{ fallback_group_id }}" title="Expand/Collapse">
                                            <i
                                                class="fas fa-chevron-down transform transition-transform duration-200"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Card Content -->
                                <div class="p-4">
                                    <!-- Status Badge -->
                                    <div class="mb-3">
                                        {% if shipment.inspection_compliance_status == 'compliant' %}
                                        <span
                                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            <i class="fas fa-check-circle mr-1"></i> Compliant
                                        </span>
                                        {% else %}
                                        <span
                                            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fas fa-times-circle mr-1"></i> Non-Compliant
                                        </span>
                                        {% endif %}
                                    </div>

                                    <!-- Key Info -->
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Account Code:</span>
                                            <span
                                                class="font-mono text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">{{ shipment.internal_account_code|default:"-" }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Inspector:</span>
                                            <span class="font-medium">{{ shipment.inspector_name|display_inspector:shipment.inspector_id }}</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-500">Distance:</span>
                                            <input type="number"
                                                class="group-km-input text-xs border border-gray-300 rounded px-2 py-1 w-20"
                                                data-group-id="{{ fallback_group_id }}"
                                                value="{{ shipment.km_traveled|default:'' }}" placeholder="0.0"
                                                step="0.1" min="0" onchange="updateGroupKmTraveled(this)"
                                                onblur="updateGroupKmTraveled(this)" title="Total kilometers traveled">
                                            <span class="text-xs text-gray-500 ml-1">km</span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-500">Hours:</span>
                                            <input type="number"
                                                class="group-hours-input text-xs border border-gray-300 rounded px-2 py-1 w-20"
                                                data-group-id="{{ fallback_group_id }}"
                                                value="{{ shipment.hours|default:'' }}" placeholder="0.0" step="0.1"
                                                min="0" onchange="updateGroupHours(this)"
                                                onblur="updateGroupHours(this)" title="Total hours worked">
                                            <span class="text-xs text-gray-500 ml-1">hrs</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Approved:</span>
                                            <span
                                                class="text-xs px-2 py-1 rounded {% if shipment.approved %}bg-green-100 text-green-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                                {% if shipment.approved %}Yes{% else %}No{% endif %}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-500">Sent Status:</span>
                                            <span
                                                class="text-xs px-2 py-1 rounded {% if shipment.sent_date %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                {% if shipment.sent_date %}Sent{% else %}Not Sent{% endif %}
                                            </span>
                                        </div>
                                    </div>

                                    <!-- Action Buttons -->
                                    <div class="mt-4 space-y-2">
                                        <button id="view-files-mobile-{{ fallback_group_id }}" class="btn btn-sm btn-view-files w-full text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors duration-200
                                           {% if shipment.file_status == 'complete' %}
                                               btn-files-complete
                                           {% elif shipment.file_status == 'compliance_only' or shipment.file_status == 'partial' %}
                                               btn-files-partial
                                           {% elif shipment.file_status == 'no_compliance' %}
                                               btn-files-none
                                           {% else %}
                                               btn-files-checking
                                           {% endif %}" data-group-id="{{ fallback_group_id }}"
                                            data-client-name="{{ shipment.client_name }}"
                                            data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                            onclick="if(typeof openFilesPopup === 'function') { openFilesPopup('{{ fallback_group_id|escapejs }}', '{{ shipment.client_name|escapejs }}', '{{ shipment.date_of_inspection|date:"Y-m-d"|escapejs }}'); } else { console.warn('openFilesPopup not loaded
                                            yet'); }">
                                            <i class="fas fa-eye mr-2"></i> View Files
                                        </button>
                                        <div class="grid grid-cols-1 gap-2">
                                            {% if shipment.rfi_uploaded %}
                                            <button id="rfi-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="RFI file exists">
                                                <i class="fas fa-check mr-1"></i> RFI
                                            </button>
                                            {% else %}
                                            <button id="rfi-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadRfiForInspection('{{ shipment.products.0.id }}', '{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload RFI">
                                                <i class="fas fa-file-alt mr-1"></i> RFI
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% if user.role != 'inspector' %}
                                        <div class="mt-2">
                                            {% if shipment.invoice_uploaded %}
                                            <button id="invoice-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="Invoice file exists">
                                                <i class="fas fa-check mr-1"></i> Invoice
                                            </button>
                                            {% else %}
                                            <button id="invoice-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadInvoice('{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload Invoice">
                                                <i class="fas fa-file-invoice mr-1"></i> Invoice
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- Retest Button (mobile card) -->
                                        <div class="mt-2">
                                            {% if shipment.retest_uploaded %}
                                            <button id="retest-btn-{{ fallback_group_id }}"
                                                class="w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="Retest file exists">
                                                <i class="fas fa-check mr-1"></i> Retest
                                            </button>
                                            {% else %}
                                            <button id="retest-btn-{{ fallback_group_id }}"
                                                class="w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadRetestForInspection(null, '{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload Retest">
                                                <i class="fas fa-redo mr-1"></i> Retest
                                            </button>
                                            {% endif %}
                                        </div>

                                        <!-- Occurrence Button (mobile card) -->
                                        {% if request.user.role == 'inspector' or request.user.role != 'scientist' %}
                                        <div class="mt-2">
                                            {% if shipment.occurrence_uploaded %}
                                            <button id="occurrence-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="Occurrence file exists">
                                                <i class="fas fa-check mr-1"></i> Upload
                                            </button>
                                            {% else %}
                                            <button id="occurrence-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadOccurrence('{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload Occurrence">
                                                <i class="fas fa-exclamation-triangle mr-1"></i> Upload
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- Composition Button (mobile card) -->
                                        {% if request.user.role != 'scientist' %}
                                        <div class="mt-2">
                                            {% if shipment.composition_uploaded %}
                                            <button id="composition-mobile-{{ fallback_group_id }}"
                                                class="composition-btn w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="Composition file exists">
                                                <i class="fas fa-check mr-1"></i> Upload
                                            </button>
                                            {% else %}
                                            <button id="composition-mobile-{{ fallback_group_id }}"
                                                class="composition-btn w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadComposition('{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload Composition">
                                                <i class="fas fa-flask mr-1"></i> Upload
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% endif %}

                                        <!-- Compliance Button (mobile card) -->
                                        <div class="mt-2">
                                            {% if shipment.has_compliance %}
                                            <button id="compliance-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium"
                                                style="background-color: #28a745; border-color: #28a745; color: white;"
                                                disabled title="Compliance file exists">
                                                <i class="fas fa-check mr-1"></i> Compliance
                                            </button>
                                            {% else %}
                                            <button id="compliance-mobile-{{ fallback_group_id }}"
                                                class="w-full bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200"
                                                onclick="uploadComplianceForInspection(null, '{{ fallback_group_id|escapejs }}')"
                                                data-client-name="{{ shipment.client_name }}"
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                title="Upload Compliance">
                                                <i class="fas fa-shield-alt mr-1"></i> Compliance
                                            </button>
                                            {% endif %}
                                        </div>

                                        <!-- Comment Input (mobile card) -->
                                        <div class="mt-3">
                                            <label class="block text-gray-600 font-medium mb-1 text-xs">Comment</label>
                                            <input type="text"
                                                class="form-control form-control-sm group-comment-input w-full px-3 py-2 border border-gray-300 rounded-lg text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                                data-group-id="{{ fallback_group_id }}"
                                                value="{{ shipment.comment|default:'' }}" placeholder="Add comment..."
                                                onchange="updateGroupComment(this)" onblur="updateGroupComment(this)"
                                                title="Comment for this inspection group">
                                        </div>
                                    </div>
                                </div>

                                <!-- Expandable Details (Hidden by default) -->
                                <div class="group-details border-t border-gray-200 bg-gray-50 p-4">
                                    <h4 class="font-semibold text-gray-800 mb-3">Inspection Details</h4>
                                    <div class="space-y-3 text-sm">
                                        <!-- Email Section -->
                                        <div>
                                            <label class="block text-gray-600 font-medium mb-1">Email</label>
                                            <div class="space-y-1">
                                                {% if shipment.client_emails %}
                                                {% for item in shipment.client_emails %}
                                                <div class="bg-white p-2 rounded border">
                                                    <span class="text-xs"
                                                        style="display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%;"
                                                        title="{{ item.email }}">{{ item.email }}</span>
                                                </div>
                                                {% endfor %}
                                                {% else %}
                                                <span class="text-gray-400 text-xs">No emails</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Additional Email Section (Mobile Input) -->
                                        <div class="mt-4">
                                            <label class="block text-gray-600 font-medium mb-2">Additional Email</label>
                                            <div class="additional-emails-container"
                                                data-group-id="{{ fallback_group_id }}"
                                                data-initial-emails="{{ shipment.additional_email|default:'' }}">
                                                <div class="email-inputs space-y-2" style="width: 100%;">
                                                    <div class="email-input-row" style="width: 100%;">
                                                        <input type="email"
                                                            class="group-additional-email-input border border-gray-300 rounded px-3 py-2"
                                                            value="" placeholder="email@example.com"
                                                            onchange="updateGroupAdditionalEmails(this)"
                                                            onblur="updateGroupAdditionalEmails(this)"
                                                            style="width: 100%; min-height: 44px; font-size: 16px; box-sizing: border-box;"
                                                            title="Enter additional email address">
                                                    </div>
                                                </div>
                                                <button type="button" onclick="addEmailInput(this)"
                                                    class="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium"
                                                    style="padding: 8px 0; text-decoration: underline; background: none; border: none; cursor: pointer; min-height: 44px;">
                                                    + Add Email
                                                </button>
                                            </div>
                                        </div>

                                        <!-- Other Details -->
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-gray-600 font-medium mb-1">Approved</label>
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                                    {% if shipment.approved %}Yes{% else %}No{% endif %}
                                                </span>
                                            </div>
                                            <div>
                                                <label class="block text-gray-600 font-medium mb-1">Sent Status</label>
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                                    {% if shipment.sent_date %}Sent{% else %}Not Sent{% endif %}
                                                </span>
                                            </div>
                                            {% if shipment.km_traveled %}
                                            <div>
                                                <label class="block text-gray-600 font-medium mb-1">Distance</label>
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                                    {{ shipment.km_traveled }} km
                                                </span>
                                            </div>
                                            {% endif %}
                                            {% if shipment.hours %}
                                            <div>
                                                <label class="block text-gray-600 font-medium mb-1">Hours Worked</label>
                                                <span class="text-xs bg-gray-100 px-2 py-1 rounded">
                                                    {{ shipment.hours }} hrs
                                                </span>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- Bought Sample Input -->
                                        <div class="mt-4">
                                            <label class="block text-gray-600 font-medium mb-2">Bought Sample</label>
                                            <div class="flex items-center space-x-2">
                                                <input type="number"
                                                    class="bought-sample-input flex-1 text-xs border border-gray-300 rounded px-2 py-1"
                                                    data-group-id="{{ fallback_group_id }}"
                                                    value="{{ shipment.bought_sample|default:'' }}" placeholder="0.00"
                                                    step="0.01" min="0" onchange="updateGroupBoughtSample(this)"
                                                    onblur="updateGroupBoughtSample(this)"
                                                    title="Enter bought sample amount in Rands">
                                                <span class="text-xs text-gray-500">R</span>
                                            </div>
                                        </div>

                                        <!-- Individual Inspection Details -->
                                        {% if shipment.products %}
                                        <div class="mt-6">
                                            <h5 class="font-semibold text-gray-800 mb-3">Individual Inspections</h5>
                                            <div class="space-y-3">
                                                {% for product in shipment.products %}
                                                <div
                                                    class="bg-white border border-gray-200 rounded-lg p-4 {% if product.is_complete %}bg-green-50 border-green-200{% endif %}">
                                                    <!-- Basic Info -->
                                                    <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                                                        <div>
                                                            <span class="text-gray-500">ID:</span>
                                                            <span class="font-medium">{{ product.remote_id|default:"-" }}</span>
                                                        </div>
                                                        <div>
                                                            <span class="text-gray-500">Commodity:</span>
                                                            <span class="font-medium">{{ product.commodity|default:"-" }}</span>
                                                        </div>
                                                        <div>
                                                            <span class="text-gray-500">Status:</span>
                                                            {% if product.is_direction_present_for_this_inspection %}
                                                            <span class="text-red-600 font-medium">Non-Compliant</span>
                                                            {% else %}
                                                            <span class="text-green-600 font-medium">Compliant</span>
                                                            {% endif %}
                                                        </div>
                                                        <div>
                                                            <span class="text-gray-500">Sample:</span>
                                                            {% if product.is_sample_taken %}
                                                            <span class="text-green-600 font-medium">‚úì Taken</span>
                                                            {% else %}
                                                            <span class="text-gray-500">Not Taken</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>

                                                    <!-- Product Name Input -->
                                                    <div class="mb-3">
                                                        <label
                                                            class="block text-gray-600 font-medium mb-1 text-xs">Product
                                                            Name</label>
                                                        <input type="text"
                                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1"
                                                            data-inspection-id="{{ product.remote_id }}"
                                                            value="{{ product.product_name|default:'' }}"
                                                            placeholder="Enter product name"
                                                            onchange="updateProductName(this)"
                                                            onblur="updateProductName(this)">
                                                    </div>

                                                    <!-- Product Class Dropdown -->
                                                    <div class="mb-3">
                                                        <label
                                                            class="block text-gray-600 font-medium mb-1 text-xs">Product
                                                            Class</label>
                                                        <select
                                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1 product-class-select"
                                                            data-inspection-id="{{ product.remote_id }}"
                                                            data-commodity="{{ product.commodity|default:''|lower }}"
                                                            data-current-class="{{ product.product_class }}"
                                                            onchange="updateProductClass(this)">
                                                            <option value="">Select Class</option>
                                                        </select>
                                                    </div>

                                                    <!-- Test Checkboxes -->
                                                    <div class="mb-3">
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <label class="flex items-center text-xs cursor-pointer">
                                                                <input type="checkbox"
                                                                    class="test-checkbox mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2"
                                                                    data-inspection-id="{{ product.remote_id }}"
                                                                    data-test-type="fat" {% if product.fat %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %}
                                                                    onchange="updateTestResult(this)">
                                                                Fat
                                                            </label>
                                                            <label class="flex items-center text-xs cursor-pointer">
                                                                <input type="checkbox"
                                                                    class="test-checkbox mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2"
                                                                    data-inspection-id="{{ product.remote_id }}"
                                                                    data-test-type="protein" {% if product.protein %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %}
                                                                    onchange="updateTestResult(this)">
                                                                Protein
                                                            </label>
                                                            <label class="flex items-center text-xs cursor-pointer">
                                                                <input type="checkbox"
                                                                    class="test-checkbox mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2"
                                                                    data-inspection-id="{{ product.remote_id }}"
                                                                    data-test-type="calcium" {% if product.calcium %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %}
                                                                    onchange="updateTestResult(this)">
                                                                Calcium
                                                            </label>
                                                            <label class="flex items-center text-xs cursor-pointer">
                                                                <input type="checkbox"
                                                                    class="test-checkbox mr-2 w-4 h-4 text-primary bg-gray-100 border-gray-300 rounded focus:ring-primary focus:ring-2"
                                                                    data-inspection-id="{{ product.remote_id }}"
                                                                    data-test-type="dna" {% if product.dna %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %}
                                                                    onchange="updateTestResult(this)">
                                                                DNA
                                                            </label>
                                                        </div>
                                                    </div>

                                                    <!-- Bought Sample Input -->
                                                    <div class="mb-3">
                                                        <label
                                                            class="block text-gray-600 font-medium mb-1 text-xs">Bought
                                                            Sample</label>
                                                        <div class="flex items-center space-x-2">
                                                            <input type="number"
                                                                class="bought-sample-input flex-1 text-xs border border-gray-300 rounded px-2 py-1"
                                                                data-inspection-id="{{ product.remote_id }}"
                                                                value="{{ product.bought_sample|default:'' }}"
                                                                placeholder="0.00" step="0.01" min="0"
                                                                onchange="updateBoughtSample(this)"
                                                                onblur="updateBoughtSample(this)" {% if not product.is_sample_taken %}disabled
                                                                style="opacity: 0.5; cursor: not-allowed;"
                                                                title="No sample taken - cannot enter bought sample" {% endif %}>
                                                            <span class="text-xs text-gray-500">R</span>
                                                        </div>
                                                    </div>

                                                    <!-- Lab Dropdown -->
                                                    <div class="mb-3">
                                                        <label
                                                            class="block text-gray-600 font-medium mb-1 text-xs">Lab</label>
                                                        <select
                                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1 lab-dropdown"
                                                            data-inspection-id="{{ product.remote_id }}" {% if not product.is_sample_taken %}disabled
                                                            style="opacity: 0.5; cursor: not-allowed;"
                                                            title="No sample taken - lab selection disabled" {% endif %}
                                                            onchange="updateLab(this)">
                                                            <option value="">Select Lab</option>
                                                            <option value="lab_b" {% if product.lab == 'lab_b' %}selected{% endif %}>Merieux NutriSciences</option>
                                                            <option value="lab_c" {% if product.lab == 'lab_c' %}selected{% endif %}>AGRI Food Laboratory (SGS)
                                                            </option>
                                                            <option value="lab_d" {% if product.lab == 'lab_d' %}selected{% endif %}>SANBI</option>
                                                            <option value="lab_e" {% if product.lab == 'lab_e' %}selected{% endif %}>SMT</option>
                                                            <option value="lab_f" {% if product.lab == 'lab_f' %}selected{% endif %}>ARC</option>
                                                            <option value="lab_a" {% if product.lab == 'lab_a' %}selected{% endif %}>Food Safety Laboratory</option>
                                                        </select>
                                                    </div>

                                                    <!-- Needs Retest Dropdown -->
                                                    <div class="mb-3">
                                                        <label
                                                            class="block text-gray-600 font-medium mb-1 text-xs">Retest</label>
                                                        <select
                                                            class="w-full text-xs border border-gray-300 rounded px-2 py-1 needs-retest-dropdown"
                                                            data-inspection-id="{{ product.remote_id }}" {% if not product.is_sample_taken %}disabled
                                                            style="opacity: 0.5; cursor: not-allowed;"
                                                            title="No sample taken - retest options disabled" {% endif %} onchange="updateNeedsRetest(this)">
                                                            <option value="">Select Option</option>
                                                            <option value="yes" {% if product.needs_retest == 'yes' %}selected{% endif %}>Yes</option>
                                                            <option value="no" {% if product.needs_retest == 'no' %}selected{% endif %}>No</option>
                                                        </select>
                                                    </div>

                                                    <!-- Upload Buttons -->
                                                    <div class="space-y-2">
                                                        {% if request.user.role == 'inspector' %}
                                                        <!-- Inspector: Only show Lab Form button -->
                                                        <div class="grid grid-cols-1 gap-2">
                                                            <button
                                                                class="bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200
                                                               {% if not product.is_sample_taken %}opacity-50 cursor-not-allowed{% endif %}"
                                                                {% if not product.is_sample_taken %}disabled title="No sample taken - lab form upload disabled"{% endif %}
                                                                onclick="{% if product.is_sample_taken %}uploadLabForm('{{ product.remote_id|escapejs }}'){% else %}alert('No sample taken - lab form upload disabled'){% endif %}">
                                                                <i class="fas fa-file-alt mr-1"></i> Lab Form
                                                            </button>
                                                        </div>
                                                        {% else %}
                                                        <!-- Non-Inspector: Show Lab, Retest, and Lab Form buttons -->
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <button
                                                                class="bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200
                                                               {% if not product.is_sample_taken %}opacity-50 cursor-not-allowed{% endif %}"
                                                                {% if not product.is_sample_taken %}disabled title="No sample taken - lab upload disabled"{% endif %}
                                                                onclick="{% if product.is_sample_taken %}uploadLabFile('{{ product.remote_id|escapejs }}', '{{ fallback_group_id|escapejs }}'){% else %}alert('No sample taken - lab upload disabled'){% endif %}">
                                                                <i class="fas fa-flask mr-1"></i> Lab
                                                            </button>
                                                            <button
                                                                class="bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200
                                                               {% if not product.is_sample_taken or product.needs_retest == 'no' or product.needs_retest == 'NO' %}opacity-50 cursor-not-allowed{% endif %}"
                                                                {% if not product.is_sample_taken or product.needs_retest == 'no' or product.needs_retest == 'NO' %}disabled
                                                                title="{% if not product.is_sample_taken %}No sample taken - retest upload disabled{% else %}Needs retest is 'No' - retest upload disabled{% endif %}"
                                                                {% endif %}
                                                                onclick="{% if product.is_sample_taken and product.needs_retest != 'no' and product.needs_retest != 'NO' %}uploadRetestFile('{{ product.remote_id|escapejs }}', '{{ fallback_group_id|escapejs }}'){% else %}alert('{% if not product.is_sample_taken %}No sample taken - retest upload disabled{% else %}Needs retest is No - retest upload disabled{% endif %}'){% endif %}">
                                                                <i class="fas fa-redo mr-1"></i> Retest
                                                            </button>
                                                        </div>
                                                        <div class="grid grid-cols-1 gap-2">
                                                            <button
                                                                class="bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-gray-500 transition-colors duration-200
                                                               {% if not product.is_sample_taken %}opacity-50 cursor-not-allowed{% endif %}"
                                                                {% if not product.is_sample_taken %}disabled
                                                                title="No sample taken - lab form generation disabled"
                                                                {% endif %}
                                                                onclick="{% if product.is_sample_taken %}generateLabForm('{{ product.remote_id|escapejs }}'){% else %}alert('No sample taken - lab form generation disabled'){% endif %}">
                                                                <i class="fas fa-file-alt mr-1"></i> Lab Form
                                                            </button>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                            {% endfor %}
                        </div>

                        <!-- Desktop Table Layout (Hidden on mobile) -->
                        <div class="hidden lg:block overflow-x-auto shadow-md rounded-lg">
                            <table id="shipmentsTable" class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase"
                                            style="width: 40%;">Facility</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 uppercase"
                                            style="width: 50px;">Files</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 uppercase"
                                            style="width: 100px;">Date</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 uppercase"
                                            style="width: 80px;">Approved</th>
                                        <th class="px-2 py-2 text-center text-xs font-medium text-gray-700 uppercase"
                                            style="width: 80px;">Sent</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    {% for shipment in shipments %}
                                    {% with client_slug=shipment.client_name|sanitize_group_id %}
                                    {% with date_str=shipment.date_of_inspection|date:"Ymd" %}
                                    {% with fallback_group_id=client_slug|add:"_"|add:date_str %}
                                    <tr class="group-row shipment-row bg-white hover:bg-gray-50 border-b border-gray-200 cursor-pointer"
                                        data-group-id="{{ fallback_group_id }}"
                                        data-client-name="{{ shipment.client_name }}"
                                        data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}" {% if shipment.sent_date %}data-sent-timestamp="{{ shipment.sent_date|date:'c' }}" {% endif %} onclick="toggleGroup(event, '{{ fallback_group_id|escapejs }}')">
                                        <td class="px-3 py-2">
                                            <span class="font-semibold text-primary hover:text-primary-dark text-sm">{{ shipment.client_name|default:"-" }}</span>
                                            <span style="font-size: 10px; color: #6b7280; margin-left: 8px;">{{ shipment.inspector_name|default:"" }}</span>
                                        </td>
                                        <td class="px-2 py-2 text-center">
                                            <button
                                                style="padding: 3px 6px; background: #007890; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;"
                                                onclick="event.stopPropagation(); viewFilesForGroup('{{ fallback_group_id|escapejs }}', '{{ shipment.client_name|escapejs }}', '{{ shipment.date_of_inspection|date:"Y-m-d" }}')" title="View All Files"><i
                                                    class="fas fa-folder-open"></i></button>
                                        </td>
                                        <td class="px-2 py-2 text-xs text-center text-gray-600">{{ shipment.date_of_inspection|date:"d/m/Y"|default:"-" }}</td>
                                        <td class="px-2 py-2 text-center">
                                            <select class="approved-dropdown"
                                                style="width: 72px; display: block; margin: 0 auto;"
                                                data-group-id="{{ fallback_group_id }}"
                                                onchange="event.stopPropagation(); updateGroupApproved(this)">
                                                <option value="PENDING" {% if shipment.approved_status == 'PENDING' or not shipment.approved_status %}selected{% endif %}>Pending</option>
                                                <option value="APPROVED" {% if shipment.approved_status == 'APPROVED' %}selected{% endif %}>Approved</option>
                                            </select>
                                        </td>
                                        <td class="px-2 py-2 text-center">
                                            <select class="sent-status-dropdown"
                                                style="width: 72px; display: block; margin: 0 auto;"
                                                data-group-id="{{ fallback_group_id }}"
                                                onchange="event.stopPropagation(); updateSentStatus(this)">
                                                <option value="NO" {% if not shipment.is_sent %}selected{% endif %}>No
                                                </option>
                                                <option value="YES" {% if shipment.is_sent %}selected{% endif %}>Yes
                                                </option>
                                            </select>
                                        </td>
                                    </tr>
                                    <!-- Expandable detail rows - Horizontal Block Layout -->
                                    <tr class="detail-row" id="detail-{{ fallback_group_id }}" style="display: none;">
                                        <td colspan="5" class="detail-cell" style="padding: 0;">
                                            <div class="detail-content" style="background: #f8fafc;">
                                                <!-- Main Layout: Facility info on left, Products list on right -->
                                                <div style="display: flex; gap: 12px; padding: 8px; align-items: flex-start;">

                                                    <!-- Facility Info (shown once) -->
                                                    <div style="flex: 0 0 180px; background: white; border-radius: 8px; padding: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); border-left: 3px solid #007890;">
                                                        <div style="font-size: 11px; color: #007890; font-weight: 600; margin-bottom: 4px;">Facility</div>
                                                        <div style="font-size: 11px; color: #374151; font-weight: 500;">{{ shipment.client_name|truncatechars:22 }}</div>
                                                        <div style="font-size: 9px; color: #6b7280; margin-bottom: 4px;">{{ shipment.internal_account_code|default:"-" }}</div>
                                                        <div style="font-size: 8px; color: #3b82f6; margin-bottom: 6px; word-break: break-all;">
                                                            {% if shipment.client_emails %}{% for e in shipment.client_emails %}{{ e.email }}{% if not forloop.last %}, {% endif %}{% endfor %}{% else %}-{% endif %}
                                                        </div>
                                                        <div style="display: flex; flex-direction: column; gap: 4px; border-top: 1px solid #e5e7eb; padding-top: 6px;">
                                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                                <span style="font-size: 9px; color: #374151; font-weight: 500; min-width: 40px;">Km:</span>
                                                                <input type="number" style="width: 65px; font-size: 9px; padding: 3px; border: 1px solid #e5e7eb; border-radius: 3px;"
                                                                    data-group-id="{{ fallback_group_id }}"
                                                                    value="{{ shipment.km_traveled|default:'' }}"
                                                                    placeholder="0"
                                                                    onchange="updateGroupKmTraveled(this)"
                                                                    onclick="event.stopPropagation()">
                                                            </div>
                                                            <div style="display: flex; align-items: center; gap: 4px;">
                                                                <span style="font-size: 9px; color: #374151; font-weight: 500; min-width: 40px;">Hours:</span>
                                                                <input type="number" style="width: 65px; font-size: 9px; padding: 3px; border: 1px solid #e5e7eb; border-radius: 3px;"
                                                                    data-group-id="{{ fallback_group_id }}"
                                                                    value="{{ shipment.hours|default:'' }}"
                                                                    placeholder="0"
                                                                    onchange="updateGroupHours(this)"
                                                                    onclick="event.stopPropagation()">
                                                            </div>
                                                        </div>
                                                        {% if shipment.products %}
                                                        <div style="display: flex; gap: 4px; margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 6px;">
                                                            <button data-upload-btn="rfi-{{ shipment.products.0.id }}" style="flex: 1; padding: 4px 6px; background: {% if shipment.has_rfi %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;" onclick="event.stopPropagation(); uploadRfiForInspection('{{ shipment.products.0.id }}', '{{ fallback_group_id|escapejs }}')">RFI</button>
                                                            {% if request.user.role != 'inspector' %}
                                                            <button data-upload-btn="invoice-{{ shipment.products.0.id }}" style="flex: 1; padding: 4px 6px; background: {% if shipment.has_invoice %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 8px;" onclick="event.stopPropagation(); uploadInvoiceForInspection('{{ shipment.products.0.id }}', '{{ fallback_group_id|escapejs }}')">Invoice</button>
                                                            {% endif %}
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                    <!-- Products List (each inspection in the group) -->
                                                    <div style="flex: 1; display: flex; flex-direction: column; gap: 6px; overflow-x: auto;">
                                                        {% if shipment.products %}
                                                        {% for product in shipment.products %}
                                                        <!-- Single Inspection Row -->
                                                        <div style="display: flex; gap: 6px; flex-wrap: nowrap; align-items: stretch; background: white; border-radius: 6px; padding: 6px; box-shadow: 0 1px 2px rgba(0,0,0,0.04);">
                                                            <!-- Product Info + Test Flags -->
                                                            <div style="flex: 0 0 180px; background: {% if product.is_direction_present_for_this_inspection %}#fef2f2{% else %}#f0fdf4{% endif %}; border-radius: 4px; border-left: 3px solid {% if product.is_direction_present_for_this_inspection %}#ef4444{% else %}#22c55e{% endif %}; padding: 6px;">
                                                                <div style="font-size: 9px; color: #6b7280;">Commodity: <span style="font-weight: 600; color: #374151;">{{ product.commodity|default:"-"|truncatechars:12 }}</span></div>
                                                                <div style="font-size: 9px; color: #6b7280; margin-bottom: 4px;">Product: <span style="font-weight: 600; color: #374151;">{{ product.product_name|default:"-"|truncatechars:16 }}</span></div>
                                                                <div style="display: flex; flex-wrap: wrap; gap: 2px;">
                                                                    {% if product.is_sample_taken %}<span style="font-size: 7px; padding: 2px 4px; background: #3b82f6; color: white; border-radius: 2px;">Sampled</span>{% endif %}
                                                                    {% if product.is_direction_present_for_this_inspection %}<span style="font-size: 7px; padding: 2px 4px; background: #ef4444; color: white; border-radius: 2px;">Non-Compliant</span>{% else %}<span style="font-size: 7px; padding: 2px 4px; background: #22c55e; color: white; border-radius: 2px;">Compliant</span>{% endif %}
                                                                </div>
                                                            </div>
                                                            <!-- DNA/Fat/Protein/Calcium -->
                                                            <div style="flex: 0 0 135px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; padding: 8px; background: #f9fafb; border-radius: 4px;">
                                                                <div><span style="color: #6b7280;">DNA:</span> <span style="color: {% if product.dna %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 500;">{{ product.dna|yesno:"Y,N" }}</span></div>
                                                                <div><span style="color: #6b7280;">Fat:</span> <span style="color: {% if product.fat %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 500;">{{ product.fat|yesno:"Y,N" }}</span></div>
                                                                <div><span style="color: #6b7280;">Pro:</span> <span style="color: {% if product.protein %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 500;">{{ product.protein|yesno:"Y,N" }}</span></div>
                                                                <div><span style="color: #6b7280;">Cal:</span> <span style="color: {% if product.calcium %}#22c55e{% else %}#ef4444{% endif %}; font-weight: 500;">{{ product.calcium|yesno:"Y,N" }}</span></div>
                                                            </div>
                                                            <!-- Upload Buttons -->
                                                            <div style="flex: 1; display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                                                                <button data-upload-btn="compliance-{{ product.id }}" style="padding: 6px 14px; background: {% if shipment.has_compliance %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadComplianceForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">Compliance</button>
                                                                <button data-upload-btn="composition-{{ product.id }}" style="padding: 6px 14px; background: {% if product.composition_uploaded %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadCompositionForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">Composition</button>
                                                                <button data-upload-btn="lab-{{ product.id }}" style="padding: 6px 14px; background: {% if product.coa_uploaded %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadLabForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">COA/Lab</button>
                                                                <button data-upload-btn="retest-{{ product.id }}" style="padding: 6px 14px; background: {% if product.retest_uploaded %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadRetestForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">Retest</button>
                                                                <button data-upload-btn="occurrence-{{ product.id }}" style="padding: 6px 14px; background: {% if product.occurrence_uploaded %}#22c55e{% else %}#6c757d{% endif %}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadOccurrenceForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">Occurrence</button>
                                                                <button data-upload-btn="other-{{ product.id }}" style="padding: 6px 14px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 9px;" onclick="event.stopPropagation(); uploadOtherForInspection('{{ product.id }}', '{{ fallback_group_id|escapejs }}')">Other</button>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                        {% else %}
                                                        <div style="flex: 1; background: white; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); padding: 8px; display: flex; align-items: center; justify-content: center;">
                                                            <span style="color: #9ca3af; font-size: 11px;">No inspection records</span>
                                                        </div>
                                                        {% endif %}
                                                    </div>

                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endwith %}
                                    {% endwith %}
                                    {% endwith %}
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="empty-message">No inspections found. Try adjusting your
                                            filters or sync inspections.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        {% if paginator and not show_all %}
                        <div class="pagination">
                            {% if page_obj.has_previous %}
                            <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                class="btn btn-sm btn-secondary">First</a>
                            <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                class="btn btn-sm btn-secondary">Previous</a>
                            {% endif %}

                            <span class="page-info">
                                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                            </span>

                            {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                class="btn btn-sm btn-secondary">Next</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"
                                class="btn btn-sm btn-secondary">Last</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Files Popup Modal -->
            <div id="filesModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <i class="fas fa-folder-open"></i>
                            <span id="modalTitle">Inspection Files</span>
                        </div>
                        <div class="modal-actions">
                            <button id="downloadAllBtn" class="btn btn-sm btn-download" onclick="downloadAllFiles()"
                                title="Download All Files as ZIP" style="display: none;">
                                <i class="fas fa-download"></i> Download All
                            </button>
                            <button class="modal-close" onclick="closeFilesPopup()" title="Close">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-body">
                        <div id="filesLoading" class="loading-state">
                            <div class="loading-spinner"></div>
                            <span>Loading files...</span>
                        </div>
                        <div id="filesContent" style="display: none;">
                            <div id="filesList"></div>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                /* Modal styles matching shipment list page */
                .modal {
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    animation: modalFadeIn 0.3s ease-out;
                }

                @keyframes modalFadeIn {
                    from {
                        opacity: 0;
                    }

                    to {
                        opacity: 1;
                    }
                }

                @keyframes modalSlideIn {
                    from {
                        transform: translateY(-20px) scale(0.98);
                        opacity: 0;
                    }

                    to {
                        transform: translateY(0) scale(1);
                        opacity: 1;
                    }
                }

                .modal-content {
                    background: var(--card-bg);
                    margin: 2% auto;
                    padding: 0;
                    border-radius: var(--radius);
                    width: 95%;
                    max-width: 1000px;
                    max-height: 90vh;
                    overflow: hidden;
                    box-shadow: var(--shadow-lg);
                    animation: modalSlideIn 0.3s ease-out;
                    border: 1px solid var(--border);
                }

                .modal-header {
                    padding: 16px 20px;
                    background: var(--card-bg);
                    border-bottom: 1px solid var(--border);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .modal-actions {
                    display: flex;
                    gap: 10px;
                    align-items: center;
                }

                .btn-download {
                    background: #10b981;
                    color: white;
                    border: none;
                    padding: 8px 12px;
                    border-radius: 4px;
                    font-size: 12px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    gap: 4px;
                }

                .btn-download:hover {
                    background: #059669;
                    transform: translateY(-1px);
                    box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
                }

                .btn-download:disabled {
                    background: #6b7280;
                    cursor: not-allowed;
                    transform: none;
                    box-shadow: none;
                }

                .modal-title {
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: var(--text);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .modal-title i {
                    color: var(--primary);
                }

                .modal-close {
                    background: none;
                    border: none;
                    font-size: 18px;
                    cursor: pointer;
                    padding: 8px;
                    border-radius: 4px;
                    color: var(--text-light);
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    width: 32px;
                    height: 32px;
                }

                .modal-close:hover {
                    background: var(--primary-light);
                    color: var(--primary);
                }

                .modal-body {
                    padding: 16px 20px;
                    max-height: 75vh;
                    overflow-y: auto;
                    background: var(--background);
                }

                .loading-state {
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    padding: 40px 20px;
                    color: var(--text-light);
                }

                .loading-spinner {
                    border: 3px solid var(--border);
                    border-top: 3px solid var(--primary);
                    border-radius: 50%;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin-bottom: 16px;
                }

                @keyframes spin {
                    0% {
                        transform: rotate(0deg);
                    }

                    100% {
                        transform: rotate(360deg);
                    }
                }

                .file-category {
                    background: var(--card-bg);
                    border-radius: var(--radius);
                    box-shadow: var(--shadow-lg);
                    margin-bottom: var(--spacing);
                    border: 1px solid var(--border);
                    overflow: hidden;
                }

                .file-category-header {
                    padding: 16px;
                    border-bottom: 1px solid var(--border);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    background: var(--card-bg);
                }

                .file-category-header .category-title {
                    font-size: 1rem;
                    font-weight: 600;
                    color: var(--text);
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .file-category-header .category-title i {
                    color: var(--primary);
                    font-size: 1rem;
                }

                .file-category-header .file-count {
                    background: var(--primary);
                    color: white;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 0.75rem;
                    font-weight: 500;
                }

                .file-list {
                    padding: 16px;
                    background: var(--card-bg);
                }

                .file-item {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 12px;
                    margin-bottom: 8px;
                    background: var(--card-bg);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    transition: all 0.2s ease;
                    font-size: 0.875rem;
                }

                .file-item:hover {
                    background: var(--primary-light);
                    border-color: var(--primary);
                }

                .file-item:last-child {
                    margin-bottom: 0;
                }

                .file-info {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    flex: 1;
                }

                .file-icon {
                    color: var(--primary);
                    width: 20px;
                    font-size: 16px;
                }

                .file-details {
                    flex: 1;
                }

                .file-name {
                    font-weight: 600;
                    color: var(--text);
                    margin-bottom: 2px;
                    word-break: break-word;
                }

                .file-size {
                    color: var(--text-light);
                    font-size: 11px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                }

                .file-actions {
                    display: flex;
                    gap: 6px;
                }

                .btn-file {
                    padding: 6px 10px;
                    font-size: 12px;
                    border-radius: 6px;
                    border: none;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    text-decoration: none;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    min-width: 36px;
                    height: 32px;
                }

                .btn-file:hover {
                    transform: translateY(-1px);
                }

                .btn-file.btn-primary {
                    background: linear-gradient(135deg, #007890, #005a6b);
                    color: white;
                    box-shadow: 0 2px 6px rgba(0, 120, 144, 0.3);
                }

                .btn-file.btn-primary:hover {
                    box-shadow: 0 4px 12px rgba(0, 120, 144, 0.4);
                }

                .btn-file.btn-secondary {
                    background: linear-gradient(135deg, #6b7280, #4b5563);
                    color: white;
                    box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
                }

                .btn-file.btn-secondary:hover {
                    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
                }

                .btn-file.btn-warning {
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                    box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
                }

                .btn-file.btn-warning:hover {
                    box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
                }

                .btn-file.btn-info {
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    color: white;
                    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
                }

                .btn-file.btn-info:hover {
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
                }

                .btn-file.btn-danger {
                    background: linear-gradient(135deg, #ef4444, #dc2626);
                    color: white;
                    box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
                }

                .btn-file.btn-danger:hover {
                    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
                }

                .empty-category {
                    padding: 24px;
                    text-align: center;
                    color: var(--text-light);
                    font-style: italic;
                    background: #f8f9fa;
                    border-radius: 8px;
                    margin: 12px;
                }

                .empty-category::before {
                    content: "üìÇ";
                    display: block;
                    font-size: 2rem;
                    margin-bottom: 8px;
                    opacity: 0.5;
                }
            </style>

            <!-- Load sent status functionality from external file -->
            <script src="{% static 'js/sent_status.js' %}?v=20260112-cache-bust"></script>
            <!-- Load clean upload functions -->
            <script src="{% static 'js/upload_functions.js'%}?v=20260110-V3"></script>
            <!-- Load bought sample functionality -->
            <script src="{% static 'js/bought_sample.js' %}?v=20251003-FINAL-FIX"></script>
            <!-- Load KM and Hours functions fix (before main JS to ensure functions are available) -->
            <script src="{% static 'js/km_hours_fix.js' %}?v=20251030-NO-X-BUTTON"></script>
            <!-- Load current rendered JavaScript functions -->
            <script src="{% static 'js/current_rendered_js.js' %}?v=20260110-V3"></script>
            <script>
                // CACHE BUST: 2025-10-28 - Email functions fix - MUST SEE THIS
                console.log('üöÄ SCRIPT LOADED - Cache busted at:', new Date().toISOString());

                // Set global CSRF token for upload functions
                try {
                    window.csrfToken = '{{ csrf_token|escapejs }}';
                    console.log('CSRF token set globally for upload functions');
                } catch (error) {
                    console.error('Error setting CSRF token:', error);
                }

                // DEBOUNCE HELPER FUNCTION - Must be defined early
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // EMAIL MANAGEMENT FUNCTIONS - lightweight stubs
                // The full, robust implementations are defined later in this file
                // to avoid duplicate definitions and to keep logic centralized.
                (function () {
                    function stub(name) {
                        return function () {
                            console.warn('[EMAIL-STUB]', name, 'called before real implementation is loaded.');
                        };
                    }

                    window.updateGroupAdditionalEmails = window.updateGroupAdditionalEmails || stub('updateGroupAdditionalEmails');
                    window.addEmailInput = window.addEmailInput || stub('addEmailInput');
                    window.removeEmailInput = window.removeEmailInput || stub('removeEmailInput');

                    // Basic safe initializer for existing inputs so inline handlers don't fail
                    document.addEventListener('DOMContentLoaded', function () {
                        // === DEBUG: Screen Size and Detail Table Styling ===
                        console.log('=== DETAIL TABLE DEBUG INFO ===');
                        console.log('Screen Width:', window.innerWidth + 'px');
                        console.log('Screen Height:', window.innerHeight + 'px');
                        console.log('Device Pixel Ratio:', window.devicePixelRatio);

                        // Log detail table styling
                        const detailTable = document.querySelector('.detail-table');
                        if (detailTable) {
                            const computedStyle = window.getComputedStyle(detailTable);
                            console.log('Detail Table Width:', detailTable.offsetWidth + 'px');
                            console.log('Detail Table Display:', computedStyle.display);
                            console.log('Detail Table Table Layout:', computedStyle.tableLayout);
                            console.log('Detail Table Min Width:', computedStyle.minWidth);
                        }

                        // Log detail table wrapper styling
                        const detailWrapper = document.querySelector('.detail-table-wrapper');
                        if (detailWrapper) {
                            const wrapperStyle = window.getComputedStyle(detailWrapper);
                            console.log('Wrapper Width:', detailWrapper.offsetWidth + 'px');
                            console.log('Wrapper Overflow-X:', wrapperStyle.overflowX);
                            console.log('Wrapper Max Width:', wrapperStyle.maxWidth);
                        }

                        // Log breakpoint info
                        if (window.innerWidth <= 640) {
                            console.log('Breakpoint: MOBILE (‚â§640px)');
                        } else if (window.innerWidth <= 1024) {
                            console.log('Breakpoint: TABLET (641-1024px)');
                        } else {
                            console.log('Breakpoint: DESKTOP (‚â•1025px)');
                        }
                        console.log('=== END DEBUG INFO ===');

                        // Listen for window resize
                        window.addEventListener('resize', function () {
                            console.log('Window Resized - New Width:', window.innerWidth + 'px');
                        });
                        // === END DEBUG ===

                        try {
                            const containers = document.querySelectorAll('.additional-emails-container');
                            containers.forEach(function (container) {
                                const emailInputs = container.querySelectorAll('.group-additional-email-input');
                                emailInputs.forEach(function (input) {
                                    // Ensure onchange/onblur attributes won't throw if functions not ready
                                    input.addEventListener('change', function () {
                                        if (typeof window.updateGroupAdditionalEmails === 'function') {
                                            window.updateGroupAdditionalEmails(this);
                                        }
                                    });
                                    input.addEventListener('blur', function () {
                                        if (typeof window.updateGroupAdditionalEmails === 'function') {
                                            window.updateGroupAdditionalEmails(this);
                                        }
                                    });
                                });
                            });
                        } catch (e) {
                            console.warn('[EMAIL-STUB] initialization error', e);
                        }
                    });
                })();

                // CLASS DROPDOWN FUNCTION - Must be defined early to avoid syntax errors
                window.filterClassOptions = function (dropdown) {
                    console.log('[CLASS] Populating dropdown - function called');
                    console.log('[CLASS] Dropdown element:', dropdown);
                    console.log('[CLASS] Dropdown classes:', dropdown.className);
                    const currentValue = dropdown.getAttribute('data-current-class') || dropdown.value;
                    console.log('[CLASS] Current value:', currentValue);

                    const allClassOptions = ['Raw species sausage / wors', 'Extra Lean Mince', 'Lean Mince', 'Regular Mince', 'Raw Flavoured Ground Meat', 'Raw Flavoured Ground Meat & Offal', 'Raw Flavoured mixed species Ground Meat', 'Raw Flavoured mixed species Ground Meat & Offal', 'Raw Boerewors', 'Raw mixed species sausage / wors', 'Ground Burger / Ground patty = Extra Lean', 'Ground Burger / Ground patty = Lean', 'Ground Burger / Ground patty = Regular', 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean', 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean', 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular', 'Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel', 'Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger', 'Raw Banger / Griller', 'Raw Bratwurst / Sizzler', 'Whole Muscle, uncured and heat / partial heat treated products', 'Whole muscle, uncured, no or partial heat treated and air dried products', 'Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)', 'Whole muscle, dry cured, no or partial heat treated products', 'Whole muscle, cured and no or partial heat treated products', 'Whole muscle, cured, no or partial heat treated and air dried products', 'Whole muscle, dry cured, no or partial heat treated and dried products', 'Comminuted, cured and heat treated products', 'Comminuted, uncured, no or partial heat treated and dried products', 'Comminuted, cured, no or partial heat treated, dried and fermented products', 'Comminuted, uncured and heat treated products', 'Reformed, uncured and no or partial heat treated products', 'Reformed, cured, heat treated products from single species', 'Reformed, cured, heat treated products from mixed species', 'Reformed, cured and no or partial heat treated products', 'Liver spreads, p√¢t√© and terrines', 'Products in aspic: Brawn', 'Product in aspic: Souse, Other products containing cured meat pieces in aspic', 'Products made from blood', 'Coated Processed Meat Products', 'Unspecified processed meat products'];

                    dropdown.innerHTML = '';
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select Class...';
                    dropdown.appendChild(placeholder);

                    allClassOptions.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        if (optionText === currentValue) option.selected = true;
                        dropdown.appendChild(option);
                    });

                    if (currentValue && allClassOptions.includes(currentValue)) {
                        dropdown.value = currentValue;
                    }

                    // Apply border styling based on current value
                    console.log('[BORDER DEBUG] Dropdown value:', dropdown.value);
                    console.log('[BORDER DEBUG] Is empty?', !dropdown.value || dropdown.value === '');
                    console.log('[BORDER DEBUG] Is placeholder?', dropdown.value === 'Select Class...');

                    if (dropdown.value && dropdown.value !== '' && dropdown.value !== 'Select Class...') {
                        dropdown.classList.add('has-value');
                        console.log('[BORDER DEBUG] Added has-value class - should be GREEN');
                    } else {
                        dropdown.classList.remove('has-value');
                        console.log('[BORDER DEBUG] Removed has-value class - should be RED');
                    }

                    console.log('[CLASS] Dropdown now has', dropdown.options.length, 'options');
                    console.log('[CLASS] First few options:', Array.from(dropdown.options).slice(0, 5).map(opt => opt.textContent));
                    console.log('[CLASS] Dropdown value after population:', dropdown.value);
                };

                // Function to enforce mobile layout
                function enforceMobileLayout() {
                    if (window.innerWidth <= 1024) {
                        const table = document.getElementById('shipmentsTable');
                        if (table) {
                            const rows = table.querySelectorAll('tbody tr');
                            rows.forEach(row => {
                                if (!row.classList.contains('detail-row')) {
                                    row.style.display = 'block';
                                    const cells = row.querySelectorAll('td');
                                    cells.forEach(cell => {
                                        cell.style.display = 'block';
                                    });
                                }
                            });
                        }
                    }
                }

                // Initialize class dropdowns when DOM is ready
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('[CLASS] Initializing class dropdowns...');
                    const dropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[CLASS] Found', dropdowns.length, 'dropdowns');
                    dropdowns.forEach(window.filterClassOptions);

                    // Observe the table for dynamic changes and re-apply filters
                    const table = document.getElementById('shipmentsTable');
                    if (table && 'MutationObserver' in window) {
                        console.log('[CLASS] Setting up MutationObserver...');
                        const observer = new MutationObserver(() => {
                            console.log('[CLASS] Table changed, re-filtering dropdowns...');
                            document.querySelectorAll('select.product-class-select').forEach(window.filterClassOptions);
                        });
                        observer.observe(table, { childList: true, subtree: true });
                    }

                    // Fallback: periodic re-filter shortly after load in case of late rendering
                    setTimeout(() => {
                        console.log('[CLASS] Fallback timeout - re-filtering dropdowns...');
                        const fallbackDropdowns = document.querySelectorAll('select.product-class-select');
                        console.log('[CLASS] Fallback found', fallbackDropdowns.length, 'dropdowns');
                        fallbackDropdowns.forEach(window.filterClassOptions);
                    }, 500);

                    // Re-populate after expand (for dynamically shown rows)
                    setTimeout(function () {
                        console.log('[CLASS] Re-checking dropdowns after delay...');
                        document.querySelectorAll('select.product-class-select').forEach(window.filterClassOptions);
                    }, 1000);
                });

                // Simple KM and Hours update functions - defined early
                window.updateGroupKmTraveled = function (input) {
                    const groupId = input.getAttribute('data-group-id');
                    const kmValue = input.value;

                    console.log('[STORAGE] Updating Group KM - Group ID:', groupId, 'Value:', kmValue);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('km_traveled', kmValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-km-traveled/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] KM saved successfully:', data);
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving KM:', data.error);
                                alert('Error updating KM: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving KM:', error);
                            alert('Error updating KM: ' + error.message);
                        });
                };

                window.updateGroupHours = function (input) {
                    const groupId = input.getAttribute('data-group-id');
                    const hoursValue = input.value;

                    console.log('[STORAGE] Updating Group Hours - Group ID:', groupId, 'Value:', hoursValue);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('hours', hoursValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-hours/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Hours saved successfully:', data);
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving Hours:', data.error);
                                alert('Error updating Hours: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving Hours:', error);
                            alert('Error updating Hours: ' + error.message);
                        });
                };

                // Bought Sample function is now loaded from bought_sample.js

                // Group Bought Sample update function
                window.updateGroupBoughtSample = function (input) {
                    const groupId = input.getAttribute('data-group-id');
                    const boughtSampleValue = input.value;

                    console.log('[STORAGE] Updating Group Bought Sample - Group ID:', groupId, 'Value:', boughtSampleValue);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('bought_sample', boughtSampleValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-bought-sample/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Bought Sample saved successfully:', data);
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving Bought Sample:', data.error);
                                alert('Error updating Bought Sample: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving Bought Sample:', error);
                            alert('Error updating Bought Sample: ' + error.message);
                        });
                };

                // Backwards-compatible wrapper: delegate single-input updates to the consolidated function
                window.updateGroupAdditionalEmail = function (input) {
                    if (typeof window.updateGroupAdditionalEmails === 'function') {
                        return window.updateGroupAdditionalEmails(input);
                    }
                    // Fallback: do a direct POST (legacy behavior)
                    const groupId = input.getAttribute('data-group-id');
                    const emailValue = input.value.trim();
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('additional_email', emailValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    fetch('/update-group-additional-email/', { method: 'POST', body: formData })
                        .then(r => r.json())
                        .then(data => {
                            if (data.success) {
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => input.style.backgroundColor = '', 500);
                            } else {
                                console.error('Error saving additional email (fallback):', data.error);
                            }
                        })
                        .catch(err => console.error('Network error (fallback):', err));
                };

                // Debounce function moved to early in script (around line 7193)

                // Email management functions moved to early in script (around line 7206)
                // Duplicate definitions removed to prevent conflicts

                // Function to update input border colors based on value
                function updateInputBorderColor(input) {
                    if (input.value && input.value.trim() !== '') {
                        input.style.borderColor = '#28a745'; // Green when has value
                    } else {
                        input.style.borderColor = '#dc3545'; // Red when empty
                    }
                }

                // Add event listeners to all input fields for dynamic border updates
                document.addEventListener('DOMContentLoaded', function () {
                    // Update borders for all input fields
                    const allInputs = document.querySelectorAll('.km-input, .hours-input, .bought-sample-input, .group-km-input, .group-hours-input, .group-additional-email-input');
                    allInputs.forEach(input => {
                        // Set initial border color
                        updateInputBorderColor(input);

                        // Add event listeners for real-time updates
                        input.addEventListener('input', function () {
                            updateInputBorderColor(this);
                        });

                        input.addEventListener('blur', function () {
                            updateInputBorderColor(this);
                        });
                    });
                };

                // Function to update approved status
                window.updateGroupApproved = function (select) {
                    const groupId = select.getAttribute('data-group-id');
                    const approvedValue = select.value;

                    console.log('[STORAGE] Updating Group Approved Status - Group ID:', groupId, 'Value:', approvedValue);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('approved_status', approvedValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-approved/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('‚úÖ Approved status saved successfully:', data);
                                // Show success feedback
                                select.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    select.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('‚ùå Error saving approved status:', data.error);
                                alert('Error updating approved status: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('‚ùå Network error saving approved status:', error);
                            alert('Error updating approved status: ' + error.message);
                        });
                };
            </script>
            <script>
                // ============================================
                // CRITICAL: Define core functions FIRST
                // These must be available immediately for onclick handlers
                // ============================================

                // Files popup function (main implementation)
                window.openFilesPopup = window.openFilesPopup || function (groupId, clientName, inspectionDate) {
                    console.log('openFilesPopup called:', groupId, clientName, inspectionDate);
                    const modal = document.getElementById('filesModal');
                    if (modal) {
                        modal.style.display = 'block';
                        const modalTitle = document.getElementById('modalTitle');
                        if (modalTitle) modalTitle.textContent = 'Files for ' + clientName + ' - ' + inspectionDate;
                        window.currentFilesClient = clientName;
                        window.currentFilesDate = inspectionDate;
                        window.currentFilesGroupId = groupId;
                        if (typeof window.loadInspectionFiles === 'function') {
                            window.loadInspectionFiles(groupId, clientName, inspectionDate);
                        }
                    }
                };

                // View files alias
                window.viewFilesForGroup = window.viewFilesForGroup || function (groupId, clientName, inspectionDate) {
                    window.openFilesPopup(groupId, clientName, inspectionDate);
                };

                // Upload functions for inspection-level documents
                window.uploadComplianceForInspection = window.uploadComplianceForInspection || function (productId, groupId) {
                    console.log('Upload compliance for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadCompositionForInspection = window.uploadCompositionForInspection || function (productId, groupId) {
                    console.log('Upload composition for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadLabForInspection = window.uploadLabForInspection || function (productId, groupId) {
                    console.log('Upload lab for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadOccurrenceForInspection = window.uploadOccurrenceForInspection || function (productId, groupId) {
                    console.log('Upload occurrence for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadInvoiceForInspection = window.uploadInvoiceForInspection || function (productId, groupId) {
                    console.log('Upload invoice for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadRfiForInspection = window.uploadRfiForInspection || function (productId, groupId) {
                    console.log('Upload RFI for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadRetestForInspection = window.uploadRetestForInspection || function (productId, groupId) {
                    console.log('Upload Retest for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.uploadOtherForInspection = window.uploadOtherForInspection || function (productId, groupId) {
                    console.log('Upload other for inspection:', productId, groupId);
                    alert('Please wait - upload functions loading...');
                };

                window.viewDocForInspection = window.viewDocForInspection || function (productId, docType) {
                    console.log('View doc for inspection:', productId, docType);
                };

                window.deleteDocForInspection = window.deleteDocForInspection || function (productId, docType) {
                    console.log('Delete doc for inspection:', productId, docType);
                };

                console.log('‚úÖ Critical functions defined early');

                // Global error handler to catch any uncaught exceptions
                window.addEventListener('error', function (event) {
                    console.error('Uncaught JavaScript error:', event.error);
                    console.error('Error details:', {
                        message: event.message,
                        filename: event.filename,
                        lineno: event.lineno,
                        colno: event.colno,
                        error: event.error
                    });
                    // Don't let errors break the page functionality
                    return true;
                });

                // Wrap all JavaScript in error handling to prevent uncaught exceptions
                console.log('Main JavaScript started loading...');

                // Hide invoice column for inspectors
                document.addEventListener('DOMContentLoaded', function () {
                    const userRole = '{{ request.user.role|default:"admin" }}';
                    if (userRole === 'inspector') {
                        const table = document.getElementById('shipmentsTable');
                        if (table) {
                            table.classList.add('hide-invoice');
                        }

                        // Hide actions column in detail tables for inspectors
                        const detailTables = document.querySelectorAll('.detail-table');
                        detailTables.forEach(table => {
                            table.classList.add('hide-actions');
                        });
                    }
                });

                // Theme management (using same system as inspector settings)
                function initTheme() {
                    const savedTheme = localStorage.getItem('theme');

                    // Default to light mode first
                    let activeTheme = 'light';
                    if (savedTheme) {
                        activeTheme = savedTheme;
                    }

                    document.documentElement.setAttribute('data-theme', activeTheme);
                    console.log('Theme initialized:', activeTheme);
                }

                function toggleTheme() {
                    const themeMode = document.getElementById('theme_mode');
                    if (themeMode) {
                        const newTheme = themeMode.checked ? 'dark' : 'light';
                        console.log('Switching to theme:', newTheme);

                        document.documentElement.setAttribute('data-theme', newTheme);

                        try {
                            localStorage.setItem('theme', newTheme);
                            console.log('Theme saved to localStorage:', newTheme);
                        } catch (e) {
                            console.log('Could not save theme to localStorage:', e);
                        }
                    }
                }

                // Listen for theme changes from other pages
                function listenForThemeChanges() {
                    window.addEventListener('storage', function (e) {
                        if (e.key === 'theme') {
                            console.log('Theme changed from another page:', e.newValue);
                            document.documentElement.setAttribute('data-theme', e.newValue || 'light');
                        }
                    });
                }

                // Force theme application (can be called manually)
                function forceThemeApplication() {
                    const savedTheme = localStorage.getItem('theme') || 'light';
                    document.documentElement.setAttribute('data-theme', savedTheme);
                    console.log('Theme force applied:', savedTheme);
                }

                // Make theme functions globally available
                window.initTheme = initTheme;
                window.forceThemeApplication = forceThemeApplication;


                // Global expand/collapse functions
                function expandAll() {
                    const detailRows = document.querySelectorAll('.detail-row');
                    const expandBtns = document.querySelectorAll('.expand-btn');

                    detailRows.forEach(row => {
                        // Skip if this detail row belongs to a "New" client
                        const groupRow = row.previousElementSibling;
                        if (groupRow && groupRow.classList.contains('greyed-out-group')) {
                            return; // Skip "New" clients
                        }
                        row.style.display = 'table-row';
                    });

                    // Force mobile layout if screen is small
                    if (typeof enforceMobileLayout === 'function') {
                        enforceMobileLayout();
                    }

                    expandBtns.forEach(btn => {
                        // Skip if this button belongs to a "New" client
                        const row = btn.closest('tr.greyed-out-group');
                        if (row) {
                            return; // Skip "New" clients
                        }
                        btn.classList.add('expanded');
                        const icon = btn.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-chevron-right');
                            icon.classList.add('fa-chevron-down');
                        }
                    });

                    // Also expand mobile cards
                    const mobileCards = document.querySelectorAll('.group-card .group-details');
                    const mobileExpandBtns = document.querySelectorAll('.group-card .expand-btn');

                    mobileCards.forEach(card => {
                        card.classList.add('expanded');
                    });

                    mobileExpandBtns.forEach(btn => {
                        btn.classList.add('expanded');
                        const icon = btn.querySelector('i');
                        if (icon) {
                            icon.style.transform = 'rotate(180deg)';
                        }
                    });
                };

                function collapseAll() {
                    const detailRows = document.querySelectorAll('.detail-row');
                    const expandBtns = document.querySelectorAll('.expand-btn');

                    detailRows.forEach(row => {
                        // Skip if this detail row belongs to a "New" client
                        const groupRow = row.previousElementSibling;
                        if (groupRow && groupRow.classList.contains('greyed-out-group')) {
                            return; // Skip "New" clients
                        }
                        row.style.display = 'none';
                    });

                    expandBtns.forEach(btn => {
                        // Skip if this button belongs to a "New" client
                        const row = btn.closest('tr.greyed-out-group');
                        if (row) {
                            return; // Skip "New" clients
                        }
                        btn.classList.remove('expanded');
                        const icon = btn.querySelector('i');
                        if (icon) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-right');
                        }
                    });

                    // Also collapse mobile cards
                    const mobileCards = document.querySelectorAll('.group-card .group-details');
                    const mobileExpandBtns = document.querySelectorAll('.group-card .expand-btn');

                    mobileCards.forEach(card => {
                        card.classList.remove('expanded');
                    });

                    mobileExpandBtns.forEach(btn => {
                        btn.classList.remove('expanded');
                        const icon = btn.querySelector('i');
                        if (icon) {
                            icon.style.transform = 'rotate(0deg)';
                        }
                    });
                };

                // Mobile card expand/collapse functionality
                function initMobileCards() {
                    const expandBtns = document.querySelectorAll('.group-card .expand-btn');

                    expandBtns.forEach(btn => {
                        btn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            const groupId = this.getAttribute('data-group-id');
                            const card = this.closest('.group-card');
                            const details = card.querySelector('.group-details');
                            const icon = this.querySelector('i');

                            console.log('Mobile card clicked, groupId:', groupId);
                            console.log('Details element:', details);
                            console.log('Current classes:', details.className);

                            if (details.classList.contains('expanded')) {
                                // Collapse
                                console.log('Collapsing card');
                                details.classList.remove('expanded');
                                this.classList.remove('expanded');
                                if (icon) {
                                    icon.style.transform = 'rotate(0deg)';
                                }
                            } else {
                                // Expand
                                console.log('Expanding card');
                                details.classList.add('expanded');
                                this.classList.add('expanded');
                                if (icon) {
                                    icon.style.transform = 'rotate(180deg)';
                                }
                            }
                        });
                    });
                }

                // Initialize mobile cards when DOM is loaded
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('DOM loaded, initializing mobile cards');
                    initMobileCards();
                });

                // Also initialize when window loads (fallback)
                window.addEventListener('load', function () {
                    console.log('Window loaded, initializing mobile cards');
                    initMobileCards();
                });

                // Re-initialize mobile cards after any dynamic content changes
                function reinitMobileCards() {
                    console.log('Re-initializing mobile cards');
                    initMobileCards();
                }

                // Global toggle function
                function toggleGroup(e, groupId) {
                    console.log('[TOGGLE] Toggling group:', groupId);
                    e.preventDefault();
                    e.stopPropagation();

                    const detailRow = document.getElementById('detail-' + groupId);
                    console.log('[TOGGLE] Detail row found:', detailRow);
                    console.log('[TOGGLE] Detail row ID:', 'detail-' + groupId);

                    if (!detailRow) {
                        console.warn('No detail row for groupId:', groupId);
                        return;
                    }

                    // Find the expand button safely
                    let expandBtn = null;
                    if (e && e.target) {
                        expandBtn = e.target.closest('.expand-btn');
                    }
                    if (!expandBtn) {
                        const groupRow = document.querySelector('tr.group-row[data-group-id="' + groupId + '"]');
                        if (groupRow) {
                            expandBtn = groupRow.querySelector('.expand-btn');
                        }
                    }

                    const icon = expandBtn ? expandBtn.querySelector('i') : null;

                    const isHidden = detailRow.style.display === 'none' || detailRow.style.display === '';
                    if (isHidden) {
                        // Expand
                        detailRow.style.display = 'table-row';
                        if (expandBtn) expandBtn.classList.add('expanded');

                        // Force mobile layout if screen is small
                        if (typeof enforceMobileLayout === 'function') {
                            enforceMobileLayout();
                        }
                        if (icon) {
                            icon.classList.remove('fa-chevron-right');
                            icon.classList.add('fa-chevron-down');
                        }

                        // Populate class dropdowns when expanding
                        console.log('[TOGGLE] Expanding - populating class dropdowns...');
                        const classDropdowns = detailRow.querySelectorAll('select.product-class-select');
                        console.log('[TOGGLE] Found', classDropdowns.length, 'class dropdowns in expanded row');

                        if (classDropdowns.length > 0) {
                            console.log('[TOGGLE] Calling filterClassOptions for each dropdown...');
                            classDropdowns.forEach((dropdown, index) => {
                                console.log(`[TOGGLE] Processing dropdown ${index + 1}:`, dropdown);
                                console.log(`[TOGGLE] Dropdown classes:`, dropdown.className);
                                console.log(`[TOGGLE] Dropdown data attributes:`, {
                                    'data-inspection-id': dropdown.getAttribute('data-inspection-id'),
                                    'data-commodity': dropdown.getAttribute('data-commodity'),
                                    'data-current-class': dropdown.getAttribute('data-current-class')
                                });
                                window.filterClassOptions(dropdown);
                            });
                        } else {
                            console.log('[TOGGLE] No class dropdowns found in expanded row');
                            // Try to find any select elements
                            const allSelects = detailRow.querySelectorAll('select');
                            console.log('[TOGGLE] All select elements found:', allSelects.length);
                            allSelects.forEach((select, index) => {
                                console.log(`[TOGGLE] Select ${index + 1}:`, select.className, select);
                            });
                        }
                    } else {
                        // Collapse
                        detailRow.style.display = 'none';
                        if (expandBtn) expandBtn.classList.remove('expanded');
                        if (icon) {
                            icon.classList.remove('fa-chevron-down');
                            icon.classList.add('fa-chevron-right');
                        }
                    }
                }

                // Mobile Menu Toggle
                function toggleSidebar() {
                    console.log('üçî ===== MENU TOGGLE STARTED =====');
                    console.log('üçî Menu button clicked!');

                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('sidebar-overlay');
                    const mobileBtn = document.getElementById('mobile-menu-btn');

                    console.log('üçî Elements found:', {
                        sidebar: !!sidebar,
                        overlay: !!overlay,
                        mobileBtn: !!mobileBtn
                    });

                    if (sidebar && overlay && mobileBtn) {
                        console.log('üçî All elements found, proceeding with toggle...');

                        // Check current state before toggle
                        const wasOpen = sidebar.classList.contains('show');
                        console.log('üçî Current state - Sidebar open:', wasOpen);
                        console.log('üçî Current sidebar classes:', sidebar.className);
                        console.log('üçî Current overlay classes:', overlay.className);

                        // Toggle classes
                        sidebar.classList.toggle('show');
                        overlay.classList.toggle('show');

                        console.log('üçî After toggle - Sidebar classes:', sidebar.className);
                        console.log('üçî After toggle - Overlay classes:', overlay.className);

                        // Check new state
                        const isNowOpen = sidebar.classList.contains('show');
                        console.log('üçî New state - Sidebar open:', isNowOpen);

                        // Update icon
                        const icon = mobileBtn.querySelector('i');
                        console.log('üçî Icon element found:', !!icon);
                        console.log('üçî Current icon classes:', icon ? icon.className : 'N/A');

                        if (isNowOpen) {
                            icon.className = 'fas fa-times';
                            console.log('üçî ‚úÖ SIDEBAR OPENED - Icon changed to X');
                            console.log('üçî New icon classes:', icon.className);

                            // Check computed styles
                            const sidebarStyles = getComputedStyle(sidebar);
                            console.log('üçî Sidebar computed styles:', {
                                transform: sidebarStyles.transform,
                                display: sidebarStyles.display,
                                visibility: sidebarStyles.visibility,
                                opacity: sidebarStyles.opacity,
                                zIndex: sidebarStyles.zIndex
                            });

                            const overlayStyles = getComputedStyle(overlay);
                            console.log('üçî Overlay computed styles:', {
                                display: overlayStyles.display,
                                visibility: overlayStyles.visibility,
                                opacity: overlayStyles.opacity,
                                zIndex: overlayStyles.zIndex
                            });
                        } else {
                            icon.className = 'fas fa-bars';
                            console.log('üçî ‚ùå SIDEBAR CLOSED - Icon changed to hamburger');
                            console.log('üçî New icon classes:', icon.className);
                        }

                        console.log('üçî ===== MENU TOGGLE COMPLETED =====');
                    } else {
                        console.error('üçî ‚ùå MISSING ELEMENTS FOR MENU TOGGLE');
                        console.error('üçî Sidebar found:', !!sidebar);
                        console.error('üçî Overlay found:', !!overlay);
                        console.error('üçî Mobile button found:', !!mobileBtn);
                    }
                }

                // Handle window resize for responsive behavior
                function handleResize() {
                    console.log('üçî ===== WINDOW RESIZE EVENT =====');
                    console.log('üçî Window width:', window.innerWidth);

                    // Handle sidebar resize logic
                    if (window.innerWidth > 1024) {
                        console.log('üçî Desktop size detected, closing mobile menu...');
                        const sidebar = document.getElementById('sidebar');
                        const overlay = document.getElementById('sidebar-overlay');
                        const mobileBtn = document.getElementById('mobile-menu-btn');

                        console.log('üçî Elements found for resize:', {
                            sidebar: !!sidebar,
                            overlay: !!overlay,
                            mobileBtn: !!mobileBtn
                        });

                        if (sidebar) {
                            console.log('üçî Sidebar classes before close:', sidebar.className);
                            sidebar.classList.remove('show');
                            console.log('üçî Sidebar classes after close:', sidebar.className);
                        }

                        if (overlay) {
                            console.log('üçî Overlay classes before close:', overlay.className);
                            overlay.classList.remove('show');
                            console.log('üçî Overlay classes after close:', overlay.className);
                        }

                        if (mobileBtn) {
                            const icon = mobileBtn.querySelector('i');
                            if (icon) {
                                console.log('üçî Icon classes before reset:', icon.className);
                                icon.className = 'fas fa-bars';
                                console.log('üçî Icon classes after reset:', icon.className);
                            }
                        }

                        console.log('üçî ‚úÖ Mobile menu closed due to desktop resize');
                    } else {
                        console.log('üçî Mobile size detected, menu should be available');
                    }

                    console.log('üçî ===== WINDOW RESIZE COMPLETE =====');
                }

                document.addEventListener('DOMContentLoaded', function () {
                    console.log('üöÄ DOM Content Loaded - Initializing...');
                    console.log('üöÄ CACHE BUST: 2025-01-15 - Menu debugging version loaded');

                    // Initialize theme
                    if (typeof initTheme === 'function') initTheme();

                    // Mobile menu functionality
                    console.log('üçî ===== SETTING UP MENU EVENT LISTENERS =====');
                    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
                    const sidebarOverlay = document.getElementById('sidebar-overlay');

                    console.log('üçî Looking for menu elements...');
                    console.log('üçî Mobile menu button found:', !!mobileMenuBtn);
                    console.log('üçî Sidebar overlay found:', !!sidebarOverlay);

                    if (mobileMenuBtn) {
                        console.log('üçî Mobile menu button element:', mobileMenuBtn);
                        console.log('üçî Mobile menu button classes:', mobileMenuBtn.className);
                        console.log('üçî Mobile menu button styles:', {
                            display: getComputedStyle(mobileMenuBtn).display,
                            visibility: getComputedStyle(mobileMenuBtn).visibility,
                            position: getComputedStyle(mobileMenuBtn).position,
                            zIndex: getComputedStyle(mobileMenuBtn).zIndex,
                            pointerEvents: getComputedStyle(mobileMenuBtn).pointerEvents
                        });

                        // Test if button is clickable
                        console.log('üçî Testing button clickability...');
                        console.log('üçî Button offsetParent:', mobileMenuBtn.offsetParent);
                        console.log('üçî Button getBoundingClientRect:', mobileMenuBtn.getBoundingClientRect());

                        // Add event listener with debugging
                        mobileMenuBtn.addEventListener('click', function (e) {
                            console.log('üçî EVENT LISTENER TRIGGERED!', e);
                            toggleSidebar();
                        });
                        console.log('üçî ‚úÖ Menu button event listener attached successfully');

                        // Test direct click simulation
                        setTimeout(() => {
                            console.log('üçî Testing programmatic click...');
                            // Don't actually click, just test if we can
                            console.log('üçî Button is ready for testing');
                        }, 1000);
                    } else {
                        console.error('üçî ‚ùå Mobile menu button not found!');
                        console.error('üçî Searching for button with ID "mobile-menu-btn"...');
                        const allButtons = document.querySelectorAll('button');
                        console.error('üçî All buttons found:', allButtons.length);
                        allButtons.forEach((btn, index) => {
                            console.error(`üçî Button ${index}:`, {
                                id: btn.id,
                                classes: btn.className,
                                text: btn.textContent.trim()
                            });
                        });
                    }

                    if (sidebarOverlay) {
                        console.log('üçî Sidebar overlay element:', sidebarOverlay);
                        console.log('üçî Sidebar overlay classes:', sidebarOverlay.className);
                        sidebarOverlay.addEventListener('click', toggleSidebar);
                        console.log('üçî ‚úÖ Sidebar overlay event listener attached successfully');
                    } else {
                        console.error('üçî ‚ùå Sidebar overlay not found!');
                    }

                    console.log('üçî ===== MENU EVENT LISTENERS SETUP COMPLETE =====');

                    // Close sidebar when clicking on nav links on mobile
                    const navLinks = document.querySelectorAll('.nav-link');
                    navLinks.forEach(link => {
                        link.addEventListener('click', function () {
                            if (window.innerWidth <= 1024) {
                                toggleSidebar();
                            }
                        });
                    });

                    // Handle window resize
                    window.addEventListener('resize', handleResize);

                    // Listen for theme changes from other pages
                    listenForThemeChanges();

                    // Expand buttons are handled by the global document click listener

                    // Clear any cached data and force immediate file status check on page load
                    setTimeout(() => {
                        console.log('üßπ [PAGE LOAD] Clearing cached data and forcing fresh file status check...');
                        // Clear any local storage cache
                        localStorage.removeItem('file_status_cache');
                        localStorage.removeItem('shipment_data_cache');
                        updateAllViewFilesButtonColors();
                    }, 1000);

                    // Additional file status check after a longer delay to catch any missed files
                    setTimeout(() => {
                        console.log('üîÑ [PAGE LOAD] Running secondary file status check...');
                        updateAllViewFilesButtonColors();
                    }, 3000);

                });

                // CSRF functions now defined at top of script section

                // Download file function
                function downloadFile(url) {
                    if (!url || url === '#') {
                        console.error('Invalid download URL');
                        return;
                    }
                    // Open in new tab to trigger download
                    window.open(url, '_blank');
                }

                // Delete file function
                async function deleteFile(filePath, category) {
                    if (!confirm('Are you sure you want to delete this ' + category + ' file? This action cannot be undone.')) {
                        return;
                    }

                    try {
                        const response = await fetch('/delete-inspection-file/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                file_path: filePath,
                                client_name: window.currentFilesClient,
                                inspection_date: window.currentFilesDate
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Show success message
                            console.log('‚úÖ File deleted successfully:', filePath);

                            // After deletion, fetch updated file list to check remaining count
                            const filesResponse = await fetch('/inspections/files/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken()
                                },
                                body: JSON.stringify({
                                    client_name: window.currentFilesClient,
                                    inspection_date: window.currentFilesDate,
                                    _force_refresh: true
                                })
                            });

                            const filesData = await filesResponse.json();
                            const files = filesData.files || {};
                            const groupId = window.currentFilesGroupId;

                            // Helper function to update button to grey (enabled, no files)
                            function setButtonGrey(btn, label, uploadFn) {
                                btn.style.backgroundColor = '#6c757d';
                                btn.style.borderColor = '#6c757d';
                                btn.innerHTML = label;
                                btn.disabled = false;
                                btn.title = 'Upload ' + label;
                                if (uploadFn) btn.onclick = uploadFn;
                                console.log('‚úÖ ' + label + ' button set to GREY (0 files remaining)');
                            }

                            // Check RFI file count - only go grey if count == 0
                            if (category === 'rfi') {
                                const rfiCount = (files.rfi || []).length;
                                console.log('üìÅ RFI files remaining after delete:', rfiCount);
                                if (rfiCount === 0) {
                                    const rfiBtn = document.getElementById('rfi-btn-' + groupId);
                                    const rfiMobileBtn = document.getElementById('rfi-mobile-' + groupId);
                                    // Get productId from data attribute
                                    const rfiProductId = rfiBtn ? (rfiBtn.getAttribute('data-upload-btn') || '').replace('rfi-', '') : groupId;
                                    if (rfiBtn) setButtonGrey(rfiBtn, 'RFI', function() { uploadRfiForInspection(rfiProductId, groupId); });
                                    if (rfiMobileBtn) {
                                        rfiMobileBtn.style.backgroundColor = '#6c757d';
                                        rfiMobileBtn.style.borderColor = '#6c757d';
                                        rfiMobileBtn.innerHTML = '<i class="fas fa-file-alt mr-1"></i> RFI';
                                        rfiMobileBtn.disabled = false;
                                        rfiMobileBtn.onclick = function() { uploadRfiForInspection(rfiProductId, groupId); };
                                    }
                                }
                            }

                            // Check Invoice file count - only go grey if count == 0
                            if (category === 'invoice') {
                                const invoiceCount = (files.invoice || []).length;
                                console.log('üìÅ Invoice files remaining after delete:', invoiceCount);
                                if (invoiceCount === 0) {
                                    const invoiceBtn = document.getElementById('invoice-btn-' + groupId);
                                    const invoiceMobileBtn = document.getElementById('invoice-mobile-' + groupId);
                                    // Get productId from data attribute
                                    const invoiceProductId = invoiceBtn ? (invoiceBtn.getAttribute('data-upload-btn') || '').replace('invoice-', '') : groupId;
                                    if (invoiceBtn) setButtonGrey(invoiceBtn, 'Invoice', function() { uploadInvoiceForInspection(invoiceProductId, groupId); });
                                    if (invoiceMobileBtn) {
                                        invoiceMobileBtn.style.backgroundColor = '#6c757d';
                                        invoiceMobileBtn.style.borderColor = '#6c757d';
                                        invoiceMobileBtn.innerHTML = '<i class="fas fa-file-invoice mr-1"></i> Invoice';
                                        invoiceMobileBtn.disabled = false;
                                        invoiceMobileBtn.onclick = function() { uploadInvoiceForInspection(invoiceProductId, groupId); };
                                    }
                                }
                            }

                            // Check Composition file count - only go grey if count == 0
                            if (category === 'composition') {
                                const compCount = (files.composition || []).length;
                                console.log('üìÅ Composition files remaining after delete:', compCount);
                                if (compCount === 0) {
                                    const allCompBtns = document.querySelectorAll('[data-upload-btn*="composition"]');
                                    allCompBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Check Retest file count - only go grey if count == 0
                            if (category === 'retest') {
                                const retestCount = (files.retest || []).length;
                                console.log('üìÅ Retest files remaining after delete:', retestCount);
                                if (retestCount === 0) {
                                    const allRetestBtns = document.querySelectorAll('[data-upload-btn*="retest"]');
                                    allRetestBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Check Lab/COA file count - only go grey if count == 0
                            if (category === 'lab' || category === 'coa') {
                                const labCount = (files.lab || []).length + (files.coa || []).length;
                                console.log('üìÅ Lab/COA files remaining after delete:', labCount);
                                if (labCount === 0) {
                                    const allLabBtns = document.querySelectorAll('[data-upload-btn*="lab"]');
                                    allLabBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Check Occurrence file count - only go grey if count == 0
                            if (category === 'occurrence') {
                                const occCount = (files.occurrence || []).length;
                                console.log('üìÅ Occurrence files remaining after delete:', occCount);
                                if (occCount === 0) {
                                    const allOccBtns = document.querySelectorAll('[data-upload-btn*="occurrence"]');
                                    allOccBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Check Other file count - only go grey if count == 0
                            if (category === 'other') {
                                const otherCount = (files.other || []).length;
                                console.log('üìÅ Other files remaining after delete:', otherCount);
                                if (otherCount === 0) {
                                    const allOtherBtns = document.querySelectorAll('[data-upload-btn*="other"]');
                                    allOtherBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Check Compliance file count - only go grey if count == 0
                            if (category === 'compliance') {
                                const complianceCount = (files.compliance || []).length;
                                console.log('üìÅ Compliance files remaining after delete:', complianceCount);
                                if (complianceCount === 0) {
                                    const allComplianceBtns = document.querySelectorAll('[data-upload-btn*="compliance"]');
                                    allComplianceBtns.forEach(btn => {
                                        btn.style.background = '#6c757d';
                                        btn.innerHTML = 'Upload';
                                        btn.disabled = false;
                                    });
                                }
                            }

                            // Update View Files button colors after deletion
                            updateAllViewFilesButtonColors();

                            // Also update RFI/Invoice button colors after deletion
                            if (window.currentFilesClient) {
                                updateRFIAndInvoiceButtonColorsForClient(window.currentFilesClient);
                            }

                            // Refresh the files display while preserving scroll position
                            if (window.currentFilesClient && window.currentFilesDate) {
                                // Save current scroll position
                                const modalBody = document.querySelector('#filesModal .modal-body');
                                const scrollTop = modalBody ? modalBody.scrollTop : 0;

                                openFilesPopup(window.currentFilesGroupId, window.currentFilesClient, window.currentFilesDate);

                                // Restore scroll position after content loads
                                setTimeout(() => {
                                    if (modalBody) {
                                        modalBody.scrollTop = scrollTop;
                                    }
                                }, 100);
                            }
                        } else {
                            console.error('‚ùå Failed to delete file:', result.error);
                        }

                    } catch (error) {
                        console.error('‚ùå Error deleting file:', error);
                    }
                }

                // Function to re-enable upload buttons when files are deleted (legacy - main handling is done above)
                function reEnableUploadButtons(filePath, category) {
                    console.log('üîÑ reEnableUploadButtons called for:', filePath, 'category:', category);
                    // Button resetting is now handled by immediate deletion handlers above
                    // This function just cleans up localStorage
                    const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                    // Remove any entries matching this category
                    Object.keys(uploadStatus).forEach(key => {
                        if (key.toLowerCase().includes(category.toLowerCase())) {
                            delete uploadStatus[key];
                        }
                    });
                    localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                }

                // Client Autocomplete Functionality
                document.addEventListener('DOMContentLoaded', function () {
                    const clientSearchInput = document.getElementById('clientSearchInput');
                    const suggestionsDropdown = document.getElementById('clientSuggestions');
                    let currentSuggestions = [];
                    let selectedIndex = -1;
                    let debounceTimer;

                    if (!clientSearchInput || !suggestionsDropdown) {
                        console.log('Client autocomplete elements not found');
                        return;
                    }

                    // Debounced search function
                    function debounceSearch(query) {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => {
                            if (query.length >= 2) {
                                fetchClientSuggestions(query);
                            } else {
                                hideSuggestions();
                            }
                        }, 300);
                    }

                    // Fetch suggestions from API
                    async function fetchClientSuggestions(query) {
                        try {
                            const response = await fetch('/api/clients/autocomplete/?q=' + encodeURIComponent(query));
                            if (response.ok) {
                                const data = await response.json();
                                currentSuggestions = data.suggestions || [];
                                displaySuggestions(currentSuggestions);
                            } else {
                                hideSuggestions();
                            }
                        } catch (error) {
                            console.error('Error fetching client suggestions:', error);
                            hideSuggestions();
                        }
                    }

                    // Display suggestions in dropdown
                    function displaySuggestions(suggestions) {
                        if (suggestions.length === 0) {
                            hideSuggestions();
                            return;
                        }

                        suggestionsDropdown.innerHTML = '';
                        suggestions.forEach((suggestion, index) => {
                            const item = document.createElement('div');
                            item.className = 'autocomplete-item';
                            item.setAttribute('data-index', index);

                            // Simple client name only
                            item.textContent = suggestion.name;

                            // Click handler
                            item.addEventListener('click', () => {
                                selectSuggestion(suggestion);
                            });

                            // Hover handler
                            item.addEventListener('mouseenter', () => {
                                selectedIndex = index;
                                updateHighlight();
                            });

                            suggestionsDropdown.appendChild(item);
                        });

                        // Position the dropdown using absolute positioning relative to input
                        const inputRect = clientSearchInput.getBoundingClientRect();
                        const viewportHeight = window.innerHeight;
                        const spaceBelow = viewportHeight - inputRect.bottom;
                        const spaceAbove = inputRect.top;

                        // Check if there's a table below that we would overlay
                        const tableElement = document.querySelector('#shipmentsTable, .table-responsive');
                        let tableTop = null;
                        if (tableElement) {
                            const tableRect = tableElement.getBoundingClientRect();
                            tableTop = tableRect.top;
                        }

                        suggestionsDropdown.style.display = 'block';
                        suggestionsDropdown.style.position = 'absolute';
                        suggestionsDropdown.style.left = '0px';
                        suggestionsDropdown.style.right = '0px';
                        suggestionsDropdown.style.width = 'auto';

                        // Calculate available space without overlaying table
                        let availableSpaceBelow = spaceBelow - 10;
                        if (tableTop && tableTop > inputRect.bottom) {
                            availableSpaceBelow = Math.min(availableSpaceBelow, tableTop - inputRect.bottom - 20);
                        }

                        let maxHeight = Math.min(300, availableSpaceBelow);

                        // If dropdown would be too small below or would overlay table, position above
                        if (maxHeight < 120 || (tableTop && inputRect.bottom + 200 > tableTop)) {
                            // Position above the input
                            const heightAbove = Math.min(250, spaceAbove - 20);
                            suggestionsDropdown.style.bottom = '100%';
                            suggestionsDropdown.style.top = 'auto';
                            suggestionsDropdown.style.borderRadius = 'var(--radius) var(--radius) 0 0';
                            suggestionsDropdown.style.borderTop = '1px solid var(--border)';
                            suggestionsDropdown.style.borderBottom = 'none';
                            maxHeight = heightAbove;
                        } else {
                            // Position below the input
                            suggestionsDropdown.style.top = '100%';
                            suggestionsDropdown.style.bottom = 'auto';
                            suggestionsDropdown.style.borderRadius = '0 0 var(--radius) var(--radius)';
                            suggestionsDropdown.style.borderTop = 'none';
                            suggestionsDropdown.style.borderBottom = '1px solid var(--border)';
                        }

                        suggestionsDropdown.style.maxHeight = maxHeight + 'px';
                        suggestionsDropdown.style.minHeight = Math.min(100, maxHeight) + 'px';

                        selectedIndex = -1;
                    }

                    // Hide suggestions dropdown
                    function hideSuggestions() {
                        suggestionsDropdown.style.display = 'none';
                        currentSuggestions = [];
                        selectedIndex = -1;
                    }

                    // Select a suggestion
                    function selectSuggestion(suggestion) {
                        clientSearchInput.value = suggestion.name;
                        hideSuggestions();
                        // Optionally trigger form submission or search
                        // clientSearchInput.form.submit();
                    }

                    // Update highlight for keyboard navigation
                    function updateHighlight() {
                        const items = suggestionsDropdown.querySelectorAll('.autocomplete-item');
                        items.forEach((item, index) => {
                            if (index === selectedIndex) {
                                item.style.backgroundColor = 'var(--primary-light)';
                            } else {
                                item.style.backgroundColor = '';
                            }
                        });
                    }

                    // Event listeners
                    clientSearchInput.addEventListener('input', (e) => {
                        const query = e.target.value.trim();
                        debounceSearch(query);
                    });

                    clientSearchInput.addEventListener('keydown', (e) => {
                        if (suggestionsDropdown.style.display === 'none') return;

                        switch (e.key) {
                            case 'ArrowDown':
                                e.preventDefault();
                                selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                                updateHighlight();
                                break;
                            case 'ArrowUp':
                                e.preventDefault();
                                selectedIndex = Math.max(selectedIndex - 1, -1);
                                updateHighlight();
                                break;
                            case 'Enter':
                                e.preventDefault();
                                if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
                                    selectSuggestion(currentSuggestions[selectedIndex]);
                                }
                                break;
                            case 'Escape':
                                hideSuggestions();
                                break;
                        }
                    });

                    // Hide suggestions when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!clientSearchInput.contains(e.target) && !suggestionsDropdown.contains(e.target)) {
                            hideSuggestions();
                        }
                    });

                    // Hide suggestions when input loses focus (with delay to allow clicks)
                    clientSearchInput.addEventListener('blur', () => {
                        setTimeout(() => {
                            hideSuggestions();
                        }, 150);
                    });

                    // Reposition dropdown on window resize
                    window.addEventListener('resize', () => {
                        if (suggestionsDropdown.style.display === 'block' && currentSuggestions.length > 0) {
                            displaySuggestions(currentSuggestions);
                        }
                    });

                    // Hide dropdown on scroll for better UX
                    window.addEventListener('scroll', () => {
                        if (suggestionsDropdown.style.display === 'block') {
                            hideSuggestions();
                        }
                    });
                });

                // Show loading indicator for large datasets and check OneDrive status after page is fully loaded
                document.addEventListener('DOMContentLoaded', function () {
                    const totalRecords = parseInt('{{ total_shipments|default:0 }}') || 0;
                    if (totalRecords > 1000) {
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        loadingOverlay.style.display = 'flex';

                        // Hide loading overlay after page is fully loaded
                        window.addEventListener('load', function () {
                            setTimeout(function () {
                                loadingOverlay.style.display = 'none';
                                // Re-enable pagination after overlay is hidden
                                enablePagination();
                            }, 1000); // Reduced delay to prevent pagination blocking
                        });
                    } else {
                        // For smaller datasets, enable pagination immediately
                        enablePagination();
                    }

                    // Check OneDrive processing status for background service

                });

                // Function to enable pagination functionality
                function enablePagination() {
                    // Ensure pagination links are clickable
                    const paginationLinks = document.querySelectorAll('.pagination a');
                    paginationLinks.forEach(link => {
                        link.style.pointerEvents = 'auto';
                        link.style.opacity = '1';

                        // Add click handler to ensure navigation works
                        link.addEventListener('click', function (e) {
                            // Allow default navigation behavior
                            console.log('Pagination link clicked:', this.href);
                        });
                    });

                    // Remove any blocking overlays
                    const blockingOverlays = document.querySelectorAll('.loading-overlay, .status-check-overlay');
                    blockingOverlays.forEach(overlay => {
                        if (overlay.id !== 'loadingOverlay') {
                            overlay.style.display = 'none';
                        }
                    });

                    console.log('Pagination enabled for', paginationLinks.length, 'links');

                    // Also handle page navigation
                    handlePageNavigation();
                }

                // Function to handle page navigation
                function handlePageNavigation() {
                    // Ensure all pagination links work properly
                    const paginationLinks = document.querySelectorAll('.pagination a');
                    paginationLinks.forEach(link => {
                        // Remove any existing event listeners to avoid duplicates
                        link.removeEventListener('click', handlePaginationClick);
                        // Add new event listener
                        link.addEventListener('click', handlePaginationClick);
                    });
                };

                // Handle pagination click
                function handlePaginationClick(e) {
                    console.log('Pagination clicked:', this.href);
                    // Allow default navigation - don't prevent default
                    // The page will reload with the new page number
                }
                // Function to check compliance documents in batch with completion tracking
                async function checkComplianceDocumentsBatch(inspections, overlay, messageElement) {
                    try {
                        console.log('üîÑ OneDrive overlay: Starting batch compliance check...');

                        // Start the batch processing
                        const response = await fetch('/check-compliance-documents-batch/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                inspections: inspections
                            })
                        });

                        const result = await response.json();
                        console.log('üîÑ OneDrive overlay: Batch compliance check completed:', result.success);

                        if (result.success) {
                            // Update the UI with compliance status
                            updateComplianceStatus(result.results);
                            console.log('üîÑ OneDrive overlay: UI updated with compliance status');

                            // Now wait for OneDrive processing to complete
                            await waitForOneDriveCompletion(overlay, messageElement);
                        } else {
                            console.log('‚ùå OneDrive overlay: Batch compliance check failed:', result.error);
                            // Show error message
                            messageElement.textContent = '‚ùå Error processing files. Please try again.';

                            // Hide overlay after error
                            setTimeout(function () {
                                overlay.style.display = 'none';
                                console.log('‚ùå OneDrive overlay: Hidden due to batch check error');
                            }, 3000);
                        }
                    } catch (error) {
                        console.log('‚ùå OneDrive overlay: Batch compliance check network error:', error);

                        // Show error message
                        messageElement.textContent = '‚ùå Network error. Please try again.';

                        // Hide overlay after error
                        setTimeout(function () {
                            overlay.style.display = 'none';
                            console.log('‚ùå OneDrive overlay: Hidden due to network error');
                        }, 3000);
                    }
                }

                // Function to wait for OneDrive processing to complete
                async function waitForOneDriveCompletion(overlay, messageElement) {
                    let attempts = 0;
                    const maxAttempts = 60; // Wait up to 5 minutes (60 * 5 seconds)

                    console.log('üîÑ OneDrive overlay: Starting OneDrive completion polling...');

                    while (attempts < maxAttempts) {
                        try {
                            console.log('üîÑ OneDrive overlay: Polling attempt ' + attempts + 1 + '/' + maxAttempts);

                            const response = await fetch('/check-onedrive-status/', {
                                method: 'GET',
                                headers: {
                                    'X-CSRFToken': getCSRFToken()
                                }
                            });

                            const status = await response.json();
                            console.log('üîÑ OneDrive overlay: Status response:', status);

                            if (status.success) {
                                // Check if OneDrive is still processing
                                if (status.is_processing) {
                                    messageElement.textContent = 'üîÑ Processing OneDrive files... (' + attempts + 1 + '/' + maxAttempts + ')';
                                    console.log('üîÑ OneDrive overlay: Still processing... (' + attempts + 1 + '/' + maxAttempts + ');');
                                    await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
                                    attempts++;
                                    continue;
                                } else {
                                    // OneDrive processing is complete
                                    console.log('‚úÖ OneDrive overlay: Processing complete!');
                                    messageElement.textContent = '‚úÖ All files processed successfully!';

                                    // Hide overlay after showing completion
                                    setTimeout(function () {
                                        overlay.style.display = 'none';
                                        console.log('‚úÖ OneDrive overlay: Hidden after successful completion');
                                    }, 2000);
                                    return;
                                }
                            } else {
                                // Error checking status, assume completion
                                console.log('[WARNING] OneDrive overlay: Status check failed, assuming completion');
                                messageElement.textContent = '‚úÖ Files processed successfully!';
                                setTimeout(function () {
                                    overlay.style.display = 'none';
                                    console.log('‚úÖ OneDrive overlay: Hidden after status check failure');
                                }, 2000);
                                return;
                            }
                        } catch (error) {
                            console.log('‚ùå OneDrive overlay: Error checking OneDrive status:', error);
                            attempts++;
                            await new Promise(resolve => setTimeout(resolve, 5000));
                        }
                    }

                    // If we reach max attempts, assume completion
                    console.log('[TIMER] OneDrive overlay: Reached max attempts, assuming completion');
                    messageElement.textContent = '‚úÖ Files processed successfully!';
                    setTimeout(function () {
                        overlay.style.display = 'none';
                        console.log('‚úÖ OneDrive overlay: Hidden after max attempts reached');
                    }, 2000);
                }

                // Function to update compliance status in the UI
                function updateComplianceStatus(results) {
                    Object.keys(results).forEach(key => {
                        const [clientName, inspectionDate] = key.split('_', 2);
                        const hasCompliance = results[key];

                        // Find the corresponding row and update the button
                        const row = document.querySelector('[data-client-name="' + clientName + '"][data-inspection-date="' + inspectionDate + '"]');
                        if (row) {
                            const viewFilesBtn = row.querySelector('.btn-view-files');
                            if (viewFilesBtn) {
                                if (hasCompliance) {
                                    viewFilesBtn.classList.remove('btn-view-files-red');
                                    viewFilesBtn.classList.add('btn-view-files-blue');
                                }
                            }
                        }
                    });
                };

                // Function to initialize disabled rows for already sent items
                function initializeDisabledRows() {
                    console.log('[DEBUG] Initializing sent rows...');

                    // Find all rows with sent timestamps
                    const sentRows = document.querySelectorAll('.shipment-row[data-sent-timestamp]');
                    console.log('[DEBUG] Found', sentRows.length, 'rows with sent timestamps');

                    sentRows.forEach((row, index) => {
                        console.log(`[DEBUG] Processing sent row ${index + 1}:`, row);

                        const groupId = row.getAttribute('data-group-id');
                        const sentTimestamp = row.getAttribute('data-sent-timestamp');

                        // Store timestamp in localStorage for persistence
                        if (groupId && sentTimestamp) {
                            localStorage.setItem('sent_timestamp_' + groupId, sentTimestamp);
                            console.log(`[STORAGE] Stored sent timestamp for group ${groupId}:`, sentTimestamp);

                            // Check if 15 minutes have already passed
                            const sentDate = new Date(sentTimestamp);
                            const fifteenMinutesLater = new Date(sentDate.getTime() + (15 * 60 * 1000));
                            const now = new Date();
                            const remainingTime = fifteenMinutesLater.getTime() - now.getTime();

                            if (remainingTime <= 0) {
                                // 15 minutes have passed, disable the row (no countdown display, no green background)
                                console.log(`[LOCK] 15 minutes already passed for group ${groupId}, disabling row`);
                                disableRowAfterTimer(row, groupId);
                            } else {
                                // 15 minutes haven't passed yet, start countdown timer (no green background)
                                console.log(`[TIMER] 15 minutes not yet passed for group ${groupId}, starting countdown timer`);
                                startFifteenMinuteTimer(row, groupId, sentTimestamp);
                            }
                        } else {
                            // No timestamp available, keep as disabled (fallback)
                            console.log(`[WARNING] No timestamp available for group ${groupId}, keeping disabled`);
                            row.setAttribute('data-was-sent', 'true');
                        }
                    });

                    console.log('‚úÖ Sent rows initialization complete');
                }


                // Initialize page on load
                document.addEventListener('DOMContentLoaded', function () {
                    loadUploadStatus();

                    // RFI status is now handled by file-based checking in the backend
                    // No need to call loadRFIStatus since template uses shipment.rfi_uploaded

                    // Load sent status immediately and then with delays
                    console.log('üöÄ [SENT STATUS] Calling loadSentStatus immediately');
                    console.log('üöÄ [SENT STATUS] ===========================================');
                    loadSentStatus();

                    // DISABLED: Row locking removed - users can always change sent status
                    // initializeDisabledRows();
                    // initializeFifteenMinuteTimers();
                    console.log('‚úÖ Sent status loaded - no row locking enabled');

                    // Load sent status with a longer delay to ensure DOM is fully rendered and all other functions have run
                    setTimeout(() => {
                        console.log('üöÄ [SENT STATUS] Calling loadSentStatus after 2s delay');
                        loadSentStatus();
                    }, 2000);

                    initializeButtonStates();

                    // Check for uploaded files that might not be in localStorage
                    // This catches cases where files exist but localStorage was cleared
                    setTimeout(() => {
                        checkAllUploadedFiles();
                    }, 2000); // Delay to let other checks complete

                    // Final check to ensure sent status styling is preserved after all other functions
                    setTimeout(() => {
                        console.log('[DEBUG] [SENT STATUS] Final check to preserve sent status styling');
                        loadSentStatus();
                    }, 3000);
                });

                // Also run when window is fully loaded
                window.addEventListener('load', function () {
                    console.log('üöÄ [SENT STATUS] Window loaded, calling loadSentStatus');
                    setTimeout(() => {
                        loadSentStatus();
                    }, 1000);

                    // Set up a periodic check to ensure sent status styling is maintained
                    setInterval(() => {
                        const sentRows = document.querySelectorAll('tr[data-sent-status="yes"]');
                        sentRows.forEach(row => {
                            // Always ensure span colors are white for facility name
                            row.querySelectorAll('td span').forEach(span => {
                                span.classList.remove('text-primary', 'hover:text-primary-dark');
                                span.style.setProperty('color', 'white', 'important');
                            });

                            if (!row.classList.contains('inspection-complete') ||
                                row.style.backgroundColor !== 'rgb(34, 197, 94)') {
                                console.log('[DEBUG] [SENT STATUS] Re-applying styling to row:', row.getAttribute('data-group-id'));
                                row.classList.add('inspection-complete');
                                row.style.setProperty('background-color', '#22c55e', 'important');
                                row.style.setProperty('color', 'white', 'important');
                                row.style.setProperty('border-color', '#16a34a', 'important');

                                const tds = row.querySelectorAll('td');
                                tds.forEach(td => {
                                    td.style.setProperty('background-color', '#22c55e', 'important');
                                    td.style.setProperty('color', 'white', 'important');
                                    td.style.setProperty('border-color', '#16a34a', 'important');
                                });
                            }
                        });
                    }, 5000); // Check every 5 seconds

                    // Automatically check file status for all clients on page load
                    // Add a delay to ensure all buttons are fully rendered and prevent conflicts
                    console.log('üöÄ [FRONTEND] Page loaded, starting automatic file status check...');
                    setTimeout(() => {
                        console.log('üîÑ [FRONTEND] Starting delayed automatic file status check...');
                        checkAllClientFileStatus();
                    }, 1500); // Increased to 1500ms delay to ensure buttons are rendered

                    // Also enable pagination if needed
                    setTimeout(() => {
                        const paginationLinks = document.querySelectorAll('.pagination a');
                        if (paginationLinks.length > 0) {
                            enablePagination();
                        }
                    }, 100);
                });

                // Files popup management
                function openFilesPopup(groupId, clientName, inspectionDate) {
                    const modal = document.getElementById('filesModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const filesLoading = document.getElementById('filesLoading');
                    const filesContent = document.getElementById('filesContent');
                    const downloadBtn = document.getElementById('downloadAllBtn');

                    // Store current client and date for download functionality
                    window.currentFilesClient = clientName;
                    window.currentFilesDate = inspectionDate;
                    window.currentFilesGroupId = groupId;

                    // Set title and show modal - shows files for specific inspection date
                    modalTitle.textContent = 'Files for ' + clientName + ' - ' + inspectionDate;
                    modal.style.display = 'block';

                    // Show download button
                    downloadBtn.style.display = 'flex';

                    // Show loading state
                    filesLoading.style.display = 'block';
                    filesContent.style.display = 'none';

                    console.log('üîÑ File overlay: View Files clicked - Starting files fetch for', clientName, 'on', inspectionDate);

                    // Load files for this specific inspection date only
                    window.loadInspectionFiles(groupId, clientName, inspectionDate);
                }

                function closeFilesPopup() {
                    const modal = document.getElementById('filesModal');
                    modal.style.display = 'none';

                    // Hide download button
                    const downloadBtn = document.getElementById('downloadAllBtn');
                    downloadBtn.style.display = 'none';
                }

                // Download all files for current inspection group as ZIP
                async function downloadAllFiles() {
                    const downloadBtn = document.getElementById('downloadAllBtn');
                    const clientName = window.currentFilesClient;
                    const inspectionDate = window.currentFilesDate;
                    const groupId = window.currentFilesGroupId;

                    if (!clientName || !inspectionDate) {
                        alert('Error: Missing client or inspection date information');
                        return;
                    }

                    // Show loading state
                    const originalText = downloadBtn.innerHTML;
                    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating ZIP...';
                    downloadBtn.disabled = true;

                    try {
                        console.log('üóÇÔ∏è Starting download of all files for ' + clientName + ' on ' + inspectionDate);

                        const response = await fetch('/inspections/download-all-files/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_name: clientName,
                                inspection_date: inspectionDate,
                                group_id: groupId
                            })
                        });

                        if (response.ok) {
                            // Get the blob from response
                            const blob = await response.blob();
                            const contentDisposition = response.headers.get('Content-Disposition');

                            // Extract filename from header or create default
                            let filename = clientName + '_' + inspectionDate + '_all_files.zip';
                            if (contentDisposition) {
                                const match = contentDisposition.match(/filename[;^;=\n]*=([^;\n]*)/);
                                if (match && match[1]) {
                                    filename = match[1].replace(/['"]/g, '');
                                }
                            }

                            // Create download link
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();

                            // Cleanup
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);

                            console.log('‚úÖ Download completed: ' + filename);
                        } else {
                            const errorData = await response.json();
                            alert('Download failed: ' + (errorData.error || 'Unknown error'));
                        }

                    } catch (error) {
                        console.error('‚ùå Download error:', error);
                        alert('Download failed: ' + error.message);
                    } finally {
                        // Reset button state
                        downloadBtn.innerHTML = originalText;
                        downloadBtn.disabled = false;
                    }
                }

                // Close modal when clicking outside
                window.onclick = function (event) {
                    const modal = document.getElementById('filesModal');
                    if (event.target === modal) {
                        closeFilesPopup();
                    }
                };

                window.loadInspectionFiles = async function loadInspectionFiles(groupId, clientName, inspectionDate) {
                    try {
                        console.log('üîÑ File fetch: Starting file fetch request...');
                        console.log('[DEBUG] DEBUG: Group ID:', groupId);
                        console.log('[DEBUG] DEBUG: Client Name:', clientName);
                        console.log('[DEBUG] DEBUG: Inspection Date:', inspectionDate);

                        const requestData = {
                            group_id: groupId,
                            client_name: clientName,
                            inspection_date: inspectionDate,
                            _force_refresh: true
                        };
                        console.log('DEBUG: Request data being sent:', JSON.stringify(requestData, null, 2));

                        const response = await fetch('/inspections/files/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify(requestData)
                        });

                        console.log('[DEBUG] DEBUG: Response status:', response.status);
                        console.log('DEBUG: Response headers:', Object.fromEntries(response.headers.entries()));

                        const result = await response.json();
                        console.log('üîÑ File fetch: File fetch completed:', result.success);
                        console.log('DEBUG: Full server response:', JSON.stringify(result, null, 2));

                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';

                        if (result.success) {
                            console.log('üîÑ File fetch: Success - processing files...');
                            console.log('[DEBUG] DEBUG: Files object type:', typeof result.files);
                            console.log('[DEBUG] DEBUG: Files object:', result.files);
                            console.log('DEBUG: Files object keys:', Object.keys(result.files || {}));
                            console.log('DEBUG: Files object values:', Object.values(result.files || {}));
                            console.log('[DEBUG] DEBUG: Files object length:', result.files ? Object.keys(result.files).length : 'N/A');
                            console.log('[DEBUG] DEBUG: Message:', result.message);

                            // Check if files exist - verify at least one category has files
                            const hasFiles = result.files && Object.values(result.files).some(fileList =>
                                Array.isArray(fileList) && fileList.length > 0
                            );
                            console.log('[DEBUG] DEBUG: Has files check result:', hasFiles);
                            console.log('[DEBUG] DEBUG: Files check breakdown:');
                            console.log('  - result.files exists:', !!result.files);
                            console.log('  - result.files is object:', typeof result.files === 'object');
                            console.log('  - Object.keys(result.files).length:', result.files ? Object.keys(result.files).length : 'N/A');
                            console.log('  - At least one category has files:', hasFiles);

                            if (hasFiles) {
                                console.log('üìÅ Files found - displaying file list');
                                console.log('[DEBUG] DEBUG: About to call displayFiles with:', {
                                    files: result.files,
                                    message: result.message
                                });
                                displayFiles(result.files, result.message);
                            } else {
                                console.log('üìÅ No files found - showing empty message');
                                console.log('[DEBUG] DEBUG: Files object details for empty case:', {
                                    files: result.files,
                                    filesType: typeof result.files,
                                    filesKeys: result.files ? Object.keys(result.files) : 'N/A',
                                    filesLength: result.files ? Object.keys(result.files).length : 'N/A'
                                });
                                filesList.innerHTML = '<div class="no-files-message">No files found for this inspection.</div>';
                            }
                        } else {
                            console.error('‚ùå File fetch failed:', result.error);
                            console.log('[DEBUG] DEBUG: Error details:', {
                                success: result.success,
                                error: result.error,
                                fullResult: result
                            });
                            filesList.innerHTML = '<div class="error-message">Error loading files: ' + (result.error || 'Unknown error') + '</div>';
                        }

                    } catch (error) {
                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        console.log('‚ùå File fetch: File fetch error:', error);

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';
                        filesList.innerHTML = '<div class="empty-category">Network error: ' + error.message + '</div>';
                    }
                }

                function getCurrentPageClientNames() {
                    // Get all client names from the current page's shipment rows
                    const clientNames = [];
                    const shipmentRows = document.querySelectorAll('.shipment-row[data-client-name]');

                    shipmentRows.forEach(row => {
                        const clientName = row.getAttribute('data-client-name');
                        if (clientName && !clientNames.includes(clientName)) {
                            clientNames.push(clientName);
                        }
                    });

                    console.log('üìÑ Found ' + clientNames.length + ' unique clients on current page');
                    return clientNames;
                }

                function getCurrentPageClientData() {
                    // Get client names and their inspection dates from the current page
                    const clientData = {};
                    const groupRows = document.querySelectorAll('tr.group-row[data-client-name]');

                    groupRows.forEach(row => {
                        const clientName = row.getAttribute('data-client-name');
                        const inspectionDate = row.getAttribute('data-inspection-date');
                        if (clientName && inspectionDate) {
                            clientData[clientName] = inspectionDate;
                        }
                    });

                    console.log('üìÑ Found ' + Object.keys(clientData).length + ' clients with inspection dates on current page');
                    return clientData;
                }

                // Flag to prevent duplicate status checks
                if (typeof statusCheckInProgress === 'undefined') {
                    var statusCheckInProgress = false;
                }

                async function checkAllClientFileStatus() {
                    // Check file status for all clients on current page and update button colors
                    if (statusCheckInProgress) {
                        console.log('[WARNING] [FRONTEND] Status check already in progress, skipping...');
                        return;
                    }

                    statusCheckInProgress = true;

                    try {
                        const clientData = getCurrentPageClientData();
                        const clientNames = Object.keys(clientData);

                        if (clientNames.length === 0) {
                            console.log('üìÑ No clients found on current page');
                            return;
                        }

                        console.log('üîÑ [FRONTEND] Checking file status for all clients on current page...');
                        console.log('üìã [FRONTEND] Client names:', clientNames);
                        console.log('üìÖ [FRONTEND] Inspection dates:', clientData);

                        // Debug: Check if New Poultry Retailer is in the list
                        if (clientNames.includes('New Poultry Retailer')) {
                            console.log('[DEBUG] [DEBUG] Found New Poultry Retailer in client list');
                            console.log('[DEBUG] [DEBUG] Inspection date for New Poultry Retailer:', clientData['New Poultry Retailer']);
                        } else {
                            console.log('‚ùå [DEBUG] New Poultry Retailer NOT found in client list');
                            console.log('[DEBUG] [DEBUG] Available client names:', clientNames);
                        }

                        // Debug: Check if buttons are available
                        const testButtons = document.querySelectorAll('button.btn-view-files, button[class*="btn-view-files"]');
                        const allButtons = document.querySelectorAll('button');
                        console.log('[DEBUG] [FRONTEND] Found ' + testButtons.length + ' View Files buttons on page (' + allButtons.length + ' total buttons)');

                        // If no buttons found, wait a bit more
                        if (testButtons.length === 0) {
                            console.log('[WARNING] [FRONTEND] No buttons found, waiting 500ms more...');
                            statusCheckInProgress = false; // Reset flag for retry
                            setTimeout(() => {
                                console.log('üîÑ [FRONTEND] Retrying status check after button wait...');
                                checkAllClientFileStatus();
                            }, 500);
                            return;
                        }

                        // Show loading indicator
                        showStatusCheckProgress();

                        const response = await fetch('/page-clients-status/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_names: clientNames,
                                inspection_dates: clientData
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            console.log('‚úÖ File status check completed for all clients');
                            console.log('üìä Client statuses received:', result.client_statuses);

                            // Debug: Check specific client status
                            if (result.client_statuses['New Poultry Retailer']) {
                                console.log('[DEBUG] [DEBUG] New Poultry Retailer status:', result.client_statuses['New Poultry Retailer']);
                            } else {
                                console.log('‚ùå [DEBUG] New Poultry Retailer NOT found in response');
                                console.log('DEBUG: Available clients in response:', Object.keys(result.client_statuses));
                            }

                            // Update all button colors
                            const clientStatuses = result.client_statuses;
                            for (const [clientName, status] of Object.entries(clientStatuses)) {
                                console.log('üîÑ Processing client: ' + clientName + ' with status: ' + status.file_status);
                                updateViewFilesButtonColor(clientName, status.file_status);
                            }

                            // Hide loading indicator
                            hideStatusCheckProgress();

                            console.log('üé® Updated button colors for ' + Object.keys(clientStatuses).length + ' clients');
                        } else {
                            console.error('‚ùå Error checking file status:', result.error);
                            hideStatusCheckProgress();
                        }

                    } catch (error) {
                        console.error('‚ùå Error checking file status:', error);
                        hideStatusCheckProgress();
                    } finally {
                        statusCheckInProgress = false;
                    }
                }

                function showStatusCheckProgress() {
                    // Show a subtle progress indicator
                    const progressDiv = document.createElement('div');
                    progressDiv.id = 'statusCheckProgress';
                    progressDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 4px; z-index: 9999; font-size: 0.875rem;';
                    progressDiv.innerHTML = '<i class="fas fa-sync fa-spin"></i> Checking file status...';
                    document.body.appendChild(progressDiv);
                }

                function hideStatusCheckProgress() {
                    // Hide the progress indicator
                    const progressDiv = document.getElementById('statusCheckProgress');
                    if (progressDiv) {
                        progressDiv.remove();
                    }
                }
                async function loadClientAllFilesOptimized(clientName, currentPageClients) {
                    try {
                        console.log('üîÑ Client files: Starting OPTIMIZED files fetch for client:', clientName);
                        console.log('üìÑ Using current page clients for optimization:', currentPageClients.length);

                        const response = await fetch('/page-clients-files/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                target_client: clientName,
                                client_names: currentPageClients
                            })
                        });

                        const result = await response.json();
                        console.log('üîÑ Client files: OPTIMIZED files fetch completed:', result.success);

                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';

                        if (result.success) {
                            // Update button color based on file status
                            updateViewFilesButtonColor(clientName, result.file_status);

                            // Add optimization info to the display
                            const optimizationInfo = result.optimized ?
                                ' (Optimized: checked ' + result.clients_checked + ' clients from current page)' : ';';

                            displayClientAllFiles(
                                result.files,
                                result.categories,
                                result.total_files,
                                result.inspections_found,
                                result.message + optimizationInfo,
                                result.file_status
                            );
                        } else {
                            filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + result.error + '</div>';
                        }

                    } catch (error) {
                        console.error('Error loading client files:', error);
                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';
                        filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + error.message + '</div>';
                    }
                }

                async function loadClientAllFiles(clientName) {
                    try {
                        console.log('üîÑ Client files: Starting ALL files fetch for client:', clientName);

                        const response = await fetch('/client-all-files/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_name: clientName
                            })
                        });

                        const result = await response.json();
                        console.log('üîÑ Client files: ALL files fetch completed:', result.success);

                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';

                        if (result.success) {
                            displayClientAllFiles(result.files, result.categories, result.total_files, result.inspections_found, result.message);
                        } else {
                            filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + result.error + '</div>';
                        }

                    } catch (error) {
                        console.error('Error loading client files:', error);
                        const filesLoading = document.getElementById('filesLoading');
                        const filesContent = document.getElementById('filesContent');
                        const filesList = document.getElementById('filesList');

                        filesLoading.style.display = 'none';
                        filesContent.style.display = 'block';
                        filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + error.message + '</div>';
                    }
                }

                function updateViewFilesButtonColor(clientName, fileStatus) {
                    console.log('üé® Updating button color for client: "' + clientName + '"');
                    console.log('   File status: ' + fileStatus);

                    // Find all View Files buttons for this client using multiple methods
                    let buttons = [];

                    // Method 1: Look for buttons with client name in onclick attribute
                    const buttonsByOnclick = document.querySelectorAll('button[onclick*="' + clientName + '"]');
                    buttonsByOnclick.forEach(btn => {
                        if (btn.textContent.includes('View Files') || btn.textContent.includes('Files')) {
                            buttons.push(btn);
                        }
                    });

                    // Method 2: Look for buttons in rows with matching client name
                    const groupRows = document.querySelectorAll('tr.group-row[data-client-name="' + clientName + '"]');
                    groupRows.forEach(row => {
                        const viewFilesBtn = row.querySelector('button[class*="btn-view-files"]');
                        if (viewFilesBtn && !buttons.includes(viewFilesBtn)) {
                            buttons.push(viewFilesBtn);
                        }
                    });

                    // Method 3: Look for buttons with client name in quotes in onclick
                    const buttonsWithQuotes = document.querySelectorAll('button[onclick*="\'' + clientName + '\'"]');
                    buttonsWithQuotes.forEach(btn => {
                        if ((btn.textContent.includes('View Files') || btn.textContent.includes('Files')) && !buttons.includes(btn)) {
                            buttons.push(btn);
                        }
                    });

                    console.log('   Found ' + buttons.length + ' View Files buttons for "' + clientName + '"');

                    buttons.forEach((button, index) => {
                        if (button.textContent.includes('View Files') || button.textContent.includes('Files')) {
                            console.log('   Button ' + (index + 1) + ': "' + button.textContent.trim() + '"');
                            // COMPLETE REDESIGN: Clear all existing classes and styles
                            button.className = 'files-button-custom';

                            // Clear any conflicting inline styles completely
                            button.removeAttribute('style');

                            // Icons removed - buttons now show only text

                            // Add appropriate color class and icon based on status
                            switch (fileStatus) {
                                case 'all_files':
                                    button.classList.add('status-green');
                                    button.title = 'All files available (RFI, Invoice, Lab Results, Compliance)';
                                    console.log('   ‚úÖ Applied GREEN color to button');
                                    break;
                                case 'compliance_only':
                                    button.classList.add('status-orange');
                                    button.title = 'Only compliance documents available';
                                    console.log('   üü† Applied ORANGE color to button');
                                    break;
                                case 'no_files':
                                    button.classList.add('status-red');
                                    button.title = 'No files found';
                                    console.log('   üî¥ Applied RED color to button');
                                    break;
                                case 'partial_files':
                                    button.classList.add('status-orange');
                                    button.title = 'Some files available';
                                    console.log('   üü† Applied ORANGE color to button');
                                    break;
                                default:
                                    button.classList.add('status-red');
                                    button.title = 'View Files';
                            }
                        }
                    });

                    // Also update RFI and Invoice button colors based on actual file existence
                    // Skip NEW inspections - they should not have any file buttons colored
                    if (!clientName.toUpperCase().includes('NEW')) {
                        updateRFIAndInvoiceButtonColorsForClient(clientName);
                    }
                }

                function updateRFIAndInvoiceButtonColorsForClient(clientName) {
                    console.log('[DEBUG] [BUTTON COLOR] Updating RFI/Invoice button colors for all rows of client:', clientName);

                    // Find all group rows for this client
                    const groupRows = document.querySelectorAll('tr.group-row[data-client-name="' + clientName + '"]');
                    console.log('[DEBUG] [BUTTON COLOR] Found', groupRows.length, 'rows for client:', clientName);

                    groupRows.forEach(row => {
                        const inspectionDate = row.getAttribute('data-inspection-date');
                        if (inspectionDate) {
                            console.log('[DEBUG] [BUTTON COLOR] Processing row for date:', inspectionDate);
                            updateRFIAndInvoiceButtonColors(clientName, inspectionDate);
                        }
                    });
                };

                function updateRFIAndInvoiceButtonColors(clientName, inspectionDate) {
                    // CRITICAL: Strip "mobile-" prefix if present (handles mobile button client names)
                    if (clientName && clientName.startsWith('mobile-')) {
                        clientName = clientName.replace('mobile-', '');
                    }

                    console.log('[DEBUG] [API] ===== CALLING API FOR BUTTON COLORS =====');
                    console.log('[DEBUG] [API] Client:', clientName);
                    console.log('[DEBUG] [API] Date:', inspectionDate);

                    // Make API call to check specifically for RFI and Invoice files
                    fetch('/inspections/files/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            client_name: clientName,
                            inspection_date: inspectionDate,
                            _force_refresh: true
                        })
                    })
                        .then(response => {
                            console.log('[DEBUG] [API] Response status:', response.status);
                            console.log('[DEBUG] [API] Response ok:', response.ok);
                            return response.json();
                        })
                        .then(data => {
                            console.log('[DEBUG] [API] Full response data:', data);

                            if (data.success && data.files) {
                                const rfiFiles = data.files.rfi || [];
                                const invoiceFiles = data.files.invoice || [];

                                console.log('[DEBUG] [API] ‚úÖ SUCCESS - RFI files found:', rfiFiles.length);
                                console.log('[DEBUG] [API] ‚úÖ SUCCESS - Invoice files found:', invoiceFiles.length);
                                console.log('[DEBUG] [API] RFI files:', rfiFiles);
                                console.log('[DEBUG] [API] Invoice files:', invoiceFiles);

                                // Find the group row for this client and date
                                const groupRows = document.querySelectorAll('tr.group-row');
                                let targetRow = null;

                                groupRows.forEach(row => {
                                    const rowClientName = row.getAttribute('data-client-name');
                                    const rowDate = row.getAttribute('data-inspection-date');
                                    if (rowClientName === clientName && rowDate === inspectionDate) {
                                        targetRow = row;
                                    }
                                });

                                if (targetRow) {
                                    // Update RFI button (desktop)
                                    const rfiButton = targetRow.querySelector('button[id^="rfi-"]');
                                    if (rfiButton) {
                                        if (rfiFiles.length > 0) {
                                            // RFI file exists - make it green
                                            rfiButton.className = 'btn btn-sm btn-success';
                                            rfiButton.innerHTML = 'RFI ‚úì';
                                            rfiButton.title = 'RFI file uploaded';
                                            rfiButton.style.backgroundColor = '#28a745';
                                            rfiButton.style.borderColor = '#28a745';
                                            rfiButton.style.color = 'white';
                                            rfiButton.disabled = true;
                                            rfiButton.onclick = null;
                                            console.log('‚úÖ [RFI] Desktop button updated to GREEN (file exists)');
                                        } else {
                                            // No RFI file - make it RED
                                            rfiButton.className = 'btn btn-sm btn-danger';
                                            rfiButton.innerHTML = 'RFI';
                                            rfiButton.title = 'Upload RFI';
                                            rfiButton.style.backgroundColor = '#ef4444';
                                            rfiButton.style.borderColor = '#ef4444';
                                            rfiButton.style.color = 'white';
                                            rfiButton.disabled = false;
                                            // Re-enable onclick handler
                                            const groupId = rfiButton.id.replace('rfi-', '');
                                            rfiButton.onclick = function () { uploadRFI(groupId); };
                                            console.log('üî¥ [RFI] Desktop button updated to RED (no file)');
                                        }
                                    }

                                    // Update Invoice button (desktop)
                                    const invoiceButton = targetRow.querySelector('button[id^="invoice-"]');
                                    if (invoiceButton) {
                                        if (invoiceFiles.length > 0) {
                                            // Invoice file exists - make it green
                                            invoiceButton.className = 'btn btn-sm btn-success';
                                            invoiceButton.innerHTML = 'Invoice ‚úì';
                                            invoiceButton.title = 'Invoice file uploaded';
                                            invoiceButton.style.backgroundColor = '#28a745';
                                            invoiceButton.style.borderColor = '#28a745';
                                            invoiceButton.style.color = 'white';
                                            invoiceButton.disabled = true;
                                            invoiceButton.onclick = null;
                                            console.log('‚úÖ [INVOICE] Button updated to GREEN (file exists)');
                                        } else {
                                            // No Invoice file - make it RED
                                            invoiceButton.className = 'btn btn-sm btn-danger';
                                            invoiceButton.innerHTML = 'Invoice';
                                            invoiceButton.title = 'Upload Invoice';
                                            invoiceButton.style.backgroundColor = '#ef4444';
                                            invoiceButton.style.borderColor = '#ef4444';
                                            invoiceButton.style.color = 'white';
                                            invoiceButton.disabled = false;
                                            // Re-enable onclick handler
                                            const groupId = invoiceButton.id.replace('invoice-', '');
                                            invoiceButton.onclick = function () { uploadInvoice(groupId); };
                                            console.log('üî¥ [INVOICE] Desktop button updated to RED (no file)');
                                        }
                                    }
                                }

                                // ALSO update mobile buttons with same logic
                                // Find mobile buttons by ID pattern
                                const groupId = targetRow ? targetRow.getAttribute('data-group-id') : null;
                                if (groupId) {
                                    const mobileRfiButton = document.getElementById('rfi-mobile-' + groupId);
                                    const mobileInvoiceButton = document.getElementById('invoice-mobile-' + groupId);

                                    // Update mobile RFI button
                                    if (mobileRfiButton) {
                                        if (rfiFiles.length > 0) {
                                            mobileRfiButton.className = 'btn btn-sm btn-success bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium';
                                            mobileRfiButton.innerHTML = '<i class="fas fa-check mr-1"></i> RFI ‚úì';
                                            mobileRfiButton.title = 'RFI file exists';
                                            mobileRfiButton.style.backgroundColor = '#28a745';
                                            mobileRfiButton.style.borderColor = '#28a745';
                                            mobileRfiButton.style.color = 'white';
                                            mobileRfiButton.disabled = true;
                                            mobileRfiButton.onclick = null;
                                            console.log('‚úÖ [RFI] Mobile button updated to GREEN (file exists)');
                                        } else {
                                            mobileRfiButton.className = 'btn btn-sm btn-danger bg-red-500 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-red-600 transition-colors duration-200';
                                            mobileRfiButton.innerHTML = '<i class="fas fa-file-alt mr-1"></i> RFI';
                                            mobileRfiButton.title = 'Upload RFI';
                                            mobileRfiButton.style.backgroundColor = '#ef4444';
                                            mobileRfiButton.style.borderColor = '#ef4444';
                                            mobileRfiButton.style.color = 'white';
                                            mobileRfiButton.disabled = false;
                                            mobileRfiButton.onclick = function () { uploadRFI(groupId); };
                                            console.log('üî¥ [RFI] Mobile button updated to RED (no file)');
                                        }
                                    }

                                    // Update mobile Invoice button
                                    if (mobileInvoiceButton) {
                                        if (invoiceFiles.length > 0) {
                                            mobileInvoiceButton.className = 'btn btn-sm btn-success w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium';
                                            mobileInvoiceButton.innerHTML = '<i class="fas fa-check mr-1"></i> Invoice ‚úì';
                                            mobileInvoiceButton.title = 'Invoice file exists';
                                            mobileInvoiceButton.style.backgroundColor = '#28a745';
                                            mobileInvoiceButton.style.borderColor = '#28a745';
                                            mobileInvoiceButton.style.color = 'white';
                                            mobileInvoiceButton.disabled = true;
                                            mobileInvoiceButton.onclick = null;
                                            console.log('‚úÖ [Invoice] Mobile button updated to GREEN (file exists)');
                                        } else {
                                            mobileInvoiceButton.className = 'btn btn-sm btn-danger w-full bg-red-500 text-white py-2 px-3 rounded-lg text-xs font-medium hover:bg-red-600 transition-colors duration-200';
                                            mobileInvoiceButton.innerHTML = '<i class="fas fa-file-invoice mr-1"></i> Invoice';
                                            mobileInvoiceButton.title = 'Upload Invoice';
                                            mobileInvoiceButton.style.backgroundColor = '#ef4444';
                                            mobileInvoiceButton.style.borderColor = '#ef4444';
                                            mobileInvoiceButton.style.color = 'white';
                                            mobileInvoiceButton.disabled = false;
                                            mobileInvoiceButton.onclick = function () { uploadInvoice(groupId); };
                                        }
                                    }

                                    // Update composition, lab, and occurrence buttons based on API data
                                    const compositionFiles = data.files.composition || [];
                                    const labFiles = data.files.lab || [];
                                    const occurrenceFiles = data.files.occurrence || [];

                                    // Find all buttons with data-upload-btn in this row
                                    if (targetRow) {
                                        // Update Composition buttons - skip if just deleted
                                        if (!window.compositionJustDeleted) {
                                            const compositionBtns = targetRow.querySelectorAll('[data-upload-btn*="composition"]');
                                            compositionBtns.forEach(btn => {
                                                if (compositionFiles.length > 0) {
                                                    btn.style.background = '#22c55e';
                                                    btn.innerHTML = 'Upload ‚úì';
                                                } else {
                                                    btn.style.background = '#6c757d';
                                                    btn.innerHTML = 'Upload';
                                                }
                                            });
                                        }

                                        // Update Lab/COA buttons
                                        const labBtns = targetRow.querySelectorAll('[data-upload-btn*="lab"]');
                                        labBtns.forEach(btn => {
                                            if (labFiles.length > 0) {
                                                btn.style.background = '#22c55e';
                                                btn.innerHTML = 'Upload ‚úì';
                                            } else {
                                                btn.style.background = '#6c757d';
                                                btn.innerHTML = 'Upload';
                                            }
                                        });

                                        // Update Occurrence buttons
                                        const occurrenceBtns = targetRow.querySelectorAll('[data-upload-btn*="occurrence"]');
                                        occurrenceBtns.forEach(btn => {
                                            if (occurrenceFiles.length > 0) {
                                                btn.style.background = '#22c55e';
                                                btn.innerHTML = 'Upload ‚úì';
                                            } else {
                                                btn.style.background = '#6c757d';
                                                btn.innerHTML = 'Upload';
                                            }
                                        });
                                    }
                                }
                            }
                        } else {
                            console.log('[DEBUG] [API] ‚ùå API call failed or no files data');
                            console.log('[DEBUG] [API] Success:', data.success);
                            console.log('[DEBUG] [API] Error:', data.error);
                        }
            })
            .catch (error => {
                    console.error('‚ùå [API] Network error checking file status:', error);
                    console.error('‚ùå [API] Error details:', error.message);
                });
        };

                function displayClientAllFiles(files, categories, totalFiles, inspectionsFound, message = null, fileStatus = null) {
                    const filesList = document.getElementById('filesList');

                    let html = '';

                    // Show summary header with status indicator
                    const statusInfo = getFileStatusInfo(fileStatus);
                    html += `
                <div class="client-files-header" style="background: #f8fafc; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">
                        <i class="fas fa-folder-open" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                        All Files for Client
                        ${statusInfo ? '<span style="margin-left: 1rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; ' + statusInfo.style + '">' + statusInfo.text + '</span>' : ''}
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.875rem; color: #64748b;">
                        <div><strong>Total Files:</strong> ${totalFiles}</div>
                        <div><strong>Inspection Periods:</strong> ${inspectionsFound.length}</div>
                        <div><strong>Source:</strong> Local PC</div>
                    </div>
                </div>
            `;

                    // Show success message if provided
                    if (message) {
                        html += '<div class="success-message" style="background: #d4edda; color: #155724; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid #c3e6cb;">' + message + '</div>';
                    }

                    // Display files by category
                    for (const [categoryKey, categoryName] of Object.entries(categories)) {
                        const categoryFiles = files[categoryKey] || [];

                        if (categoryFiles.length === 0) {
                            continue; // Skip empty categories
                        }

                        html += `
                    <div class="file-category" style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-${getCategoryIcon(categoryKey)}" style="color: ${getCategoryColor(categoryKey)};"></i>
                            ${categoryName} (${categoryFiles.length})
                        </h5>
                        <div class="file-list" style="display: grid; gap: 0.5rem;">
                `;

                        // Group files by inspection period
                        const filesByPeriod = {};
                        categoryFiles.forEach(file => {
                            const period = file.inspection_period || 'Unknown';
                            if (!filesByPeriod[period]) {
                                filesByPeriod[period] = [];
                            }
                            filesByPeriod[period].push(file);
                        });

                        // Display files grouped by inspection period
                        for (const [period, periodFiles] of Object.entries(filesByPeriod)) {
                            // Set background and border colors based on category
                            const periodBackground = categoryKey === 'compliance' ? '#fef3c7' : '#f9fafb;'; // Yellow background for compliance
                            const periodBorderColor = categoryKey === 'compliance' ? '#fbbf24' : '#d1d5db;'; // Yellow border for compliance

                            html += `
                        <div class="inspection-period" style="background: ${periodBackground}; padding: 0.75rem; border-radius: 4px; border-left: 3px solid ${periodBorderColor};">
                            <div style="font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; font-size: 0.875rem;">
                                üìÖ ${period}${categoryKey === 'compliance' ? ' - ' + (periodFiles[0].commodity || 'Unknown Commodity') : ''}
                            </div>
                    `;

                            periodFiles.forEach(file => {
                                const fileSize = formatFileSize(file.size);
                                const modifiedDate = new Date(file.modified_time * 1000).toLocaleDateString('en-GB');

                                // Set background color based on category
                                const backgroundColor = categoryKey === 'compliance' ? '#fef3c7' : 'white;'; // Yellow background for compliance
                                const borderColor = categoryKey === 'compliance' ? '#fbbf24' : '#e5e7eb;'; // Yellow border for compliance

                                html += `
                            <div class="file-item" style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: ${backgroundColor}; border-radius: 4px; margin-bottom: 0.25rem; border: 1px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <i class="fas fa-${getFileIcon(file.name)}" style="color: ${categoryKey === 'compliance' ? '#f59e0b' : '#6b7280'};"></i>
                                    <div>
                                        <div style="font-weight: 500; color: #374151;">${file.name}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">
                                            ${fileSize} ‚Ä¢ Modified: ${modifiedDate}
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <a href="${'/inspections/download-file/?file=' + encodeURIComponent(file.relative_path || file.path || '') + '&source=' + (file.source || 'local') + '&action=download'}" download="${file.name || 'file'}" class="btn btn-sm" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-decoration: none; display: inline-flex; align-items: center;">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button class="btn btn-sm" onclick="deleteFile('${(file.relative_path || file.path || file.name).replace(/'/g, "\\'")}', '${categoryKey}')" style="background: transparent; color: #605e5c; border: 1px solid #d2d0ce; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; transition: all 0.1s ease;" onmouseenter="this.style.background='#fde7e9'; this.style.borderColor='#d13438'; this.style.color='#a4262c';" onmouseleave="this.style.background='transparent'; this.style.borderColor='#d2d0ce'; this.style.color='#605e5c';">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                            });

                            html += '</div>'; // Close inspection-period
                        }

                        html += '</div></div>'; // Close file-list and file-category
                    }

                    // Show message if no files found
                    if (totalFiles === 0) {
                        html = `
                    <div class="empty-state" style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; color: #d1d5db;"></i>
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151;">No Files Found</h4>
                        <p style="margin: 0;">No files found for this client. Run the 4-month data pull to download files from Google Drive.</p>
                    </div>
                `;
                    }

                    filesList.innerHTML = html;
                }

                function getCategoryIcon(categoryKey) {
                    const icons = {
                        'rfi': 'file-alt',
                        'invoice': 'file-invoice',
                        'lab': 'flask',
                        'retest': 'redo',
                        'compliance': 'shield-alt'
                    };
                    return icons[categoryKey] || 'file';
                }

                function getCategoryColor(categoryKey) {
                    const colors = {
                        'rfi': '#f59e0b',
                        'invoice': '#10b981',
                        'lab': '#8b5cf6',
                        'retest': '#ef4444',
                        'compliance': '#fbbf24'  // Yellow color for compliance documents
                    };
                    return colors[categoryKey] || '#6b7280';
                }

                function getFileIcon(filename) {
                    if (!filename) return 'file';
                    const ext = String(filename).split('.').pop().toLowerCase();
                    const iconMap = {
                        'pdf': 'file-pdf',
                        'doc': 'file-word',
                        'docx': 'file-word',
                        'xls': 'file-excel',
                        'xlsx': 'file-excel',
                        'jpg': 'file-image',
                        'jpeg': 'file-image',
                        'png': 'file-image',
                        'gif': 'file-image',
                        'zip': 'file-archive',
                        'rar': 'file-archive'
                    };
                    return iconMap[ext] || 'file';
                }

                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }

                function getFileStatusInfo(fileStatus) {
                    switch (fileStatus) {
                        case 'all_files':
                            return {
                                text: '‚úÖ All Files Available',
                                style: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;'
                            };
                        case 'compliance_only':
                            return {
                                text: 'üîµ Compliance Only',
                                style: 'background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;'
                            };
                        case 'no_files':
                            return {
                                text: '‚ùå No Files',
                                style: 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                            };
                        case 'partial_files':
                            return {
                                text: 'üü† Partial Files',
                                style: 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;'
                            };
                        default:
                            return null;
                    }
                }

                function displayFiles(files, message = null) {
                    const filesList = document.getElementById('filesList');

                    // EXTENSIVE DEBUG LOGGING
                    console.log('[DEBUG] displayFiles called with files:', files);
                    console.log('[DEBUG] DEBUG: files type:', typeof files);
                    console.log('DEBUG: files keys:', Object.keys(files || {}));
                    console.log('DEBUG: files values:', Object.values(files || {}));
                    console.log('[DEBUG] DEBUG: message:', message);
                    console.log('[DEBUG] DEBUG: filesList element:', filesList);

                    // Detailed analysis of files object
                    if (files) {
                        console.log('[DEBUG] DEBUG: Files object analysis:');
                        console.log('  - Is array:', Array.isArray(files));
                        console.log('  - Is object:', typeof files === 'object');
                        console.log('  - Has length property:', 'length' in files);
                        console.log('  - Length value:', files.length);
                        console.log('  - Object.keys length:', Object.keys(files).length);
                        console.log('  - Object.values length:', Object.values(files).length);

                        // Check each category
                        Object.keys(files).forEach(category => {
                            const fileList = files[category];
                            console.log(`[DEBUG] DEBUG: Category "${category}":`, {
                                type: typeof fileList,
                                isArray: Array.isArray(fileList),
                                length: fileList ? fileList.length : 'N/A',
                                content: fileList
                            });
                        });
                    } else {
                        console.log('[DEBUG] DEBUG: Files is null/undefined');
                    }

                    // Show success message if provided
                    if (message) {
                        console.log('[DEBUG] DEBUG: Adding success message:', message);
                        filesList.innerHTML = `<div class="success-message" style="background: #d4edda; color: #155724; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid #c3e6cb;">
                    <i class="fas fa-check-circle"></i> ${message}
                </div>`;
                    }

                    // Check if there are actually any files (not just empty arrays)
                    const hasFiles = files && Object.values(files).some(fileList => fileList && fileList.length > 0);
                    console.log('[DEBUG] DEBUG: hasFiles check result:', hasFiles);
                    console.log('[DEBUG] DEBUG: hasFiles breakdown:');
                    console.log('  - files exists:', !!files);
                    console.log('  - Object.values(files):', files ? Object.values(files) : 'N/A');
                    console.log('  - some() result:', files ? Object.values(files).some(fileList => fileList && fileList.length > 0) : 'N/A');

                    if (!hasFiles) {
                        console.log('[DEBUG] DEBUG: No files found - showing empty message');
                        filesList.innerHTML += '<div class="empty-category">No files found for this inspection</div>';
                        return;
                    }

                    let html = '';

                    // Define categories in order - handle both document types and commodity types
                    const documentCategories = [
                        { key: 'rfi', name: 'RFI Documents', icon: 'fas fa-file-alt' },
                        { key: 'invoice', name: 'Invoice Documents', icon: 'fas fa-file-invoice' },
                        { key: 'lab', name: 'COA', icon: 'fas fa-flask' },
                        { key: 'retest', name: 'Retest Documents', icon: 'fas fa-redo' },
                        { key: 'compliance', name: 'Compliance Documents', icon: 'fas fa-shield-alt' },
                        { key: 'composition', name: 'Composition Documents', icon: 'fas fa-vial' },
                        { key: 'occurrence', name: 'Occurrence Documents', icon: 'fas fa-exclamation-triangle' },
                        { key: 'other', name: 'Other Documents', icon: 'fas fa-folder' }
                    ];

                    // Check if files are categorized by commodity type (like POULTRY, MEAT, etc.)
                    const fileKeys = Object.keys(files);
                    const documentTypeKeys = ['rfi', 'invoice', 'lab', 'retest', 'compliance', 'composition', 'occurrence', 'other'];

                    // Check if ALL keys are document types (not commodity-based)
                    const allKeysAreDocumentTypes = fileKeys.every(key =>
                        documentTypeKeys.includes(key.toLowerCase())
                    );

                    let categories;
                    if (allKeysAreDocumentTypes && fileKeys.length > 0) {
                        // Files are categorized by document type - use predefined categories
                        categories = documentCategories;
                    } else {
                        // Files are categorized by commodity type or mixed
                        categories = fileKeys.map(key => ({
                            key: key,
                            name: `${key} Documents`,
                            icon: 'fas fa-shield-alt'
                        }));
                    }

                    categories.forEach(category => {
                        const categoryFiles = files[category.key] || [];
                        console.log(`üìÅ Processing category: ${category.key}`, categoryFiles);
                        console.log(`[DEBUG] Category key: "${category.key}", Is compliance: ${category.key === 'compliance'}`);
                        console.log(`üìÅ Files object for ${category.key}:`, files[category.key]);

                        html += `
                    <div class="file-category">
                        <div class="file-category-header">
                            <div class="category-title">
                                <i class="${category.icon}"></i>
                                ${category.name}
                            </div>
                            <div class="file-count">${categoryFiles.length}</div>
                        </div>
                        <div class="file-list">
                `;

                        if (categoryFiles.length === 0) {
                            html += '<div class="empty-category">No files in this category</div>';
                        } else {
                            categoryFiles.forEach(file => {
                                console.log(`üìÑ File processing: ${file.name}, category.key: "${category.key}", file.category: "${file.category}"`);
                                html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <i class="file-icon ${getFileIcon(file.filename || file.name)}"></i>
                                    <div class="file-details">
                                        <div class="file-name">${file.filename || file.name}</div>
                                        <div class="file-size">
                                            <span>${formatFileSize(file.size)}</span>
                                            <span>‚Ä¢</span>
                                            ${file.type ? `<span class="file-type">${file.type.toUpperCase()}</span>` : ''}
                                            <span>${file.modified || ''}</span>
                                        </div>
                                    </div>
                                <
                                /div>
                                <div class="file-actions" style="display: flex !important; gap: 8px !important; align-items: center;">
                                    ${getViewButton(file)}
                                    <a href="${'/inspections/download-file/?file=' + encodeURIComponent(file.relative_path || file.path) + '&source=' + (file.source || 'local') + '&action=download'}" download="${file.name || 'file'}" class="btn btn-file btn-secondary" style="background: #10b981 !important; color: white !important; padding: 6px 10px; border-radius: 6px; font-size: 12px;" title="Download File">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <button class="btn btn-file" style="background: transparent; color: #605e5c; padding: 6px 10px; border-radius: 4px; border: 1px solid #d2d0ce; transition: all 0.1s ease;" onclick="deleteFile('${(file.relative_path || file.path).replace(/'/g, "\\'")}', '${category.key}')" title="Delete" onmouseenter="this.style.background='#fde7e9'; this.style.borderColor='#d13438'; this.style.color='#a4262c';" onmouseleave="this.style.background='transparent'; this.style.borderColor='#d2d0ce'; this.style.color='#605e5c';">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                            });
                        }

                        html += '</div></div>';
                    });

                    filesList.innerHTML = html;
                }

                function getFileIcon(filename) {
                    if (!filename) return 'fas fa-file';
                    const ext = String(filename).split('.').pop().toLowerCase();
                    switch (ext) {
                        case 'pdf': return 'fas fa-file-pdf';
                        case 'xlsx': case 'xls': return 'fas fa-file-excel';
                        case 'docx': case 'doc': return 'fas fa-file-word';
                        case 'jpg': case 'jpeg': case 'png': return 'fas fa-file-image';
                        case 'zip': case 'rar': return 'fas fa-file-archive';
                        default: return 'fas fa-file';
                    }
                }

                function getViewButton(file) {
                    try {
                        const filename = file.filename || file.name || 'unknown';
                        const ext = filename.split('.').pop().toLowerCase();
                        const filePath = file.relative_path || file.path || '';

                        // If no valid file path, return empty string
                        if (!filePath) {
                            console.warn('[DEBUG] getViewButton: No valid file path for:', filename);
                            return '';
                        }

                        // For ZIP files, show extract/contents button instead of view
                        if (ext === 'zip' || ext === 'rar') {
                            return `<button class="btn btn-file btn-warning" onclick="showZipContents('${filePath}', '${file.source || 'local'}')" title="Show ZIP Contents" style="background: #f59e0b !important; color: white !important; padding: 6px 10px; border-radius: 6px; border: none;"><i class="fas fa-eye"></i></button>`;
                        }

                        // For viewable files (PDF, images, etc.), show view button
                        const viewableTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'txt'];
                        if (viewableTypes.includes(ext)) {
                            const viewUrl = '/inspections/download-file/?file=' + encodeURIComponent(filePath) + '&source=' + (file.source || 'local') + '&action=view';
                            return `<a href="${viewUrl}" class="btn btn-file btn-primary" target="_blank" title="View File" style="background: #3b82f6 !important; color: white !important; padding: 6px 10px; border-radius: 6px; text-decoration: none; display: inline-flex; align-items: center;"><i class="fas fa-eye"></i></a>`;
                        }

                        // For other files (Excel, Word), show info button
                        return `<button class="btn btn-file btn-info" onclick="alert('This file type opens best when downloaded')" title="Download to View" style="background: #06b6d4 !important; color: white !important; padding: 6px 10px; border-radius: 6px; border: none;"><i class="fas fa-info"></i></button>`;
                    } catch (e) {
                        console.error('[DEBUG] getViewButton error:', e);
                        return '';
                    }
                }

                async function showZipContents(relativePath, source = 'local') {
                    try {
                        const response = await fetch('/inspections/zip-contents/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                file_path: relativePath,
                                source: source
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Create styled ZIP contents popup matching shipment list design
                            let contentsHtml = `
                        <div class="file-category">
                            <div class="file-category-header">
                                <div class="category-title">
                                    <i class="fas fa-file-archive"></i>
                                    ZIP File Contents: ${result.zip_name}
                                </div>
                                <div class="file-count">${result.total_files}</div>
                            </div>
                            <div class="file-list">
                    ;`;

                            if (result.contents && result.contents.length > 0) {
                                result.contents.forEach(item => {
                                    contentsHtml += `
                                <div class="file-item">
                                    <div class="file-info">
                                        <i class="file-icon ${getFileIcon(item.name)}"></i>
                                        <div class="file-details">
                                            <div class="file-name">${item.name}</div>
                                            <div class="file-size">
                                                <span>${formatFileSize(item.size)}</span>
                                                <span>‚Ä¢</span>
                                                <span>Compressed: ${formatFileSize(item.compressed_size)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                                });
                            } else {
                                contentsHtml += '<div class="empty-category">No files found in ZIP</div>';
                            }

                            contentsHtml += '</div></div>';

                            // Create modal matching the main files popup style
                            const overlay = document.createElement('div');
                            overlay.className = 'modal';
                            overlay.style.zIndex = '10001';

                            const modalContent = document.createElement('div');
                            modalContent.className = 'modal-content';
                            modalContent.style.maxWidth = '700px';

                            modalContent.innerHTML =
                                '<div class="modal-header">' +
                                '<div class="modal-title">' +
                                '<i class="fas fa-archive"></i>' +
                                '<span>ZIP File Contents</span>' +
                                '</div>' +
                                '<button class="modal-close" onclick="this.closest(\'.modal\').remove()" title="Close">' +
                                '<i class="fas fa-times"></i>' +
                                '</button>' +
                                '</div>' +
                                '<div class="modal-body">' +
                                contentsHtml +
                                '</div>';

                            overlay.appendChild(modalContent);
                            document.body.appendChild(overlay);

                        } else {
                            alert('Error reading ZIP contents: ' + result.error);
                        }

                    } catch (error) {
                        alert('Network error: ' + error.message);
                    }
                }
                function formatFileSize(bytes) {
                    if (!bytes) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                }

                // Send group documents function
                async function sendGroupDocuments(groupId, clientName, inspectionDate) {
                    try {
                        // Show confirmation dialog
                        const confirmed = confirm('Send all documents for ' + clientName + ' - ' + inspectionDate + '?\n\nThis will send RFI, Invoice, Lab results, and other completed documents.');

                        if (!confirmed) {
                            return;
                        }

                        // Update button state
                        const sendButton = document.getElementById('send-' + groupId);
                        const originalText = sendButton.innerHTML;
                        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                        sendButton.disabled = true;

                        // Make API call to send documents
                        const response = await fetch('/inspections/send-documents/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                group_id: groupId,
                                client_name: clientName,
                                inspection_date: inspectionDate
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Update button to show sent state
                            sendButton.innerHTML = '<i class="fas fa-check"></i> Sent';
                            sendButton.classList.add('sent');
                            sendButton.disabled = false;

                            // Show success message
                            alert('‚úÖ Documents sent successfully!\n\nSent to: ' + result.recipients + '\nDocuments: ' + result.documents_sent + '\nEmail ID: ' + result.email_id || 'N/A');
                        } else {
                            // Restore button on error
                            sendButton.innerHTML = originalText;
                            sendButton.disabled = false;
                            alert('‚ùå Error sending documents: ' + result.error);
                        }

                    } catch (error) {
                        // Restore button on network error
                        const sendButton = document.getElementById('send-' + groupId);
                        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                        sendButton.disabled = false;
                        alert('‚ùå Network error: ' + error.message);
                    }
                }

                // Upload status management
                function loadUploadStatus() {
                    // Load upload status from localStorage and update button colors
                    const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');

                    // First, apply stored upload status immediately for better UX
                    Object.keys(uploadStatus).forEach(buttonId => {
                        const button = document.getElementById(buttonId);
                        if (button && uploadStatus[buttonId]) {
                            button.classList.add('uploaded');
                            console.log('Restored upload status for ' + buttonId);
                        }
                    });

                    // Then, verify file existence in the background
                    // This ensures buttons stay green if files actually exist
                    setTimeout(() => {
                        Object.keys(uploadStatus).forEach(buttonId => {
                            if (uploadStatus[buttonId]) {
                                checkFileExists(buttonId, uploadStatus[buttonId]);
                            }
                        });
                    }, 1000); // Small delay to let page fully load
                }

                // RFI status is now handled by file-based checking in the backend
                // No need for separate loadRFIStatus function since template uses shipment.rfi_uploaded

                // Load sent status from database on page load
                function loadSentStatus() {
                    console.log('üöÄ [SENT STATUS] Starting loadSentStatus function');
                    console.log('üöÄ [SENT STATUS] Function called at:', new Date().toISOString());

                    // Get all sent status dropdowns and restore their values from the template data
                    const sentDropdowns = document.querySelectorAll('.sent-status-dropdown');
                    console.log('[DEBUG] [SENT STATUS] Found ' + sentDropdowns.length + ' sent status dropdowns');

                    // Also check how many rows we have
                    const allRows = document.querySelectorAll('tr[data-group-id]');
                    console.log('[DEBUG] [SENT STATUS] Found ' + allRows.length + ' rows with data-group-id');

                    sentDropdowns.forEach((dropdown, index) => {
                        const groupId = dropdown.getAttribute('data-group-id');
                        const currentValue = dropdown.value;
                        console.log('[DEBUG] [SENT STATUS] Processing dropdown ' + index + 1 + '/' + sentDropdowns.length + ': groupId="' + groupId + '", value="' + currentValue + '"');

                        // Apply visual styling based on current value
                        if (currentValue === 'YES') {
                            console.log('‚úÖ [SENT STATUS] Applying YES styling to dropdown for ' + groupId);
                            dropdown.style.backgroundColor = '#10b981';
                            dropdown.style.color = 'white';
                            dropdown.style.borderColor = '#059669';
                            dropdown.classList.remove('sent-no');
                            dropdown.classList.add('sent-yes');

                            // Also mark the row as complete
                            // Note: groupId from dropdown already has the correct format (with hyphens)
                            const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                            console.log('[DEBUG] [SENT STATUS] Looking for row with data-group-id="' + groupId + '":', groupRow ? 'FOUND' : 'NOT FOUND');

                            // Debug: List all available rows with data-group-id
                            const allRows = document.querySelectorAll('tr[data-group-id]');
                            console.log('[DEBUG] [SENT STATUS] Available rows:', Array.from(allRows).map(row => row.getAttribute('data-group-id')));

                            if (groupRow) {
                                groupRow.classList.add('inspection-complete');
                                groupRow.classList.add('row-locked');
                                groupRow.setAttribute('data-locked', 'true');
                                groupRow.setAttribute('data-sent-status', 'yes');
                                groupRow.setAttribute('data-was-sent', 'true');
                                console.log('üéØ [SENT STATUS] SUCCESS: Marked group ' + groupId + ' as complete and LOCKED on page load');

                                // Set span colors to white for facility name and remove conflicting classes
                                groupRow.querySelectorAll('td span').forEach(span => {
                                    span.classList.remove('text-primary', 'hover:text-primary-dark');
                                    span.style.setProperty('color', 'white', 'important');
                                });

                                // Lock the entire row - disable all interactive elements
                                if (typeof lockRow === 'function') {
                                    lockRow(groupRow);
                                } else {
                                    console.log('[WARNING] [SENT STATUS] lockRow function not available, applying basic styling');
                                    // Fallback styling if lockRow function is not available
                                    groupRow.style.borderLeft = '4px solid #22c55e';
                                }

                                // Verify the class was added
                                if (groupRow.classList.contains('inspection-complete')) {
                                    console.log('‚úÖ [SENT STATUS] VERIFIED: Row ' + groupId + ' has inspection-complete class and is LOCKED');
                                } else {
                                    console.log('‚ùå [SENT STATUS] ERROR: Row ' + groupId + ' does NOT have inspection-complete class');
                                }
                            } else {
                                console.log('‚ùå [SENT STATUS] ERROR: Could not find row for group ' + groupId);

                                // Let's see what rows we do have
                                const allGroupRows = document.querySelectorAll('tr[data-group-id]');
                                console.log('[DEBUG] [SENT STATUS] Available rows:', Array.from(allGroupRows).map(row => row.getAttribute('data-group-id')));
                            }
                        } else if (currentValue === 'NO') {
                            dropdown.style.backgroundColor = '#ef4444';
                            dropdown.style.color = 'white';
                            dropdown.style.borderColor = '#dc2626';
                            dropdown.classList.remove('sent-yes');
                            dropdown.classList.add('sent-no');

                            // Remove complete status from row and unlock it
                            const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                            if (groupRow) {
                                groupRow.classList.remove('inspection-complete');
                                groupRow.classList.remove('row-locked');
                                groupRow.removeAttribute('data-locked');
                                groupRow.removeAttribute('data-sent-status');

                                // Unlock the row if lockRow function is available
                                if (typeof unlockRow === 'function') {
                                    unlockRow(groupRow);
                                } else {
                                    // Fallback: remove styling
                                    groupRow.style.borderLeft = '';
                                }
                            }
                        } else {
                            dropdown.style.backgroundColor = 'var(--card-bg)';
                            dropdown.style.color = 'var(--text)';
                            dropdown.style.borderColor = 'var(--border)';
                            dropdown.classList.remove('sent-yes', 'sent-no');

                            // Remove complete status from row and unlock it
                            const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                            if (groupRow) {
                                groupRow.classList.remove('inspection-complete');
                                groupRow.classList.remove('row-locked');
                                groupRow.removeAttribute('data-locked');
                                groupRow.removeAttribute('data-sent-status');

                                // Unlock the row if lockRow function is available
                                if (typeof unlockRow === 'function') {
                                    unlockRow(groupRow);
                                } else {
                                    // Fallback: remove styling
                                    groupRow.style.borderLeft = '';
                                }
                            }
                        }

                        console.log('Restored sent status for group ' + groupId + ': ' + currentValue);
                    });

                    console.log('üèÅ [SENT STATUS] Completed loadSentStatus function');
                    console.log('üöÄ [SENT STATUS] ===========================================');
                }

                // Check all uploaded files on page load to ensure buttons are properly colored
                function checkAllUploadedFiles() {
                    console.log('[DEBUG] Checking all uploaded files on page load...');

                    // Get all upload buttons on the page
                    const uploadButtons = document.querySelectorAll('.btn-upload');

                    uploadButtons.forEach(button => {
                        const buttonId = button.i; d;
                        if (buttonId) {
                            // Check if this button is already marked as uploaded
                            if (!button.classList.contains('uploaded')) {
                                // Check if file actually exists
                                checkFileExists(buttonId, null);
                            }
                        }
                    });
                };

                function checkFileExists(buttonId, fileInfo) {
                    // Make a lightweight request to check if file exists
                    const parts = buttonId.split('-');
                    const docType = parts[0]; // Extract document type
                    const identifier = parts[1]; // Extract group ID or inspection ID

                    console.log('Checking file existence for: ' + buttonId + ' (' + docType + ' - ' + identifier + ')');

                    // Determine if this is a group upload or individual inspection upload
                    let url;
                    if (docType === 'rfi' || docType === 'invoice') {
                        url = '/list-uploaded-files/?group_id=' + identifier;
                    } else {
                        // For lab and retest, we need both group_id and inspection_id
                        // Get the group_id from the button's data attribute or parent row
                        const button = document.getElementById(buttonId);
                        let groupId = null;
                        if (button) {
                            // Try to get group_id from the button's data attribute
                            groupId = button.getAttribute('data-group-id');
                            if (!groupId) {
                                // Try to get it from the parent row
                                const row = button.closest('tr');
                                if (row) {
                                    const groupRow = row.previousElementSibling;
                                    if (groupRow && groupRow.classList.contains('group-row')) {
                                        const groupButton = groupRow.querySelector('.expand-btn');
                                        if (groupButton) {
                                            groupId = groupButton.getAttribute('data-group-id');
                                        }
                                    }
                                }
                            }
                        }

                        if (groupId) {
                            url = '/list-uploaded-files/?group_id=' + groupId + '&inspection_id=' + identifier;
                        } else {
                            url = '/list-uploaded-files/?inspection_id=' + identifier;
                        }
                    }

                    console.log('Making request to: ' + url);

                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Response for ' + buttonId + ':', data);
                            if (data.success) {
                                const files = data.files[docType] || [];
                                console.log('Files found for ' + docType + ':', files);
                                if (files.length === 0) {
                                    // File doesn't exist, reset button
                                    console.log('No files found for ' + buttonId + ', resetting button');
                                    const button = document.getElementById(buttonId);
                                    if (button) {
                                        button.classList.remove('uploaded');
                                        // Remove from localStorage
                                        const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                        delete uploadStatus[buttonId];
                                        localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                                        console.log('Removed ' + buttonId + ' from localStorage');
                                    }
                                } else {
                                    // File exists, mark button as uploaded
                                    console.log('Files found for ' + buttonId + ', marking button as uploaded');
                                    const button = document.getElementById(buttonId);
                                    if (button) {
                                        button.classList.add('uploaded');
                                        // Also save to localStorage for future page loads
                                        const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                        uploadStatus[buttonId] = true;
                                        localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                                        console.log('Added ' + buttonId + ' to localStorage');
                                    }
                                }
                            }
                        })
                        .catch(error => {
                            console.log('Error checking file existence:', error);
                            // On error, assume file doesn't exist and reset button
                            const button = document.getElementById(buttonId);
                            if (button) {
                                button.classList.remove('uploaded');
                                const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                delete uploadStatus[buttonId];
                                localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                            }
                        });
                };

                // Make markAsUploaded globally available
                window.markAsUploaded = function markAsUploaded(buttonId) {
                    // Mark button as uploaded and save to localStorage
                    console.log('[DEBUG] [DEBUG] markAsUploaded called for:', buttonId);
                    console.log('[DEBUG] [DEBUG] Button type:', buttonId.startsWith('rfi-') ? 'RFI' : buttonId.startsWith('invoice-') ? 'Invoice' : buttonId.startsWith('occurrence-') ? 'Occurrence' : 'Unknown');

                    const button = document.getElementById(buttonId);
                    console.log('[DEBUG] [DEBUG] Button element found:', button);
                    console.log('[DEBUG] [DEBUG] Button current innerHTML:', button ? button.innerHTML : 'N/A');
                    console.log('[DEBUG] [DEBUG] Button current disabled state:', button ? button.disabled : 'N/A');

                    if (button) {
                        console.log('[DEBUG] [DEBUG] Button found, updating to show uploaded state');

                        // Clear the file-deleted flag since a new file has been uploaded
                        button.removeAttribute('data-file-deleted');
                        console.log('[DEBUG] [DEBUG] Removed data-file-deleted attribute');

                        // Get current user first name from template context
                        const currentUserName = '{{ request.user.first_name|default:request.user.username|escapejs }}';
                        console.log('[DEBUG] [DEBUG] Current user first name from template:', currentUserName);
                        console.log('[DEBUG] [DEBUG] User name length:', currentUserName.length);
                        console.log('[DEBUG] [DEBUG] User name type:', typeof currentUserName);

                        const currentDate = new Date().toLocaleDateString('en-GB', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                        console.log('[DEBUG] [DEBUG] Current date:', currentDate);

                        // Store original button state for debugging
                        const originalInnerHTML = button.innerHTML;
                        const originalDisabled = button.disabled;
                        const originalStyle = button.style.cssText;

                        console.log('[DEBUG] [DEBUG] Original button state:');
                        console.log('  - innerHTML:', originalInnerHTML);
                        console.log('  - disabled:', originalDisabled);
                        console.log('  - style:', originalStyle);

                        // Update button to show uploaded state with user's name
                        console.log('[DEBUG] [DEBUG] Setting button.disabled = true');
                        button.disabled = true;

                        console.log('[DEBUG] [DEBUG] Setting button styles...');
                        // Force override any existing styles with !important
                        button.style.setProperty('background-color', '#d4edda', 'important');
                        button.style.setProperty('color', '#155724', 'important');
                        button.style.setProperty('border-color', '#c3e6cb', 'important');
                        button.style.setProperty('cursor', 'not-allowed', 'important');

                        // Remove conflicting classes and add proper classes
                        button.classList.remove('btn-success', 'btn-secondary', 'btn-sm');
                        button.classList.add('btn-rfi', 'uploaded');

                        console.log('[DEBUG] [DEBUG] Setting button.innerHTML to user first name:', currentUserName);
                        button.innerHTML = currentUserName;

                        // Verify the change was applied
                        console.log('[DEBUG] [DEBUG] After update - button.innerHTML:', button.innerHTML);
                        console.log('[DEBUG] [DEBUG] After update - button.disabled:', button.disabled);
                        console.log('[DEBUG] [DEBUG] After update - button.style.background:', button.style.background);

                        // Determine document type from button ID
                        let docType = 'document';
                        if (buttonId.startsWith('rfi-')) {
                            docType = 'RFI';
                        } else if (buttonId.startsWith('invoice-')) {
                            docType = 'Invoice';
                        } else if (buttonId.startsWith('occurrence-')) {
                            docType = 'Occurrence';
                        }
                        console.log('[DEBUG] [DEBUG] Document type:', docType);

                        const titleText = `${docType} uploaded by ${currentUserName} on ${currentDate}`;
                        console.log('[DEBUG] [DEBUG] Setting button.title to:', titleText);
                        button.title = titleText;

                        // Remove the onclick handler since button is now disabled
                        console.log('[DEBUG] [DEBUG] Removing onclick handler');
                        button.onclick = null;

                        // Add uploaded class for any CSS styling
                        console.log('[DEBUG] [DEBUG] Adding uploaded class');
                        button.classList.add('uploaded');

                        // Save to localStorage
                        const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                        uploadStatus[buttonId] = true;
                        localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));

                        console.log('‚úÖ [DEBUG] Button update completed. Final state:');
                        console.log('  - innerHTML:', button.innerHTML);
                        console.log('  - disabled:', button.disabled);
                        console.log('  - title:', button.title);
                        console.log('  - classList:', button.classList.toString());

                    } else {
                        console.error('‚ùå [DEBUG] Button not found for ID:', buttonId);
                        console.log('[DEBUG] [DEBUG] Available buttons on page:');
                        const allButtons = document.querySelectorAll('button[id]');
                        allButtons.forEach(btn => {
                            console.log('  - Button ID:', btn.id);
                        });
                    }
                };


                // INSTANT UPDATE: After file upload, immediately update button color without checking files
                function instantUpdateViewFilesButton(clientName, inspectionDate, fileType) {
                    console.log(`‚ö° INSTANT UPDATE: ${fileType} uploaded for ${clientName} on ${inspectionDate}`);

                    // Find the View Files button for this client/date
                    const buttons = document.querySelectorAll('button.btn-view-files, button[class*="btn-view-files"]');

                    buttons.forEach(button => {
                        const btnClient = button.getAttribute('data-client-name');
                        const btnDate = button.getAttribute('data-inspection-date');

                        if (btnClient === clientName && btnDate === inspectionDate) {
                            console.log('‚úÖ Found matching button, updating to partial/complete status');

                            // Remove old status classes
                            button.classList.remove('btn-files-none', 'btn-files-checking', 'btn-danger');

                            // Add partial status (orange) - we know at least one file exists
                            button.classList.add('btn-files-partial');

                            console.log(`üé® Button updated instantly - no file checking needed!`);
                        }
                    });
                }

                // Function to automatically update all View Files button colors on page load
                async function updateAllViewFilesButtonColors() {
                    console.log('üé® Starting automatic color update for all View Files buttons');

                    // Show loading state on all View Files buttons - use multiple detection methods
                    let allViewFilesButtons = [];

                    // Method 1: By class
                    allViewFilesButtons = document.querySelectorAll('button.btn-view-files, button[class*="btn-view-files"]');
                    console.log('[DEBUG] [FRONTEND] Method 1 - Found ' + allViewFilesButtons.length + ' buttons by class');

                    // Method 2: By onclick attribute (more reliable)
                    if (allViewFilesButtons.length === 0) {
                        allViewFilesButtons = document.querySelectorAll('button[onclick*="openFilesPopup"]');
                        console.log('[DEBUG] [FRONTEND] Method 2 - Found ' + allViewFilesButtons.length + ' buttons by onclick');
                    }

                    // Method 3: By text content as fallback
                    if (allViewFilesButtons.length === 0) {
                        const allButtons = document.querySelectorAll('button');
                        allViewFilesButtons = Array.from(allButtons).filter(btn =>
                            btn.textContent.includes('View Files') ||
                            btn.textContent.includes('Files') ||
                            btn.onclick && btn.onclick.toString().includes('openFilesPopup')
                        );
                        console.log('[DEBUG] [FRONTEND] Method 3 - Found ' + allViewFilesButtons.length + ' buttons by text/onclick');
                    }

                    allViewFilesButtons.forEach(button => {
                        const icon = button.querySelector('i');
                        if (icon) {
                            icon.className = 'fas fa-sync fa-spin';
                            icon.style.color = '#6b7280';
                        }
                        button.title = 'Checking file status...';
                    });

                    // Get all client data from the current page
                    const clientData = getCurrentPageClientData();
                    const clientNames = Object.keys(clientData);

                    console.log('üìã Found ' + clientNames.length + ' unique clients to check:', clientNames);
                    console.log('üìÖ Inspection dates:', clientData);

                    if (clientNames.length === 0) {
                        console.log('[WARNING] No clients found to check');
                        // Reset loading state
                        allViewFilesButtons.forEach(button => {
                            const icon = button.querySelector('i');
                            if (icon) {
                                icon.className = 'fas fa-download';
                                icon.style.color = '#6b7280';
                            }
                            button.title = 'View Files';
                        });
                        return;
                    }

                    if (allViewFilesButtons.length === 0) {
                        console.log('[WARNING] No View Files buttons found, skipping automatic color update');
                        return;
                    }

                    try {
                        // Call the bulk status check endpoint
                        const response = await fetch('/page-clients-status/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCSRFToken()
                            },
                            body: JSON.stringify({
                                client_names: clientNames,
                                inspection_dates: clientData
                            })
                        });

                        if (!response.ok) {
                            throw new Error('HTTP error! status: ' + response.status);
                        }

                        const result = await response.json();

                        if (result.success) {
                            console.log('‚úÖ Received file status data for all clients');

                            // Update button colors for each client
                            Object.entries(result.client_statuses).forEach(([clientName, statusData]) => {
                                console.log('üé® Updating colors for ' + clientName + ': ' + statusData.file_status);
                                updateViewFilesButtonColor(clientName, statusData.file_status);
                            });

                            console.log('üé® Completed automatic color update for all buttons');
                        } else {
                            console.error('‚ùå Error getting file status:', result.error);
                        }

                    } catch (error) {
                        console.error('‚ùå Error updating View Files button colors:', error);

                        // Reset loading state on error
                        allViewFilesButtons.forEach(button => {
                            const icon = button.querySelector('i');
                            if (icon) {
                                icon.className = 'fas fa-download';
                                icon.style.color = '#6b7280';
                            }
                            button.title = 'View Files';
                        });
                    }
                }

                // Helper function to get CSRF token
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }

                // Setup expand buttons function
                function setupExpandButtons() {
                    console.log('[DEBUG] Setting up expand button event listeners');
                    const expandButtons = document.querySelectorAll('.expand-btn');
                    console.log('[DEBUG] Found expand buttons:', expandButtons.length);

                    if (expandButtons.length === 0) {
                        console.warn('[WARNING] No expand buttons found!');
                        return;
                    }

                    expandButtons.forEach((button, index) => {
                        console.log('[DEBUG] Setting up button ' + index + ':', button);
                        console.log('[DEBUG] Button group ID:', button.getAttribute('data-group-id'));
                        // Remove any existing listeners to avoid duplicates
                        button.removeEventListener('click', handleExpandClick);
                        button.addEventListener('click', handleExpandClick);
                    });
                };

                // Handle expand button click
                function handleExpandClick(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Check if this is a "New" client row (greyed out)
                    const row = this.closest('tr.greyed-out-group');
                    if (row) {
                        console.log('üö´ Expand button clicked for "New" client - action blocked');
                        return; // Prevent expansion for "New" clients
                    }

                    const groupId = this.getAttribute('data-group-id');
                    console.log('Expand button clicked for group:', groupId);
                    toggleGroup(e, groupId);
                }

                // Simple, clean expand button functionality
                document.addEventListener('click', function (e) {
                    if (e.target.closest('.expand-btn')) {
                        e.preventDefault();
                        e.stopPropagation();
                        const button = e.target.closest('.expand-btn');
                        const groupId = button.getAttribute('data-group-id');
                        console.log('[DEBUG] Expand button clicked for group:', groupId);
                        toggleGroup(e, groupId);
                    }
                });

                // Initialize page functionality when DOM is ready
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('üöÄ [FRONTEND] DOM ready, initializing page functionality...');

                    // Update View Files button colors with delays
                    setTimeout(function () {
                        console.log('üé® [FRONTEND] Starting initial automatic color update...');
                        updateAllViewFilesButtonColors();
                    }, 1000);

                    setTimeout(function () {
                        console.log('üîÑ [FRONTEND] Retrying automatic color update...');
                        updateAllViewFilesButtonColors();
                    }, 3000);

                    // Fix header positions when expanding
                    setupHeaderPositionFix();
                });

                // Function to fix header positions when expanding/collapsing
                function setupHeaderPositionFix() {
                    console.log('[DEBUG] Setting up header position fix...');

                    // Add event listeners to all expand buttons
                    document.addEventListener('click', function (e) {
                        if (e.target.closest('.expand-btn')) {
                            console.log('üîÑ Expand button clicked, fixing header positions...');
                            setTimeout(fixHeaderPositions, 100);
                        }
                    });

                    // Also fix on window resize
                    window.addEventListener('resize', function () {
                        setTimeout(fixHeaderPositions, 100);
                    });
                };

                // Function to force header positions to stay in place
                function fixHeaderPositions() {
                    const table = document.getElementById('shipmentsTable');
                    if (!table) return;

                    const thead = table.querySelector('thead');
                    if (!thead) return;

                    // Force the header to maintain its position
                    thead.style.position = 'sticky';
                    thead.style.top = '0';
                    thead.style.zIndex = '100';
                    thead.style.backgroundColor = '#f8f9fa';

                    // Force all header cells to maintain their width
                    const headerCells = thead.querySelectorAll('th');
                    headerCells.forEach((cell, index) => {
                        cell.style.position = 'sticky';
                        cell.style.top = '0';
                        cell.style.zIndex = '100';
                        cell.style.backgroundColor = '#f8f9fa';

                        // Force specific widths for problematic columns
                        if (cell.classList.contains('col-km')) {
                            cell.style.width = '120px';
                            cell.style.minWidth = '120px';
                            cell.style.maxWidth = '120px';
                        }
                        if (cell.classList.contains('col-hours')) {
                            cell.style.width = '120px';
                            cell.style.minWidth = '120px';
                            cell.style.maxWidth = '120px';
                        }
                    });

                    // Fix detail table width constraints to prevent main table shifting
                    const detailTables = document.querySelectorAll('.detail-table');
                    detailTables.forEach(detailTable => {
                        detailTable.style.maxWidth = '100%';
                        detailTable.style.minWidth = '100%';
                    });

                    const detailWrappers = document.querySelectorAll('.detail-table-wrapper');
                    detailWrappers.forEach(wrapper => {
                        wrapper.style.maxWidth = 'calc(100vw - 100px)';
                        wrapper.style.overflowX = 'auto';
                    });

                    console.log('‚úÖ Header positions fixed and detail table constrained');
                }
                // Upload RFI function
                function uploadRFI(groupId) {
                    console.log('[DEBUG] uploadRFI called with groupId:', groupId);
                    console.log('[DEBUG] Function execution starting...');

                    // Validate that groupId is provided
                    if (!groupId) {
                        alert('Error: Unable to upload RFI - missing group ID. Please refresh the page and try again.');
                        console.error('[UPLOAD] Missing groupId for RFI upload');
                        return;
                    }

                    try {
                        // Create a file input element
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.pdf';
                        fileInput.style.display = 'none';

                        console.log('‚úÖ File input element created successfully');

                        fileInput.onchange = function (e) {
                            const file = e.target.files[0];
                            if (file) {
                                // Additional client-side PDF validation
                                if (!file.name.toLowerCase().endsWith('.pdf')) {
                                    alert('Only PDF files are allowed. Please select a PDF document.');
                                    return;
                                }
                                // Create form data
                                const formData = new FormData();
                                formData.append('file', file);
                                formData.append('group_id', groupId);
                                formData.append('document_type', 'rfi');

                                // Get CSRF token
                                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                    '{{ csrf_token|escapejs }}';
                                formData.append('csrfmiddlewaretoken', csrfToken);

                                // Upload file
                                fetch('/upload-document/', {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            console.log('‚úÖ RFI uploaded successfully!');
                                            markAsUploaded('rfi-' + groupId);

                                            // INSTANT UPDATE: Update View Files button immediately without checking files
                                            const button = document.getElementById('rfi-' + groupId);
                                            if (button) {
                                                const clientName = button.getAttribute('data-client-name');
                                                const inspectionDate = button.getAttribute('data-inspection-date');
                                                if (clientName && inspectionDate) {
                                                    instantUpdateViewFilesButton(clientName, inspectionDate, 'RFI');
                                                }
                                            }

                                            // Auto-open files popup after successful upload
                                            const button = document.getElementById('rfi-' + groupId);
                                            if (button) {
                                                const clientName = button.getAttribute('data-client-name');
                                                const inspectionDate = button.getAttribute('data-inspection-date');
                                                if (clientName && inspectionDate) {
                                                    // Longer delay to ensure the upload is processed and indexed
                                                    setTimeout(() => {
                                                        openFilesPopup(groupId, clientName, inspectionDate);
                                                    }, 2500);
                                                }
                                            }
                                        } else {
                                            alert('Error uploading RFI: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        alert('Error uploading RFI: ' + error.message);
                                    });
                            }
                        };

                        console.log('‚úÖ File input onchange handler set');

                        // Trigger file selection
                        document.body.appendChild(fileInput);
                        console.log('‚úÖ File input appended to body');

                        fileInput.click();
                        console.log('‚úÖ File input click() triggered - dialog should open now');

                        document.body.removeChild(fileInput);
                        console.log('‚úÖ File input removed from body');

                    } catch (error) {
                        console.error('‚ùå Error in uploadRFI function:', error);
                        alert('Error in upload function: ' + error.message);
                    }
                }

                // Upload Occurrence function
                function uploadOccurrence(groupId) {
                    console.log('[DEBUG] uploadOccurrence called with groupId:', groupId);
                    console.log('[DEBUG] Function execution starting...');

                    // Validate that groupId is provided
                    if (!groupId) {
                        alert('Error: Unable to upload occurrence - missing group ID. Please refresh the page and try again.');
                        console.error('[UPLOAD] Missing groupId for occurrence upload');
                        return;
                    }

                    try {
                        // Create a file input element
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.pdf';
                        fileInput.style.display = 'none';

                        console.log('‚úÖ File input element created successfully');

                        fileInput.onchange = function (e) {
                            const file = e.target.files[0];
                            if (file) {
                                // Additional client-side PDF validation
                                if (!file.name.toLowerCase().endsWith('.pdf')) {
                                    alert('Only PDF files are allowed. Please select a PDF document.');
                                    return;
                                }
                                // Create form data
                                const formData = new FormData();
                                formData.append('file', file);
                                formData.append('group_id', groupId);
                                formData.append('document_type', 'occurrence');

                                // Get CSRF token
                                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                    '{{ csrf_token|escapejs }}';
                                formData.append('csrfmiddlewaretoken', csrfToken);

                                // Upload file
                                fetch('/upload-document/', {
                                    method: 'POST',
                                    body: formData
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            console.log('‚úÖ Occurrence uploaded successfully!');

                                            // CRITICAL: Update BOTH desktop and mobile Occurrence buttons
                                            const desktopButtonId = 'occurrence-' + groupId;
                                            const mobileButtonId = 'occurrence-mobile-' + groupId;
                                            const desktopButton = document.getElementById(desktopButtonId);
                                            const mobileButton = document.getElementById(mobileButtonId);

                                            const buttonsToUpdate = [];
                                            if (desktopButton) buttonsToUpdate.push({ button: desktopButton, type: 'desktop' });
                                            if (mobileButton) buttonsToUpdate.push({ button: mobileButton, type: 'mobile' });

                                            if (buttonsToUpdate.length > 0) {
                                                buttonsToUpdate.forEach(({ button, type }) => {
                                                    console.log(`‚úÖ Marking ${type} Occurrence button as uploaded`);
                                                    // Update button to green success state
                                                    button.disabled = true;
                                                    button.className = 'btn btn-sm btn-success w-full bg-green-500 text-white py-2 px-3 rounded-lg text-xs font-medium';
                                                    button.style.backgroundColor = '#28a745';
                                                    button.style.borderColor = '#28a745';
                                                    button.style.color = 'white';
                                                    button.innerHTML = '<i class="fas fa-check mr-1"></i> Upload';
                                                    button.title = 'Occurrence file exists';
                                                });
                                                console.log(`‚úÖ Updated ${buttonsToUpdate.length} Occurrence button(s) to green`);
                                            }

                                            // INSTANT UPDATE: Update View Files button immediately without checking files
                                            const buttonWithData = desktopButton || mobileButton;
                                            if (buttonWithData) {
                                                const clientName = buttonWithData.getAttribute('data-client-name');
                                                const inspectionDate = buttonWithData.getAttribute('data-inspection-date');
                                                if (clientName && inspectionDate) {
                                                    instantUpdateViewFilesButton(clientName, inspectionDate, 'Occurrence');
                                                }
                                            }

                                            // Auto-open files popup after successful upload
                                            const buttonWithData = desktopButton || mobileButton;
                                            if (buttonWithData) {
                                                const clientName = buttonWithData.getAttribute('data-client-name');
                                                const inspectionDate = buttonWithData.getAttribute('data-inspection-date');
                                                if (clientName && inspectionDate) {
                                                    // Longer delay to ensure the upload is processed and indexed
                                                    setTimeout(() => {
                                                        openFilesPopup(groupId, clientName, inspectionDate);
                                                    }, 2500);
                                                }
                                            }
                                        } else {
                                            alert('Error uploading Occurrence: ' + data.error);
                                        }
                                    })
                                    .catch(error => {
                                        alert('Error uploading Occurrence: ' + error.message);
                                    });
                            }
                        };

                        console.log('‚úÖ File input onchange handler set');

                        // Trigger file selection
                        document.body.appendChild(fileInput);
                        console.log('‚úÖ File input appended to body');

                        fileInput.click();
                        console.log('‚úÖ File input click() triggered - dialog should open now');

                        document.body.removeChild(fileInput);
                        console.log('‚úÖ File input removed from body');

                    } catch (error) {
                        console.error('‚ùå Error in uploadOccurrence function:', error);
                        alert('Error in upload function: ' + error.message);
                    }
                }

                // Note: uploadComposition function is now in upload_functions.js

                // Upload Invoice function
                function uploadInvoice(groupId) {
                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Additional client-side PDF validation
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }
                            // Create form data
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('group_id', groupId);
                            formData.append('document_type', 'invoice');

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Invoice uploaded successfully!');
                                        console.log('[DEBUG] About to call markAsUploaded for invoice-' + groupId);
                                        markAsUploaded('invoice-' + groupId);
                                        console.log('[DEBUG] markAsUploaded called for invoice-' + groupId);

                                        // INSTANT UPDATE: Update View Files button immediately without checking files
                                        const button = document.getElementById('invoice-' + groupId);
                                        if (button) {
                                            const clientName = button.getAttribute('data-client-name');
                                            const inspectionDate = button.getAttribute('data-inspection-date');
                                            if (clientName && inspectionDate) {
                                                instantUpdateViewFilesButton(clientName, inspectionDate, 'Invoice');
                                            }
                                        }

                                        // Auto-open files popup after successful upload
                                        const button = document.getElementById('invoice-' + groupId);
                                        if (button) {
                                            const clientName = button.getAttribute('data-client-name');
                                            const inspectionDate = button.getAttribute('data-inspection-date');
                                            if (clientName && inspectionDate) {
                                                // Longer delay to ensure the upload is processed and indexed
                                                setTimeout(() => {
                                                    openFilesPopup(groupId, clientName, inspectionDate);
                                                }, 2500);
                                            }
                                        }
                                    } else {
                                        alert('Error uploading Invoice: ' + data.error);
                                    }
                                })
                                .catch(error => {
                                    alert('Error uploading Invoice: ' + error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                }

                // Upload Lab function
                window.uploadLab = function uploadLab(inspectionId) {
                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Additional client-side PDF validation
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }
                            // Get the group_id from the button's data attribute
                            const button = document.getElementById('lab-' + inspectionId);
                            let groupId = null;
                            if (button) {
                                groupId = button.getAttribute('data-group-id');
                            }

                            // Create form data
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', inspectionId);
                            formData.append('document_type', 'lab');
                            if (groupId) {
                                formData.append('group_id', groupId);
                            }

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Lab upload response:', data);
                                    if (data.success) {
                                        console.log('‚úÖ Lab report uploaded successfully!');
                                        console.log('Marking lab button as uploaded:', 'lab-' + inspectionId);
                                        markAsUploaded('lab-' + inspectionId);

                                        // Auto-open files popup after successful upload
                                        const button = document.getElementById('lab-' + inspectionId);
                                        if (button) {
                                            const groupId = button.getAttribute('data-group-id');
                                            const clientName = button.getAttribute('data-client-name');
                                            const inspectionDate = button.getAttribute('data-inspection-date');
                                            if (groupId && clientName && inspectionDate) {
                                                // Longer delay to ensure the upload is processed and indexed
                                                setTimeout(() => {
                                                    openFilesPopup(groupId, clientName, inspectionDate);
                                                }, 2500);
                                            }
                                        }
                                    } else {
                                        console.error('‚ùå Error uploading Lab report:', data.error);
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading Lab report:', error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                }

                // Upload Lab Form function
                window.uploadLabForm = function uploadLabForm(inspectionId) {
                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Additional client-side PDF validation
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }
                            // Get the group_id from the button's data attribute
                            const button = document.getElementById('lab-form-' + inspectionId);
                            let groupId = null;
                            if (button) {
                                groupId = button.getAttribute('data-group-id');
                            }

                            // Create form data
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', inspectionId);
                            formData.append('document_type', 'lab_form');
                            if (groupId) {
                                formData.append('group_id', groupId);
                            }

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Lab form upload response:', data);
                                    if (data.success) {
                                        console.log('‚úÖ Lab form submission uploaded successfully!');
                                        console.log('Marking lab form button as uploaded:', 'lab-form-' + inspectionId);
                                        markAsUploaded('lab-form-' + inspectionId);

                                        // Auto-open files popup after successful upload
                                        const button = document.getElementById('lab-form-' + inspectionId);
                                        if (button) {
                                            const groupId = button.getAttribute('data-group-id');
                                            const clientName = button.getAttribute('data-client-name');
                                            const inspectionDate = button.getAttribute('data-inspection-date');
                                            if (groupId && clientName && inspectionDate) {
                                                // Longer delay to ensure the upload is processed and indexed
                                                setTimeout(() => {
                                                    openFilesPopup(groupId, clientName, inspectionDate);
                                                }, 2500);
                                            }
                                        }
                                    } else {
                                        console.error('‚ùå Error uploading Lab form submission:', data.error);
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading Lab form submission:', error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                }

                // Upload Retest function - accepts both groupId and inspectionId (same as other uploads)
                window.uploadRetest = function uploadRetest(groupId, inspectionId) {
                    console.log('window.uploadRetest called with groupId:', groupId, 'inspectionId:', inspectionId);

                    if (!groupId && !inspectionId) {
                        alert('Error: Group ID or Inspection ID is required');
                        return;
                    }

                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Additional client-side PDF validation
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }

                            // Create form data - send both group_id and inspection_id (same as other uploads)
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('document_type', 'retest');
                            if (groupId) formData.append('group_id', groupId);
                            if (inspectionId) formData.append('inspection_id', inspectionId);

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            console.log('Uploading retest with group_id:', groupId);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log('Retest upload response:', data);
                                    if (data.success) {
                                        alert(data.message || 'Retest document uploaded successfully!');
                                        console.log('‚úÖ Retest report uploaded successfully!');

                                        // Update button to green
                                        const desktopBtn = document.getElementById('retest-btn-' + groupId);
                                        const mobileBtn = document.getElementById('retest-btn-' + groupId);

                                        [desktopBtn, mobileBtn].forEach(btn => {
                                            if (btn) {
                                                btn.style.backgroundColor = '#22c55e';
                                                btn.style.borderColor = '#22c55e';
                                                btn.disabled = true;
                                                btn.title = 'Retest file uploaded';
                                            }
                                        });

                                        // Refresh button colors
                                        if (typeof updateAllViewFilesButtonColors === 'function') {
                                            setTimeout(() => updateAllViewFilesButtonColors(), 2000);
                                        }
                                    } else {
                                        alert(data.error || 'Failed to upload retest document');
                                        console.error('‚ùå Error uploading Retest report:', data.error);
                                    }
                                })
                                .catch(error => {
                                    alert('Error uploading retest document. Please try again.');
                                    console.error('‚ùå Error uploading Retest report:', error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                }

                // ============================================
                // Inspection-level upload functions
                // ============================================

                // Upload Compliance for a specific inspection
                window.uploadComplianceForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf,.jpg,.jpeg,.png';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'compliance');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Compliance uploaded for inspection ' + productId);
                                        // Turn button green but keep enabled for multiple uploads
                                        const btn = document.querySelector('.upload-btn[data-type="compliance"][data-id="' + productId + '"]');
                                        if (btn) {
                                            btn.style.backgroundColor = '#22c55e';
                                            btn.style.borderColor = '#22c55e';
                                            btn.disabled = false;
                                            btn.style.cursor = 'pointer';
                                            btn.title = 'Compliance file exists - click to upload more';
                                            // Ensure this button can be found by id-based reset/check logic
                                            if (!btn.id) btn.id = 'compliance-' + productId;
                                            // Persist upload state so loadUploadStatus/check routines pick this up
                                            try {
                                                const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                                uploadStatus[btn.id] = true;
                                                localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                                            } catch (e) {
                                                console.error('Error saving uploadStatus for compliance:', e);
                                            }
                                        }
                                        // Also update template-style button
                                        const templateBtn = document.querySelector('[data-upload-btn="compliance-' + productId + '"]');
                                        if (templateBtn) {
                                            templateBtn.style.backgroundColor = '#22c55e';
                                            templateBtn.style.borderColor = '#22c55e';
                                            templateBtn.disabled = false;
                                            templateBtn.style.cursor = 'pointer';
                                            templateBtn.title = 'Compliance file exists - click to upload more';
                                        }
                                        alert('Compliance document uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading compliance:', data.error);
                                        alert('Error uploading compliance: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading compliance:', error);
                                    alert('Error uploading compliance: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // Upload Lab/COA for a specific inspection
                window.uploadLabForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed for lab/COA documents.');
                                return;
                            }

                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'lab');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Lab/COA uploaded for inspection ' + productId);
                                        // Turn button green
                                        const btn = document.querySelector('.upload-btn[data-type="lab"][data-id="' + productId + '"]');
                                        if (btn) btn.style.background = '#22c55e';
                                        alert('Lab/COA document uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading lab:', data.error);
                                        alert('Error uploading lab/COA: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading lab:', error);
                                    alert('Error uploading lab/COA: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // Upload Invoice for a specific inspection
                window.uploadInvoiceForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf,.jpg,.jpeg,.png';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'invoice');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Invoice uploaded for inspection ' + productId);
                                        // Turn button green
                                        const btn = document.querySelector('.upload-btn[data-type="invoice"][data-id="' + productId + '"]');
                                        if (btn) btn.style.background = '#22c55e';
                                        alert('Invoice uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading invoice:', data.error);
                                        alert('Error uploading invoice: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading invoice:', error);
                                    alert('Error uploading invoice: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // Upload Composition for a specific inspection
                window.uploadCompositionForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf,.jpg,.jpeg,.png';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'composition');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Composition uploaded for inspection ' + productId);
                                        // Turn button green
                                        const btn = document.querySelector('.upload-btn[data-type="composition"][data-id="' + productId + '"]');
                                        if (btn) btn.style.background = '#22c55e';
                                        alert('Composition uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading composition:', data.error);
                                        alert('Error uploading composition: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading composition:', error);
                                    alert('Error uploading composition: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // Upload Occurrence for a specific inspection
                window.uploadOccurrenceForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf,.jpg,.jpeg,.png';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'occurrence');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Occurrence uploaded for inspection ' + productId);
                                        // Turn button green
                                        const btn = document.querySelector('.upload-btn[data-type="occurrence"][data-id="' + productId + '"]');
                                        if (btn) btn.style.background = '#22c55e';
                                        alert('Occurrence uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading occurrence:', data.error);
                                        alert('Error uploading occurrence: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading occurrence:', error);
                                    alert('Error uploading occurrence: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // Upload Other file for a specific inspection
                window.uploadOtherForInspection = function (productId, groupId) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf,.jpg,.jpeg,.png,.doc,.docx,.xls,.xlsx';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('inspection_id', productId);
                            formData.append('document_type', 'other');
                            formData.append('group_id', groupId);

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        console.log('‚úÖ Other file uploaded for inspection ' + productId);
                                        // Turn button green but keep enabled for multiple uploads
                                        const btn = document.querySelector('[data-upload-btn="other-' + productId + '"]');
                                        if (btn) {
                                            btn.style.backgroundColor = '#22c55e';
                                            btn.style.borderColor = '#22c55e';
                                            btn.disabled = false;
                                            btn.style.cursor = 'pointer';
                                            btn.title = 'Other file exists - click to upload more';
                                        }
                                        alert('File uploaded successfully!');
                                    } else {
                                        console.error('‚ùå Error uploading file:', data.error);
                                        alert('Error uploading file: ' + (data.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error uploading file:', error);
                                    alert('Error uploading file: ' + error.message);
                                });
                        }
                    };

                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                // View document for a specific inspection by type
                window.viewDocForInspection = function (productId, docType) {
                    fetch('/list-uploaded-files/?inspection_id=' + productId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('Error: ' + data.error);
                                return;
                            }
                            // Check if we have files for this document type
                            const files = data.files || data;
                            const typeFiles = files[docType] || [];
                            if (typeFiles.length > 0) {
                                // Open the first file in a new tab
                                const file = typeFiles[0];
                                // Use download endpoint with action=view instead of direct /media/ URL
                                const filePath = file.relative_path || file.path;
                                const url = filePath ? '/inspections/download-file/?file=' + encodeURIComponent(filePath) + '&action=view' : null;
                                if (url) {
                                    window.open(url, '_blank');
                                } else {
                                    alert('No viewable URL for this document.');
                                }
                            } else {
                                alert('No ' + docType + ' document found for this inspection.');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching document:', error);
                            alert('Error fetching document: ' + error.message);
                        });
                };

                // Delete document for a specific inspection by type
                window.deleteDocForInspection = function (productId, docType) {
                    if (!confirm('Are you sure you want to delete the ' + docType + ' document for this inspection?')) {
                        return;
                    }

                    // First get the files to find the file path
                    fetch('/list-uploaded-files/?inspection_id=' + productId)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert('Error: ' + data.error);
                                return;
                            }
                            const files = data.files || data;
                            const typeFiles = files[docType] || [];
                            if (typeFiles.length === 0) {
                                alert('No ' + docType + ' document found to delete.');
                                return;
                            }

                            // Get the file to delete
                            const file = typeFiles[0];
                            const filePath = file.relative_path || file.path;

                            if (!filePath) {
                                alert('Could not determine file path for deletion.');
                                return;
                            }

                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';

                            // Now delete the file
                            fetch('/delete-inspection-file/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': csrfToken
                                },
                                body: JSON.stringify({
                                    file_path: filePath,
                                    client_name: file.client_name || '',
                                    inspection_date: file.inspection_date || ''
                                })
                            })
                                .then(response => response.json())
                                .then(deleteData => {
                                    if (deleteData.success) {
                                        console.log('‚úÖ ' + docType + ' deleted for inspection ' + productId);
                                        // Turn button back to grey
                                        const btn = document.querySelector('.upload-btn[data-type="' + docType + '"][data-id="' + productId + '"]');
                                        if (btn) btn.style.background = '#6b7280';
                                        alert(docType.charAt(0).toUpperCase() + docType.slice(1) + ' document deleted successfully!');
                                    } else {
                                        console.error('‚ùå Error deleting ' + docType + ':', deleteData.error);
                                        alert('Error deleting ' + docType + ': ' + (deleteData.error || 'Unknown error'));
                                    }
                                })
                                .catch(error => {
                                    console.error('‚ùå Error deleting ' + docType + ':', error);
                                    alert('Error deleting ' + docType + ': ' + error.message);
                                });
                        })
                        .catch(error => {
                            console.error('‚ùå Error fetching files for deletion:', error);
                            alert('Error fetching files: ' + error.message);
                        });
                };

                // View files for a specific inspection
                window.viewFilesForInspection = function (productId, commodity) {
                    const modal = document.getElementById('filesModal');
                    const modalTitle = document.getElementById('modalTitle');
                    const filesLoading = document.getElementById('filesLoading');
                    const filesContent = document.getElementById('filesContent');
                    const downloadBtn = document.getElementById('downloadAllBtn');

                    modalTitle.textContent = 'Files for ' + commodity + ' (Inspection #' + productId + ')';
                    modal.style.display = 'block';
                    downloadBtn.style.display = 'none';

                    filesLoading.style.display = 'block';
                    filesContent.style.display = 'none';

                    // Load files for this specific inspection
                    fetch('/inspections/files/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCSRFToken()
                        },
                        body: JSON.stringify({
                            inspection_id: productId
                        })
                    })
                        .then(response => response.json())
                        .then(result => {
                            filesLoading.style.display = 'none';
                            filesContent.style.display = 'block';

                            const filesList = document.getElementById('filesList');
                            if (result.success && result.files) {
                                const hasFiles = Object.values(result.files).some(arr => arr && arr.length > 0);
                                if (hasFiles) {
                                    displayFiles(result.files);
                                } else {
                                    filesList.innerHTML = '<div style="text-align: center; padding: 30px; color: #6b7280;"><i class="fas fa-folder-open" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>No files uploaded for this inspection yet</div>';
                                }
                            } else {
                                filesList.innerHTML = '<div style="text-align: center; padding: 30px; color: #6b7280;">No files found</div>';
                            }
                        })
                        .catch(error => {
                            filesLoading.style.display = 'none';
                            filesContent.style.display = 'block';
                            document.getElementById('filesList').innerHTML = '<div style="text-align: center; padding: 30px; color: #ef4444;">Error loading files: ' + error.message + '</div>';
                        });
                };

                // View all files for a group (alias for openFilesPopup)
                window.viewFilesForGroup = function (groupId, clientName, inspectionDate) {
                    openFilesPopup(groupId, clientName, inspectionDate);
                };

                // Update sample taken status function
                window.updateSampleTaken = function (checkbox) {
                    const inspectionId = checkbox.getAttribute('data-inspection-id');
                    const isSampleTaken = checkbox.checked;

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('is_sample_taken', isSampleTaken);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-sample-taken/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Sample taken status updated successfully');
                                // Show success feedback
                                checkbox.style.backgroundColor = isSampleTaken ? '#d4edda' : '#f8f9fa';
                                setTimeout(() => {
                                    checkbox.style.backgroundColor = '';
                                }, 500);

                                // Update the label text next to the checkbox
                                const label = checkbox.parentElement.querySelector('span.text-xs');
                                if (label) {
                                    label.innerHTML = isSampleTaken ?
                                        '<span class="text-green-600">‚úì Yes</span>' :
                                        '<span class="text-gray-500">No</span>';
                                }

                                // Enable/disable related fields based on sample taken status
                                const productCard = checkbox.closest('.bg-white');
                                if (productCard) {
                                    // Find all fields that depend on sample taken status
                                    const testCheckboxes = productCard.querySelectorAll('.test-checkbox');
                                    const boughtSampleInput = productCard.querySelector('.bought-sample-input');
                                    const labDropdown = productCard.querySelector('.lab-dropdown');
                                    const retestDropdown = productCard.querySelector('.needs-retest-dropdown');

                                    [testCheckboxes, boughtSampleInput, labDropdown, retestDropdown].forEach(elements => {
                                        if (elements) {
                                            if (elements.length !== undefined) {
                                                // It's a collection
                                                elements.forEach(el => {
                                                    el.disabled = !isSampleTaken;
                                                    el.style.opacity = isSampleTaken ? '1' : '0.5';
                                                    el.style.cursor = isSampleTaken ? 'pointer' : 'not-allowed';
                                                    el.title = isSampleTaken ? '' : 'No sample taken';
                                                });
                                            } else {
                                                // It's a single element
                                                elements.disabled = !isSampleTaken;
                                                elements.style.opacity = isSampleTaken ? '1' : '0.5';
                                                elements.style.cursor = isSampleTaken ? 'pointer' : 'not-allowed';
                                                elements.title = isSampleTaken ? '' : 'No sample taken - cannot enter';
                                            }
                                        }
                                    });
                                }
                            } else {
                                // Revert checkbox state on error
                                checkbox.checked = !isSampleTaken;
                                alert('Error updating sample taken status: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Revert checkbox state on error
                            checkbox.checked = !isSampleTaken;
                            alert('Error updating sample taken status: ' + error.message);
                        });
                };

                // Update test result function
                window.updateTestResult = function (checkbox) {
                    const inspectionId = checkbox.getAttribute('data-inspection-id');
                    const testType = checkbox.getAttribute('data-test-type');
                    const isChecked = checkbox.checked;

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('test_type', testType);
                    formData.append('test_result', isChecked);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-test-result/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success feedback
                                checkbox.style.backgroundColor = isChecked ? '#d4edda' : '#f8f9fa';
                                setTimeout(() => {
                                    checkbox.style.backgroundColor = '';
                                }, 500);
                            } else {
                                // Revert checkbox state on error
                                checkbox.checked = !isChecked;
                                alert('Error updating test result: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Revert checkbox state on error
                            checkbox.checked = !isChecked;
                            alert('Error updating test result: ' + error.message);
                        });
                };

                // Update needs retest function
                window.updateNeedsRetest = function (dropdown) {
                    const inspectionId = dropdown.getAttribute('data-inspection-id');
                    const needsRetest = dropdown.value;

                    // Check if dropdown is disabled (no sample taken)
                    if (dropdown.disabled) {
                        return; // Don't allow changes if disabled
                    }

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('needs_retest', needsRetest);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-needs-retest/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success feedback
                                dropdown.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    dropdown.style.backgroundColor = '';
                                }, 500);

                                // Update button states based on retest selection
                                updateButtonStates(inspectionId, needsRetest);
                            } else {
                                // Revert dropdown state on error
                                dropdown.value = '';
                                alert('Error updating needs retest: ' + data.error);
                            }
                        })
                        .catch(error => {
                            // Revert dropdown state on error
                            dropdown.value = '';
                            alert('Error updating needs retest: ' + error.message);
                        });
                };

                // Update Km Traveled function
                function updateKmTraveled(input) {
                    const inspectionId = input.getAttribute('data-inspection-id');
                    const kmValue = input.value;

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('km_traveled', kmValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-km-traveled/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                alert('Error updating Km Traveled: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error updating Km Traveled: ' + error.message);
                        });
                };

                // Update Group Km Traveled
                window.updateGroupKmTraveled = function (input) {
                    const groupId = input.getAttribute('data-group-id');
                    const kmValue = input.value;

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('km_traveled', kmValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-km-traveled/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                alert('Error updating Group Km Traveled: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error updating Group Km Traveled: ' + error.message);
                        });
                };

                // Update Group Hours
                window.updateGroupHours = function (input) {
                    const groupId = input.getAttribute('data-group-id');
                    const hoursValue = input.value;

                    // Get CSRF token
                    const csrfToken = getCSRFToken();

                    // Create form data
                    const formData = new FormData();
                    formData.append('group_id', groupId);
                    formData.append('hours', hoursValue);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-group-hours/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Show success feedback
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                alert('Error updating Group Hours: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error updating Group Hours: ' + error.message);
                        });
                };

                // Bought Sample function is now defined earlier in the file (line ~4942)

                // Get CSRF Token function
                function getCSRFToken() {
                    const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                    if (!token) {
                        console.error('CSRF token not found');
                        return '';
                    }
                    return token;
                }

                // KM, Hours, and Bought Sample functions are now defined earlier in the file (lines 4861-4980)
                console.log('‚úÖ KM, Hours, and Bought Sample update functions ready');
                console.log('[DEBUG] updateGroupKmTraveled:', typeof window.updateGroupKmTraveled);
                console.log('[DEBUG] updateGroupHours:', typeof window.updateGroupHours);
                console.log('[DEBUG] updateBoughtSample:', typeof window.updateBoughtSample);



                // Update Product Name
                window.updateProductName = function (input) {
                    // Check if field is disabled (no sample taken)
                    if (input.disabled) {
                        console.log('Product name update blocked - no sample taken');
                        return;
                    }

                    const inspectionId = input.getAttribute('data-inspection-id');
                    const value = input.value;
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('product_name', value);
                    fetch('/update-product-name/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken') || '',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    }).then(r => r.json()).then(data => {
                        if (!data.success) alert('Error updating product name: ' + (data.error || 'Unknown error'));
                    }).catch(err => alert('Error updating product name: ' + (err?.message || err)));
                }

                // Update Product Class - Simplified to only handle RAW and PMP
                window.updateProductClass = function (dropdown) {
                    // Check if field is disabled (no sample taken)
                    if (dropdown.disabled) {
                        console.log('Product class update blocked - no sample taken');
                        return;
                    }

                    // If commodity is egg/poultry, block updates and reset to empty
                    const commodity = (dropdown.getAttribute('data-commodity') || '').toLowerCase();
                    if (['egg', 'eggs', 'poultry', 'chicken'].includes(commodity)) {
                        dropdown.value = '';
                        // Remove has-value class for disabled dropdowns
                        dropdown.classList.remove('has-value');
                        alert('Product class is not applicable for Egg/Poultry commodities.');
                        return;
                    }

                    // Update border styling based on selection
                    console.log('[BORDER DEBUG] updateProductClass - Dropdown value:', dropdown.value);
                    console.log('[BORDER DEBUG] updateProductClass - Is empty?', !dropdown.value || dropdown.value === '');
                    console.log('[BORDER DEBUG] updateProductClass - Is placeholder?', dropdown.value === 'Select Class...');

                    if (dropdown.value && dropdown.value !== '' && dropdown.value !== 'Select Class...') {
                        dropdown.classList.add('has-value');
                        console.log('[BORDER DEBUG] updateProductClass - Added has-value class - should be GREEN');
                    } else {
                        dropdown.classList.remove('has-value');
                        console.log('[BORDER DEBUG] updateProductClass - Removed has-value class - should be RED');
                    }

                    // Simplified logic: Only RAW and PMP are allowed
                    const inspectionId = dropdown.getAttribute('data-inspection-id');
                    const value = dropdown.value;

                    // Send update to server
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('product_class', value);

                    fetch('/update-product-class/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken') || '',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    }).then(r => r.json()).then(data => {
                        if (!data.success) alert('Error updating product class: ' + (data.error || 'Unknown error'));
                    }).catch(err => alert('Error updating product class: ' + (err?.message || err)));
                }

                // Manual trigger function for class dropdown population
                window.populateAllClassDropdowns = function () {
                    console.log('[MANUAL] Manually populating all class dropdowns...');
                    const allDropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[MANUAL] Found', allDropdowns.length, 'class dropdowns');
                    allDropdowns.forEach(window.filterClassOptions);
                };

                // Debug function to test class dropdown population
                window.debugClassDropdowns = function () {
                    console.log('[DEBUG] === CLASS DROPDOWN DEBUG ===');
                    const allDropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[DEBUG] Total class dropdowns found:', allDropdowns.length);

                    allDropdowns.forEach((dropdown, index) => {
                        console.log(`[DEBUG] Dropdown ${index + 1}:`, {
                            element: dropdown,
                            classes: dropdown.className,
                            options: dropdown.options.length,
                            value: dropdown.value,
                            dataAttributes: {
                                'data-inspection-id': dropdown.getAttribute('data-inspection-id'),
                                'data-commodity': dropdown.getAttribute('data-commodity'),
                                'data-current-class': dropdown.getAttribute('data-current-class')
                            }
                        });
                    });

                    // Test populating all dropdowns
                    console.log('[DEBUG] Testing population...');
                    allDropdowns.forEach(window.filterClassOptions);
                };

                // Test function for border styling
                window.testBorderStyling = function () {
                    console.log('[TEST] === BORDER STYLING TEST ===');
                    const allDropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[TEST] Found', allDropdowns.length, 'class dropdowns');

                    allDropdowns.forEach((dropdown, index) => {
                        console.log(`[TEST] Testing dropdown ${index + 1}:`);
                        console.log(`[TEST] - Current value: "${dropdown.value}"`);
                        console.log(`[TEST] - Has has-value class: ${dropdown.classList.contains('has-value')}`);
                        console.log(`[TEST] - Computed border color:`, window.getComputedStyle(dropdown).borderColor);

                        // Test setting to empty
                        console.log(`[TEST] - Setting to empty...`);
                        dropdown.value = '';
                        window.updateProductClass(dropdown);
                        console.log(`[TEST] - After empty: has-value class = ${dropdown.classList.contains('has-value')}`);

                        // Test setting to placeholder
                        console.log(`[TEST] - Setting to placeholder...`);
                        dropdown.value = 'Select Class...';
                        window.updateProductClass(dropdown);
                        console.log(`[TEST] - After placeholder: has-value class = ${dropdown.classList.contains('has-value')}`);

                        // Test setting to real value
                        console.log(`[TEST] - Setting to real value...`);
                        dropdown.value = 'Raw species sausage / wors';
                        window.updateProductClass(dropdown);
                        console.log(`[TEST] - After real value: has-value class = ${dropdown.classList.contains('has-value')}`);

                        console.log(`[TEST] - Final computed border color:`, window.getComputedStyle(dropdown).borderColor);
                        console.log('---');
                    });
                };

                // Note: Duplicate filterClassOptions function removed - using window.filterClassOptions defined earlier

                // Update Lab function
                window.updateLab = function (dropdown) {
                    const inspectionId = dropdown.getAttribute('data-inspection-id');
                    const labValue = dropdown.value;

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('lab', labValue);

                    // Send update request with CSRF header
                    fetch('/update-lab/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken') || '',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    })
                        .then(async (response) => {
                            if (!response.ok) {
                                const text = await response.text();
                                throw new Error(text || ('HTTP ' + response.status));
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                dropdown.style.backgroundColor = '#d4edda';
                                setTimeout(() => { dropdown.style.backgroundColor = ''; }, 500);
                            } else {
                                alert('Error updating Lab: ' + (data.error || 'Unknown error'));
                            }
                        })
                        .catch(error => {
                            alert('Error updating Lab: ' + (error?.message || error));
                        });
                };

                // Function to handle sample status changes and update retest accordingly
                function handleSampleStatusChange(inspectionId, isSampleTaken) {
                    const dropdown = document.querySelector('select[data-inspection-id="' + inspectionId + '"]');
                    if (dropdown) {
                        if (!isSampleTaken) {
                            // No sample taken - disable dropdown and set to NO
                            dropdown.disabled = true;
                            dropdown.style.opacity = '0.5';
                            dropdown.style.cursor = 'not-allowed';
                            dropdown.value = 'NO';

                            // Update the database
                            updateNeedsRetest(dropdown);

                            // Disable both buttons
                            updateButtonStates(inspectionId, 'NO');
                        } else {
                            // Sample taken - enable dropdown
                            dropdown.disabled = false;
                            dropdown.style.opacity = '';
                            dropdown.style.cursor = '';

                            // Update button states based on current retest value
                            updateButtonStates(inspectionId, dropdown.value);
                        }
                    }
                }

                // Function to update button states based on retest selection
                function updateButtonStates(inspectionId, needsRetest) {
                    const labButton = document.getElementById('lab-' + inspectionId);
                    const retestButton = document.getElementById('retest-btn-' + inspectionId);
                    const needsRetestDropdown = document.querySelector('select[data-inspection-id="' + inspectionId + '"]');
                    const labDropdown = document.querySelector('select.lab-dropdown[data-inspection-id="' + inspectionId + '"]');

                    if (labButton && retestButton) {
                        // Check if sample was taken
                        const isSampleTaken = needsRetestDropdown && !needsRetestDropdown.disabled;

                        if (!isSampleTaken) {
                            // No sample taken - disable both buttons and lab dropdown
                            labButton.disabled = true;
                            labButton.style.opacity = '0.5';
                            labButton.style.cursor = 'not-allowed';
                            labButton.onclick = null;
                            labButton.title = 'No sample taken - Lab upload disabled';

                            retestButton.disabled = true;
                            retestButton.style.opacity = '0.5';
                            retestButton.style.cursor = 'not-allowed';
                            retestButton.onclick = null;
                            retestButton.title = 'No sample taken - Retest upload disabled';

                            // Disable lab dropdown
                            if (labDropdown) {
                                labDropdown.disabled = true;
                                labDropdown.style.opacity = '0.5';
                                labDropdown.style.cursor = 'not-allowed';
                                labDropdown.title = 'No sample taken - Lab selection disabled';
                            }
                        } else {
                            // Sample taken - enable lab button and lab dropdown
                            labButton.disabled = false;
                            labButton.style.opacity = '';
                            labButton.style.cursor = '';
                            labButton.onclick = function () { uploadLab(inspectionId); };
                            labButton.title = 'Lab result upload available';

                            // Enable lab dropdown
                            if (labDropdown) {
                                labDropdown.disabled = false;
                                labDropdown.style.opacity = '';
                                labDropdown.style.cursor = '';
                                labDropdown.title = 'Select laboratory for sample testing';
                            }

                            // Retest button is enabled ONLY if sample taken AND retest is YES (must upload document)
                            if (isSampleTaken && (needsRetest === 'YES' || needsRetest === 'yes')) {
                                retestButton.disabled = false;
                                retestButton.style.opacity = '1';
                                retestButton.style.cursor = 'pointer';
                                // DON'T override the onclick - keep the original template onclick handler
                                // which already has the correct groupId. Just ensure button is enabled.
                                retestButton.title = 'Retest required - Please upload retest document';
                            } else {
                                retestButton.disabled = true;
                                retestButton.style.opacity = '0.5';
                                retestButton.style.cursor = 'not-allowed';
                                retestButton.onclick = null;
                                if (needsRetest === 'NO' || needsRetest === 'no') {
                                    retestButton.title = 'No retest required - Upload disabled';
                                } else if (needsRetest === 'PENDING' || needsRetest === 'pending') {
                                    retestButton.title = 'Needs retest is "Pending" - retest upload disabled';
                                } else {
                                    retestButton.title = 'Select retest status first';
                                }
                            }
                        }
                    }
                }

                // Function to calculate and display OneDrive auto-upload countdown
                function updateOneDriveCountdown() {
                    const countdownElements = document.querySelectorAll('.onedrive-countdown');

                    countdownElements.forEach((element, index) => {
                        const sentDateStr = element.getAttribute('data-sent-date');
                        const onedriveUploaded = element.getAttribute('data-onedrive-uploaded') === 'true;';
                        const onedriveUploadDate = element.getAttribute('data-onedrive-upload-date');
                        const delayDays = parseFloat(element.getAttribute('data-delay-days')) || ; 3;

                        const countdownText = element.querySelector('.countdown-text');
                        if (!countdownText) return;

                        // If no sent date, show default status
                        if (!sentDateStr) {
                            countdownText.textContent = 'Not sent';
                            countdownText.style.color = '#6b7280';
                            countdownText.style.fontWeight = 'normal';
                            return;
                        }

                        // Check if files have been uploaded to OneDrive
                        if (onedriveUploaded && onedriveUploadDate) {
                            countdownText.textContent = 'Uploaded to OneDrive';
                            countdownText.style.color = '#10b981';
                            countdownText.style.fontWeight = 'bold';
                            return;
                        }

                        try {
                            const sentDate = new Date(sentDateStr);
                            const now = new Date();

                            // Check if date is valid
                            if (isNaN(sentDate.getTime())) {
                                countdownText.textContent = 'Invalid date';
                                countdownText.style.color = '#ef4444';
                                return;
                            }

                            const timeDiff = now - sentDate;
                            const totalMinutesDiff = Math.floor(timeDiff / (1000 * 60));
                            const totalHoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                            const totalDaysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));

                            // Convert delay days to minutes for precise calculation
                            const delayMinutes = delayDays * 24 * 60;
                            const minutesLeft = Math.max(0, delayMinutes - totalMinutesDiff);

                            if (minutesLeft <= 0) {
                                countdownText.textContent = 'Ready for OneDrive upload';
                                countdownText.style.color = '#10b981';
                                countdownText.style.fontWeight = 'bold';
                            } else {
                                // Calculate remaining time in appropriate units
                                const daysLeft = Math.floor(minutesLeft / (24 * 60));
                                const hoursLeft = Math.floor((minutesLeft % (24 * 60)) / 60);
                                const minsLeft = minutesLeft % 60;

                                let displayText;
                                let color = '#6b7280'

                                if (daysLeft > 0) {
                                    if (daysLeft === 1) {
                                        displayText = '1 day left until upload';
                                        color = '#f59e0b';
                                    } else {
                                        displayText = daysLeft + ' days left until upload';
                                        color = '#6b7280';
                                    }
                                } else if (hoursLeft > 0) {
                                    if (hoursLeft === 1) {
                                        displayText = '1 hour left until upload';
                                        color = '#f59e0b';
                                    } else {
                                        displayText = hoursLeft + ' hours left until upload';
                                        color = '#f59e0b';
                                    }
                                } else {
                                    if (minsLeft <= 1) {
                                        displayText = 'Uploading soon...';
                                        color = '#ef4444';
                                    } else {
                                        displayText = minsLeft + ' minutes left until upload';
                                        color = '#ef4444';
                                    }
                                }

                                countdownText.textContent = displayText;
                                countdownText.style.color = color;
                                countdownText.style.fontWeight = 'normal';
                            }
                        } catch (error) {
                            console.error('Error calculating OneDrive countdown:', error);
                            countdownText.textContent = 'Error calculating';
                            countdownText.style.color = '#ef4444';
                        }
                    });
                };

                // Make updateOneDriveCountdown globally available
                window.updateOneDriveCountdown = updateOneDriveCountdown;

                // Call countdown function immediately if DOM is already loaded
                if (document.readyState === 'loading') {
                    // Will call on DOMContentLoaded
                } else {
                    updateOneDriveCountdown();
                }

                // Update countdown every minute for real-time updates
                setInterval(updateOneDriveCountdown, 60000); // 60 seconds

                // updateSentStatus function now defined at top of script section

                // Initialize sample status indicators and apply filtering
                function initializeSampleIndicators() {
                    console.log('üî¨ Initializing sample indicators...');

                    // First, temporarily show all detail rows to read sample data
                    const detailRows = document.querySelectorAll('.detail-row');
                    const originalStates = new Map();

                    // Save original states and show all detail rows
                    detailRows.forEach(row => {
                        originalStates.set(row.id, row.style.display);
                        row.style.display = '';
                    });

                    // Process each row
                    detailRows.forEach(row => {
                        const groupId = row.id.replace('detail-', '');
                        const indicator = document.querySelector('.sample-indicator[data-group-id="' + groupId + '"]');

                        // Check if any product in this group has samples
                        const sampleBadges = row.querySelectorAll('.sampled-badge.sampled-yes');
                        const hasSamples = sampleBadges.length > 0;

                        console.log(`üî¨ Processing ${groupId}: found ${sampleBadges.length} sampled products, hasSamples=${hasSamples}`);

                        if (indicator) {
                            if (hasSamples) {
                                indicator.innerHTML = '<span class="sampled-badge sampled-yes" style="padding: 1px 3px;" title="Has samples">S</span>';
                            } else {
                                indicator.innerHTML = '<span class="sampled-badge sampled-no" style="padding: 1px 3px;" title="No samples">N</span>';
                            }
                        }

                        // Store sample status as data attribute for filtering
                        const mainRow = document.querySelector('[data-group-id="' + groupId + '"]');
                        if (mainRow) {
                            mainRow.setAttribute('data-has-samples', hasSamples);
                            console.log(`üî¨ Set data-has-samples="${hasSamples}" for ${mainRow.getAttribute('data-client-name')}`);
                        } else {
                            console.warn(`üî¨ Could not find main row for group ID: ${groupId}`);
                        }
                    });

                    // Restore original states
                    detailRows.forEach(row => {
                        const originalState = originalStates.get(row.id);
                        row.style.display = originalState || 'none';
                    });

                    console.log('‚úÖ Sample indicators initialized');

                    // Apply sample filter if one is selected
                    applySampleFilter();
                }

                // Apply sample status filtering
                function applySampleFilter() {
                    const urlParams = new URLSearchParams(window.location.search);
                    const sampleStatus = urlParams.get('sample_status');

                    console.log('üî¨ Checking sample filter. URL param:', sampleStatus);

                    if (!sampleStatus) {
                        console.log('üî¨ No sample filter applied, showing all');
                        return; // No filter applied
                    }

                    console.log('üî¨ Applying sample filter:', sampleStatus);

                    const allRows = document.querySelectorAll('.group-row.shipment-row');
                    let visibleCount = 0;
                    let hiddenCount = 0;

                    allRows.forEach(row => {
                        const hasSamples = row.getAttribute('data-has-samples') === 'true';
                        const groupId = row.getAttribute('data-group-id');
                        const detailRow = document.getElementById('detail-' + groupId);
                        const clientName = row.getAttribute('data-client-name');

                        let shouldShow = false;

                        if (sampleStatus === 'SAMPLED' && hasSamples) {
                            shouldShow = true;
                        } else if (sampleStatus === 'NOT_SAMPLED' && !hasSamples) {
                            shouldShow = true;
                        } else if (sampleStatus === '' || !sampleStatus) {
                            shouldShow = true;
                        }

                        console.log(`üî¨ ${clientName}: hasSamples=${hasSamples}, filter=${sampleStatus}, shouldShow=${shouldShow}`);

                        if (shouldShow) {
                            row.style.display = '';
                            if (detailRow) {
                                // Restore original detail row state (hidden by default)
                                if (!detailRow.style.display || detailRow.style.display === 'none') {
                                    detailRow.style.display = 'none';
                                }
                            }
                            visibleCount++;
                        } else {
                            row.style.display = 'none';
                            if (detailRow) detailRow.style.display = 'none';
                            hiddenCount++;
                        }
                    });

                    // Update the inspection count display
                    updateInspectionCount(visibleCount);

                    console.log(`‚úÖ Sample filter applied: showing ${visibleCount}, hidden ${hiddenCount} inspections`);
                }

                // Update the inspection count display
                function updateInspectionCount(count) {
                    const countElement = document.querySelector('.table-info');
                    if (countElement) {
                        const currentText = countElement.textContent;
                        const newText = currentText.replace(/Showing \d+ of \d+ inspections/, `Showing ${count} of ${count} inspections`);
                        countElement.textContent = newText;
                    }
                }

                // Manual function to trigger sample filter (for debugging)
                function triggerSampleFilter() {
                    console.log('üî¨ Manually triggering sample filter...');
                    initializeSampleIndicators();
                }
                // Debug function to check current page state
                function debugSampleFilter() {
                    console.log('üî¨ DEBUGGING SAMPLE FILTER STATE');
                    console.log('================================');

                    // Check URL parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const sampleStatus = urlParams.get('sample_status');
                    console.log('üìç URL sample_status parameter:', sampleStatus);

                    // Check all rows
                    const allRows = document.querySelectorAll('.group-row.shipment-row');
                    console.log('üìã Total rows found:', allRows.length);

                    let sampledCount = 0;
                    let notSampledCount = 0;
                    let unknownCount = 0;

                    allRows.forEach((row, index) => {
                        const clientName = row.getAttribute('data-client-name');
                        const groupId = row.getAttribute('data-group-id');
                        const hasSamples = row.getAttribute('data-has-samples');
                        const isVisible = row.style.display !== 'none';

                        console.log(`[DEBUG] Row ${index + 1}: ${clientName}`);
                        console.log(`   group-id: ${groupId}`);
                        console.log(`   data-has-samples: ${hasSamples}`);
                        console.log(`   visible: ${isVisible}`);

                        // Check detail row for actual sample badges
                        const detailRow = document.getElementById('detail-' + groupId);
                        if (detailRow) {
                            const sampleBadges = detailRow.querySelectorAll('.sampled-badge.sampled-yes');
                            const totalBadges = detailRow.querySelectorAll('.sampled-badge');
                            console.log(`   sample badges: ${sampleBadges.length}/${totalBadges.length} "Yes"`);

                            if (sampleBadges.length > 0) {
                                sampledCount++;
                            } else if (totalBadges.length > 0) {
                                notSampledCount++;
                            } else {
                                unknownCount++;
                            }
                        } else {
                            console.log(`   [WARNING] No detail row found for group-id: ${groupId}`);
                            unknownCount++;
                        }
                        console.log('');
                    });

                    console.log('üìä SUMMARY:');
                    console.log(`   Sampled inspections: ${sampledCount}`);
                    console.log(`   Not sampled inspections: ${notSampledCount}`);
                    console.log(`   Unknown status: ${unknownCount}`);
                    console.log(`   Expected sampled (from test): 2 (Nesta Foods Factory, New RMP Producer)`);
                    console.log(`   Expected not sampled (from test): 23`);

                    // Check dropdown state
                    const dropdown = document.querySelector('select[name="sample_status"]');
                    if (dropdown) {
                        console.log(`üìã Dropdown current value: "${dropdown.value}"`);
                    }

                    return {
                        totalRows: allRows.length,
                        sampledCount,
                        notSampledCount,
                        unknownCount,
                        urlParam: sampleStatus,
                        dropdownValue: dropdown ? dropdown.value : null
                    });
                };

                // Function to force apply filter manually
                function forceApplyFilter(filterType) {
                    console.log(`[DEBUG] FORCING filter application: ${filterType}`);

                    // Update dropdown
                    const dropdown = document.querySelector('select[name="sample_status"]');
                    if (dropdown) {
                        dropdown.value = filterType || '';
                    }

                    // Update URL
                    const currentUrl = new URL(window.location);
                    if (filterType) {
                        currentUrl.searchParams.set('sample_status', filterType);
                    } else {
                        currentUrl.searchParams.delete('sample_status');
                    }
                    window.history.replaceState({}, '', currentUrl.toString());

                    // Apply filter
                    initializeSampleIndicators();
                }

                // Test function to verify JavaScript is working
                function testFunction() {
                    console.log('Test function is working');
                }

                // Update countdown on page load and every minute
                document.addEventListener('DOMContentLoaded', function () {
                    updateOneDriveCountdown();
                    setInterval(updateOneDriveCountdown, 60000); // Update every minute

                    // Initialize other functions
                    initializeButtonStates();

                    // Initialize sample indicators with delay to ensure DOM is ready
                    setTimeout(() => {
                        initializeSampleIndicators();
                    }, 1000);

                    // Sample filter now handled by backend - no client-side filtering needed
                    // Just let the form submit normally to reload with backend filtering

                    // Also add listener to the form submission to ensure compatibility
                    const filterForm = document.querySelector('form[method="get"]');
                    if (filterForm) {
                        filterForm.addEventListener('submit', function (e) {
                            // Let form submit normally but also apply client-side filter
                            setTimeout(() => {
                                initializeSampleIndicators();
                            }, 100);
                        });
                    }
                });

                // Function to handle Send button clicks with validation
                // DEBUG: Function to check Lab Form column positioning
                function debugLabFormColumn() {
                    console.log('=== DEBUG: Lab Form Column Positioning ===');

                    // Check body class for role
                    const bodyClass = document.body.className;
                    console.log('Body class:', bodyClass);
                    const isInspector = bodyClass.includes('user-role-inspector');
                    console.log('Is inspector:', isInspector);

                    // Find all detail tables
                    const detailTables = document.querySelectorAll('.detail-table');
                    console.log('Found detail tables:', detailTables.length);

                    detailTables.forEach((table, index) => {
                        console.log(`\n--- Detail Table ${index + 1} ---`);

                        // Check table dimensions
                        const tableRect = table.getBoundingClientRect();
                        console.log('Table width:', tableRect.width);
                        console.log('Table position:', tableRect.left, tableRect.top);

                        // Check column 15 (Lab Form/Actions)
                        const col15Headers = table.querySelectorAll('th:nth-child(15)');
                        const col15Cells = table.querySelectorAll('td:nth-child(15)');

                        console.log('Column 15 headers found:', col15Headers.length);
                        console.log('Column 15 cells found:', col15Cells.length);

                        col15Headers.forEach((header, i) => {
                            const rect = header.getBoundingClientRect();
                            console.log(`Header ${i}:`, {
                                text: header.textContent.trim(),
                                width: rect.width,
                                left: rect.left,
                                right: rect.right,
                                visible: rect.width > 0 && rect.height > 0
                            });
                        });

                        col15Cells.forEach((cell, i) => {
                            const rect = cell.getBoundingClientRect();
                            const computedStyle = window.getComputedStyle(cell);

                            // Check buttons inside this cell
                            const labBtn = cell.querySelector('.btn-lab');
                            const labFormBtn = cell.querySelector('.btn-lab-form');
                            const retestBtn = cell.querySelector('.btn-retest');

                            console.log(`Cell ${i}:`, {
                                content: cell.textContent.trim().substring(0, 30),
                                width: rect.width,
                                left: rect.left,
                                right: rect.right,
                                visible: rect.width > 0 && rect.height > 0,
                                overflow: computedStyle.overflow,
                                position: computedStyle.position,
                                zIndex: computedStyle.zIndex,
                                buttons: {
                                    labBtn: labBtn ? {
                                        exists: true,
                                        display: window.getComputedStyle(labBtn).display,
                                        visibility: window.getComputedStyle(labBtn).visibility
                                    } : 'not found',
                                    labFormBtn: labFormBtn ? {
                                        exists: true,
                                        display: window.getComputedStyle(labFormBtn).display,
                                        visibility: window.getComputedStyle(labFormBtn).visibility
                                    } : 'not found',
                                    retestBtn: retestBtn ? {
                                        exists: true,
                                        display: window.getComputedStyle(retestBtn).display,
                                        visibility: window.getComputedStyle(retestBtn).visibility
                                    } : 'not found'
                                }
                            });
                        });

                        // Check detail-content container
                        const detailContent = table.closest('.detail-content');
                        if (detailContent) {
                            const contentRect = detailContent.getBoundingClientRect();
                            const contentStyle = window.getComputedStyle(detailContent);
                            console.log('Detail-content container:', {
                                width: contentRect.width,
                                overflowX: contentStyle.overflowX,
                                scrollWidth: detailContent.scrollWidth,
                                clientWidth: detailContent.clientWidth,
                                canScroll: detailContent.scrollWidth > detailContent.clientWidth
                            });
                        }
                    });

                    console.log('=== END DEBUG ===');
                }

                // Run debug when a detail row is expanded
                document.addEventListener('click', function (e) {
                    if (e.target.closest('.expand-btn')) {
                        setTimeout(debugLabFormColumn, 500);
                    }
                });

                function handleSendButtonClick(groupId, clientName, inspectionDate, hasAllDocuments) {
                    if (!hasAllDocuments) {
                        console.warn('[WARNING] Cannot send: Missing required documents. Ensure all compliance documents are downloaded and RFI/Invoice are uploaded.');
                        return false;
                    }

                    // If all documents are present, proceed with sending
                    sendGroupDocuments(groupId, clientName, inspectionDate);
                    return true;
                }

                // Function to initialize button states on page load
                function initializeButtonStates() {
                    // Get all retest dropdowns
                    const dropdowns = document.querySelectorAll('.needs-retest-dropdown');

                    dropdowns.forEach(dropdown => {
                        const inspectionId = dropdown.getAttribute('data-inspection-id');
                        const needsRetest = dropdown.value;

                        // Update button states based on current dropdown value
                        updateButtonStates(inspectionId, needsRetest);
                    });

                    // BACKEND FILE CHECKING: File colors are now set on backend for instant display
                    // No need to check files via JavaScript after page load
                    // File colors are already correct from Django template rendering
                    console.log('[PERFORMANCE] File button colors set by backend - no JavaScript file checking needed');
                }

                function initializeRFIAndInvoiceButtonColors() {
                    console.log('[DEBUG] [INIT] ===== STARTING RFI/INVOICE BUTTON INITIALIZATION =====');
                    console.log('[PERFORMANCE] Starting background file checks now...');

                    // Get all unique client names from the page
                    const groupRows = document.querySelectorAll('tr.group-row[data-client-name]');
                    console.log('[DEBUG] [INIT] Found', groupRows.length, 'group rows with data-client-name');

                    const processedClients = new Set();
                    let delayMs = 0; // Start immediately, but stagger each request

                    groupRows.forEach((row, index) => {
                        const clientName = row.getAttribute('data-client-name');
                        const inspectionDate = row.getAttribute('data-inspection-date');
                        console.log(`[DEBUG] [INIT] Row ${index + 1}: client="${clientName}", date="${inspectionDate}"`);

                        if (clientName && !processedClients.has(clientName)) {
                            processedClients.add(clientName);

                            // Skip NEW inspections - they should not have any file buttons colored
                            if (clientName.toUpperCase().includes('NEW')) {
                                console.log('[DEBUG] [INIT] ‚è≠Ô∏è SKIPPING NEW inspection (disabled):', clientName);
                            } else {
                                // PERFORMANCE FIX: Stagger requests with 300ms delay between each
                                setTimeout(() => {
                                    console.log('[DEBUG] [INIT] ‚úÖ Processing client:', clientName);
                                    updateRFIAndInvoiceButtonColorsForClient(clientName);
                                }, delayMs);
                                delayMs += 300; // 300ms between each request (slower, smoother)
                            }
                        } else if (clientName) {
                            console.log('[DEBUG] [INIT] ‚è≠Ô∏è SKIPPING already processed client:', clientName);
                        } else {
                            console.log('[DEBUG] [INIT] ‚ùå Row has no client name');
                        }
                    });

                    console.log('[DEBUG] [INIT] ===== FINISHED SCHEDULING', processedClients.size, 'UNIQUE CLIENTS =====');
                    console.log('[DEBUG] [INIT] Processed clients:', Array.from(processedClients));
                }
            </script>
            <script>
                async function saveManualEmail(clientName, email) {
                    try {
                        const resp = await fetch('/client/save-manual-email/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                            },
                            body: JSON.stringify({ client_name: clientName, email })
                        });

                        // Check if response is JSON
                        const contentType = resp.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            // If not JSON, likely an HTML error page
                            if (resp.status === 403) {
                                alert('Session expired. Please refresh the page and try again.');
                                window.location.reload();
                                return;
                            } else if (resp.status === 500) {
                                alert('Server error. Please try again.');
                                return;
                            } else {
                                alert('Unexpected response format. Please refresh the page and try again.');
                                return;
                            }
                        }

                        const result = await resp.json();
                        if (result.success) {
                            alert('Email saved');
                            window.location.reload();
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch (e) {
                        console.error('Network error:', e);
                        alert('Network error: ' + e.message);
                    }
                }
                async function deleteClientEmail(clientName, email) {
                    if (!confirm('Remove this email?')) return;
                    try {
                        const resp = await fetch('/client/delete-email/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                            },
                            body: JSON.stringify({ client_name: clientName, email })
                        });

                        // Check if response is JSON
                        const contentType = resp.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            // If not JSON, likely an HTML error page
                            if (resp.status === 403) {
                                alert('Session expired. Please refresh the page and try again.');
                                window.location.reload();
                                return;
                            } else if (resp.status === 500) {
                                alert('Server error. Please try again.');
                                return;
                            } else {
                                alert('Unexpected response format. Please refresh the page and try again.');
                                return;
                            }
                        }

                        const result = await resp.json();
                        if (result.success) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + result.error);
                        }
                    } catch (e) {
                        console.error('Network error:', e);
                        alert('Network error: ' + e.message);
                    }
                }

                // Inspection sync function for shipment list page
                function syncInspectionsFromShipmentList() {
                    const btn = document.querySelector('button[onclick="syncInspectionsFromShipmentList()"]');
                    const statusDiv = document.getElementById('inspection-sync-status') || createStatusDiv();

                    // Disable button and show loading state
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
                    btn.style.opacity = '0.7';
                    statusDiv.innerHTML = '';

                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';

                    fetch('{% url "refresh_inspections" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-CSRFToken': csrfToken,
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                            }
                        })
                        .then(data => {
                            if (data.success && data.status === 'started') {
                                // Background sync started - start polling
                                pollInspectionSyncStatus();
                            } else if (data.success) {
                                // Immediate success
                                updateInspectionPageAfterSync();
                                resetInspectionButton();
                            } else {
                                statusDiv.innerHTML =
                                    '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                                    '<i class="fas fa-exclamation-circle mr-2"></i>' +
                                    (data.error || 'Failed to start sync') +
                                    '</div>';
                                resetInspectionButton();
                            }
                        })
                        .catch(error => {
                            console.error('Error starting sync:', error);
                            statusDiv.innerHTML =
                                '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                                '<i class="fas fa-exclamation-circle mr-2"></i>' +
                                'Error: ' + error.message +
                                '</div>';
                            resetInspectionButton();
                        });

                    let pollCount = 0;
                    const maxPolls = 60; // 2 minutes max

                    function pollInspectionSyncStatus() {
                        pollCount++;
                        if (pollCount > maxPolls) {
                            statusDiv.innerHTML = `
                        <div class="p-4 mt-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Sync is taking longer than expected. Please check back later.
                        </div>
                    `;
                            resetInspectionButton();
                            return;
                        }

                        fetch('{% url "check_sync_status" %}', {
                            method: 'GET',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.message) {
                                    // Sync completed successfully
                                    updateInspectionPageAfterSync();
                                    resetInspectionButton();
                                } else if (data.status === 'running' || !data.success) {
                                    // Still running
                                    btn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
                                    setTimeout(pollInspectionSyncStatus, 2000);
                                } else {
                                    // Error occurred
                                    statusDiv.innerHTML =
                                        '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                                        '<i class="fas fa-exclamation-circle mr-2"></i>' +
                                        (data.error || 'Sync failed') +
                                        '</div>';
                                    resetInspectionButton();
                                }
                            })
                            .catch(error => {
                                console.error('Error checking sync status:', error);
                                statusDiv.innerHTML =
                                    '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                                    '<i class="fas fa-exclamation-circle mr-2"></i>' +
                                    'Error checking sync status: ' + error.message +
                                    '</div>';
                                resetInspectionButton();
                            });
                    }

                    function resetInspectionButton() {
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fas fa-sync-alt"></i> Sync Inspections';
                        btn.style.opacity = '1';
                    }

                    function createStatusDiv() {
                        // Create status div if it doesn't exist
                        let statusDiv = document.getElementById('inspection-sync-status');
                        if (!statusDiv) {
                            statusDiv = document.createElement('div');
                            statusDiv.id = 'inspection-sync-status';
                            statusDiv.className = 'mt-4';
                            // Insert after the sync button
                            const navItem = btn.closest('.nav-item');
                            if (navItem && navItem.parentNode) {
                                navItem.parentNode.insertBefore(statusDiv, navItem.nextSibling);
                            }
                        }
                        return statusDiv;
                    }

                    function updateInspectionPageAfterSync() {
                        // Reload the page to show updated inspection data
                        window.location.reload();
                    }

                    console.log('JavaScript finished loading successfully!');

                    // Test if timer functions are available
                    console.log('[DEBUG] Testing timer function availability...');
                    console.log('[DEBUG] initializeFifteenMinuteTimers available:', typeof initializeFifteenMinuteTimers);
                    console.log('[DEBUG] initializeDisabledRows available:', typeof initializeDisabledRows);

                    // Test if KM and Hours functions are available
                    console.log('[DEBUG] Testing KM and Hours function availability...');
                    console.log('[DEBUG] updateGroupKmTraveled available:', typeof updateGroupKmTraveled);
                    console.log('[DEBUG] updateGroupHours available:', typeof updateGroupHours);
                    console.log('[DEBUG] getCSRFToken available:', typeof getCSRFToken);

                    // Test window object functions
                    console.log('[DEBUG] Window functions - updateGroupKmTraveled:', typeof window.updateGroupKmTraveled);
                    console.log('[DEBUG] Window functions - updateGroupHours:', typeof window.updateGroupHours);
                    console.log('[DEBUG] Window functions - getCSRFToken:', typeof window.getCSRFToken);

                    // DISABLED: Row locking removed - users can always change sent status
                    // initializeFifteenMinuteTimers();
                    // initializeDisabledRows();
                    console.log('‚úÖ Row locking disabled - sent status can be changed freely');
                }

                // Initialize theme on page load
                if (typeof window.initTheme === 'function') {
                    window.initTheme();
                }

                // Email function is now defined in km_hours_fix.js as updateGroupAdditionalEmail (singular)
                // No need for complex add/remove email row functions anymore

                // Manual class dropdown fix - run this in console if dropdowns don't work
                window.fixClassDropdowns = function () {
                    console.log('[FIX] Manually fixing class dropdowns...');
                    const allDropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[FIX] Found', allDropdowns.length, 'class dropdowns');

                    allDropdowns.forEach((dropdown, index) => {
                        console.log(`[FIX] Fixing dropdown ${index + 1}:`, dropdown);

                        // Clear existing options
                        dropdown.innerHTML = '';

                        // Add placeholder
                        const placeholder = document.createElement('option');
                        placeholder.value = '';
                        placeholder.textContent = 'Select Class...';
                        dropdown.appendChild(placeholder);

                        // Add all class options
                        const allClassOptions = [
                            'Raw species sausage / wors',
                            'Extra Lean Mince',
                            'Lean Mince',
                            'Regular Mince',
                            'Raw Flavoured Ground Meat',
                            'Raw Flavoured Ground Meat & Offal',
                            'Raw Flavoured mixed species Ground Meat',
                            'Raw Flavoured mixed species Ground Meat & Offal',
                            'Raw Boerewors',
                            'Raw mixed species sausage / wors',
                            'Ground Burger / Ground patty = Extra Lean',
                            'Ground Burger / Ground patty = Lean',
                            'Ground Burger / Ground patty = Regular',
                            'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean',
                            'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean',
                            'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular',
                            'Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel',
                            'Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger',
                            'Raw Banger / Griller',
                            'Raw Bratwurst / Sizzler',
                            'Whole Muscle, uncured and heat / partial heat treated products',
                            'Whole muscle, uncured, no or partial heat treated and air dried products',
                            'Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)',
                            'Whole muscle, dry cured, no or partial heat treated products',
                            'Whole muscle, cured and no or partial heat treated products',
                            'Whole muscle, cured, no or partial heat treated and air dried products',
                            'Whole muscle, dry cured, no or partial heat treated and dried products',
                            'Comminuted, cured and heat treated products',
                            'Comminuted, uncured, no or partial heat treated and dried products',
                            'Comminuted, cured, no or partial heat treated, dried and fermented products',
                            'Comminuted, uncured and heat treated products',
                            'Reformed, uncured and no or partial heat treated products',
                            'Reformed, cured, heat treated products from single species',
                            'Reformed, cured, heat treated products from mixed species',
                            'Reformed, cured and no or partial heat treated products',
                            'Liver spreads, p√¢t√© and terrines',
                            'Products in aspic: Brawn',
                            'Product in aspic: Souse, Other products containing cured meat pieces in aspic',
                            'Products made from blood',
                            'Coated Processed Meat Products',
                            'Unspecified processed meat products'
                        ];

                        allClassOptions.forEach(optionText => {
                            const option = document.createElement('option');
                            option.value = optionText;
                            option.textContent = optionText;
                            dropdown.appendChild(option);
                        });

                        console.log(`[FIX] Dropdown ${index + 1} now has ${dropdown.options.length} options`);
                    });

                    console.log('[FIX] Class dropdown fix completed!');
                };

            </script>

            <!-- REBUILT CLASS DROPDOWN SYSTEM - Clean Implementation -->
            <script>
                console.log('[CLASS DROPDOWN] Loading rebuilt class dropdown system...');

                // Class options array - complete list
                const CLASS_OPTIONS = [
                    'Raw species sausage / wors',
                    'Extra Lean Mince',
                    'Lean Mince',
                    'Regular Mince',
                    'Raw Flavoured Ground Meat',
                    'Raw Flavoured Ground Meat & Offal',
                    'Raw Flavoured mixed species Ground Meat',
                    'Raw Flavoured mixed species Ground Meat & Offal',
                    'Raw Boerewors',
                    'Raw mixed species sausage / wors',
                    'Ground Burger / Ground patty = Extra Lean',
                    'Ground Burger / Ground patty = Lean',
                    'Ground Burger / Ground patty = Regular',
                    'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean',
                    'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean',
                    'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular',
                    'Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel',
                    'Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger',
                    'Raw Banger / Griller',
                    'Raw Bratwurst / Sizzler',
                    'Whole Muscle, uncured and heat / partial heat treated products',
                    'Whole muscle, uncured, no or partial heat treated and air dried products',
                    'Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)',
                    'Whole muscle, dry cured, no or partial heat treated products',
                    'Whole muscle, cured and no or partial heat treated products',
                    'Whole muscle, cured, no or partial heat treated and air dried products',
                    'Whole muscle, dry cured, no or partial heat treated and dried products',
                    'Comminuted, cured and heat treated products',
                    'Comminuted, uncured, no or partial heat treated and dried products',
                    'Comminuted, cured, no or partial heat treated, dried and fermented products',
                    'Comminuted, uncured and heat treated products',
                    'Reformed, uncured and no or partial heat treated products',
                    'Reformed, cured, heat treated products from single species',
                    'Reformed, cured, heat treated products from mixed species',
                    'Reformed, cured and no or partial heat treated products',
                    'Liver spreads, p√¢t√© and terrines',
                    'Products in aspic: Brawn',
                    'Product in aspic: Souse, Other products containing cured meat pieces in aspic',
                    'Products made from blood',
                    'Coated Processed Meat Products',
                    'Unspecified processed meat products'
                ];

                // Function to populate a single dropdown
                function populateClassDropdown(dropdown) {
                    console.log('[CLASS DROPDOWN] Populating dropdown:', dropdown);

                    // Get the current class value from data attribute
                    const currentClass = dropdown.getAttribute('data-current-class');
                    console.log('[CLASS DROPDOWN] Current class value:', currentClass);

                    // Clear existing options
                    dropdown.innerHTML = '';

                    // Add placeholder
                    const placeholder = document.createElement('option');
                    placeholder.value = '';
                    placeholder.textContent = 'Select Class...';
                    dropdown.appendChild(placeholder);

                    // Add all class options
                    CLASS_OPTIONS.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;

                        // Set as selected if it matches the current class
                        if (currentClass && currentClass === optionText) {
                            option.selected = true;
                            console.log('[CLASS DROPDOWN] Set option as selected:', optionText);
                        }

                        dropdown.appendChild(option);
                    });

                    // Set the dropdown value to the current class if it exists
                    if (currentClass && currentClass !== 'None' && currentClass.trim() !== '') {
                        dropdown.value = currentClass;
                        console.log('[CLASS DROPDOWN] Set dropdown value to:', currentClass);
                    } else {
                        dropdown.value = '';
                        console.log('[CLASS DROPDOWN] No current class, cleared selection');
                    }

                    console.log('[CLASS DROPDOWN] Dropdown populated with', dropdown.options.length, 'options');
                }

                // Function to populate all class dropdowns
                function populateAllClassDropdowns() {
                    console.log('[CLASS DROPDOWN] Populating all class dropdowns...');
                    const dropdowns = document.querySelectorAll('select.product-class-select');
                    console.log('[CLASS DROPDOWN] Found', dropdowns.length, 'class dropdowns');

                    dropdowns.forEach((dropdown, index) => {
                        console.log(`[CLASS DROPDOWN] Processing dropdown ${index + 1}`);
                        populateClassDropdown(dropdown);
                    });

                    console.log('[CLASS DROPDOWN] All dropdowns populated successfully!');
                }

                // Function to handle expand button clicks
                function handleExpandClick(groupId) {
                    console.log('[CLASS DROPDOWN] Expand clicked for group:', groupId);

                    // Wait a bit for the detail row to be shown
                    setTimeout(function () {
                        const detailRow = document.getElementById('detail-' + groupId);
                        if (detailRow) {
                            const dropdowns = detailRow.querySelectorAll('select.product-class-select');
                            console.log('[CLASS DROPDOWN] Found', dropdowns.length, 'dropdowns in expanded row');
                            dropdowns.forEach(populateClassDropdown);
                        }
                    }, 100);
                }

                // Make functions globally available
                window.populateAllClassDropdowns = populateAllClassDropdowns;
                window.populateClassDropdown = populateClassDropdown;
                window.fixClassDropdowns = populateAllClassDropdowns; // Alias for compatibility

                // Initialize when page loads
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('[CLASS DROPDOWN] DOM loaded, initializing...');

                    // Populate existing dropdowns
                    populateAllClassDropdowns();

                    // Set up expand button monitoring
                    document.addEventListener('click', function (e) {
                        if (e.target.closest('.expand-btn')) {
                            const button = e.target.closest('.expand-btn');
                            const groupId = button.getAttribute('data-group-id');
                            if (groupId) {
                                handleExpandClick(groupId);
                            }
                        }
                    });

                    // Monitor for dynamically added dropdowns
                    const observer = new MutationObserver(function (mutations) {
                        mutations.forEach(function (mutation) {
                            if (mutation.type === 'childList') {
                                mutation.addedNodes.forEach(function (node) {
                                    if (node.nodeType === 1) { // Element node
                                        const dropdowns = node.querySelectorAll ? node.querySelectorAll('select.product-class-select') : [];
                                        dropdowns.forEach(populateClassDropdown);
                                    }
                                });
                            }
                        });
                    });

                    const table = document.getElementById('shipmentsTable');
                    if (table) {
                        observer.observe(table, { childList: true, subtree: true });
                        console.log('[CLASS DROPDOWN] MutationObserver set up for dynamic content');
                    }
                });

                // Fallback initialization after page load
                window.addEventListener('load', function () {
                    console.log('[CLASS DROPDOWN] Page fully loaded, running fallback...');
                    setTimeout(populateAllClassDropdowns, 1000);
                });

                console.log('[CLASS DROPDOWN] Rebuilt class dropdown system loaded successfully!');
            </script>

            <script>
                // DEBUG: Log account codes on page load
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('='.repeat(80));
                    console.log('ACCOUNT CODE DEBUG - Checking rendered values');
                    console.log('='.repeat(80));

                    // Find all account code cells
                    const accountCodeCells = document.querySelectorAll('.col-account-code span');
                    console.log(`Found ${accountCodeCells.length} account code cells`);

                    let missingCount = 0;
                    let foundCount = 0;

                    accountCodeCells.forEach((cell, index) => {
                        const code = cell.textContent.trim();
                        const row = cell.closest('tr');
                        const clientCell = row ? row.querySelector('.col-client-name') : null;
                        const clientName = clientCell ? clientCell.textContent.trim() : 'Unknown';

                        if (code === '-' || code === '') {
                            missingCount++;
                            console.log(`${index + 1}. MISSING: ${clientName} -> "${code}"`);
                        } else {
                            foundCount++;
                            console.log(`${index + 1}. OK: ${clientName} -> "${code}"`);
                        }
                    });

                    console.log('='.repeat(80));
                    console.log(`SUMMARY: ${foundCount} found, ${missingCount} missing`);
                    console.log('='.repeat(80));
                });
            </script>

            <script>
                // Date picker functionality with DD/MM/YYYY format
                let currentCalendar = null;
                let currentInput = null;

                function openDatePicker(inputName) {
                    // Close any existing calendar
                    if (currentCalendar) {
                        currentCalendar.remove();
                    }

                    currentInput = document.querySelector(`input[name="${inputName}"]`);

                    // Create calendar popup
                    const calendar = document.createElement('div');
                    calendar.className = 'calendar-popup';
                    calendar.innerHTML = generateCalendarHTML();

                    // Position calendar above the input
                    const inputRect = currentInput.getBoundingClientRect();
                    const calendarWidth = 320;
                    const calendarHeight = 350;

                    // Calculate position
                    let left = inputRect.left + (inputRect.width / 2) - (calendarWidth / 2);
                    let top = inputRect.top - calendarHeight - 10;

                    // Ensure calendar stays within viewport
                    if (left < 10) left = 10;
                    if (left + calendarWidth > window.innerWidth - 10) {
                        left = window.innerWidth - calendarWidth - 10;
                    }
                    if (top < 10) {
                        top = inputRect.bottom + 10; // Show below if no space above
                    }

                    calendar.style.left = left + 'px';
                    calendar.style.top = top + 'px';

                    document.body.appendChild(calendar);
                    currentCalendar = calendar;

                    // Add event listeners
                    setupCalendarEvents(calendar);

                    // Close calendar when clicking outside
                    setTimeout(() => {
                        document.addEventListener('click', closeCalendar);
                    }, 100);
                }

                function closeCalendar(e) {
                    if (currentCalendar && (!e || !currentCalendar.contains(e.target) && !e.target.classList.contains('date-picker-btn'))) {
                        currentCalendar.remove();
                        currentCalendar = null;
                        currentInput = null;
                        document.removeEventListener('click', closeCalendar);
                    }
                }

                function generateCalendarHTML() {
                    const today = new Date();
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();

                    const monthNames = [
                        'January', 'February', 'March', 'April', 'May', 'June',
                        'July', 'August', 'September', 'October', 'November', 'December'
                    ];

                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

                    let html = `
                <div class="calendar-header">
                    <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                    <div class="calendar-month-year">${monthNames[currentMonth]} ${currentYear}</div>
                    <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                </div>
                <div class="calendar-grid">
            `;

                    // Day headers
                    dayNames.forEach(day => {
                        html += `<div class="calendar-day-header">${day}</div>`;
                    });

                    // Calendar days
                    const firstDay = new Date(currentYear, currentMonth, 1);
                    const lastDay = new Date(currentYear, currentMonth + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());

                    for (let i = 0; i < 42; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);

                        const isCurrentMonth = date.getMonth() === currentMonth;
                        const isToday = date.toDateString() === today.toDateString();
                        const isSelected = currentInput.value === formatDateDDMMYYYY(date);

                        let classes = 'calendar-day';
                        if (!isCurrentMonth) classes += ' other-month';
                        if (isToday) classes += ' today';
                        if (isSelected) classes += ' selected';

                        html += `<div class="${classes}" onclick="selectDate('${formatDateYYYYMMDD(date)}')">${date.getDate()}</div>`;
                    }

                    html += '</div>';
                    return html;
                }

                function setupCalendarEvents(calendar) {
                    // Month navigation
                    window.changeMonth = function (direction) {
                        // This would need to be implemented to change months
                        // For now, just regenerate the calendar
                        calendar.innerHTML = generateCalendarHTML();
                        setupCalendarEvents(calendar);
                    };
                }

                function selectDate(dateStr) {
                    const date = new Date(dateStr);
                    const formattedDate = formatDateDDMMYYYY(date);

                    currentInput.value = formattedDate;

                    // Update hidden input
                    const hiddenInput = currentInput.parentNode.querySelector('input[type="hidden"]');
                    if (hiddenInput) {
                        hiddenInput.value = dateStr;
                    }

                    closeCalendar();
                }

                function formatDateDDMMYYYY(date) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                }

                function formatDateYYYYMMDD(date) {
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${year}-${month}-${day}`;
                }

                // Handle form submission
                document.addEventListener('DOMContentLoaded', function () {
                    const filterForm = document.querySelector('form[method="get"]');
                    if (filterForm) {
                        filterForm.addEventListener('submit', function (e) {
                            // Ensure hidden inputs are updated before submission
                            const dateInputs = this.querySelectorAll('.date-picker');
                            dateInputs.forEach(function (input) {
                                if (input.value && input.value.includes('/')) {
                                    const parts = input.value.split('/');
                                    if (parts.length === 3) {
                                        const day = parts[0].padStart(2, '0');
                                        const month = parts[1].padStart(2, '0');
                                        const year = parts[2];

                                        const hiddenInput = input.parentNode.querySelector('input[type="hidden"]');
                                        if (hiddenInput) {
                                            hiddenInput.value = year + '-' + month + '-' + day;
                                        }
                                    }
                                }
                            });
                        });
                    }
                });
            </script>

            <!-- Mobile Card Expand/Collapse Functionality -->
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('[MOBILE CARDS] Initializing expand/collapse functionality...');

                    // Handle mobile card expansion
                    document.querySelectorAll('.expand-btn').forEach(button => {
                        // Ensure initial state is correct
                        const card = button.closest('.group-card');
                        if (!card) return; // Skip if no group-card parent
                        const details = card.querySelector('.group-details');
                        const icon = button.querySelector('i');

                        // Reset to collapsed state on load
                        if (details && icon) {
                            details.classList.remove('expanded');
                            button.classList.remove('expanded');
                            icon.style.transform = 'rotate(0deg)';
                        }

                        button.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            console.log('[MOBILE CARDS] Expand button clicked');

                            const groupId = this.getAttribute('data-group-id');
                            const card = this.closest('.group-card');
                            const details = card.querySelector('.group-details');
                            const icon = this.querySelector('i');

                            if (details && icon) {
                                console.log('[MOBILE CARDS] Toggling details for group:', groupId);

                                // Toggle the expanded class
                                details.classList.toggle('expanded');
                                this.classList.toggle('expanded');

                                // Update the icon rotation
                                if (details.classList.contains('expanded')) {
                                    icon.style.transform = 'rotate(180deg)';
                                    console.log('[MOBILE CARDS] Details expanded');
                                } else {
                                    icon.style.transform = 'rotate(0deg)';
                                    console.log('[MOBILE CARDS] Details collapsed');
                                }
                            } else {
                                console.warn('[MOBILE CARDS] Could not find details or icon element');
                            }
                        });
                    });

                    console.log('[MOBILE CARDS] Expand/collapse functionality initialized successfully');

                    // Desktop expand button functionality is handled by the main toggleGroup function
                    // No separate desktop handler needed - the global click listener handles all expand buttons

                    console.log('[DESKTOP] Expand/collapse functionality initialized successfully');

                    // Initialize product class dropdowns for mobile cards
                    setTimeout(() => {
                        document.querySelectorAll('.product-class-select').forEach(window.filterClassOptions);
                    }, 1000);
                });

                // Mobile card specific functions
                window.updateProductName = function (input) {
                    const inspectionId = input.getAttribute('data-inspection-id');
                    const productName = input.value;

                    console.log('[MOBILE] Updating product name for inspection:', inspectionId, 'Value:', productName);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('product_name', productName);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-product-name/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Product name saved successfully:', data);
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving product name:', data.error);
                                alert('Error updating product name: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving product name:', error);
                            alert('Error updating product name: ' + error.message);
                        });
                };

                window.updateProductClass = function (select) {
                    const inspectionId = select.getAttribute('data-inspection-id');
                    const productClass = select.value;

                    console.log('[MOBILE] Updating product class for inspection:', inspectionId, 'Value:', productClass);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('product_class', productClass);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-product-class/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Product class saved successfully:', data);
                                select.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    select.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving product class:', data.error);
                                alert('Error updating product class: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving product class:', error);
                            alert('Error updating product class: ' + error.message);
                        });
                };

                window.updateTestResult = function (checkbox) {
                    const inspectionId = checkbox.getAttribute('data-inspection-id');
                    const testType = checkbox.getAttribute('data-test-type');
                    const isChecked = checkbox.checked;

                    console.log('[MOBILE] Updating test result for inspection:', inspectionId, 'Test:', testType, 'Checked:', isChecked);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('test_type', testType);
                    formData.append('test_result', isChecked);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-test-result/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Test result saved successfully:', data);
                            } else {
                                console.error('[ERROR] Error saving test result:', data.error);
                                alert('Error updating test result: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving test result:', error);
                            alert('Error updating test result: ' + error.message);
                        });
                };

                window.updateLab = function (select) {
                    const inspectionId = select.getAttribute('data-inspection-id');
                    const lab = select.value;

                    console.log('[MOBILE] Updating lab for inspection:', inspectionId, 'Value:', lab);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('lab', lab);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-lab/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Lab saved successfully:', data);
                                select.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    select.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving lab:', data.error);
                                alert('Error updating lab: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving lab:', error);
                            alert('Error updating lab: ' + error.message);
                        });
                };

                window.uploadLabFile = function (inspectionId, groupId) {
                    console.log('[MOBILE] Uploading lab file for inspection:', inspectionId, 'Group:', groupId);

                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Validate PDF file
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }

                            // Create form data
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('group_id', groupId);
                            formData.append('document_type', 'lab');
                            formData.append('inspection_id', inspectionId);

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('Lab file uploaded successfully!');
                                        console.log('[MOBILE] Lab upload successful:', data);
                                        // Refresh the page to show updated status
                                        location.reload();
                                    } else {
                                        alert('Error uploading lab file: ' + data.error);
                                    }
                                })
                                .catch(error => {
                                    alert('Error uploading lab file: ' + error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                window.uploadRetestFile = function (inspectionId, groupId) {
                    console.log('[MOBILE] Uploading retest file for inspection:', inspectionId, 'Group:', groupId);

                    // Validate that at least one ID is provided
                    if (!groupId && !inspectionId) {
                        alert('Error: Unable to upload - missing group or inspection ID. Please refresh the page and try again.');
                        console.error('[UPLOAD] Missing both groupId and inspectionId');
                        return;
                    }

                    // Create a file input element
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.accept = '.pdf';
                    fileInput.style.display = 'none';

                    fileInput.onchange = function (e) {
                        const file = e.target.files[0];
                        if (file) {
                            // Validate PDF file
                            if (!file.name.toLowerCase().endsWith('.pdf')) {
                                alert('Only PDF files are allowed. Please select a PDF document.');
                                return;
                            }

                            // Create form data
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('document_type', 'retest');
                            // Only send values if they're truthy
                            if (groupId) formData.append('group_id', groupId);
                            if (inspectionId) formData.append('inspection_id', inspectionId);

                            // Get CSRF token
                            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                '{{ csrf_token|escapejs }}';
                            formData.append('csrfmiddlewaretoken', csrfToken);

                            // Upload file
                            fetch('/upload-document/', {
                                method: 'POST',
                                body: formData
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        alert('Retest file uploaded successfully!');
                                        console.log('[MOBILE] Retest upload successful:', data);
                                        // Refresh the page to show updated status
                                        location.reload();
                                    } else {
                                        alert('Error uploading retest file: ' + data.error);
                                    }
                                })
                                .catch(error => {
                                    alert('Error uploading retest file: ' + error.message);
                                });
                        }
                    };

                    // Trigger file selection
                    document.body.appendChild(fileInput);
                    fileInput.click();
                    document.body.removeChild(fileInput);
                };

                window.editInspection = function (inspectionId) {
                    console.log('[MOBILE] Editing inspection:', inspectionId);
                    // This would open the inspection edit dialog
                    // Implementation depends on your existing edit system
                    alert('Edit inspection functionality - Inspection ID: ' + inspectionId);
                };

                window.generateLabForm = function (inspectionId) {
                    console.log('[MOBILE] Generating lab form for inspection:', inspectionId);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                        '{{ csrf_token|escapejs }}';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Generate lab form
                    fetch('/generate-lab-form/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('Lab form generated successfully!');
                                console.log('[MOBILE] Lab form generation successful:', data);
                                // Optionally refresh the page or update UI
                                location.reload();
                            } else {
                                alert('Error generating lab form: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error generating lab form: ' + error.message);
                        });
                };

                window.updateBoughtSample = function (input) {
                    const inspectionId = input.getAttribute('data-inspection-id');
                    const boughtSample = input.value;

                    console.log('[MOBILE] Updating bought sample for inspection:', inspectionId, 'Value:', boughtSample);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('bought_sample', boughtSample);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-bought-sample/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Bought sample saved successfully:', data);
                                input.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    input.style.backgroundColor = '';
                                }, 500);
                            } else {
                                console.error('[ERROR] Error saving bought sample:', data.error);
                                alert('Error updating bought sample: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving bought sample:', error);
                            alert('Error updating bought sample: ' + error.message);
                        });
                };

                window.updateNeedsRetest = function (select) {
                    const inspectionId = select.getAttribute('data-inspection-id');
                    const needsRetest = select.value;

                    // Check if the select is disabled (no sample taken)
                    if (select.disabled) {
                        console.log('[MOBILE] Needs retest dropdown is disabled - no sample taken');
                        alert('Cannot set retest options - no sample taken for this inspection');
                        return;
                    }

                    console.log('[MOBILE] Updating needs retest for inspection:', inspectionId, 'Value:', needsRetest);

                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

                    // Create form data
                    const formData = new FormData();
                    formData.append('inspection_id', inspectionId);
                    formData.append('needs_retest', needsRetest);
                    formData.append('csrfmiddlewaretoken', csrfToken);

                    // Send update request
                    fetch('/update-needs-retest/', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('[SUCCESS] Needs retest saved successfully:', data);
                                select.style.backgroundColor = '#d4edda';
                                setTimeout(() => {
                                    select.style.backgroundColor = '';
                                }, 500);

                                // Update retest button state based on needs retest value
                                updateRetestButtonState(inspectionId, needsRetest);
                            } else {
                                console.error('[ERROR] Error saving needs retest:', data.error);
                                alert('Error updating needs retest: ' + data.error);
                            }
                        })
                        .catch(error => {
                            console.error('[ERROR] Network error saving needs retest:', error);
                            alert('Error updating needs retest: ' + error.message);
                        });
                };

                // Function to update retest button state based on needs retest value
                function updateRetestButtonState(inspectionId, needsRetest) {
                    // Find the retest button for this inspection
                    const retestButton = document.querySelector(`button[onclick*="uploadRetestFile('${inspectionId}')"]`);
                    if (retestButton) {
                        if (needsRetest === 'yes' || needsRetest === 'YES') {
                            // Enable retest button only if needs retest is "yes"
                            retestButton.disabled = false;
                            retestButton.style.opacity = '';
                            retestButton.style.cursor = '';
                            retestButton.title = 'Retest required - Please upload retest document';
                        } else {
                            // Disable retest button for all other values (no, pending, empty)
                            retestButton.disabled = true;
                            retestButton.style.opacity = '0.5';
                            retestButton.style.cursor = 'not-allowed';
                            if (needsRetest === 'no' || needsRetest === 'NO') {
                                retestButton.title = 'Needs retest is "No" - retest upload disabled';
                            } else if (needsRetest === 'pending' || needsRetest === 'PENDING') {
                                retestButton.title = 'Needs retest is "Pending" - retest upload disabled';
                            } else {
                                retestButton.title = 'No retest required - Upload disabled';
                            }
                        }
                    }
                }

                // Function to check if a group has both PMP and RAW products
                function checkCompositionButtonVisibility() {
                    console.log('[COMPOSITION] Checking composition button visibility...');

                    // Get all group rows
                    const groupRows = document.querySelectorAll('.group-row');

                    groupRows.forEach(row => {
                        const groupId = row.getAttribute('data-group-id');
                        const clientName = row.getAttribute('data-client-name');
                        const inspectionDate = row.getAttribute('data-inspection-date');

                        if (!groupId) return;

                        console.log(`[COMPOSITION] Checking group: ${groupId}`);

                        // Find all detail rows for this group
                        const detailRow = row.nextElementSibling;
                        if (!detailRow || !detailRow.classList.contains('detail-row')) {
                            console.log(`[COMPOSITION] No detail row found for ${groupId}`);
                            return;
                        }

                        // Get all product class dropdowns within this group's detail table
                        const classDropdowns = detailRow.querySelectorAll('.product-class-select');

                        let hasPMP = false;
                        let hasRAW = false;

                        classDropdowns.forEach(dropdown => {
                            const commodity = (dropdown.getAttribute('data-commodity') || '').toLowerCase().trim();

                            // Check commodity type - not product class!
                            if (commodity) {
                                if (commodity === 'raw') {
                                    hasRAW = true;
                                    console.log(`[COMPOSITION] Found RAW commodity: ${commodity}`);
                                } else if (commodity === 'pmp') {
                                    hasPMP = true;
                                    console.log(`[COMPOSITION] Found PMP commodity: ${commodity}`);
                                }
                            }
                        });

                        // Show composition button if group has RAW or PMP (or both)
                        const compositionBtn = document.getElementById('composition-' + groupId);
                        const compositionBtnMobile = document.getElementById('composition-mobile-' + groupId);
                        const compositionCell = row.querySelector('.col-composition');

                        if (compositionBtn && !compositionBtn.classList.contains('btn-success')) {
                            // Only modify non-uploaded buttons
                            // Show button if group has RAW OR PMP (or both)
                            if (hasPMP || hasRAW) {
                                compositionBtn.style.display = 'block';
                                if (compositionCell) {
                                    compositionCell.querySelector('.composition-indicator')?.remove();
                                }
                                const commodityTypes = [];
                                if (hasRAW) commodityTypes.push('RAW');
                                if (hasPMP) commodityTypes.push('PMP');
                                console.log(`[COMPOSITION] ‚úÖ Showing composition button for ${groupId} (has ${commodityTypes.join(' and ')} commodities)`);
                            } else {
                                compositionBtn.style.display = 'block';
                                if (compositionCell && !compositionCell.querySelector('.composition-indicator')) {
                                    // Add dash if not already present
                                    const indicator = document.createElement('span');
                                    indicator.className = 'composition-indicator';
                                    indicator.textContent = '-';
                                    compositionCell.appendChild(indicator);
                                }
                                console.log(`[COMPOSITION] ‚ùå Hiding composition button for ${groupId} - No RAW or PMP commodities found`);
                            }
                        }

                        // Also update mobile button
                        if (compositionBtnMobile && !compositionBtnMobile.classList.contains('btn-success')) {
                            if (hasPMP || hasRAW) {
                                compositionBtnMobile.style.display = 'block';
                                console.log(`[COMPOSITION] ‚úÖ Showing MOBILE composition button for ${groupId}`);
                            } else {
                                compositionBtnMobile.style.display = 'block';
                                console.log(`[COMPOSITION] ‚ùå Hiding MOBILE composition button for ${groupId}`);
                            }
                        }
                    });
                }

                // Run on page load
                document.addEventListener('DOMContentLoaded', function () {
                    console.log('[COMPOSITION] DOM loaded, checking composition buttons...');
                    // Delay to ensure product classes are loaded
                    setTimeout(checkCompositionButtonVisibility, 1000);

                    // Validate RFI and Invoice button states based on actual files
                    console.log('[BUTTON STATE] Validating upload button states...');
                    if (typeof validateUploadButtonStates === 'function') {
                        setTimeout(validateUploadButtonStates, 1500);
                    }
                });

                // Also run when product class is updated
                const originalUpdateProductClass = window.updateProductClass;
                window.updateProductClass = function (dropdown) {
                    originalUpdateProductClass(dropdown);
                    // Recheck composition button visibility after class update
                    setTimeout(checkCompositionButtonVisibility, 500);
                };

                // Run when groups are expanded to ensure visibility is correct
                const originalToggleGroup = window.toggleGroup;
                if (originalToggleGroup) {
                    window.toggleGroup = function (event, groupId) {
                        originalToggleGroup(event, groupId);
                        // Recheck composition button visibility after group toggle
                        setTimeout(checkCompositionButtonVisibility, 500);
                    };
                }
            </script>
</body>

</html>