<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    {% load group_filters %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claims Records Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #007890;
            --primary-light: #e6f3f7;
            --secondary: #EC343C;
            --danger: #EC343C;
            --warning: #f59e0b; 
            --background: #f9fafb;
            --card-bg: #ffffff;
            --text: #1f2937;
            --text-light: #6b7280;
            --border: #e5e7eb;
            --radius: 6px;
            --shadow: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-lg: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --spacing: 5px;
            --light-black: #333333;
            --import-color: #446f1e;
            --grey: #777777;
            --analytics: #7c3aed;
        }
        
        /* Dark mode variables */
        [data-theme="dark"] {
            --background: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #ffffff;
            --text-light: #b0b0b0;
            --border: #404040;
            --primary-light: #1a3a40;
            --light-black: #ffffff;
            --grey: #b0b0b0;
        }
        
        /* Dark mode specific overrides */
        [data-theme="dark"] tr:nth-child(even) {
            background-color: #363636;
        }
        
        [data-theme="dark"] tr:hover {
            background-color: var(--primary-light);
        }
        
        [data-theme="dark"] .view-btn {
            background: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }
        
        [data-theme="dark"] .tooltip:hover::after {
            background-color: #000;
            color: white;
        }
        
        [data-theme="dark"] .detail-content h4 {
            color: white !important;
        }
        
        [data-theme="dark"] .detail-table th {
            color: white !important;
        }
        
        [data-theme="dark"] .main-table th {
            color: white !important;
        }
        
        /* Dark mode support for file status buttons */
        [data-theme="dark"] .btn-files-complete {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        [data-theme="dark"] .btn-files-partial {
            background-color: #f59e0b !important;
            border-color: #d97706 !important;
            color: white !important;
        }
        
        [data-theme="dark"] .btn-files-none {
            background-color: #ef4444 !important;
            border-color: #dc2626 !important;
            color: white !important;
        }
        
        [data-theme="dark"] .btn-files-checking {
            background-color: #6b7280 !important;
            border-color: #4b5563 !important;
            color: white !important;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: url("{% static 'img/food_safety_background.png' %}") no-repeat center center;
            
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            line-height: 1.5;
            padding: var(--spacing);
            position: relative;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        
        .container {
            width: calc(100% - var(--spacing)*2);
            margin: 0 auto;
            padding: 5px 0;
            position: relative;
        }
        
        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .logo {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .logo img {
            max-height: 80px;
        }
        
        .header {
            padding: 10px 5px 20px;
            margin-bottom: var(--spacing);
            width: 100%;
            text-align: center;
        }
        
        .header h1 {
            color: white;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .header h2 {
            color: white;
            font-size: 1rem;
            font-weight: 400;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing);
            border: 1px solid var(--border);
            width: 100%;
        }
        
        /* Completion status styling - bright green */
        .inspection-complete {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        .inspection-complete td {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        .inspection-complete .detail-content {
            background-color: #22c55e !important;
            color: white !important;
        }
        
        .inspection-complete .detail-table {
            background-color: #22c55e !important;
        }
        
        .inspection-complete .detail-table th,
        .inspection-complete .detail-table td {
            background-color: #22c55e !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        /* Dark mode completion styling - bright green */
        [data-theme="dark"] .inspection-complete {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        [data-theme="dark"] .inspection-complete td {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        [data-theme="dark"] .inspection-complete .detail-content {
            background-color: #15803d !important;
            color: white !important;
        }
        
        [data-theme="dark"] .inspection-complete .detail-table {
            background-color: #15803d !important;
        }
        
        [data-theme="dark"] .inspection-complete .detail-table th,
        [data-theme="dark"] .inspection-complete .detail-table td {
            background-color: #15803d !important;
            border-color: #16a34a !important;
            color: white !important;
        }
        
        .card-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-body {
            padding: 16px;
            overflow-x: auto; /* Allow horizontal scrolling */
        }
        
        .action-bar {
            display: flex;
            gap: 12px;
            margin-bottom: var(--spacing);
            width: 100%;
            flex-wrap: wrap; /* Allow wrapping on narrower laptop screens */
        }

        .btn-danger{
            background-color: red;
            color: white;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: var(--radius);
            border: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s ease;
            text-decoration: none;
            box-shadow: var(--shadow);
        }
        
       .btn-analytics {
    background-color: #ef4444; /* Red color */
    color: white;
}
        .btn-analytics:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        
        .btn-remote {
            background-color: #059669; /* Green color for remote data */
            color: white;
        }
        
        .btn-remote:hover {
            background-color: #047857; /* Darker green on hover */
        }
        
        .btn-allocation {
            background-color: #7c3aed; /* Purple color for client allocation */
            color: white;
        }
        
        .btn-allocation:hover {
            background-color: #6d28d9; /* Darker purple on hover */
        }
        

        
        .form-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
            width: 100%;
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-light);
        }
        
        .form-control {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.15s ease;
            color: var(--text);
            background-color: var(--card-bg);
            width: 100%;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* Autocomplete dropdown styles */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: var(--shadow-lg);
            min-height: 100px;
        }
        
        .autocomplete-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            transition: background-color 0.15s ease;
            font-weight: 500;
            color: var(--text);
        }
        
        .autocomplete-item:hover {
            background-color: var(--primary-light);
        }
        
        .autocomplete-item:last-child {
            border-bottom: none;
        }
        
        /* Dark mode autocomplete styles */
        [data-theme="dark"] .autocomplete-dropdown {
            background: var(--card-bg);
            border-color: var(--border);
        }
        
        [data-theme="dark"] .autocomplete-item:hover {
            background-color: var(--primary-light);
        }
        
        [data-theme="dark"] .autocomplete-item {
            color: var(--text);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #005a6b;
        }
        
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #4b5563;
        }
        
        /* Dark mode button overrides */
        [data-theme="dark"] .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        
        [data-theme="dark"] .btn-secondary:hover {
            background-color: #374151;
        }
        
        .messages {
            margin-bottom: var(--spacing);
            width: 100%;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: var(--radius);
            margin-bottom: var(--spacing);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        .message.success {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--secondary);
            border-left: 3px solid var(--secondary);
        }
        
        .message.error {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-left: 3px solid var(--danger);
        }
        
        .table-responsive {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            width: 100%;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.7rem;
            min-width: 1000px; /* Further reduced for better space utilization */
        }
        
        th {
            background-color: var(--primary-light);
            color: var(--primary);
            text-align: left;
            padding: 4px 6px;
            font-weight: 600;
            white-space: nowrap;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        tr:hover {
            background-color: var(--primary-light);
        }
        
        td {
            padding: 4px 6px;
            border-bottom: 1px solid var(--border);
            font-size: 0.7rem;
            white-space: nowrap;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Main table layout - efficient space usage */
        #shipmentsTable {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            max-width: 100%;
        }
        
        /* Ensure table maintains its structure when expanded */
        #shipmentsTable tbody {
            position: relative;
        }
        
        /* Keep main table rows stable */
        #shipmentsTable tbody tr.group-row {
            position: relative;
            z-index: 5;
        }
        
        /* Ultra-optimized column widths - minimal space needed */
        .col-expand { width: 25px; min-width: 25px; max-width: 25px; }
        .col-client-name { width: 120px; min-width: 120px; max-width: 120px; }
        .col-account-code { width: 120px; min-width: 120px; max-width: 120px; text-align: center; }
        .col-date { width: 65px; min-width: 65px; max-width: 65px; }
        .col-email { width: 120px; min-width: 120px; max-width: 120px; }
        .col-compliance { width: 100px; min-width: 100px; max-width: 100px; text-align: center; }
        .col-inspector { width: 80px; min-width: 80px; max-width: 80px; }
        .col-view-files { width: 60px; min-width: 60px; max-width: 60px; text-align: center; }
        .col-rfi { width: 80px; min-width: 80px; max-width: 80px; text-align: center; }
        .col-invoice { width: 80px; min-width: 80px; max-width: 80px; text-align: center; }
        
        /* Hide invoice column for inspectors */
        .hide-invoice .col-invoice { display: none !important; }
        .col-km { width: 120px; min-width: 120px; max-width: 120px; text-align: center; }
        .col-hours { width: 120px; min-width: 120px; max-width: 120px; text-align: center; }
        
        /* Ensure KM and Hours headers are fully visible */
        #shipmentsTable thead th.col-km,
        #shipmentsTable thead th.col-hours {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
        }
        .col-send { width: 200px; min-width: 200px; max-width: 200px; text-align: center; }
        
        /* Ensure text doesn't wrap unnecessarily */
        #shipmentsTable td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 8px 4px;
        }
        
        /* Allow client name to wrap if needed since it's variable width */
        .col-client-name {
            white-space: normal;
            word-wrap: break-word;
        }
        
        /* Compliance status styling */
        .compliance-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
            display: inline-block;
            text-align: center;
            min-width: 80px;
        }
        
        .compliance-status.compliant {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .compliance-status.non-compliant {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Dark mode compliance status */
        [data-theme="dark"] .compliance-status.compliant {
            background-color: #1e4d2b;
            color: #d4edda;
            border: 1px solid #2d5a3d;
        }
        
        [data-theme="dark"] .compliance-status.non-compliant {
            background-color: #4d1a1a;
            color: #f8d7da;
            border: 1px solid #5c2a2a;
        }
        
        /* Action columns specific styling */
        .col-rfi, .col-invoice, .col-km, .col-hours, .col-send {
            white-space: nowrap !important;
            overflow: visible !important;
            text-overflow: initial !important;
        }
        
        /* View Files button color coding */
        .btn-files-complete {
            background-color: #22c55e !important; /* Green */
            border-color: #16a34a !important;
            color: white !important;
        }
        
        .btn-files-partial {
            background-color: #f59e0b !important; /* Yellow/Orange */
            border-color: #d97706 !important;
            color: white !important;
        }
        
        .btn-files-none {
            background-color: #ef4444 !important; /* Red */
            border-color: #dc2626 !important;
            color: white !important;
        }
        
        .btn-files-checking {
            background-color: #6b7280 !important; /* Gray */
            border-color: #4b5563 !important;
            color: white !important;
        }
        
        /* Additional classes for JavaScript compatibility */
        .btn-view-files[style*="rgb(255, 193, 7)"],
        .btn-view-files[style*="#ffc107"],
        .btn-view-files[style*="rgb(245, 158, 11)"],
        .btn-view-files[style*="#f59e0b"] {
            background-color: #f59e0b !important; /* Yellow - partial files */
            border-color: #d97706 !important;
            color: white !important;
        }
        
        .btn-view-files[style*="rgb(34, 197, 94)"],
        .btn-view-files[style*="#22c55e"],
        .btn-view-files[style*="rgb(40, 167, 69)"],
        .btn-view-files[style*="#28a745"] {
            background-color: #22c55e !important; /* Green - complete */
            border-color: #16a34a !important;
            color: white !important;
        }
        
        .btn-view-files[style*="rgb(239, 68, 68)"],
        .btn-view-files[style*="#ef4444"],
        .btn-view-files[style*="rgb(220, 53, 69)"],
        .btn-view-files[style*="#dc3545"] {
            background-color: #ef4444 !important; /* Red - no files */
            border-color: #dc2626 !important;
            color: white !important;
        }
        
        /* Hover effects removed for file status buttons */
        
        /* Special styling for the client reference */
        .client-reference {
            font-family: 'Courier New', monospace;
            font-weight: 500;
            color: var(--secondary);
            background-color: rgba(16, 185, 129, 0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.65rem;
        }
        
        .client-reference.empty {
            color: var(--text-light);
            background-color: rgba(107, 114, 128, 0.05);
            font-style: italic;
        }
        
        /* Tooltip for truncated text */
        .tooltip {
            position: relative;
            cursor: help;
        }
        
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* Compact table controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .table-info {
            font-size: 0.875rem;
            color: var(--text-light);
        }
        
        .view-toggle {
            display: flex;
            gap: 5px;
        }
        
        .view-btn {
            padding: 4px 8px;
            font-size: 0.75rem;
            border: 1px solid var(--border);
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .view-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .empty-message {
            text-align: center;
            color: var(--text-light);
            padding: 40px 20px;
            background-color: #f8fafc;
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.65rem;
            margin: 1px;
        }
        
        .btn-edit {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-edit:hover {
            background-color: #005a6b;
        }
        
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d42e35;
        }
        
        .btn-upload {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            margin: 1px;
            border: none;
            box-shadow: 0 2px 4px rgba(107, 114, 128, 0.3);
            font-weight: 500;
            padding: 4px 8px !important;
            font-size: 0.65rem !important;
        }
        
        .btn-upload:hover {
            background: linear-gradient(135deg, #4b5563, #374151);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(107, 114, 128, 0.4);
        }
        
        .btn-upload:active {
            transform: translateY(0);
        }
        
        .btn-upload.uploaded {
            background: linear-gradient(135deg, #10B981, #059669);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .btn-upload.uploaded:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.4);
        }
        
        .btn-lab {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }
        
        .btn-lab:hover {
            background-color: #4b5563;
        }
        
        .btn-lab.uploaded {
            background-color: #059669;
        }
        
        .btn-lab.uploaded:hover {
            background-color: #047857;
        }
        
        .btn-lab-form {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }
        
        .btn-lab-form:hover {
            background-color: #4b5563;
            color: white;
        }
        
        .btn-lab-form.uploaded {
            background-color: #059669;
        }
        
        .btn-lab-form.uploaded:hover {
            background-color: #047857;
        }
        
        /* Group actions styling - inline, no wrapping */
        .group-actions {
            display: flex;
            flex-direction: row;
            gap: 3px;
            align-items: center;
            flex-wrap: nowrap;
            width: 100%;
        }
        
        .group-inputs {
            display: flex;
            flex-direction: row;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
            margin-left: 4px;
            flex-wrap: nowrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            white-space: nowrap;
        }
        
        .input-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary);
            white-space: nowrap;
            margin-right: 2px;
        }
        
        .group-km-input,
        .group-hours-input {
            width: 50px;
            min-width: 50px;
            max-width: 50px;
            padding: 3px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        
        .group-km-input:focus,
        .group-hours-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }
        
        .group-buttons {
            display: flex;
            gap: 1px;
            flex-wrap: nowrap;
            align-items: center;
        }
        
        .group-buttons .btn {
            font-size: 8px;
            padding: 2px 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .upload-info {
            margin-top: 4px;
            margin-bottom: 2px;
        }
        
        .uploader-text {
            font-size: 0.6rem;
            color: #6b7280;
            line-height: 1.2;
            margin-bottom: 1px;
        }
        
        .uploader-text small {
            font-size: 0.6rem;
            color: #6b7280;
        }
        
        .button-with-uploader {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 4px;
            flex-shrink: 0;
            min-width: 50px;
            min-height: 40px;
            justify-content: flex-start;
        }
        
        .button-with-uploader .uploader-text {
            margin-top: 2px;
            text-align: center;
            white-space: nowrap;
            width: 100%;
            height: 12px;
            line-height: 12px;
        }
        
        .btn-retest {
            background-color: #6b7280;
            color: white;
            margin: 1px;
        }
        
        .btn-retest:hover {
            background-color: #4b5563;
        }
        .btn-retest.uploaded {
            background-color: #059669;
        }
        
        .btn-retest.uploaded:hover {
            background-color: #047857;
        }
        
        .btn-rfi {
            background-color: #28a745;
            color: white !important;
            margin: 1px;
            transition: all 0.3s ease;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }
        
        .btn-rfi:hover {
            background-color: #1e7e34;
        }
        
        .btn-rfi.uploaded {
            background-color: #d4edda;
            color: #155724 !important;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }
        
        .btn-rfi.uploaded:hover {
            background-color: #c3e6cb;
        }
        
        .btn-invoice {
            background-color: #28a745;
            color: white !important;
            margin: 1px;
            transition: all 0.3s ease;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        .btn-invoice:hover {
            background-color: #1e7e34;
        }
        
        .btn-invoice.uploaded {
            background-color: #d4edda;
            color: #155724 !important;
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
        }
        
        .btn-invoice.uploaded:hover {
            background-color: #c3e6cb;
        }
        
        /* Ensure all RFI buttons have consistent width regardless of content */
        button[id^="rfi-"] {
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
            color: white !important;
        }
        
        /* Ensure all Invoice buttons have consistent width regardless of content */
        button[id^="invoice-"] {
            min-width: 60px !important;
            width: 60px !important;
            max-width: 60px !important;
            text-align: center !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
            font-size: 0.7rem !important;
            color: white !important;
        }
        
        /* Keep icons white in Invoice buttons */
        button[id^="invoice-"] i {
            color: white !important;
        }
        
        /* Complete redesign of View Files button - isolated from all other styles */
        .files-button-custom {
            /* Reset all inherited styles */
            all: unset !important;
            
            /* Core button styling */
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            
            /* Size and spacing */
            padding: 6px 12px !important;
            margin: 1px !important;
            min-width: 60px !important;
            height: auto !important;
            
            /* Typography */
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif !important;
            font-size: 0.75rem !important;
            font-weight: 500 !important;
            text-align: center !important;
            text-decoration: none !important;
            white-space: nowrap !important;
            
            /* Default appearance (red - no files) */
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
            
            /* Border and shape */
            border: none !important;
            border-radius: 6px !important;
            
            /* Effects */
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            
            /* Prevent text selection */
            user-select: none !important;
            -webkit-user-select: none !important;
        }


        .files-button-custom:active {
            transform: translateY(0) !important;
        }

        /* Color variants for compliance status */
        .files-button-custom.status-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3) !important;
        }


        .files-button-custom.status-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3) !important;
        }


        .files-button-custom.status-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3) !important;
        }


        .files-button-custom.status-blue {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            background-color: #3b82f6 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3) !important;
        }

        
        .btn-view-files-blue {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            background-color: #fbbf24 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.3);
        }
        
        
        /* More specific selectors to override inline styles and btn-danger class */
        .btn.btn-view-files.btn-view-files-orange,
        .btn-sm.btn-view-files.btn-view-files-orange,
        .btn-danger.btn-view-files-orange,
        button.btn.btn-view-files.btn-view-files-orange,
        button.btn-sm.btn-view-files.btn-view-files-orange,
        button.btn-danger.btn-view-files-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
        }
        
        .btn.btn-view-files.btn-view-files-green,
        .btn-sm.btn-view-files.btn-view-files-green,
        .btn-danger.btn-view-files-green,
        button.btn.btn-view-files.btn-view-files-green,
        button.btn-sm.btn-view-files.btn-view-files-green,
        button.btn-danger.btn-view-files-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
        }
        
        .btn.btn-view-files.btn-view-files-red,
        .btn-sm.btn-view-files.btn-view-files-red,
        .btn-danger.btn-view-files-red,
        button.btn.btn-view-files.btn-view-files-red,
        button.btn-sm.btn-view-files.btn-view-files-red,
        button.btn-danger.btn-view-files-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
        }
        
        .btn.btn-view-files.btn-view-files-blue,
        .btn-sm.btn-view-files.btn-view-files-blue,
        .btn-danger.btn-view-files-blue,
        button.btn.btn-view-files.btn-view-files-blue,
        button.btn-sm.btn-view-files.btn-view-files-blue,
        button.btn-danger.btn-view-files-blue {
            background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
            background-color: #fbbf24 !important;
            color: white !important;
        }
        
        .btn-view-files-green {
            background: linear-gradient(135deg, #10B981, #059669) !important;
            background-color: #10B981 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        
        .btn-view-files-red {
            background: linear-gradient(135deg, #EF4444, #dc2626) !important;
            background-color: #EF4444 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        
        .btn-view-files-orange {
            background: linear-gradient(135deg, #f59e0b, #d97706) !important;
            background-color: #f59e0b !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        
        
        .btn-send {
            background-color: #10b981;
            color: white;
            margin: 1px;
            transition: all 0.3s ease;
        }
        
        .btn-send:hover {
            background-color: #059669;
        }
        
        .btn-send.sent {
            background-color: #6366f1;
        }
        
        .btn-send.sent:hover {
            background-color: #4f46e5;
        }
        
        .btn-send-ready {
            background-color: #10b981 !important;
            color: white !important;
            cursor: pointer !important;
        }
        
        .btn-send-ready:hover {
            background-color: #059669 !important;
        }
        
        .btn-send-disabled {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        .btn-send-disabled:hover {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }
        
        /* Sent status dropdown styling */
        .sent-status-dropdown {
            width: 250px !important;
            min-width: 250px !important;
            max-width: 300px !important;
            font-size: 0.7rem;
            padding: 4px 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            color: #374151;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        
        /* Inline button layout styling */
        .group-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .group-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }
        
        .button-with-uploader {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }
        
        .uploader-text {
            margin-top: 2px;
            text-align: center;
        }
        
        .uploader-text small {
            font-size: 0.6rem;
            line-height: 1;
        }
        
        .input-label {
            font-size: 0.7rem;
            font-weight: 500;
            color: var(--text-light);
            margin-bottom: 2px;
            text-align: center;
        }
        
        /* Responsive design for inline buttons */
        @media (max-width: 768px) {
            .group-buttons,
            .group-inputs {
                gap: 4px;
            }
            
            .button-with-uploader,
            .input-group {
                min-width: 50px;
            }
            
            .sent-status-dropdown {
                width: 120px;
                font-size: 0.6rem;
            }
            
            .input-label {
                font-size: 0.65rem;
            }
        }
        
        .sent-status-dropdown.sent-yes {
            background: #10b981 !important;
            color: white !important;
            border: 1px solid #059669 !important;
            font-weight: 500 !important;
        }
        
        .sent-status-dropdown.sent-no {
            background: #ef4444 !important;
            color: white !important;
            border: 1px solid #dc2626 !important;
            font-weight: 500 !important;
        }
        
        .sent-status-dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        .sent-status-dropdown:hover {
            border-color: #9ca3af;
        }
        
        /* Ensure all Sent status dropdowns stay aligned inline with RFI buttons */
        .sent-status-dropdown {
            min-width: 180px !important;
            width: 180px !important;
            max-width: 180px !important;
            height: 28px !important;
            margin: 8px 0 0 12px !important;
            text-align: center !important;
            vertical-align: middle !important;
            font-size: 0.7rem !important;
            border: 1px solid #d1d5db !important;
            border-radius: 4px !important;
            background: white !important;
            color: #374151 !important;
            cursor: pointer !important;
            font-weight: 400 !important;
            transition: all 0.2s ease !important;
        }
        
        /* Ensure dropdown options are properly styled */
        .sent-status-dropdown option {
            text-align: center !important;
            padding: 4px 8px !important;
            background-color: white !important;
            color: #333 !important;
        }
        
        .sent-status-dropdown option:hover {
            background-color: #f8f9fa !important;
        }
        
        /* Style for disabled Sent option when files incomplete */
        .sent-status-dropdown option:disabled {
            color: #9ca3af !important;
            background-color: #f3f4f6 !important;
            cursor: not-allowed !important;
        }
        
        /* Visual indicator for incomplete files */
        .sent-status-dropdown.incomplete-files {
            border-color: #f59e0b !important;
            background-color: #fef3c7 !important;
        }
        
        /* Disabled dropdown styling */
        .sent-status-dropdown.disabled-dropdown,
        .sent-status-dropdown:disabled {
            background-color: #f3f4f6 !important;
            color: #9ca3af !important;
            border-color: #d1d5db !important;
            cursor: not-allowed !important;
            opacity: 0.6 !important;
        }
        
        .sent-status-dropdown:disabled:hover {
            border-color: #d1d5db !important;
        }
        
        /* Prevent duplicate styling issues */
        .sent-status-dropdown.sent-yes option {
            background-color: white !important;
            color: #333 !important;
        }
        
        .sent-status-dropdown.sent-no option {
            background-color: white !important;
            color: #333 !important;
        }
        
        /* Ensure only 2 options are visible and properly aligned */
        .sent-status-dropdown {
            appearance: none !important;
            -webkit-appearance: none !important;
            -moz-appearance: none !important;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e") !important;
            background-repeat: no-repeat !important;
            background-position: right 8px center !important;
            background-size: 12px !important;
            padding-right: 24px !important;
        }
        
        /* Reset any inherited styles that might cause duplication */
        .sent-status-dropdown * {
            background-color: transparent !important;
        }
        
        /* Read-only sent status styling for inspectors */
        .sent-status-readonly {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 32px;
        }
        
        .sent-status-readonly .badge {
            font-weight: 500;
            text-align: center;
            white-space: nowrap;
        }
        
        .sent-status-readonly .badge-success {
            background-color: #10b981 !important;
            color: white !important;
        }
        
        .sent-status-readonly .badge-danger {
            background-color: #ef4444 !important;
            color: white !important;
        }
        
        .sent-status-readonly .badge-secondary {
            background-color: #6b7280 !important;
            color: white !important;
        }
        
        /* Sampled badges */
        
        /* Disabled row styling for sent items */
        .shipment-row.disabled-row {
            opacity: 0.4 !important;
            pointer-events: none !important;
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }
        
        .shipment-row.disabled-row td {
            background-color: #f8f9fa !important;
            color: #6c757d !important;
        }
        
        .shipment-row.disabled-row .btn,
        .shipment-row.disabled-row .form-control,
        .shipment-row.disabled-row .expand-btn {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }
        
        .shipment-row.disabled-row .expand-btn {
            pointer-events: none !important;
        }
        
        /* Dark mode disabled row styling */
        [data-theme="dark"] .shipment-row.disabled-row {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }
        
        [data-theme="dark"] .shipment-row.disabled-row td {
            background-color: #2d2d2d !important;
            color: #6b7280 !important;
        }
        
        /* 15-minute countdown styling */
        .fifteen-minute-countdown {
            font-size: 0.6rem !important;
            margin-top: 2px !important;
            text-align: center !important;
            color: #f59e0b !important;
            font-weight: bold !important;
            background-color: rgba(245, 158, 11, 0.1) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            border: 1px solid rgba(245, 158, 11, 0.3) !important;
        }
        
        .fifteen-minute-countdown[style*="color: #ef4444"] {
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: rgba(239, 68, 68, 0.3) !important;
        }
        
        /* Dark mode countdown styling */
        [data-theme="dark"] .fifteen-minute-countdown {
            background-color: rgba(245, 158, 11, 0.2) !important;
            border-color: rgba(245, 158, 11, 0.4) !important;
        }
        
        [data-theme="dark"] .fifteen-minute-countdown[style*="color: #ef4444"] {
            background-color: rgba(239, 68, 68, 0.2) !important;
            border-color: rgba(239, 68, 68, 0.4) !important;
        }
        .sampled-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .sampled-yes {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .sampled-no {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        /* Disabled button styling */
        .btn-lab:disabled,
        .btn-lab-form:disabled,
        .btn-retest:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }
        
        .btn-lab:disabled:hover,
        .btn-lab-form:disabled:hover,
        .btn-retest:disabled:hover {
            background-color: #9ca3af !important;
            color: #6b7280 !important;
        }
        
        /* Override disabled styling for uploaded buttons - they should be green when disabled */
        .btn-lab.uploaded:disabled,
        .btn-lab-form.uploaded:disabled,
        .btn-retest.uploaded:disabled {
            background-color: #059669 !important;
            color: #ffffff !important;
            opacity: 1 !important;
            cursor: not-allowed !important;
        }
        .btn-lab.uploaded:disabled:hover,
        .btn-lab-form.uploaded:disabled:hover,
        .btn-retest.uploaded:disabled:hover {
            background-color: #047857 !important;
            color: #ffffff !important;
        }
        
        /* Success state for disabled buttons - override the disabled styling */
        .btn-success.success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }
        
        .btn-success.success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
        }
        
        /* Also target buttons with specific IDs for lab, lab-form, and retest */
        button[id^="lab-"].success:disabled,
        button[id^="lab-form-"].success:disabled,
        button[id^="retest-"].success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }
        
        button[id^="lab-"].success:disabled:hover,
        button[id^="lab-form-"].success:disabled:hover,
        button[id^="retest-"].success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
        }
        
        /* Override any default disabled button styling with higher specificity */
        button.btn-success.success:disabled,
        button[id^="lab-"].btn-success.success:disabled,
        button[id^="lab-form-"].btn-success.success:disabled,
        button[id^="retest-"].btn-success.success:disabled {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
            cursor: not-allowed !important;
        }
        
        button.btn-success.success:disabled:hover,
        button[id^="lab-"].btn-success.success:disabled:hover,
        button[id^="lab-form-"].btn-success.success:disabled:hover,
        button[id^="retest-"].btn-success.success:disabled:hover {
            background-color: #28a745 !important;
            color: #ffffff !important;
            border-color: #28a745 !important;
            opacity: 1 !important;
        }
        
        .fa-check-circle {
            color: var(--secondary);
        }
        
        .fa-times-circle {
            color: var(--text-light);
        }
        
        /* Status badges */
        .status-badge {
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-open { background-color: #dbeafe; color: #1e40af; }
        .status-pending { background-color: #fef3c7; color: #d97706; }
        .status-active { background-color: #dbeafe; color: #1e40af; }
        .status-closed { background-color: #d1fae5; color: #065f46; }
        .status-rejected { background-color: #fee2e2; color: #dc2626; }
        .status-under-review { background-color: #f3e8ff; color: #7c3aed; }
        
        .settlement-settled { background-color: #d1fae5; color: #065f46; }
        .settlement-not-settled { background-color: #fee2e2; color: #dc2626; }
        .settlement-partial { background-color: #fef3c7; color: #d97706; }

        /* Compact the main table columns on laptop screens */
        @media (max-width: 1440px) {
            #shipmentsTable th,
            #shipmentsTable td {
                padding: 2px 4px;
                font-size: 0.65rem;
            }
            .col-client-name { min-width: 70px; max-width: 70px; }
            .col-compliance { min-width: 80px; max-width: 80px; }
            
            /* Mobile compliance status adjustments */
            .compliance-status {
                font-size: 0.6rem;
                padding: 1px 4px;
                min-width: 60px;
            }
            .col-date { min-width: 50px; }
            .col-rfi, .col-invoice, .col-km, .col-hours { min-width: 60px; }
            .col-send { min-width: 180px; }
        }
        
        /* Expandable table styles */
        .expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--primary);
            font-size: 0.8rem;
            padding: 4px;
            border-radius: 3px;
            transition: all 0.3s ease;
            display: inline-block;
            min-width: 20px;
            min-height: 20px;
            position: relative;
            z-index: 10;
        }
        
        .expand-btn:hover {
            background: var(--primary-light);
            transform: scale(1.1);
        }
        
        .expand-btn.expanded {
            transform: rotate(90deg);
        }
        
        .group-row {
            background-color: var(--card-bg);
            border-left: 3px solid var(--primary);
        }
        
        .group-row:hover {
            background-color: var(--primary-light);
        }
        
        .detail-row {
            background-color: #f8f9fa;
            width: 100%;
        }
        
        [data-theme="dark"] .detail-row {
            background-color: #363636;
        }
        
        .detail-cell {
            padding: 0;
            border: none;
            width: 100%;
        }
        
        .detail-content {
            padding: 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin: 8px;
            width: 100%;
            box-sizing: border-box;
        }
        
        .detail-content h4 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
            min-width: 100%; /* Use 100% instead of fixed pixel width */
            max-width: 100%; /* Prevent overflow beyond container */
            table-layout: fixed;
        }
        
        /* Detail table specific column widths */
        .detail-table th:nth-child(1) { width: 60px; } /* Inspection No */
        .detail-table th:nth-child(2) { width: 100px; } /* Client Name */
        .detail-table th:nth-child(3) { width: 70px; } /* Commodity */
        .detail-table th:nth-child(4) { width: 80px; } /* Compliance */
        .detail-table th:nth-child(5) { width: 180px; } /* Product Name - increased width */
        .detail-table th:nth-child(6) { width: 50px; } /* Sampled */
        .detail-table th:nth-child(7) { width: 60px; } /* Needs Retest */
        .detail-table th:nth-child(8) { width: 120px; } /* Class */
        .detail-table th:nth-child(9) { width: 30px; } /* Fat */
        .detail-table th:nth-child(10) { width: 30px; } /* Protein */
        .detail-table th:nth-child(11) { width: 30px; } /* Calcium */
        .detail-table th:nth-child(12) { width: 30px; } /* DNA */
        .detail-table th:nth-child(13) { width: 80px; } /* Bought Sample */
        .detail-table th:nth-child(14) { width: 80px; } /* Lab */
        .detail-table th:nth-child(15) { width: 220px; } /* Actions - Edit, Lab, Lab Form, Retest - increased for full visibility */
        
        /* Hide actions column for inspectors */
        .hide-actions .detail-table th:nth-child(15),
        .hide-actions .detail-table td:nth-child(15) { 
            display: none !important; 
        }
        
        .detail-table-wrapper {
            overflow-x: auto;
            width: 100%;
            border-radius: var(--radius);
            max-width: 100%;
            /* Constrain to parent table width to prevent main header shifting */
            max-width: calc(100vw - 100px); /* Account for page margins */
        }
        
        .detail-table {
            width: 100%;
            table-layout: fixed;
            margin: 0;
        }
        
        /* Ensure expanded content aligns with main table */
        .expanded-content {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .expanded-content .detail-table-wrapper {
            margin-left: 0;
            margin-right: 0;
        }
        
        /* Fix detail row alignment */
        .detail-row {
            width: 100%;
        }
        
        .detail-cell {
            padding: 0;
            width: 100%;
        }
        
        .detail-content {
            width: 100%;
            margin: 0;
            padding: 10px;
        }
        
        /* Prevent main table from being affected by expanded content */
        #shipmentsTable tbody tr:not(.detail-row) {
            position: relative;
            z-index: 5;
        }
        
        /* Ensure main table rows maintain their layout */
        #shipmentsTable tbody tr:not(.detail-row) td {
            position: relative;
            z-index: 5;
        }
        
        /* Keep actions inline on desktop and tablets */
        @media (max-width: 1024px) and (min-width: 769px) {
            .col-rfi, .col-invoice { width: 70px; min-width: 70px; max-width: 70px; }
            .col-km { width: 70px; min-width: 70px; max-width: 70px; }
            .col-hours { width: 70px; min-width: 70px; max-width: 70px; }
            .col-send { width: 180px; min-width: 180px; max-width: 180px; }
            .group-buttons .btn {
                font-size: 7px;
                padding: 2px 3px;
            }
            .group-km-input,
            .group-hours-input {
                width: 40px;
                font-size: 0.6rem;
                padding: 2px 3px;
            }
        }
        
        .detail-table th {
            background-color: var(--primary-light);
            color: var(--primary);
            padding: 2px 4px;
            font-weight: 600;
            font-size: 0.65rem;
            border-bottom: 1px solid var(--border);
        }
        
        .detail-table td {
            padding: 2px 4px;
            border-bottom: 1px solid var(--border);
            font-size: 0.65rem;
        }
        
        /* Specific styling for test columns in detail table */
        .detail-table .col-test {
            min-width: 30px !important;
            max-width: 35px !important;
            padding: 2px 3px !important;
        }
        
        .detail-table tr:hover {
            background-color: var(--primary-light);
        }
        
        .product-count {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        
        .col-expand {
            width: 30px;
            text-align: center;
        }
        
        
        /* Test checkbox styling */
        .test-checkbox {
            width: 14px;
            height: 14px;
            cursor: pointer;
            border: 2px solid var(--border);
            border-radius: 3px;
            transition: all 0.2s ease;
        }
        
        .test-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }
        
        .test-checkbox:hover {
            border-color: var(--primary);
        }
        
        /* Test column styling */
        .col-test {
            text-align: center;
            min-width: 25px;
            max-width: 30px;
            padding: 2px 2px !important;
        }
        
        /* Visible but disabled test columns when no sample was taken */
        .col-test.blurred {
            opacity: 1;
            pointer-events: none;
        }
        
        .col-test.blurred input[type="checkbox"] {
            opacity: 0.7;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #f5f5f5;
            border: 2px solid #d1d5db;
            filter: grayscale(100%);
        }
        
        .col-test.blurred input[type="checkbox"]:checked {
            background-color: #e5e7eb;
            border-color: #9ca3af;
            filter: grayscale(100%);
        }
        
        .col-bought-sample.blurred {
            opacity: 1;
            pointer-events: none;
        }
        
        .col-bought-sample.blurred input[type="number"] {
            opacity: 0.7;
            pointer-events: none;
            cursor: not-allowed;
            background-color: #f5f5f5;
            border: 2px solid #d1d5db;
            filter: grayscale(100%);
        }
        
        /* New column styling */
        .col-km {
            text-align: center;
            min-width: 60px;
            max-width: 70px;
        }
        
        .col-bought-sample {
            text-align: center;
            min-width: 80px;
            max-width: 100px;
            border: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        /* Additional aggressive border removal for bought sample */
        .detail-table .col-bought-sample,
        .detail-table td.col-bought-sample {
            border: none !important;
            border-bottom: none !important;
            border-top: none !important;
            border-left: none !important;
            border-right: none !important;
            border-width: 0 !important;
            border-style: none !important;
            border-color: transparent !important;
            outline: none !important;
            box-shadow: none !important;
        }
        
        .col-hours {
            text-align: center;
            min-width: 50px;
            max-width: 60px;
        }
        
        .col-lab-dropdown {
            text-align: center;
            min-width: 70px;
            max-width: 80px;
        }
        
        /* Inspection number column - make it narrower */
        .detail-table th:first-child,
        .detail-table td:first-child {
            min-width: 40px;
            max-width: 50px;
            text-align: center;
        }
        
        /* Client name column */
        .detail-table th:nth-child(2),
        .detail-table td:nth-child(2) {
            min-width: 80px;
            max-width: 100px;
        }
        
        /* Commodity column */
        .detail-table th:nth-child(3),
        .detail-table td:nth-child(3) {
            min-width: 60px;
            max-width: 70px;
        }
        
        /* Compliance column */
        .detail-table th:nth-child(4),
        .detail-table td:nth-child(4) {
            min-width: 70px;
            max-width: 80px;
            text-align: center;
        }
        
        /* Product Name column */
        .detail-table th:nth-child(5),
        .detail-table td:nth-child(5) {
            min-width: 150px;
            max-width: 180px;
            text-align: center;
        }
        
        /* Needs retest dropdown styling */
        .needs-retest-dropdown {
            width: 100%;
            padding: 2px 4px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.65rem;
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
            max-width: 70px;
        }
        
        /* Sampled column */
        .detail-table th:nth-child(6),
        .detail-table td:nth-child(6) {
            min-width: 40px;
            max-width: 50px;
            text-align: center;
        }
        
        /* Needs retest column */
        .detail-table th:nth-child(7),
        .detail-table td:nth-child(7) {
            min-width: 50px;
            max-width: 60px;
            text-align: center;
        }

        .bought-sample-input{
            border: none;
        }
        
        /* New input and dropdown styling */
        .km-input, .hours-input, .bought-sample-input {
            width: 100%;
            padding: 4px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
            transition: all 0.2s ease;
        }
        
        /* Add border back for km-input and hours-input only (EXCEPT bought sample inputs) */
        .km-input, .hours-input {
                border: 1px solid var(--border);
        }
        
        
        
        /* SIMPLE BOUGHT SAMPLE INPUT - Clean, no borders */
        .simple-bought-sample {
            width: 100%;
            padding: 4px 6px;
            border: none;
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: var(--card-bg);
            color: var(--text);
            text-align: center;
            transition: background-color 0.2s ease;
            outline: none;
            box-shadow: none;
        }
        
        .simple-bought-sample:focus {
            background-color: var(--card-bg);
            outline: none;
            box-shadow: none;
        }
        
        .simple-bought-sample:hover {
            background-color: var(--card-bg);
        }
        
        /* Product name text styling */
        .product-name-text {
            font-size: 0.7rem;
            color: var(--text);
            text-align: left;
        }
        
        /* Greyed out groups for "New" clients */
        .greyed-out-group {
            opacity: 0.5;
            background-color: #f5f5f5 !important;
        }
        
        .greyed-out-group:hover {
            opacity: 0.7;
        }
        
        /* Ensure table headers are visible */
        #shipmentsTable thead {
            display: table-header-group !important;
            visibility: visible !important;
        }
        
        #shipmentsTable thead th {
            display: table-cell !important;
            visibility: visible !important;
            background-color: #f8f9fa;
            font-weight: bold;
            border-bottom: 2px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            white-space: nowrap;
            overflow: visible;
        }
        
        /* Force table to respect column widths */
        .table-responsive {
            overflow-x: auto;
            max-width: 100%;
        }
        
        /* Ensure all table cells respect their column widths */
        #shipmentsTable th,
        #shipmentsTable td {
            box-sizing: border-box;
            overflow: hidden;
        }
        
        /* Fix main table header positioning when expanded */
        #shipmentsTable thead tr {
            position: relative;
            z-index: 10;
        }
        
        #shipmentsTable thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa !important;
            z-index: 10;
        }
        
        /* Ensure main table headers don't move when detail rows are shown */
        .detail-row {
            position: relative;
            z-index: 1;
        }
        
        .detail-cell {
            position: relative;
            z-index: 1;
        }
        
        /* Force table to maintain its layout */
        #shipmentsTable {
            position: relative;
        }
        
        /* Prevent any layout shifts */
        .table-responsive {
            position: relative;
            overflow-x: auto;
        }
        
        /* Lock header positions */
        #shipmentsTable thead {
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* Prevent main table from being affected by detail table overflow */
        #shipmentsTable {
            position: relative;
            overflow: visible;
        }
        
        /* Ensure detail rows don't push main table around */
        .detail-row {
            position: relative;
            overflow: hidden;
        }
        
        .detail-cell {
            position: relative;
            overflow: hidden;
            padding: 0;
        }
        
        /* Manual input styling */
        .km-input.manual-input {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        
        .km-input.manual-input:focus {
            background-color: #fff;
            border-color: #007bff;
        }
        
        .lab-dropdown {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--border);
            border-radius: 3px;
            font-size: 0.7rem;
            background-color: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .km-input:focus, .hours-input:focus, .lab-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }
        
        .needs-retest-dropdown:hover {
            border-color: var(--primary);
        }
        
        .needs-retest-dropdown:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0, 120, 144, 0.2);
        }
        
        .needs-retest-dropdown option {
            background-color: var(--card-bg);
            color: var(--text);
        }
        
        /* Dark mode adjustments for dropdown */
        [data-theme="dark"] .needs-retest-dropdown {
            background-color: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }
        
        [data-theme="dark"] .needs-retest-dropdown option {
            background-color: var(--card-bg);
            color: var(--text);
        }
        
        /* Disabled dropdown styling */
        .needs-retest-dropdown:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f5f5f5;
            color: #999;
        }
        
        [data-theme="dark"] .needs-retest-dropdown:disabled {
            background-color: #404040;
            color: #666;
        }
        
        /* Search input styling */
        .search-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
            overflow: visible;
        }
        
        /* Ensure form field allows dropdown to extend */
        .form-field {
            overflow: visible !important;
        }
        
        /* Ensure form group allows dropdown to extend */
        .form-group {
            overflow: visible !important;
        }
        
        .search-input {
            transition: all 0.2s ease;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background-color: var(--card-bg);
            color: var(--text);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 144, 0.1);
        }
        
        .search-input:hover {
            border-color: var(--primary);
        }
        
        .search-icon {
            pointer-events: none;
            transition: color 0.2s ease;
        }
        
        .search-input:focus + .search-icon {
            color: var(--primary);
        }
        
        /* Dark mode search input */
        [data-theme="dark"] .search-input {
            background-color: var(--card-bg);
            color: var(--text);
            border-color: var(--border);
        }
        
        [data-theme="dark"] .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 120, 144, 0.2);
        }

        
        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-size: 18px;
        }
        
        
        /* Mobile Navigation Drawer */
        .mobile-nav {
            display: none;
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100vh;
            background: var(--card-bg);
            box-shadow: var(--shadow-lg);
            z-index: 999;
            transition: left 0.3s ease;
            overflow-y: auto;
        }
        
        .mobile-nav.show {
            left: 0;
        }
        
        .mobile-nav-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            text-align: center;
        }
        
        .mobile-nav-header img {
            max-height: 40px;
            margin-bottom: 10px;
        }
        
        .mobile-nav-links {
            padding: 20px 0;
        }
        
        .mobile-nav-links a,
        .mobile-nav-links button {
            display: block;
            width: 100%;
            padding: 12px 20px;
            color: var(--text);
            text-decoration: none;
            border: none;
            background: none;
            text-align: left;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            font-size: 14px;
        }
        
        .mobile-nav-links a:hover,
        .mobile-nav-links button:hover {
            background: var(--primary-light);
        }
        
        /* Mobile Overlay */
        .mobile-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
        }
        
        .mobile-overlay.show {
            display: block;
        }
        @media (max-width: 1024px) {
            .mobile-menu-btn {
                display: block;
            }
            
            .mobile-nav {
                display: block;
            }
            
            .container {
                padding-top: 60px;
            }
            
            .action-bar {
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .action-bar .btn {
                font-size: 12px;
                padding: 8px 12px;
            }
        }
        
        @media (max-width: 768px) {
            .form-group {
                grid-template-columns: 1fr;
            }
            
            .action-bar {
                flex-direction: column;
            }
            
            .action-bar .btn {
                width: 100%;
                margin-bottom: 5px;
            }
            
            /* Mobile Table Styles */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            #shipmentsTable {
                min-width: 800px;
                font-size: 12px;
            }
            
            #shipmentsTable th,
            #shipmentsTable td {
                padding: 8px 4px;
                font-size: 11px;
            }
            
            /* Hide less important columns on mobile */
            .col-account-code {
                display: none;
            }
            
            /* Adjust important columns for mobile */
            .col-client-name {
                min-width: 120px;
                max-width: 150px;
            }
            
            .col-date {
                min-width: 80px;
            }
            
            .col-inspector {
                min-width: 100px;
            }
            
            .col-email {
                min-width: 120px;
            }
            
            
            .col-view-files {
                min-width: 90px;
            }
            
            .col-rfi, .col-invoice { width: 60px; min-width: 60px; max-width: 60px; }
            .col-km { width: 60px; min-width: 60px; max-width: 60px; }
            .col-hours { width: 60px; min-width: 60px; max-width: 60px; }
            .col-send { width: 160px; min-width: 160px; max-width: 160px; }
            
            /* Keep buttons inline but smaller */
            .group-buttons {
                flex-wrap: nowrap;
                gap: 1px;
            }
            
            .group-buttons .btn {
                font-size: 8px;
                padding: 2px 4px;
                white-space: nowrap;
            }
            
            /* Ensure group inputs are visible on mobile */
            .group-inputs {
                gap: 6px;
                flex-wrap: nowrap;
            }
            
            .group-km-input,
            .group-hours-input {
                width: 45px;
                min-width: 45px;
                max-width: 45px;
                font-size: 0.6rem;
                padding: 2px 3px;
                flex-shrink: 0;
            }
            
            .input-label {
                font-size: 0.6rem;
            }
            
            /* Filter section mobile styles */
            .card {
                margin: 10px 5px;
            }
            
            .card-body {
                padding: 15px;
            }
            
            .form-group {
                gap: 10px;
            }
            
            .form-field {
                margin-bottom: 15px;
            }
            
            .form-control {
                font-size: 14px;
                padding: 10px;
            }
            
            /* Mobile detail table */
            .detail-table {
                font-size: 10px;
                overflow-x: auto;
            }
            
            .detail-table th,
            .detail-table td {
                padding: 4px 2px;
                font-size: 10px;
            }
            
            /* Button adjustments */
            .btn-sm {
                padding: 4px 6px;
                font-size: 10px;
            }
        }
        
        @media (max-width: 480px) {
            /* Extra small mobile devices */
            .container {
                padding: 5px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .header h2 {
                font-size: 14px;
            }
            
            /* Stack filter fields vertically on very small screens */
            .form-group {
                display: block;
            }
            
            .form-field {
                width: 100%;
                margin-bottom: 10px;
            }
            
            /* Further reduce table font size */
            #shipmentsTable {
                font-size: 10px;
            }
            
            #shipmentsTable th,
            #shipmentsTable td {
                padding: 4px 2px;
                font-size: 9px;
            }
            
            /* Hide even more columns on very small screens */
            .col-email:nth-child(5),
            .col-email:nth-child(6) {
                display: none;
            }
            
            /* Make action buttons even smaller but keep inline */
            .col-rfi, .col-invoice { width: 50px; min-width: 50px; max-width: 50px; }
            .col-km { width: 50px; min-width: 50px; max-width: 50px; }
            .col-hours { width: 50px; min-width: 50px; max-width: 50px; }
            .col-send { width: 140px; min-width: 140px; max-width: 140px; }
            
            .group-buttons {
                flex-wrap: nowrap;
                gap: 1px;
            }
            
            .group-buttons .btn {
                font-size: 7px;
                padding: 1px 3px;
                white-space: nowrap;
            }
            
            /* Ensure group inputs remain visible on very small screens */
            .group-km-input,
            .group-hours-input {
                width: 40px;
                font-size: 0.55rem;
                padding: 1px 2px;
            }
            
            .input-label {
                font-size: 0.55rem;
            }
            
            .btn-sm {
                padding: 3px 4px;
                font-size: 8px;
            }
        }
        
        @media (max-width: 1024px) and (min-width: 769px) {
            /* Tablet styles */
            .action-bar {
                flex-wrap: wrap;
                justify-content: center;
                gap: 10px;
            }
            
            .action-bar .btn {
                flex: 0 1 auto;
                min-width: 140px;
            }
            
            #shipmentsTable {
                font-size: 13px;
            }
            
            #shipmentsTable th,
            #shipmentsTable td {
                padding: 10px 6px;
                font-size: 12px;
            }
            
            .col-test {
                min-width: 25px !important;
                max-width: 30px !important;
            }
            
            .col-km {
                min-width: 60px;
                max-width: 70px;
            }
            
            .col-hours {
                min-width: 50px;
                max-width: 60px;
            }
            
            .col-lab-dropdown {
                min-width: 80px;
                max-width: 90px;
            }
            
            /* Make dropdowns smaller on mobile */
            .needs-retest-dropdown,
            .km-input,
            .hours-input,
            .lab-dropdown {
                font-size: 0.6rem;
                padding: 1px 2px;
            }
        }
        
        @media (max-width: 480px) {
            /* Even smaller adjustments for very small screens */
            .detail-table {
                font-size: 0.55rem;
            }
            
            .detail-table th,
            .detail-table td {
                padding: 1px 2px;
                font-size: 0.55rem;
            }
            
            .needs-retest-dropdown,
            .km-input,
            .hours-input,
            .lab-dropdown {
                font-size: 0.55rem;
                padding: 1px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay for large datasets -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loadingMessage">Loading {{ total_shipments }} records... Please wait...</div>
    </div>
    
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>
    
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <!-- Mobile Navigation -->
    <nav class="mobile-nav" id="mobile-nav">
        <div class="mobile-nav-header">
            <img src="{% static 'img/Food safetyagencylogo.png' %}" alt="Food Safety Agency Logo">
            <div style="font-size: 14px; font-weight: bold;">Food Safety Agency</div>
        </div>
        <div class="mobile-nav-links">
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' and request.user.role != 'admin' %}
            <a href="{% url 'home' %}">
                <i class="fas fa-home"></i> Home
            </a>
            {% endif %}
            
            <a href="{% url 'shipment_list' %}">
                <i class="fas fa-clipboard-check"></i> Inspections
            </a>
            
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
            <a href="{% url 'client_allocation' %}">
                <i class="fas fa-users"></i> Manage Clients
            </a>
            
            <a href="{% url 'analytics_dashboard' %}">
                <i class="fas fa-chart-line"></i> Analytics
            </a>
            {% endif %}
            
            {% if request.user.role == 'super_admin' or request.user.role == 'developer' %}
            <a href="{% url 'system_logs' %}">
                <i class="fas fa-list-alt"></i> System Logs
            </a>
            {% endif %}
            
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
            <button onclick="syncInspectionsFromShipmentList()">
                <i class="fas fa-sync-alt"></i> <span class="btn-text">Sync Inspections</span>
            </button>
            <div id="inspection-sync-status" style="margin-top: 10px;"></div>
            {% endif %}
            
            <button onclick="expandAll()">
                <i class="fas fa-expand-alt"></i> Expand All
            </button>
            
            <button onclick="collapseAll()">
                <i class="fas fa-compress-alt"></i> Collapse All
            </button>
            
            <form action="{% url 'logout' %}" method="post" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" style="color: var(--danger);">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
    </nav>

    
    <!-- Hidden CSRF token for AJAX requests -->
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token|escapejs }}">
    
    <div class="container">
        <div class="logo">
            <img src="{% static 'img/Food safetyagencylogo.png' %}" alt="Food Safety Agency Logo">
        </div>
        
        <div class="header">
            <h1>Food Safety Agency (Pty) Ltd</h1>
            <h2>Claims Records Management</h2>
        </div>
        

        <!-- Messages Section - Disabled -->
        
        <!-- User Context Message - Removed to hide status reset notifications -->
     
        <div class="action-bar">
            <!-- Home Button -->
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' and request.user.role != 'admin' %}
            <a href="{% url 'home' %}" class="btn" style="background: #10b981; color: white;" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='#10b981'">
                <i class="fas fa-home"></i> Home
            </a>
            {% endif %}
            
            <!-- Sync Shipments Button - Hidden for administrators -->
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' and request.user.role != 'admin' %}
            <form action="{% url 'refresh_inspections' %}" method="post" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: #007890; color: white;" onmouseover="this.style.background='#005a6b'" onmouseout="this.style.background='#007890'">
                    <i class="fas fa-sync-alt"></i> Sync Inspections
                </button>
            </form>
            {% endif %}
            
            <!-- Expand/Collapse All Buttons -->
            <button type="button" class="btn btn-secondary" onclick="expandAll()">
                <i class="fas fa-expand-alt"></i> Expand All
            </button>
            <button type="button" class="btn btn-secondary" onclick="collapseAll()">
                <i class="fas fa-compress-alt"></i> Collapse All
            </button>
            
            <!-- Analytics Dashboard Button (NEW) - Hidden for administrators -->
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' and request.user.role != 'admin' %}
            <a href="{% url 'analytics_dashboard' %}" class="btn btn-analytics">
                <i class="fas fa-chart-line"></i> Analytics Dashboard
            </a>
            {% endif %}
            
            <!-- Manage Clients Button -->
            {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
            <a href="{% url 'client_allocation' %}" class="btn btn-allocation">
                <i class="fas fa-users"></i> Manage Clients
            </a>
            {% endif %}
            
            <!-- System Logs Button - Available for super_admin and developer -->
            {% if request.user.role == 'super_admin' or request.user.role == 'developer' %}
            <a href="{% url 'system_logs' %}" class="btn" style="background: #6b7280; color: white;" onmouseover="this.style.background='#4b5563'" onmouseout="this.style.background='#6b7280'">
                <i class="fas fa-list-alt"></i> System Logs
            </a>
            {% endif %}
            
            <!-- Logout Button (Matching Other Buttons) -->
            <form action="{% url 'logout' %}" method="post" class="logout-form" style="display: inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </form>
        </div>
        
        <!-- Filter Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-filter"></i> Filter Claims
                </div>
            </div>
            <div class="card-body">
                <form method="get" action="">
                    <!-- First Row: Search and Selection Fields -->
                    <div class="form-group" style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div class="form-field" style="flex: 1; position: relative;">
                            <label class="form-label">Client Search</label>
                            <div class="search-input-wrapper" style="position: relative;">
                                <input type="text" class="form-control search-input" name="client" id="clientSearchInput" value="{{ request.GET.client }}" placeholder="Search client name..." autocomplete="off" style="padding-left: 35px;">
                                <i class="fas fa-search search-icon" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #6b7280; font-size: 14px;"></i>
                                <div id="clientSuggestions" class="autocomplete-dropdown" style="display: none;">
                                    <!-- Suggestions will be populated here -->
                                </div>
                            </div>
                        </div>
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">Inspector</label>
                            <select class="form-control" name="branch">
                                <option value="">All Inspectors</option>
                                {% for inspector in inspectors %}
                                <option value="{{ inspector }}" {% if request.GET.branch == inspector %}selected{% endif %}>{{ inspector }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <!-- Second Row: Date Range -->
                    <div class="form-group" style="display: flex; gap: 15px; margin-bottom: 20px;">
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">Date From</label>
                            <input type="date" class="form-control" name="inspection_date_from" value="{{ request.GET.inspection_date_from }}">
                        </div>
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">Date To</label>
                            <input type="date" class="form-control" name="inspection_date_to" value="{{ request.GET.inspection_date_to }}">
                        </div>
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">Sent Status</label>
                            <select class="form-control" name="sent_status">
                                <option value="">All Inspections</option>
                                <option value="YES" {% if request.GET.sent_status == 'YES' %}selected{% endif %}>Sent Only</option>
                                <option value="NO" {% if request.GET.sent_status == 'NO' %}selected{% endif %}>Not Sent Only</option>
                            </select>
                        </div>
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">RFI Status</label>
                            <select class="form-control" name="rfi_status">
                                <option value="">All Inspections</option>
                                <option value="HAS_RFI" {% if request.GET.rfi_status == 'HAS_RFI' %}selected{% endif %}>Has RFI</option>
                                <option value="NO_RFI" {% if request.GET.rfi_status == 'NO_RFI' %}selected{% endif %}>No RFI</option>
                            </select>
                        </div>
                        <div class="form-field" style="flex: 1;">
                            <label class="form-label">Compliance Status</label>
                            <select class="form-control" name="compliance_status">
                                <option value="">All Inspections</option>
                                <option value="COMPLIANT" {% if request.GET.compliance_status == 'COMPLIANT' %}selected{% endif %}>Compliant Only</option>
                                <option value="NON_COMPLIANT" {% if request.GET.compliance_status == 'NON_COMPLIANT' %}selected{% endif %}>Non-Compliant Only</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Action Buttons Row -->
                    <div class="form-group" style="display: flex; gap: 10px; align-items: center; padding-top: 10px; border-top: 1px solid #e5e7eb;">
                        <button type="submit" class="btn btn-primary" style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-search"></i> Apply Filters
                        </button>
                        <a href="?" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-times"></i> Clear All
                        </a>
                        {% if not show_all %}
                        <a href="?show_all=true" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-list"></i> Show All ({{ total_shipments }})
                        </a>
                        {% else %}
                        <a href="?" class="btn btn-secondary" style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-list"></i> Show Paginated
                        </a>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        <!-- Claims Table -->
        <div class="card">
            <div class="card-header">
                <div class="card-title">
                    <i class="fas fa-clipboard-check"></i> Inspections List
                </div>

            </div>
            <div class="card-body">
                <div class="table-controls">
                    <div class="table-info">
                        {% if show_all %}
                            Showing all {{ total_shipments }} inspection{{ total_shipments|pluralize }}
                        {% else %}
                            Showing {{ shipments|length }} of {{ total_shipments }} inspection{{ total_shipments|pluralize }}
                        {% endif %}
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="shipmentsTable">
                        <thead>
                            <tr>
                                <th class="col-expand"></th>
                                <th class="col-client-name">Client Name</th>
                                <th class="col-account-code">Account Code</th>
                                <th class="col-date">Inspection Date</th>
                                <th class="col-email">Email</th>
                                <th class="col-inspector">Inspector</th>
                                <th class="col-view-files">View Files</th>
                                <th class="col-rfi">RFI</th>
                                {% if user.role != 'inspector' %}
                                <th class="col-invoice">Invoice</th>
                                {% endif %}
                                <th class="col-km">Distance (Km)</th>
                                <th class="col-hours">Hours Worked</th>
                                <th class="col-send">Sent Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for shipment in shipments %}
                            <!-- Generate fallback group_id for this shipment -->
                            {% with client_slug=shipment.client_name|sanitize_group_id %}
                            {% with date_str=shipment.date_of_inspection|date:"Ymd" %}
                            {% with fallback_group_id=client_slug|add:"_"|add:date_str %}
                            <!-- Main grouped row -->
                            <tr class="group-row shipment-row {% if shipment.is_complete and not shipment.is_sent %}inspection-complete{% endif %} {% if shipment.client_name|slice:':3' == 'New' %}greyed-out-group{% endif %}" data-group-id="{{ fallback_group_id }}" data-client-name="{{ shipment.client_name }}" data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}" {% if shipment.sent_date %}data-sent-timestamp="{{ shipment.sent_date|date:'c' }}"{% endif %}>
                                <td class="col-expand">
                                    <button class="expand-btn" data-group-id="{{ fallback_group_id }}" title="Expand/Collapse">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </td>
                                <td class="col-client-name tooltip" data-tooltip="{{ shipment.client_name }}">
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <span>{{ shipment.client_name|default:"-" }}</span>
                                        {% comment %} Sample status indicator will be added by JavaScript {% endcomment %}
                                        <span class="sample-indicator" data-group-id="{{ fallback_group_id }}" style="font-size: 0.5rem;"></span>
                                    </div>
                                </td>
                                <td class="col-account-code">{{ shipment.internal_account_code|default:"-" }}</td>
                                <td class="col-date">{{ shipment.date_of_inspection|date:"m/d/y"|default:"-" }}</td>
                                <td class="col-email">
                                    {% if shipment.client_emails %}
                                        {% for item in shipment.client_emails %}
                                            <div class="email-line">
                                                <span>{{ item.email }}</span>
                                                {% if item.removable %}
                                                    <button class="btn btn-xs" title="Remove" onclick="deleteClientEmail('{{ shipment.client_name }}', '{{ item.email }}')">×</button>
                                                {% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td class="col-inspector">{{ shipment.inspector_name|default:"-" }}</td>
                                <td class="col-view-files">
                                    <button class="btn btn-sm btn-view-files
                                           {% if shipment.compliance_status == 'complete' %}
                                               btn-files-complete
                                           {% elif shipment.compliance_status == 'partial' %}
                                               btn-files-partial
                                           {% elif shipment.compliance_status == 'no_compliance' %}
                                               btn-files-none
                                           {% else %}
                                               btn-files-checking
                                           {% endif %}" 
                                           data-group-id="{{ fallback_group_id|escapejs }}" 
                                           data-client-name="{{ shipment.client_name|escapejs }}" 
                                           data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d"|escapejs }}" 
                                           onclick="if(typeof openFilesPopup === 'function') { openFilesPopup(this.dataset.groupId, this.dataset.clientName, this.dataset.inspectionDate); } else { console.warn('openFilesPopup not loaded yet'); }" 
                                           title="View Files - 
                                           {% if shipment.compliance_status == 'complete' %}All required files present
                                           {% elif shipment.compliance_status == 'partial' %}Some files present
                                           {% elif shipment.compliance_status == 'no_compliance' %}No files found
                                           {% else %}Status checking...{% endif %}">
                                        Files
                                    </button>
                                </td>
                                <!-- RFI Column -->
                                <td class="col-rfi">
                                    {% if request.user.role == 'inspector' %}
                                        {% if shipment.rfi_uploaded %}
                                        <button class="btn btn-sm btn-success" id="rfi-{{ fallback_group_id }}" disabled 
                                                title="RFI file exists" style="background-color: #28a745; border-color: #28a745;">
                                            RFI ✓
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" id="rfi-{{ fallback_group_id }}" onclick="uploadRFI('{{ fallback_group_id|escapejs }}')" 
                                                title="Upload RFI" 
                                                data-client-name="{{ shipment.client_name }}" 
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}">
                                            RFI
                                        </button>
                                        {% endif %}
                                    {% elif request.user.role != 'scientist' %}
                                        {% if shipment.rfi_uploaded %}
                                        <button class="btn btn-sm btn-success" id="rfi-{{ fallback_group_id }}" disabled 
                                                title="RFI file exists" style="background-color: #28a745; border-color: #28a745;">
                                            RFI ✓
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" id="rfi-{{ fallback_group_id }}" onclick="uploadRFI('{{ fallback_group_id|escapejs }}')" 
                                                title="Upload RFI">
                                            RFI
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                
                                <!-- Invoice Column -->
                                {% if user.role != 'inspector' %}
                                <td class="col-invoice">
                                    {% if request.user.role != 'inspector' and request.user.role != 'scientist' %}
                                        {% if shipment.invoice_uploaded %}
                                        <button class="btn btn-sm btn-success" id="invoice-{{ fallback_group_id }}" disabled 
                                                title="Invoice file exists" style="background-color: #28a745; border-color: #28a745;">
                                            Invoice ✓
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" id="invoice-{{ fallback_group_id }}" onclick="uploadInvoice('{{ fallback_group_id|escapejs }}')" 
                                                title="Upload Invoice"
                                                data-client-name="{{ shipment.client_name }}" 
                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}">
                                            Invoice
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                {% endif %}
                                
                                <!-- Km Column -->
                                <td class="col-km">
                                    {% if request.user.role == 'inspector' %}
                                        <input type="number" class="form-control form-control-sm group-km-input" 
                                               data-group-id="{{ fallback_group_id }}" 
                                               value="{{ shipment.km_traveled|default:'' }}" 
                                               placeholder="0.0" 
                                               step="0.1" 
                                               min="0" 
                                               onchange="updateGroupKmTraveled(this)"
                                               title="Total kilometers traveled for this inspection group">
                                    {% elif request.user.role != 'scientist' %}
                                        <input type="number" class="form-control form-control-sm group-km-input" 
                                               data-group-id="{{ fallback_group_id }}" 
                                               value="{{ shipment.km_traveled|default:'' }}" 
                                               placeholder="0.0" 
                                               step="0.1" 
                                               min="0" 
                                               onchange="updateGroupKmTraveled(this)"
                                               title="Total kilometers traveled for this inspection group">
                                    {% else %}
                                        {{ shipment.km_traveled|default:"-" }}
                                    {% endif %}
                                </td>
                                
                                <!-- Hours Column -->
                                <td class="col-hours">
                                    {% if request.user.role == 'inspector' %}
                                        <input type="number" class="form-control form-control-sm group-hours-input" 
                                               data-group-id="{{ fallback_group_id }}" 
                                               value="{{ shipment.hours|default:'' }}" 
                                               placeholder="0.0" 
                                               step="0.1" 
                                               min="0" 
                                               onchange="updateGroupHours(this)"
                                               title="Total hours spent on this inspection group">
                                    {% elif request.user.role != 'scientist' %}
                                        <input type="number" class="form-control form-control-sm group-hours-input" 
                                               data-group-id="{{ fallback_group_id }}" 
                                               value="{{ shipment.hours|default:'' }}" 
                                               placeholder="0.0" 
                                               step="0.1" 
                                               min="0" 
                                               onchange="updateGroupHours(this)"
                                               title="Total hours spent on this inspection group">
                                    {% else %}
                                        {{ shipment.hours|default:"-" }}
                                    {% endif %}
                                </td>
                                
                                <!-- Sent Status Column -->
                                <td class="col-send">
                                    {% if user_role != 'inspector' and user_role != 'scientist' %}
                                        <select class="form-control form-control-sm sent-status-dropdown {% if shipment.is_sent %}sent-yes{% elif shipment.is_sent == False %}sent-no{% endif %}{% if shipment.compliance_status != 'complete' %} disabled-dropdown{% endif %}" 
                                                data-group-id="{{ fallback_group_id }}" 
                                                data-delay-days="{{ onedrive_delay_days }}" 
                                                data-compliance-status="{{ shipment.compliance_status }}"
                                                onchange="updateSentStatus(this)" 
                                                {% if shipment.compliance_status != 'complete' %}disabled{% endif %}
                                                title="{% if shipment.compliance_status == 'complete' %}Mark as sent when documents are delivered{% else %}All required files must be uploaded before marking as sent (Status: {{ shipment.compliance_status }}){% endif %}">
                                            <option value="NO" {% if shipment.is_sent == False %}selected{% endif %}>Not Sent</option>
                                            <option value="YES" {% if shipment.is_sent %}selected{% endif %}>{% if shipment.sent_by and shipment.sent_by.first_name %}{{ shipment.sent_by.first_name }}{% else %}{{ shipment.sent_by.username|default:"Sent" }}{% endif %}{% if shipment.sent_date %} - {{ shipment.sent_date|date:"M d, Y H:i" }}{% endif %}</option>
                                        </select>
                                        {% if shipment.is_sent == True and shipment.sent_date %}
                                        <div class="onedrive-countdown" 
                                             data-sent-date="{{ shipment.sent_date|date:'c' }}" 
                                             data-onedrive-uploaded="{{ shipment.onedrive_uploaded|yesno:'true,false' }}"
                                             data-onedrive-upload-date="{% if shipment.onedrive_upload_date %}{{ shipment.onedrive_upload_date|date:'c' }}{% endif %}"
                                             data-delay-days="{{ onedrive_delay_days }}"
                                             style="font-size: 0.6rem; margin-top: 2px; text-align: center;">
                                            <span class="countdown-text">{{ onedrive_delay_days|floatformat:0 }} days until upload</span>
                                        </div>
                                        {% else %}
                                        <small class="text-muted" style="font-size: 0.6rem; margin-top: 2px; text-align: center; display: block;">Status</small>
                                        {% endif %}
                                    {% else %}
                                        <!-- Read-only sent status display for inspectors -->
                                        <div class="sent-status-readonly">
                                            {% if shipment.is_sent == True %}
                                                <span class="badge badge-success" style="background-color: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                                                    {% if shipment.sent_by and shipment.sent_by.first_name %}{{ shipment.sent_by.first_name }}{% else %}{{ shipment.sent_by.username|default:"Sent" }}{% endif %} ✓
                                                </span>
                                                {% if shipment.sent_date %}
                                                <small class="text-muted" style="font-size: 0.6rem; margin-top: 2px; text-align: center; display: block;">
                                                    {{ shipment.sent_date|date:"M d, Y H:i" }}
                                                </small>
                                                {% endif %}
                                            {% elif shipment.is_sent == False %}
                                                <span class="badge badge-danger" style="background-color: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                                                    Not Sent
                                                </span>
                                            {% else %}
                                                <!-- Fallback for when is_sent is None or not set -->
                                                <span class="badge badge-secondary" style="background-color: #6b7280; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem;">
                                                    Not Sent
                                                </span>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            <!-- Expandable detail rows -->
                            <tr class="detail-row" id="detail-{{ fallback_group_id }}" style="display: none;">
                                <td colspan="{% if user.role == 'inspector' %}12{% else %}13{% endif %}" class="detail-cell">
                                    <div class="detail-content">
                                        <h4>Products for {{ shipment.client_name }} - {{ shipment.date_of_inspection|date:"m/d/y" }} 
                                            <small style="color: #666; font-size: 0.8em;">
                                                ({{ shipment.products|length }} products)
                                            </small>
                                        </h4>
                                        <div class="detail-table-wrapper">
                                            <table class="detail-table">
                                            <thead>
                                                <tr>
                                                    <th>Inspection No</th>
                                                    <th>Client Name</th>
                                                    <th>Commodity</th>
                                                    <th>Compliance</th>
                                                    <th class="col-km">Product Name</th>
                                                    <th>Sampled</th>
                                                    <th>Needs Retest</th>
                                                    <th class="col-km">Class</th>
                                                    <th class="col-test">Fat</th>
                                                    <th class="col-test">Protein</th>
                                                    <th class="col-test">Calcium</th>
                                                    <th class="col-test">DNA</th>
                                                    <th class="col-bought-sample">Bought Sample (R)</th>
                                                    <th class="col-lab-dropdown">Lab</th>
                                                    {% if user.role != 'inspector' %}
                                                    <th>Actions</th>
                                                    {% endif %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if shipment.products %}
                                                    {% for product in shipment.products %}
                                                    <tr class="{% if product.is_complete %}inspection-complete{% endif %}">
                                                    <td>{{ product.remote_id|default:"-" }}</td>
                                                    <td>{{ product.client_name|default:"-" }}</td>
                                                    <td>{{ product.commodity|default:"-" }}</td>
                                                    <td>
                                                        {% if product.is_direction_present_for_this_inspection %}
                                                            <span class="compliance-status non-compliant" title="Non-Compliant (Direction Present)">Non-Compliant</span>
                                                        {% else %}
                                                            <span class="compliance-status compliant" title="Compliant (No Direction)">Compliant</span>
                                                        {% endif %}
                                                    </td>
                                                    <td class="col-km">
                                                        {% if product.has_sql_product_name %}
                                                            <span class="product-name-text">{{ product.product_name|default:"No product name" }}</span>
                                                        {% else %}
                                                            <input type="text" class="km-input manual-input" 
                                                                   data-inspection-id="{{ product.remote_id }}" 
                                                                   value="{{ product.product_name|default:'' }}"
                                                                   placeholder="Enter product name"
                                                                   onchange="updateProductName(this)"
                                                                   title="Manual entry - no SQL Server data found">
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        {% if product.is_sample_taken %}
                                                            <span class="sampled-badge sampled-yes">Yes</span>
                                                        {% else %}
                                                            <span class="sampled-badge sampled-no">No</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>
                                                        <select class="form-control form-control-sm needs-retest-dropdown" data-inspection-id="{{ product.remote_id }}" onchange="updateNeedsRetest(this)" {% if not product.is_sample_taken %}disabled style="opacity: 0.5; cursor: not-allowed;" title="No sample taken - retest not possible"{% endif %}>
                                                            <option value="">Select...</option>
                                                            <option value="YES" {% if product.needs_retest == 'YES' %}selected{% endif %}>Yes</option>
                                                            <option value="NO" {% if product.needs_retest == 'NO' or not product.is_sample_taken %}selected{% endif %}>No</option>
                                                        </select>
                                                    </td>
                                                    <td class="col-km {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        {% with lower_commodity=product.commodity|default:''|lower %}
                                                        <select class="km-input product-class-select" 
                                                                data-inspection-id="{{ product.remote_id }}"
                                                                data-commodity="{{ lower_commodity }}"
                                                                onchange="updateProductClass(this)"
                                                                {% if lower_commodity == 'egg' or lower_commodity == 'eggs' or lower_commodity == 'poultry' or lower_commodity == 'chicken' %}disabled style="opacity: 0.5; cursor: not-allowed;" title="Class not applicable for Egg/Poultry"{% endif %}>
                                                            {% if lower_commodity == 'egg' or lower_commodity == 'eggs' or lower_commodity == 'poultry' or lower_commodity == 'chicken' %}
                                                                <option value="">No Class</option>
                                                            {% else %}
                                                                <option value="">Select Class...</option>
                                                                <option value="Raw species sausage / wors" {% if product.product_class == 'Raw species sausage / wors' %}selected{% endif %}>Raw species sausage / wors</option>
                                                                <option value="Extra Lean Mince" {% if product.product_class == 'Extra Lean Mince' %}selected{% endif %}>Extra Lean Mince</option>
                                                                <option value="Lean Mince" {% if product.product_class == 'Lean Mince' %}selected{% endif %}>Lean Mince</option>
                                                                <option value="Regular Mince" {% if product.product_class == 'Regular Mince' %}selected{% endif %}>Regular Mince</option>
                                                                <option value="Raw Flavoured Ground Meat" {% if product.product_class == 'Raw Flavoured Ground Meat' %}selected{% endif %}>Raw Flavoured Ground Meat</option>
                                                                <option value="Raw Flavoured Ground Meat & Offal" {% if product.product_class == 'Raw Flavoured Ground Meat & Offal' %}selected{% endif %}>Raw Flavoured Ground Meat & Offal</option>
                                                                <option value="Raw Flavoured mixed species Ground Meat" {% if product.product_class == 'Raw Flavoured mixed species Ground Meat' %}selected{% endif %}>Raw Flavoured mixed species Ground Meat</option>
                                                                <option value="Raw Flavoured mixed species Ground Meat & Offal" {% if product.product_class == 'Raw Flavoured mixed species Ground Meat & Offal' %}selected{% endif %}>Raw Flavoured mixed species Ground Meat & Offal</option>
                                                                <option value="Raw Boerewors" {% if product.product_class == 'Raw Boerewors' %}selected{% endif %}>Raw Boerewors</option>
                                                                <option value="Raw mixed species sausage / wors" {% if product.product_class == 'Raw mixed species sausage / wors' %}selected{% endif %}>Raw mixed species sausage / wors</option>
                                                                <option value="Ground Burger / Ground patty = Extra Lean" {% if product.product_class == 'Ground Burger / Ground patty = Extra Lean' %}selected{% endif %}>Ground Burger / Ground patty = Extra Lean</option>
                                                                <option value="Ground Burger / Ground patty = Lean" {% if product.product_class == 'Ground Burger / Ground patty = Lean' %}selected{% endif %}>Ground Burger / Ground patty = Lean</option>
                                                                <option value="Ground Burger / Ground patty = Regular" {% if product.product_class == 'Ground Burger / Ground patty = Regular' %}selected{% endif %}>Ground Burger / Ground patty = Regular</option>
                                                                <option value="Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean" {% if product.product_class == 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean' %}selected{% endif %}>Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Extra Lean</option>
                                                                <option value="Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean" {% if product.product_class == 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean' %}selected{% endif %}>Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Lean</option>
                                                                <option value="Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular" {% if product.product_class == 'Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular' %}selected{% endif %}>Burger / Patty / Hamburger Patty / Meatball / Frikkadel = Regular</option>
                                                                <option value="Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel" {% if product.product_class == 'Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel' %}selected{% endif %}>Value burger / Value patty / Value hamburger / Value meatball / Value frikkadel</option>
                                                                <option value="Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger" {% if product.product_class == 'Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger' %}selected{% endif %}>Economy Burger / Econo Burger / Economy Patty / Econo Patty / Budget Burger</option>
                                                                <option value="Raw Banger / Griller" {% if product.product_class == 'Raw Banger / Griller' %}selected{% endif %}>Raw Banger / Griller</option>
                                                                <option value="Raw Bratwurst / Sizzler" {% if product.product_class == 'Raw Bratwurst / Sizzler' %}selected{% endif %}>Raw Bratwurst / Sizzler</option>
                                                                <option value="Whole Muscle, uncured and heat / partial heat treated products" {% if product.product_class == 'Whole Muscle, uncured and heat / partial heat treated products' %}selected{% endif %}>Whole Muscle, uncured and heat / partial heat treated products</option>
                                                                <option value="Whole muscle, uncured, no or partial heat treated and air dried products" {% if product.product_class == 'Whole muscle, uncured, no or partial heat treated and air dried products' %}selected{% endif %}>Whole muscle, uncured, no or partial heat treated and air dried products</option>
                                                                <option value="Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)" {% if product.product_class == 'Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)' %}selected{% endif %}>Whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)</option>
                                                                <option value="Whole muscle, dry cured, no or partial heat treated products" {% if product.product_class == 'Whole muscle, dry cured, no or partial heat treated products' %}selected{% endif %}>Whole muscle, dry cured, no or partial heat treated products</option>
                                                                <option value="Whole muscle, cured and no or partial heat treated products" {% if product.product_class == 'Whole muscle, cured and no or partial heat treated products' %}selected{% endif %}>Whole muscle, cured and no or partial heat treated products</option>
                                                                <option value="Whole muscle, cured, no or partial heat treated and air dried products" {% if product.product_class == 'Whole muscle, cured, no or partial heat treated and air dried products' %}selected{% endif %}>Whole muscle, cured, no or partial heat treated and air dried products</option>
                                                                <option value="Whole muscle, dry cured, no or partial heat treated and dried products" {% if product.product_class == 'Whole muscle, dry cured, no or partial heat treated and dried products' %}selected{% endif %}>Whole muscle, dry cured, no or partial heat treated and dried products</option>
                                                                <option value="PMP" {% if product.product_class == 'PMP' %}selected{% endif %}>PMP</option>
                                                                <option value="RAW" {% if product.product_class == 'RAW' %}selected{% endif %}>RAW</option>
                                                            {% endif %}
                                                        {% endwith %}
                                                        </select>
                                                    </td>
                                                    <td class="col-test {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        <input type="checkbox" class="test-checkbox" data-inspection-id="{{ product.remote_id }}" data-test-type="fat" 
                                                               {% if product.fat %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %} onchange="updateTestResult(this)">
                                                    </td>
                                                    <td class="col-test {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        <input type="checkbox" class="test-checkbox" data-inspection-id="{{ product.remote_id }}" data-test-type="protein" 
                                                               {% if product.protein %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %} onchange="updateTestResult(this)">
                                                    </td>
                                                    <td class="col-test {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        <input type="checkbox" class="test-checkbox" data-inspection-id="{{ product.remote_id }}" data-test-type="calcium" 
                                                               {% if product.calcium %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %} onchange="updateTestResult(this)">
                                                    </td>
                                                    <td class="col-test {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        <input type="checkbox" class="test-checkbox" data-inspection-id="{{ product.remote_id }}" data-test-type="dna" 
                                                               {% if product.dna %}checked{% endif %} {% if not product.is_sample_taken %}disabled{% endif %} onchange="updateTestResult(this)">
                                                    </td>
                                                    <td class="col-bought-sample {% if not product.is_sample_taken %}blurred{% endif %}">
                                                        <input type="number" class="simple-bought-sample" 
                                                               data-inspection-id="{{ product.remote_id }}" 
                                                               value="{{ product.bought_sample|default:'' }}" 
                                                               placeholder="0.00" 
                                                               step="0.01"
                                                               min="0"
                                                               onchange="updateBoughtSample(this)" 
                                                               {% if not product.is_sample_taken %}disabled style="opacity: 0.5; cursor: not-allowed;" title="No sample taken - cannot enter bought sample"{% endif %}>
                                                    </td>
                                                    <td class="col-lab-dropdown">
                                                        <select class="form-control form-control-sm lab-dropdown" 
                                                                data-inspection-id="{{ product.remote_id }}" 
                                                                onchange="updateLab(this)"
                                                                {% if not product.is_sample_taken %}disabled style="opacity: 0.5; cursor: not-allowed;" title="No sample taken - Lab selection disabled"{% endif %}>
                                                            <option value="">Select Lab...</option>
                                                            <option value="lab_b" {% if product.lab == 'lab_b' %}selected{% endif %}>Merieux NutriSciences</option>
                                                            <option value="lab_c" {% if product.lab == 'lab_c' %}selected{% endif %}>AGRI Food Laboratory (SGS)</option>
                                                            <option value="lab_d" {% if product.lab == 'lab_d' %}selected{% endif %}>SANBI</option>
                                                            <option value="lab_e" {% if product.lab == 'lab_e' %}selected{% endif %}>SMT</option>
                                                            <option value="lab_f" {% if product.lab == 'lab_f' %}selected{% endif %}>ARC</option>
                                                            <option value="lab_a" {% if product.lab == 'lab_a' %}selected{% endif %}>Food Safety Laboratory</option>
                                                        </select>
                                                    </td>
                                                    {% if user.role != 'inspector' %}
                                                    <td>
                                                        <!-- Other roles can upload lab documents -->
                                                        {% if product.is_sample_taken %}
                                                        <button class="btn btn-sm btn-lab" id="lab-{{ product.remote_id }}" 
                                                                data-group-id="{{ fallback_group_id }}"
                                                                data-client-name="{{ shipment.client_name }}"
                                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                                onclick="uploadLab('{{ product.remote_id|escapejs }}')" 
                                                                title="Lab result upload available">
                                                            <i class="fas fa-flask"></i> Lab
                                                        </button>
                                                        <button class="btn btn-sm btn-lab-form" id="lab-form-{{ product.remote_id }}" 
                                                                data-group-id="{{ fallback_group_id }}"
                                                                data-client-name="{{ shipment.client_name }}"
                                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                                onclick="uploadLabForm('{{ product.remote_id|escapejs }}')" 
                                                                title="Lab form submission upload available">
                                                            <i class="fas fa-file-alt"></i> Lab Form
                                                        </button>
                                                        <button class="btn btn-sm btn-retest" id="retest-{{ product.remote_id }}" 
                                                                data-group-id="{{ fallback_group_id }}"
                                                                data-client-name="{{ shipment.client_name }}"
                                                                data-inspection-date="{{ shipment.date_of_inspection|date:"Y-m-d" }}"
                                                                {% if product.needs_retest != 'YES' %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}
                                                                {% if product.needs_retest == 'YES' %}onclick="uploadRetest('{{ product.remote_id|escapejs }}')"{% endif %} 
                                                                title="{% if product.needs_retest == 'YES' %}Retest required - Please upload retest document{% else %}No retest required - Upload disabled{% endif %}">
                                                            <i class="fas fa-redo"></i> Retest
                                                        </button>
                                                        {% else %}
                                                        <!-- No sample taken - show message instead of buttons -->
                                                        <span class="text-muted" style="font-size: 0.85em; font-style: italic;">
                                                            <i class="fas fa-info-circle"></i> No sample taken
                                                        </span>
                                                        {% endif %}
                                                    </td>
                                                    {% endif %}
                                                </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="{% if user.role == 'inspector' %}15{% else %}16{% endif %}" style="text-align: center; padding: 20px; color: #666; font-style: italic;">
                                                            <i class="fas fa-info-circle" style="margin-right: 8px; color: #ffc107;"></i>
                                                            No detailed inspection records found for this group.
                                                            <br><small style="color: #999; margin-top: 10px; display: block;">
                                                                This may occur if inspection records are still being processed or if you don't have permission to view detailed data for this group.
                                                                {% if user.role == 'inspector' %}
                                                                <br>As an inspector, you can only view inspections you conducted.
                                                                {% endif %}
                                                            </small>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% endwith %}
                            {% endwith %}
                            {% empty %}
                            <tr>
                                <td colspan="12" class="empty-message">No inspections found. Try adjusting your filters or sync inspections.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                {% if paginator and not show_all %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm btn-secondary">First</a>
                        <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm btn-secondary">Previous</a>
                    {% endif %}
                    
                    <span class="page-info">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>
                    
                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm btn-secondary">Next</a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="btn btn-sm btn-secondary">Last</a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Files Popup Modal -->
    <div id="filesModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-folder-open"></i>
                    <span id="modalTitle">Inspection Files</span>
                </div>
                <div class="modal-actions">
                    <button id="downloadAllBtn" class="btn btn-sm btn-download" onclick="downloadAllFiles()" title="Download All Files as ZIP" style="display: none;">
                        <i class="fas fa-download"></i> Download All
                    </button>
                    <button class="modal-close" onclick="closeFilesPopup()" title="Close">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div id="filesLoading" class="loading-state">
                    <div class="loading-spinner"></div>
                    <span>Loading files...</span>
                </div>
                <div id="filesContent" style="display: none;">
                    <div id="filesList"></div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Modal styles matching shipment list page */
        .modal {
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: modalFadeIn 0.3s ease-out;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { transform: translateY(-20px) scale(0.98); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        .modal-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 0;
            border-radius: var(--radius);
            width: 95%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            padding: 16px 20px;
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn-download {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .btn-download:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        .btn-download:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .modal-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .modal-title i {
            color: var(--primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            color: var(--text-light);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .modal-close:hover {
            background: var(--primary-light);
            color: var(--primary);
        }
        
        .modal-body {
            padding: 16px 20px;
            max-height: 75vh;
            overflow-y: auto;
            background: var(--background);
        }
        
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-light);
        }
        
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .file-category {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            margin-bottom: var(--spacing);
            border: 1px solid var(--border);
            overflow: hidden;
        }
        
        .file-category-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--card-bg);
        }
        
        .file-category-header .category-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-category-header .category-title i {
            color: var(--primary);
            font-size: 1rem;
        }
        
        .file-category-header .file-count {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .file-list {
            padding: 16px;
            background: var(--card-bg);
        }
        
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        
        .file-item:hover {
            background: var(--primary-light);
            border-color: var(--primary);
        }
        
        .file-item:last-child {
            margin-bottom: 0;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .file-icon {
            color: var(--primary);
            width: 20px;
            font-size: 16px;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
            word-break: break-word;
        }
        
        .file-size {
            color: var(--text-light);
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .file-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-file {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
            height: 32px;
        }
        
        .btn-file:hover {
            transform: translateY(-1px);
        }
        
        .btn-file.btn-primary {
            background: linear-gradient(135deg, #007890, #005a6b);
            color: white;
            box-shadow: 0 2px 6px rgba(0, 120, 144, 0.3);
        }
        
        .btn-file.btn-primary:hover {
            box-shadow: 0 4px 12px rgba(0, 120, 144, 0.4);
        }
        
        .btn-file.btn-secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            box-shadow: 0 2px 6px rgba(107, 114, 128, 0.3);
        }
        
        .btn-file.btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
        }
        
        .btn-file.btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.3);
        }
        
        .btn-file.btn-warning:hover {
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-file.btn-info {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
        }
        
        .btn-file.btn-info:hover {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .empty-category {
            padding: 24px;
            text-align: center;
            color: var(--text-light);
            font-style: italic;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 12px;
        }
        
        .empty-category::before {
            content: "📂";
            display: block;
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }
    </style>

    <!-- Load sent status functionality from external file -->
    <script src="{% static 'js/sent_status.js' %}?v=20250925-fix-endpoint-calls"></script>
    <!-- Load clean upload functions -->
    <script src="{% static 'js/upload_functions.js' %}?v=20250925-fix-endpoint-calls"></script>
    <script>
        // Set global CSRF token for upload functions
        try {
            window.csrfToken = '{{ csrf_token|escapejs }}';
            console.log('CSRF token set globally for upload functions');
        } catch (error) {
            console.error('Error setting CSRF token:', error);
        }
    </script>
    <script>
        // Global error handler to catch any uncaught exceptions
        window.addEventListener('error', function(event) {
            console.error('Uncaught JavaScript error:', event.error);
            console.error('Error details:', {
                message: event.message,
                filename: event.filename,
                lineno: event.lineno,
                colno: event.colno,
                error: event.error
            });
            // Don't let errors break the page functionality
            return true;
        });

        // Wrap all JavaScript in error handling to prevent uncaught exceptions
        console.log('Main JavaScript started loading...');
        
        // Hide invoice column for inspectors
        document.addEventListener('DOMContentLoaded', function() {
            const userRole = '{{ user.role|default:"admin" }}';
            if (userRole === 'inspector') {
                const table = document.getElementById('shipmentsTable');
                if (table) {
                    table.classList.add('hide-invoice');
                }
                
                // Hide actions column in detail tables for inspectors
                const detailTables = document.querySelectorAll('.detail-table');
                detailTables.forEach(table => {
                    table.classList.add('hide-actions');
                });
            }
        });

            // Theme functionality
            function initTheme() {
                try {
                    const savedTheme = localStorage.getItem('theme');
                    const serverTheme = '{{ settings.dark_mode|yesno:"dark,light" }}';
                    const theme = savedTheme || serverTheme;
                    
                    document.documentElement.setAttribute('data-theme', theme);
                } catch (error) {
                    console.error('Error initializing theme:', error);
                }
            }
        
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
            
            // Save theme preference to server
            saveThemeToServer(newTheme);
        }
        
        
        function saveThemeToServer(theme) {
            fetch('{% url "save_system_settings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    theme_mode: theme
                })
            }).catch(error => {
                console.error('Error saving theme:', error);
            });
        }

        // Global expand/collapse functions
        function expandAll() {
            const detailRows = document.querySelectorAll('.detail-row');
            const expandBtns = document.querySelectorAll('.expand-btn');
            
            detailRows.forEach(row => {
                row.style.display = 'table-row';
            });
            
            expandBtns.forEach(btn => {
                btn.classList.add('expanded');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
            });
        }
        
        function collapseAll() {
            const detailRows = document.querySelectorAll('.detail-row');
            const expandBtns = document.querySelectorAll('.expand-btn');
            
            detailRows.forEach(row => {
                row.style.display = 'none';
            });
            
            expandBtns.forEach(btn => {
                btn.classList.remove('expanded');
                const icon = btn.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            });
        }

        // Global toggle function
        function toggleGroup(e, groupId) {
            console.log('🔧 Toggling group:', groupId);
            e.preventDefault();
            e.stopPropagation();
            
            const detailRow = document.getElementById('detail-' + groupId);
            console.log('🔧 Detail row found:', detailRow);
            console.log('🔧 Detail row ID:', 'detail-' + groupId);

            if (!detailRow) {
                console.warn('No detail row for groupId:', groupId);
                return;
            }

            // Find the expand button safely
            let expandBtn = null;
            if (e && e.target) {
                expandBtn = e.target.closest('.expand-btn');
            }
            if (!expandBtn) {
                const groupRow = document.querySelector('tr.group-row[data-group-id="' + groupId + '"]');
                if (groupRow) {
                    expandBtn = groupRow.querySelector('.expand-btn');
                }
            }

            const icon = expandBtn ? expandBtn.querySelector('i') : null;

            const isHidden = detailRow.style.display === 'none' || detailRow.style.display === '';
            if (isHidden) {
                // Expand
                detailRow.style.display = 'table-row';
                if (expandBtn) expandBtn.classList.add('expanded');
                if (icon) {
                    icon.classList.remove('fa-chevron-right');
                    icon.classList.add('fa-chevron-down');
                }
            } else {
                // Collapse
                detailRow.style.display = 'none';
                if (expandBtn) expandBtn.classList.remove('expanded');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-right');
                }
            }
        }

        // Mobile Navigation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded - Initializing...');
            
            // Initialize theme
            initTheme();
            
            // Setup expand buttons
            setupExpandButtons();
            
            // Clear any cached data and force immediate file status check on page load
            setTimeout(() => {
                console.log('🧹 [PAGE LOAD] Clearing cached data and forcing fresh file status check...');
                // Clear any local storage cache
                localStorage.removeItem('file_status_cache');
                localStorage.removeItem('shipment_data_cache');
                updateAllViewFilesButtonColors();
            }, 1000);
            
            // Additional file status check after a longer delay to catch any missed files
            setTimeout(() => {
                console.log('🔄 [PAGE LOAD] Running secondary file status check...');
                updateAllViewFilesButtonColors();
            }, 3000);
            
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const mobileNav = document.getElementById('mobile-nav');
            const mobileOverlay = document.getElementById('mobile-overlay');
            
            function toggleMobileNav() {
                mobileNav.classList.toggle('show');
                mobileOverlay.classList.toggle('show');
                
                // Update menu button icon
                const icon = mobileMenuBtn.querySelector('i');
                if (mobileNav.classList.contains('show')) {
                    icon.className = 'fas fa-times';
                } else {
                    icon.className = 'fas fa-bars';
                }
            }
            
            // Toggle navigation when menu button is clicked
            mobileMenuBtn.addEventListener('click', toggleMobileNav);
            
            // Close navigation when overlay is clicked
            mobileOverlay.addEventListener('click', toggleMobileNav);
            
            // Close navigation when a navigation link is clicked (on mobile)
            const navLinks = mobileNav.querySelectorAll('a');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 1024) {
                        toggleMobileNav();
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 1024) {
                    mobileNav.classList.remove('show');
                    mobileOverlay.classList.remove('show');
                    const icon = mobileMenuBtn.querySelector('i');
                    icon.className = 'fas fa-bars';
                }
            });
        });
        
        // CSRF functions now defined at top of script section
        
        // Delete file function - Only compliance documents are protected from deletion
        async function deleteFile(filePath, category) {
            // Prevent deletion of compliance documents only
            if (category === 'compliance' || (filePath && filePath.toLowerCase().includes('compliance'))) {
                alert('Compliance documents cannot be deleted for security and audit purposes.');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this ' + category + ' file? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/delete-inspection-file/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: filePath,
                        client_name: window.currentFilesClient,
                        inspection_date: window.currentFilesDate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    console.log('✅ File deleted successfully:', filePath);
                    
                    // Re-enable RFI and Invoice buttons if their files were deleted
                    reEnableUploadButtons(filePath, category);
                    
                    // Update View Files button colors after deletion
                    console.log('🎨 Updating button colors after file deletion...');
                    updateAllViewFilesButtonColors();
                    
                    // Refresh the files display
                    if (window.currentFilesClient && window.currentFilesDate) {
                        openFilesPopup(window.currentFilesGroupId, window.currentFilesClient, window.currentFilesDate);
                    }
                } else {
                    console.error('❌ Failed to delete file:', result.error);
                }
                
            } catch (error) {
                console.error('❌ Error deleting file:', error);
            }
        }
        
        // Function to re-enable upload buttons when files are deleted
        function reEnableUploadButtons(filePath, category) {
            console.log('🔄 Re-enabling upload buttons for deleted file:', filePath, 'category:', category);
            
            // Determine which button to re-enable based on file path or category
            let buttonId = null;
            
            if (category === 'rfi' || filePath.includes('/RFI/') || filePath.toLowerCase().includes('rfi')) {
                // Find RFI button for current client
                const groupId = window.currentFilesGroupId;
                if (groupId) {
                    buttonId = 'rfi-' + groupId;
                }
            } else if (category === 'invoice' || filePath.includes('/Invoice/') || filePath.toLowerCase().includes('invoice')) {
                // Find Invoice button for current client
                const groupId = window.currentFilesGroupId;
                if (groupId) {
                    buttonId = 'invoice-' + groupId;
                }
            }
            
            if (buttonId) {
                const button = document.getElementById(buttonId);
                if (button) {
                    console.log('🔄 Re-enabling button:', buttonId);
                    
                    // Reset button to upload state
                    button.disabled = false;
                    button.classList.remove('uploaded');
                    
                    // Add appropriate CSS classes based on button type
                    const docType = buttonId.startsWith('rfi-') ? 'RFI' : 'Invoice';
                    if (docType === 'RFI') {
                        button.classList.add('btn-rfi', 'btn-sm');
                    } else {
                        button.classList.add('btn-invoice', 'btn-sm');
                    }
                    
                    button.style.background = '#28a745'; // Same green color for both RFI and Invoice
                    button.style.color = 'white';
                    button.style.border = '1px solid #1e7e34'; // Same border color for both
                    button.style.cursor = 'pointer';
                    
                    // Reset button content to original text
                    button.innerHTML = docType;
                    
                    // Reset button title
                    button.title = 'Upload ' + docType;
                    
                    // Remove from localStorage
                    const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                    delete uploadStatus[buttonId];
                    localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                    
                    console.log('✅ Button re-enabled:', buttonId);
                } else {
                    console.log('⚠️ Button not found:', buttonId);
                }
            } else {
                console.log('⚠️ Could not determine button ID for file:', filePath);
            }
        }
        
        // Client Autocomplete Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const clientSearchInput = document.getElementById('clientSearchInput');
            const suggestionsDropdown = document.getElementById('clientSuggestions');
            let currentSuggestions = [];
            let selectedIndex = -1;
            let debounceTimer;
            
            if (!clientSearchInput || !suggestionsDropdown) {
                console.log('Client autocomplete elements not found');
                return;
            }
            
            // Debounced search function
            function debounceSearch(query) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    if (query.length >= 2) {
                        fetchClientSuggestions(query);
                    } else {
                        hideSuggestions();
                    }
                }, 300);
            }
            
            // Fetch suggestions from API
            async function fetchClientSuggestions(query) {
                try {
                    const response = await fetch('/api/clients/autocomplete/?q=' + encodeURIComponent(query));
                    if (response.ok) {
                        const data = await response.json();
                        currentSuggestions = data.suggestions || [];
                        displaySuggestions(currentSuggestions);
                    } else {
                        hideSuggestions();
                    }
                } catch (error) {
                    console.error('Error fetching client suggestions:', error);
                    hideSuggestions();
                }
            }
            
            // Display suggestions in dropdown
            function displaySuggestions(suggestions) {
                if (suggestions.length === 0) {
                    hideSuggestions();
                    return;
                }
                
                suggestionsDropdown.innerHTML = '';
                suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'autocomplete-item';
                    item.setAttribute('data-index', index);
                    
                    // Simple client name only
                    item.textContent = suggestion.name;
                    
                    // Click handler
                    item.addEventListener('click', () => {
                        selectSuggestion(suggestion);
                    });
                    
                    // Hover handler
                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        updateHighlight();
                    });
                    
                    suggestionsDropdown.appendChild(item);
                });
                
                // Position the dropdown using absolute positioning relative to input
                const inputRect = clientSearchInput.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                const spaceBelow = viewportHeight - inputRect.bottom;
                const spaceAbove = inputRect.top;
                
                // Check if there's a table below that we would overlay
                const tableElement = document.querySelector('#shipmentsTable, .table-responsive');
                let tableTop = null;
                if (tableElement) {
                    const tableRect = tableElement.getBoundingClientRect();
                    tableTop = tableRect.top;
                }
                
                suggestionsDropdown.style.display = 'block';
                suggestionsDropdown.style.position = 'absolute';
                suggestionsDropdown.style.left = '0px';
                suggestionsDropdown.style.right = '0px';
                suggestionsDropdown.style.width = 'auto';
                
                // Calculate available space without overlaying table
                let availableSpaceBelow = spaceBelow - 10;
                if (tableTop && tableTop > inputRect.bottom) {
                    availableSpaceBelow = Math.min(availableSpaceBelow, tableTop - inputRect.bottom - 20);
                }
                
                let maxHeight = Math.min(300, availableSpaceBelow);
                
                // If dropdown would be too small below or would overlay table, position above
                if (maxHeight < 120 || (tableTop && inputRect.bottom + 200 > tableTop)) {
                    // Position above the input
                    const heightAbove = Math.min(250, spaceAbove - 20);
                    suggestionsDropdown.style.bottom = '100%';
                    suggestionsDropdown.style.top = 'auto';
                    suggestionsDropdown.style.borderRadius = 'var(--radius) var(--radius) 0 0';
                    suggestionsDropdown.style.borderTop = '1px solid var(--border)';
                    suggestionsDropdown.style.borderBottom = 'none';
                    maxHeight = heightAbove;
                } else {
                    // Position below the input
                    suggestionsDropdown.style.top = '100%';
                    suggestionsDropdown.style.bottom = 'auto';
                    suggestionsDropdown.style.borderRadius = '0 0 var(--radius) var(--radius)';
                    suggestionsDropdown.style.borderTop = 'none';
                    suggestionsDropdown.style.borderBottom = '1px solid var(--border)';
                }
                
                suggestionsDropdown.style.maxHeight = maxHeight + 'px';
                suggestionsDropdown.style.minHeight = Math.min(100, maxHeight) + 'px';
                
                selectedIndex = -1;
            }
            
            // Hide suggestions dropdown
            function hideSuggestions() {
                suggestionsDropdown.style.display = 'none';
                currentSuggestions = [];
                selectedIndex = -1;
            }
            
            // Select a suggestion
            function selectSuggestion(suggestion) {
                clientSearchInput.value = suggestion.name;
                hideSuggestions();
                // Optionally trigger form submission or search
                // clientSearchInput.form.submit();
            }
            
            // Update highlight for keyboard navigation
            function updateHighlight() {
                const items = suggestionsDropdown.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => {
                    if (index === selectedIndex) {
                        item.style.backgroundColor = 'var(--primary-light)';
                    } else {
                        item.style.backgroundColor = '';
                    }
                });
            }
            
            // Event listeners
            clientSearchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                debounceSearch(query);
            });
            
            clientSearchInput.addEventListener('keydown', (e) => {
                if (suggestionsDropdown.style.display === 'none') return;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectedIndex = Math.min(selectedIndex + 1, currentSuggestions.length - 1);
                        updateHighlight();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectedIndex = Math.max(selectedIndex - 1, -1);
                        updateHighlight();
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (selectedIndex >= 0 && currentSuggestions[selectedIndex]) {
                            selectSuggestion(currentSuggestions[selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });
            
            // Hide suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (!clientSearchInput.contains(e.target) && !suggestionsDropdown.contains(e.target)) {
                    hideSuggestions();
                }
            });
            
            // Hide suggestions when input loses focus (with delay to allow clicks)
            clientSearchInput.addEventListener('blur', () => {
                setTimeout(() => {
                    hideSuggestions();
                }, 150);
            });
            
            // Reposition dropdown on window resize
            window.addEventListener('resize', () => {
                if (suggestionsDropdown.style.display === 'block' && currentSuggestions.length > 0) {
                    displaySuggestions(currentSuggestions);
                }
            });
            
            // Hide dropdown on scroll for better UX
            window.addEventListener('scroll', () => {
                if (suggestionsDropdown.style.display === 'block') {
                    hideSuggestions();
                }
            });
        });
        
        // Show loading indicator for large datasets and check OneDrive status after page is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const totalRecords = parseInt('{{ total_shipments|default:0 }}') || 0;
            if (totalRecords > 1000) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.style.display = 'flex';
                
                // Hide loading overlay after page is fully loaded
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        loadingOverlay.style.display = 'none';
                        // Re-enable pagination after overlay is hidden
                        enablePagination();
                    }, 1000); // Reduced delay to prevent pagination blocking
                });
            } else {
                // For smaller datasets, enable pagination immediately
                enablePagination();
            }
            
            // Check OneDrive processing status for background service

        });
        
        // Function to enable pagination functionality
        function enablePagination() {
            // Ensure pagination links are clickable
            const paginationLinks = document.querySelectorAll('.pagination a');
            paginationLinks.forEach(link => {
                link.style.pointerEvents = 'auto';
                link.style.opacity = '1';
                
                // Add click handler to ensure navigation works
                link.addEventListener('click', function(e) {
                    // Allow default navigation behavior
                    console.log('Pagination link clicked:', this.href);
                });
            });
            
            // Remove any blocking overlays
            const blockingOverlays = document.querySelectorAll('.loading-overlay, .status-check-overlay');
            blockingOverlays.forEach(overlay => {
                if (overlay.id !== 'loadingOverlay') {
                    overlay.style.display = 'none';
                }
            });
            
            console.log('Pagination enabled for', paginationLinks.length, 'links');
            
            // Also handle page navigation
            handlePageNavigation();
        }
        
        // Function to handle page navigation
        function handlePageNavigation() {
            // Ensure all pagination links work properly
            const paginationLinks = document.querySelectorAll('.pagination a');
            paginationLinks.forEach(link => {
                // Remove any existing event listeners to avoid duplicates
                link.removeEventListener('click', handlePaginationClick);
                // Add new event listener
                link.addEventListener('click', handlePaginationClick);
            });
        }
        
        // Handle pagination click
        function handlePaginationClick(e) {
            console.log('Pagination clicked:', this.href);
            // Allow default navigation - don't prevent default
            // The page will reload with the new page number
        }
        // Function to check compliance documents in batch with completion tracking
        async function checkComplianceDocumentsBatch(inspections, overlay, messageElement) {
            try {
                console.log('🔄 OneDrive overlay: Starting batch compliance check...');
                
                // Start the batch processing
                const response = await fetch('/check-compliance-documents-batch/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        inspections: inspections
                    })
                });
                
                const result = await response.json();
                console.log('🔄 OneDrive overlay: Batch compliance check completed:', result.success);
                
                if (result.success) {
                    // Update the UI with compliance status
                    updateComplianceStatus(result.results);
                    console.log('🔄 OneDrive overlay: UI updated with compliance status');
                    
                    // Now wait for OneDrive processing to complete
                    await waitForOneDriveCompletion(overlay, messageElement);
                } else {
                    console.log('❌ OneDrive overlay: Batch compliance check failed:', result.error);
                    // Show error message
                    messageElement.textContent = '❌ Error processing files. Please try again.';
                    
                    // Hide overlay after error
                    setTimeout(function() {
                        overlay.style.display = 'none';
                        console.log('❌ OneDrive overlay: Hidden due to batch check error');
                    }, 3000);
                }
            } catch (error) {
                console.log('❌ OneDrive overlay: Batch compliance check network error:', error);
                
                // Show error message
                messageElement.textContent = '❌ Network error. Please try again.';
                
                // Hide overlay after error
                setTimeout(function() {
                    overlay.style.display = 'none';
                    console.log('❌ OneDrive overlay: Hidden due to network error');
                }, 3000);
            }
        }
        
        // Function to wait for OneDrive processing to complete
        async function waitForOneDriveCompletion(overlay, messageElement) {
            let attempts = 0;
            const maxAttempts = 60; // Wait up to 5 minutes (60 * 5 seconds)
            
            console.log('🔄 OneDrive overlay: Starting OneDrive completion polling...');
            
            while (attempts < maxAttempts) {
                try {
                    console.log('🔄 OneDrive overlay: Polling attempt ' + attempts + 1 + '/' + maxAttempts);
                    
                    const response = await fetch('/check-onedrive-status/', {
                        method: 'GET',
                        headers: {
                            'X-CSRFToken': getCSRFToken()
                        }
                    });
                    
                    const status = await response.json();
                    console.log('🔄 OneDrive overlay: Status response:', status);
                    
                    if (status.success) {
                        // Check if OneDrive is still processing
                        if (status.is_processing) {
                            messageElement.textContent = '🔄 Processing OneDrive files... (' + attempts + 1 + '/' + maxAttempts + ')';
                            console.log('🔄 OneDrive overlay: Still processing... (' + attempts + 1 + '/' + maxAttempts + ')');
                            await new Promise(resolve => setTimeout(resolve, 5000)); // Wait 5 seconds
                            attempts++;
                            continue;
                        } else {
                            // OneDrive processing is complete
                            console.log('✅ OneDrive overlay: Processing complete!');
                            messageElement.textContent = '✅ All files processed successfully!';
                            
                            // Hide overlay after showing completion
                            setTimeout(function() {
                                overlay.style.display = 'none';
                                console.log('✅ OneDrive overlay: Hidden after successful completion');
                            }, 2000);
                            return;
                        }
                    } else {
                        // Error checking status, assume completion
                        console.log('⚠️ OneDrive overlay: Status check failed, assuming completion');
                        messageElement.textContent = '✅ Files processed successfully!';
                        setTimeout(function() {
                            overlay.style.display = 'none';
                            console.log('✅ OneDrive overlay: Hidden after status check failure');
                        }, 2000);
                        return;
                    }
                } catch (error) {
                    console.log('❌ OneDrive overlay: Error checking OneDrive status:', error);
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 5000));
                }
            }
            
            // If we reach max attempts, assume completion
            console.log('⏰ OneDrive overlay: Reached max attempts, assuming completion');
            messageElement.textContent = '✅ Files processed successfully!';
            setTimeout(function() {
                overlay.style.display = 'none';
                console.log('✅ OneDrive overlay: Hidden after max attempts reached');
            }, 2000);
        }
        
        // Function to update compliance status in the UI
        function updateComplianceStatus(results) {
            Object.keys(results).forEach(key => {
                const [clientName, inspectionDate] = key.split('_', 2);
                const hasCompliance = results[key];
                
                // Find the corresponding row and update the button
                const row = document.querySelector('[data-client-name="' + clientName + '"][data-inspection-date="' + inspectionDate + '"]');
                if (row) {
                    const viewFilesBtn = row.querySelector('.btn-view-files');
                    if (viewFilesBtn) {
                        if (hasCompliance) {
                            viewFilesBtn.classList.remove('btn-view-files-red');
                            viewFilesBtn.classList.add('btn-view-files-blue');
                        }
                    }
                }
            });
        }
        
        // Function to initialize disabled rows for already sent items
        function initializeDisabledRows() {
            console.log('🔍 Initializing sent rows...');
            
            // Find all rows with sent timestamps
            const sentRows = document.querySelectorAll('.shipment-row[data-sent-timestamp]');
            console.log('🔍 Found', sentRows.length, 'rows with sent timestamps');
            
            sentRows.forEach((row, index) => {
                console.log(`🔍 Processing sent row ${index + 1}:`, row);
                
                const groupId = row.getAttribute('data-group-id');
                const sentTimestamp = row.getAttribute('data-sent-timestamp');
                
                // Store timestamp in localStorage for persistence
                if (groupId && sentTimestamp) {
                    localStorage.setItem('sent_timestamp_' + groupId, sentTimestamp);
                    console.log(`💾 Stored sent timestamp for group ${groupId}:`, sentTimestamp);
                    
                    // Check if 15 minutes have already passed
                    const sentDate = new Date(sentTimestamp);
                    const fifteenMinutesLater = new Date(sentDate.getTime() + (15 * 60 * 1000));
                    const now = new Date();
                    const remainingTime = fifteenMinutesLater.getTime() - now.getTime();
                    
                    if (remainingTime <= 0) {
                        // 15 minutes have passed, disable the row (no countdown display, no green background)
                        console.log(`🔒 15 minutes already passed for group ${groupId}, disabling row`);
                        disableRowAfterTimer(row, groupId);
                    } else {
                        // 15 minutes haven't passed yet, start countdown timer (no green background)
                        console.log(`⏰ 15 minutes not yet passed for group ${groupId}, starting countdown timer`);
                        startFifteenMinuteTimer(row, groupId, sentTimestamp);
                    }
                } else {
                    // No timestamp available, keep as disabled (fallback)
                    console.log(`⚠️ No timestamp available for group ${groupId}, keeping disabled`);
                    row.setAttribute('data-was-sent', 'true');
                }
            });
            
            console.log('✅ Sent rows initialization complete');
        }

        
        // Initialize page on load
        document.addEventListener('DOMContentLoaded', function() {
            loadUploadStatus();
            
            // RFI status is now handled by file-based checking in the backend
            // No need to call loadRFIStatus since template uses shipment.rfi_uploaded
            
            // Load sent status immediately and then with delays
            console.log('🚀 [SENT STATUS] Calling loadSentStatus immediately');
            console.log('🚀 [SENT STATUS] ===========================================');
            loadSentStatus();
            
            // Initialize disabled rows for already sent items
            initializeDisabledRows();
            
            // Initialize bought sample input styling
            console.log('🚀 [INIT] About to call initializeBoughtSampleStyling...');
            console.log('🔍 [INIT] Function exists?', typeof initializeBoughtSampleStyling);
            if (typeof initializeBoughtSampleStyling === 'function') {
                console.log('✅ [INIT] Calling initializeBoughtSampleStyling...');
                initializeBoughtSampleStyling();
            } else {
                console.error('❌ [INIT] initializeBoughtSampleStyling function not found!');
            }
            
            // Initialize 15-minute timers for sent rows
            console.log('🔍 About to call initializeFifteenMinuteTimers...');
            if (typeof initializeFifteenMinuteTimers === 'function') {
                console.log('✅ initializeFifteenMinuteTimers function found, calling it...');
                initializeFifteenMinuteTimers();
            } else {
                console.error('❌ initializeFifteenMinuteTimers function not found!');
            }
            
            // Load sent status with a longer delay to ensure DOM is fully rendered and all other functions have run
            setTimeout(() => {
                console.log('🚀 [SENT STATUS] Calling loadSentStatus after 2s delay');
                loadSentStatus();
            }, 2000);
            
            initializeButtonStates();
            
            // Check for uploaded files that might not be in localStorage
            // This catches cases where files exist but localStorage was cleared
            setTimeout(() => {
                checkAllUploadedFiles();
            }, 2000); // Delay to let other checks complete
            
            // Final check to ensure sent status styling is preserved after all other functions
            setTimeout(() => {
                console.log('🔧 [SENT STATUS] Final check to preserve sent status styling');
                loadSentStatus();
            }, 3000);
        });
        
        // Also run when window is fully loaded
        window.addEventListener('load', function() {
            console.log('🚀 [SENT STATUS] Window loaded, calling loadSentStatus');
            setTimeout(() => {
                loadSentStatus();
            }, 1000);
        });
        
        // Set up a periodic check to ensure sent status styling is maintained
            setInterval(() => {
                const sentRows = document.querySelectorAll('tr[data-sent-status="yes"]');
                sentRows.forEach(row => {
                    if (!row.classList.contains('inspection-complete') || 
                        row.style.backgroundColor !== 'rgb(34, 197, 94)') {
                        console.log('🔧 [SENT STATUS] Re-applying styling to row:', row.getAttribute('data-group-id'));
                        row.classList.add('inspection-complete');
                        row.style.setProperty('background-color', '#22c55e', 'important');
                        row.style.setProperty('color', 'white', 'important');
                        row.style.setProperty('border-color', '#16a34a', 'important');
                        
                        const tds = row.querySelectorAll('td');
                        tds.forEach(td => {
                            td.style.setProperty('background-color', '#22c55e', 'important');
                            td.style.setProperty('color', 'white', 'important');
                            td.style.setProperty('border-color', '#16a34a', 'important');
                        });
                    }
                });
            }, 5000); // Check every 5 seconds
            
            // Automatically check file status for all clients on page load
            // Add a delay to ensure all buttons are fully rendered and prevent conflicts
            console.log('🚀 [FRONTEND] Page loaded, starting automatic file status check...');
            setTimeout(() => {
                console.log('🔄 [FRONTEND] Starting delayed automatic file status check...');
                checkAllClientFileStatus();
            }, 1500); // Increased to 1500ms delay to ensure buttons are rendered
            
            // Also enable pagination if needed
            setTimeout(() => {
                const paginationLinks = document.querySelectorAll('.pagination a');
                if (paginationLinks.length > 0) {
                    enablePagination();
                }
            }, 100);
        });
        
        // Files popup management
        function openFilesPopup(groupId, clientName, inspectionDate) {
            const modal = document.getElementById('filesModal');
            const modalTitle = document.getElementById('modalTitle');
            const filesLoading = document.getElementById('filesLoading');
            const filesContent = document.getElementById('filesContent');
            const downloadBtn = document.getElementById('downloadAllBtn');

            // Store current client and date for download functionality
            window.currentFilesClient = clientName;
            window.currentFilesDate = inspectionDate;
            window.currentFilesGroupId = groupId;

            // Set title and show modal - shows files for specific inspection date
            modalTitle.textContent = 'Files for ' + clientName + ' - ' + inspectionDate;
            modal.style.display = 'block';

            // Show download button
            downloadBtn.style.display = 'flex';

            // Show loading state
            filesLoading.style.display = 'block';
            filesContent.style.display = 'none';

            console.log('🔄 File overlay: View Files clicked - Starting files fetch for', clientName, 'on', inspectionDate);

            // Load files for this specific inspection date only
            loadInspectionFiles(groupId, clientName, inspectionDate);
        }
        
        function closeFilesPopup() {
            const modal = document.getElementById('filesModal');
            modal.style.display = 'none';
            
            // Hide download button
            const downloadBtn = document.getElementById('downloadAllBtn');
            downloadBtn.style.display = 'none';
        }
        
        // Download all files for current inspection group as ZIP
        async function downloadAllFiles() {
            const downloadBtn = document.getElementById('downloadAllBtn');
            const clientName = window.currentFilesClient;
            const inspectionDate = window.currentFilesDate;
            const groupId = window.currentFilesGroupId;
            
            if (!clientName || !inspectionDate) {
                alert('Error: Missing client or inspection date information');
                return;
            }
            
            // Show loading state
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating ZIP...';
            downloadBtn.disabled = true;
            
            try {
                console.log('🗂️ Starting download of all files for ' + clientName + ' on ' + inspectionDate);
                
                const response = await fetch('/inspections/download-all-files/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        client_name: clientName,
                        inspection_date: inspectionDate,
                        group_id: groupId
                    })
                });
                
                if (response.ok) {
                    // Get the blob from response
                    const blob = await response.blob();
                    const contentDisposition = response.headers.get('Content-Disposition');
                    
                    // Extract filename from header or create default
                    let filename = clientName + '_' + inspectionDate + '_all_files.zip';
                    if (contentDisposition) {
                        const match = contentDisposition.match(/filename[^;=\n]*=([^;\n]*)/);
                        if (match && match[1]) {
                            filename = match[1].replace(/['"]/g, '');
                        }
                    }
                    
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    
                    // Cleanup
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    console.log('✅ Download completed: ' + filename);
                } else {
                    const errorData = await response.json();
                    alert('Download failed: ' + (errorData.error || 'Unknown error'));
                }
                
            } catch (error) {
                console.error('❌ Download error:', error);
                alert('Download failed: ' + error.message);
            } finally {
                // Reset button state
                downloadBtn.innerHTML = originalText;
                downloadBtn.disabled = false;
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('filesModal');
            if (event.target === modal) {
                closeFilesPopup();
            }
        };
        
        async function loadInspectionFiles(groupId, clientName, inspectionDate) {
            try {
                console.log('🔄 File fetch: Starting file fetch request...');
                console.log('🔍 DEBUG: Group ID:', groupId);
                console.log('🔍 DEBUG: Client Name:', clientName);
                console.log('🔍 DEBUG: Inspection Date:', inspectionDate);
                
                const requestData = {
                    group_id: groupId,
                    client_name: clientName,
                    inspection_date: inspectionDate,
                    _force_refresh: true
                };
                console.log('🔍 DEBUG: Request data being sent:', JSON.stringify(requestData, null, 2));
                
                const response = await fetch('/inspections/files/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('🔍 DEBUG: Response status:', response.status);
                console.log('🔍 DEBUG: Response headers:', Object.fromEntries(response.headers.entries()));
                
                const result = await response.json();
                console.log('🔄 File fetch: File fetch completed:', result.success);
                console.log('🔍 DEBUG: Full server response:', JSON.stringify(result, null, 2));
                
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                
                if (result.success) {
                    console.log('🔄 File fetch: Success - processing files...');
                    console.log('🔍 DEBUG: Files object type:', typeof result.files);
                    console.log('🔍 DEBUG: Files object:', result.files);
                    console.log('🔍 DEBUG: Files object keys:', Object.keys(result.files || {}));
                    console.log('🔍 DEBUG: Files object values:', Object.values(result.files || {}));
                    console.log('🔍 DEBUG: Files object length:', result.files ? Object.keys(result.files).length : 'N/A');
                    console.log('🔍 DEBUG: Message:', result.message);
                    
                    // Check if files exist
                    const hasFiles = result.files && Object.keys(result.files).length > 0;
                    console.log('🔍 DEBUG: Has files check result:', hasFiles);
                    console.log('🔍 DEBUG: Files check breakdown:');
                    console.log('  - result.files exists:', !!result.files);
                    console.log('  - result.files is object:', typeof result.files === 'object');
                    console.log('  - Object.keys(result.files).length:', result.files ? Object.keys(result.files).length : 'N/A');
                    console.log('  - Object.keys(result.files).length > 0:', result.files ? Object.keys(result.files).length > 0 : 'N/A');
                    
                    if (hasFiles) {
                        console.log('📁 Files found - displaying file list');
                        console.log('🔍 DEBUG: About to call displayFiles with:', {
                            files: result.files,
                            message: result.message
                        });
                        displayFiles(result.files, result.message);
                    } else {
                        console.log('📁 No files found - showing empty message');
                        console.log('🔍 DEBUG: Files object details for empty case:', {
                            files: result.files,
                            filesType: typeof result.files,
                            filesKeys: result.files ? Object.keys(result.files) : 'N/A',
                            filesLength: result.files ? Object.keys(result.files).length : 'N/A'
                        });
                        filesList.innerHTML = '<div class="no-files-message">No files found for this inspection.</div>';
                    }
                } else {
                    console.error('❌ File fetch failed:', result.error);
                    console.log('🔍 DEBUG: Error details:', {
                        success: result.success,
                        error: result.error,
                        fullResult: result
                    });
                    filesList.innerHTML = '<div class="error-message">Error loading files: ' + (result.error || 'Unknown error') + '</div>';
                }
                
            } catch (error) {
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                console.log('❌ File fetch: File fetch error:', error);
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                filesList.innerHTML = '<div class="empty-category">Network error: ' + error.message + '</div>';
            }
        }

        function getCurrentPageClientNames() {
            // Get all client names from the current page's shipment rows
            const clientNames = [];
            const shipmentRows = document.querySelectorAll('.shipment-row[data-client-name]');
            
            shipmentRows.forEach(row => {
                const clientName = row.getAttribute('data-client-name');
                if (clientName && !clientNames.includes(clientName)) {
                    clientNames.push(clientName);
                }
            });
            
            console.log('📄 Found ' + clientNames.length + ' unique clients on current page');
            return clientNames;
        }
        
        function getCurrentPageClientData() {
            // Get client names and their inspection dates from the current page
            const clientData = {};
            const groupRows = document.querySelectorAll('tr.group-row[data-client-name]');
            
            groupRows.forEach(row => {
                const clientName = row.getAttribute('data-client-name');
                const inspectionDate = row.getAttribute('data-inspection-date');
                if (clientName && inspectionDate) {
                    clientData[clientName] = inspectionDate;
                }
            });
            
            console.log('📄 Found ' + Object.keys(clientData).length + ' clients with inspection dates on current page');
            return clientData;
        }

        // Flag to prevent duplicate status checks
        let statusCheckInProgress = false;
        
        async function checkAllClientFileStatus() {
            // Check file status for all clients on current page and update button colors
            if (statusCheckInProgress) {
                console.log('⚠️ [FRONTEND] Status check already in progress, skipping...');
                return;
            }
            
            statusCheckInProgress = true;
            
            try {
                const clientData = getCurrentPageClientData();
                const clientNames = Object.keys(clientData);
                
                if (clientNames.length === 0) {
                    console.log('📄 No clients found on current page');
                    return;
                }
                
                console.log('🔄 [FRONTEND] Checking file status for all clients on current page...');
                console.log('📋 [FRONTEND] Client names:', clientNames);
                console.log('📅 [FRONTEND] Inspection dates:', clientData);
                
                // Debug: Check if New Poultry Retailer is in the list
                if (clientNames.includes('New Poultry Retailer')) {
                    console.log('🔍 [DEBUG] Found New Poultry Retailer in client list');
                    console.log('🔍 [DEBUG] Inspection date for New Poultry Retailer:', clientData['New Poultry Retailer']);
                } else {
                    console.log('❌ [DEBUG] New Poultry Retailer NOT found in client list');
                    console.log('🔍 [DEBUG] Available client names:', clientNames);
                }
                
                // Debug: Check if buttons are available
                const testButtons = document.querySelectorAll('button.btn-view-files, button[class*="btn-view-files"]');
                const allButtons = document.querySelectorAll('button');
                console.log('🔍 [FRONTEND] Found ' + testButtons.length + ' View Files buttons on page (' + allButtons.length + ' total buttons)');
                
                // If no buttons found, wait a bit more
                if (testButtons.length === 0) {
                    console.log('⚠️ [FRONTEND] No buttons found, waiting 500ms more...');
                    statusCheckInProgress = false; // Reset flag for retry
                    setTimeout(() => {
                        console.log('🔄 [FRONTEND] Retrying status check after button wait...');
                        checkAllClientFileStatus();
                    }, 500);
                    return;
                }
                
                // Show loading indicator
                showStatusCheckProgress();
                
                const response = await fetch('/page-clients-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        client_names: clientNames,
                        inspection_dates: clientData
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ File status check completed for all clients');
                    console.log('📊 Client statuses received:', result.client_statuses);
                    
                    // Debug: Check specific client status
                    if (result.client_statuses['New Poultry Retailer']) {
                        console.log('🔍 [DEBUG] New Poultry Retailer status:', result.client_statuses['New Poultry Retailer']);
                    } else {
                        console.log('❌ [DEBUG] New Poultry Retailer NOT found in response');
                        console.log('🔍 [DEBUG] Available clients in response:', Object.keys(result.client_statuses));
                    }
                    
                    // Update all button colors
                    const clientStatuses = result.client_statuses;
                    for (const [clientName, status] of Object.entries(clientStatuses)) {
                        console.log('🔄 Processing client: ' + clientName + ' with status: ' + status.file_status);
                        updateViewFilesButtonColor(clientName, status.file_status);
                    }
                    
                    // Hide loading indicator
                    hideStatusCheckProgress();
                    
                    console.log('🎨 Updated button colors for ' + Object.keys(clientStatuses).length + ' clients');
                } else {
                    console.error('❌ Error checking file status:', result.error);
                    hideStatusCheckProgress();
                }
                
            } catch (error) {
                console.error('❌ Error checking file status:', error);
                hideStatusCheckProgress();
            } finally {
                statusCheckInProgress = false;
            }
        }

        function showStatusCheckProgress() {
            // Show a subtle progress indicator
            const progressDiv = document.createElement('div');
            progressDiv.id = 'statusCheckProgress';
            progressDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #3b82f6; color: white; padding: 0.5rem 1rem; border-radius: 4px; z-index: 9999; font-size: 0.875rem;';
            progressDiv.innerHTML = '<i class="fas fa-sync fa-spin"></i> Checking file status...';
            document.body.appendChild(progressDiv);
        }

        function hideStatusCheckProgress() {
            // Hide the progress indicator
            const progressDiv = document.getElementById('statusCheckProgress');
            if (progressDiv) {
                progressDiv.remove();
            }
        }
        async function loadClientAllFilesOptimized(clientName, currentPageClients) {
            try {
                console.log('🔄 Client files: Starting OPTIMIZED files fetch for client:', clientName);
                console.log('📄 Using current page clients for optimization:', currentPageClients.length);
                
                const response = await fetch('/page-clients-files/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        target_client: clientName,
                        client_names: currentPageClients
                    })
                });
                
                const result = await response.json();
                console.log('🔄 Client files: OPTIMIZED files fetch completed:', result.success);
                
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                
                if (result.success) {
                    // Update button color based on file status
                    updateViewFilesButtonColor(clientName, result.file_status);
                    
                    // Add optimization info to the display
                    const optimizationInfo = result.optimized ? 
                        ' (Optimized: checked ' + result.clients_checked + ' clients from current page)' : '';
                    
                    displayClientAllFiles(
                        result.files, 
                        result.categories, 
                        result.total_files, 
                        result.inspections_found, 
                        result.message + optimizationInfo,
                        result.file_status
                    );
                } else {
                    filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + result.error + '</div>';
                }
                
            } catch (error) {
                console.error('Error loading client files:', error);
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + error.message + '</div>';
            }
        }

        async function loadClientAllFiles(clientName) {
            try {
                console.log('🔄 Client files: Starting ALL files fetch for client:', clientName);
                
                const response = await fetch('/client-all-files/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        client_name: clientName
                    })
                });
                
                const result = await response.json();
                console.log('🔄 Client files: ALL files fetch completed:', result.success);
                
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                
                if (result.success) {
                    displayClientAllFiles(result.files, result.categories, result.total_files, result.inspections_found, result.message);
                } else {
                    filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + result.error + '</div>';
                }
                
            } catch (error) {
                console.error('Error loading client files:', error);
                const filesLoading = document.getElementById('filesLoading');
                const filesContent = document.getElementById('filesContent');
                const filesList = document.getElementById('filesList');
                
                filesLoading.style.display = 'none';
                filesContent.style.display = 'block';
                filesList.innerHTML = '<div class="empty-category">Error loading client files: ' + error.message + '</div>';
            }
        }
        
        function updateViewFilesButtonColor(clientName, fileStatus) {
            console.log('🎨 Updating button color for client: "' + clientName + '"');
            console.log('   File status: ' + fileStatus);
            
            // Find all View Files buttons for this client using multiple methods
            let buttons = [];
            
            // Method 1: Look for buttons with client name in onclick attribute
            const buttonsByOnclick = document.querySelectorAll('button[onclick*="' + clientName + '"]');
            buttonsByOnclick.forEach(btn => {
                if (btn.textContent.includes('View Files') || btn.textContent.includes('Files')) {
                    buttons.push(btn);
                }
            });
            
            // Method 2: Look for buttons in rows with matching client name
            const groupRows = document.querySelectorAll('tr.group-row[data-client-name="' + clientName + '"]');
            groupRows.forEach(row => {
                const viewFilesBtn = row.querySelector('button[class*="btn-view-files"]');
                if (viewFilesBtn && !buttons.includes(viewFilesBtn)) {
                    buttons.push(viewFilesBtn);
                }
            });
            
            // Method 3: Look for buttons with client name in quotes in onclick
            const buttonsWithQuotes = document.querySelectorAll('button[onclick*="\'' + clientName + '\'"]');
            buttonsWithQuotes.forEach(btn => {
                if ((btn.textContent.includes('View Files') || btn.textContent.includes('Files')) && !buttons.includes(btn)) {
                    buttons.push(btn);
                }
            });
            
            console.log('   Found ' + buttons.length + ' View Files buttons for "' + clientName + '"');
            
            buttons.forEach((button, index) => {
                if (button.textContent.includes('View Files') || button.textContent.includes('Files')) {
                    console.log('   Button ' + index + 1 + ': "' + button.textContent.trim() + '"');
                    // COMPLETE REDESIGN: Clear all existing classes and styles
                    button.className = 'files-button-custom';
                    
                    // Clear any conflicting inline styles completely
                    button.removeAttribute('style');
                    
                    // Icons removed - buttons now show only text
                    
                    // Add appropriate color class and icon based on status
                    switch(fileStatus) {
                        case 'all_files':
                            button.classList.add('status-green');
                            button.title = 'All files available (RFI, Invoice, Lab Results, Compliance)';
                            console.log('   ✅ Applied GREEN color to button');
                            break;
                        case 'compliance_only':
                            button.classList.add('status-orange');
                            button.title = 'Only compliance documents available';
                            console.log('   🟠 Applied ORANGE color to button');
                            break;
                        case 'no_files':
                            button.classList.add('status-red');
                            button.title = 'No files found';
                            console.log('   🔴 Applied RED color to button');
                            break;
                        case 'partial_files':
                            button.classList.add('status-blue');
                            button.title = 'Some files available';
                            console.log('   🔵 Applied BLUE color to button');
                            break;
                        default:
                            button.classList.add('status-red');
                            button.title = 'View Files';
                    }
                }
            });
        }

        function displayClientAllFiles(files, categories, totalFiles, inspectionsFound, message = null, fileStatus = null) {
            const filesList = document.getElementById('filesList');
            
            let html = '';
            
            // Show summary header with status indicator
            const statusInfo = getFileStatusInfo(fileStatus);
            html += `
                <div class="client-files-header" style="background: #f8fafc; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #1e293b;">
                        <i class="fas fa-folder-open" style="color: #3b82f6; margin-right: 0.5rem;"></i>
                        All Files for Client
                        ${statusInfo ? '<span style="margin-left: 1rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; ' + statusInfo.style + '">' + statusInfo.text + '</span>' : ''}
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; font-size: 0.875rem; color: #64748b;">
                        <div><strong>Total Files:</strong> ${totalFiles}</div>
                        <div><strong>Inspection Periods:</strong> ${inspectionsFound.length}</div>
                        <div><strong>Source:</strong> Local PC</div>
                    </div>
                </div>
            `;
            
            // Show success message if provided
            if (message) {
                html += '<div class="success-message" style="background: #d4edda; color: #155724; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid #c3e6cb;">' + message + '</div>';
            }
            
            // Display files by category
            for (const [categoryKey, categoryName] of Object.entries(categories)) {
                const categoryFiles = files[categoryKey] || [];
                
                if (categoryFiles.length === 0) {
                    continue; // Skip empty categories
                }
                
                html += `
                    <div class="file-category" style="margin-bottom: 1.5rem;">
                        <h5 style="margin: 0 0 0.75rem 0; color: #374151; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-${getCategoryIcon(categoryKey)}" style="color: ${getCategoryColor(categoryKey)};"></i>
                            ${categoryName} (${categoryFiles.length})
                        </h5>
                        <div class="file-list" style="display: grid; gap: 0.5rem;">
                `;
                
                // Group files by inspection period
                const filesByPeriod = {};
                categoryFiles.forEach(file => {
                    const period = file.inspection_period || 'Unknown';
                    if (!filesByPeriod[period]) {
                        filesByPeriod[period] = [];
                    }
                    filesByPeriod[period].push(file);
                });
                
                // Display files grouped by inspection period
                for (const [period, periodFiles] of Object.entries(filesByPeriod)) {
                    // Set background and border colors based on category
                    const periodBackground = categoryKey === 'compliance' ? '#fef3c7' : '#f9fafb'; // Yellow background for compliance
                    const periodBorderColor = categoryKey === 'compliance' ? '#fbbf24' : '#d1d5db'; // Yellow border for compliance
                    
                    html += `
                        <div class="inspection-period" style="background: ${periodBackground}; padding: 0.75rem; border-radius: 4px; border-left: 3px solid ${periodBorderColor};">
                            <div style="font-weight: 500; color: #6b7280; margin-bottom: 0.5rem; font-size: 0.875rem;">
                                📅 ${period}${categoryKey === 'compliance' ? ' - ' + (periodFiles[0].commodity || 'Unknown Commodity') : ''}
                            </div>
                    `;
                    
                    periodFiles.forEach(file => {
                        const fileSize = formatFileSize(file.size);
                        const modifiedDate = new Date(file.modified_time * 1000).toLocaleDateString();
                        
                        // Set background color based on category
                        const backgroundColor = categoryKey === 'compliance' ? '#fef3c7' : 'white'; // Yellow background for compliance
                        const borderColor = categoryKey === 'compliance' ? '#fbbf24' : '#e5e7eb'; // Yellow border for compliance
                        
                        html += `
                            <div class="file-item" style="display: flex; align-items: center; justify-content: space-between; padding: 0.5rem; background: ${backgroundColor}; border-radius: 4px; margin-bottom: 0.25rem; border: 1px solid ${borderColor};">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <i class="fas fa-${getFileIcon(file.name)}" style="color: ${categoryKey === 'compliance' ? '#f59e0b' : '#6b7280'};"></i>
                                    <div>
                                        <div style="font-weight: 500; color: #374151;">${file.name}</div>
                                        <div style="font-size: 0.75rem; color: #6b7280;">
                                            ${fileSize} • Modified: ${modifiedDate}
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-sm" onclick="downloadFile('${file.download_url}')" style="background: #3b82f6; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem;">
                                    <i class="fas fa-download"></i> Download
                                </button>
                            </div>
                        `;
                    });
                    
                    html += '</div>'; // Close inspection-period
                }
                
                html += '</div></div>'; // Close file-list and file-category
            }
            
            // Show message if no files found
            if (totalFiles === 0) {
                html = `
                    <div class="empty-state" style="text-align: center; padding: 2rem; color: #6b7280;">
                        <i class="fas fa-folder-open" style="font-size: 3rem; margin-bottom: 1rem; color: #d1d5db;"></i>
                        <h4 style="margin: 0 0 0.5rem 0; color: #374151;">No Files Found</h4>
                        <p style="margin: 0;">No files found for this client. Run the 4-month data pull to download files from Google Drive.</p>
                    </div>
                `;
            }
            
            filesList.innerHTML = html;
        }
        
        function getCategoryIcon(categoryKey) {
            const icons = {
                'rfi': 'file-alt',
                'invoice': 'file-invoice',
                'lab': 'flask',
                'retest': 'redo',
                'compliance': 'shield-alt'
            };
            return icons[categoryKey] || 'file';
        }
        
        function getCategoryColor(categoryKey) {
            const colors = {
                'rfi': '#f59e0b',
                'invoice': '#10b981',
                'lab': '#8b5cf6',
                'retest': '#ef4444',
                'compliance': '#fbbf24'  // Yellow color for compliance documents
            };
            return colors[categoryKey] || '#6b7280';
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'file-pdf',
                'doc': 'file-word',
                'docx': 'file-word',
                'xls': 'file-excel',
                'xlsx': 'file-excel',
                'jpg': 'file-image',
                'jpeg': 'file-image',
                'png': 'file-image',
                'gif': 'file-image',
                'zip': 'file-archive',
                'rar': 'file-archive'
            };
            return iconMap[ext] || 'file';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function getFileStatusInfo(fileStatus) {
            switch(fileStatus) {
                case 'all_files':
                    return {
                        text: '✅ All Files Available',
                        style: 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;'
                    };
                case 'compliance_only':
                    return {
                        text: '🔵 Compliance Only',
                        style: 'background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd;'
                    };
                case 'no_files':
                    return {
                        text: '❌ No Files',
                        style: 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;'
                    };
                case 'partial_files':
                    return {
                        text: '🟠 Partial Files',
                        style: 'background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;'
                    };
                default:
                    return null;
            }
        }
        
        function displayFiles(files, message = null) {
            const filesList = document.getElementById('filesList');
            
            // EXTENSIVE DEBUG LOGGING
            console.log('🔍 displayFiles called with files:', files);
            console.log('🔍 DEBUG: files type:', typeof files);
            console.log('🔍 DEBUG: files keys:', Object.keys(files || {}));
            console.log('🔍 DEBUG: files values:', Object.values(files || {}));
            console.log('🔍 DEBUG: message:', message);
            console.log('🔍 DEBUG: filesList element:', filesList);
            
            // Detailed analysis of files object
            if (files) {
                console.log('🔍 DEBUG: Files object analysis:');
                console.log('  - Is array:', Array.isArray(files));
                console.log('  - Is object:', typeof files === 'object');
                console.log('  - Has length property:', 'length' in files);
                console.log('  - Length value:', files.length);
                console.log('  - Object.keys length:', Object.keys(files).length);
                console.log('  - Object.values length:', Object.values(files).length);
                
                // Check each category
                Object.keys(files).forEach(category => {
                    const fileList = files[category];
                    console.log(`🔍 DEBUG: Category "${category}":`, {
                        type: typeof fileList,
                        isArray: Array.isArray(fileList),
                        length: fileList ? fileList.length : 'N/A',
                        content: fileList
                    });
                });
            } else {
                console.log('🔍 DEBUG: Files is null/undefined');
            }
            
            // Show success message if provided
            if (message) {
                console.log('🔍 DEBUG: Adding success message:', message);
                filesList.innerHTML = `<div class="success-message" style="background: #d4edda; color: #155724; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; border: 1px solid #c3e6cb;">
                    <i class="fas fa-check-circle"></i> ${message}
                </div>`;
            }
            
            // Check if there are actually any files (not just empty arrays)
            const hasFiles = files && Object.values(files).some(fileList => fileList && fileList.length > 0);
            console.log('🔍 DEBUG: hasFiles check result:', hasFiles);
            console.log('🔍 DEBUG: hasFiles breakdown:');
            console.log('  - files exists:', !!files);
            console.log('  - Object.values(files):', files ? Object.values(files) : 'N/A');
            console.log('  - some() result:', files ? Object.values(files).some(fileList => fileList && fileList.length > 0) : 'N/A');
            
            if (!hasFiles) {
                console.log('🔍 DEBUG: No files found - showing empty message');
                filesList.innerHTML += '<div class="empty-category">No files found for this inspection</div>';
                return;
            }
            
            let html = '';
            
            // Define categories in order - handle both document types and commodity types
            const documentCategories = [
                { key: 'rfi', name: 'RFI Documents', icon: 'fas fa-file-alt' },
                { key: 'invoice', name: 'Invoice Documents', icon: 'fas fa-file-invoice' },
                { key: 'lab', name: 'Lab Results', icon: 'fas fa-flask' },
                { key: 'retest', name: 'Retest Documents', icon: 'fas fa-redo' },
                { key: 'compliance', name: 'Compliance Documents', icon: 'fas fa-shield-alt' }
            ];
            
            // Check if files are categorized by commodity type (like POULTRY, MEAT, etc.)
            const fileKeys = Object.keys(files);
            const documentTypeKeys = ['rfi', 'invoice', 'lab', 'retest', 'compliance'];
            
            // Check if ALL keys are document types (not commodity-based)
            const allKeysAreDocumentTypes = fileKeys.every(key => 
                documentTypeKeys.includes(key.toLowerCase())
            );
            
            let categories;
            if (allKeysAreDocumentTypes && fileKeys.length > 0) {
                // Files are categorized by document type - use predefined categories
                categories = documentCategories;
            } else {
                // Files are categorized by commodity type or mixed
                categories = fileKeys.map(key => ({
                    key: key,
                    name: `${key} Documents`,
                    icon: 'fas fa-shield-alt'
                }));
            }
            
                categories.forEach(category => {
                    const categoryFiles = files[category.key] || [];
                    console.log(`📁 Processing category: ${category.key}`, categoryFiles);
                    console.log(`🔍 Category key: "${category.key}", Is compliance: ${category.key === 'compliance'}`);
                console.log(`📁 Files object for ${category.key}:`, files[category.key]);
                
                html += `
                    <div class="file-category">
                        <div class="file-category-header">
                            <div class="category-title">
                                <i class="${category.icon}"></i>
                                ${category.name}
                            </div>
                            <div class="file-count">${categoryFiles.length}</div>
                        </div>
                        <div class="file-list">
                `;
                
                if (categoryFiles.length === 0) {
                    html += '<div class="empty-category">No files in this category</div>';
                } else {
                    categoryFiles.forEach(file => {
                        console.log(`📄 File processing: ${file.name}, category.key: "${category.key}", file.category: "${file.category}"`);
                        html += `
                            <div class="file-item">
                                <div class="file-info">
                                    <i class="file-icon ${getFileIcon(file.filename || file.name)}"></i>
                                    <div class="file-details">
                                        <div class="file-name">${file.filename || file.name}</div>
                                        <div class="file-size">
                                            <span>${formatFileSize(file.size)}</span>
                                            <span>•</span>
                                            ${file.type ? `<span class="file-type">${file.type.toUpperCase()}</span>` : ''}
                                            <span>${file.modified || ''}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    ${getViewButton(file)}
                                    <a href="${file.url || '/download-inspection-file/?file=' + encodeURIComponent(file.path) + '&source=' + (file.source || 'local')}" class="btn btn-file btn-secondary" title="Download File">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    ${category.key !== 'compliance' && !(file.relative_path && file.relative_path.toLowerCase().includes('compliance')) && !(file.path && file.path.toLowerCase().includes('compliance')) ? `
                                    <button class="btn btn-file btn-danger" onclick="console.log('Delete file:', '${file.relative_path || file.path}'); deleteFile('${file.relative_path || file.path}', '${category.key}')" title="Delete File">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div></div>';
            });
            
            filesList.innerHTML = html;
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            switch(ext) {
                case 'pdf': return 'fas fa-file-pdf';
                case 'xlsx': case 'xls': return 'fas fa-file-excel';
                case 'docx': case 'doc': return 'fas fa-file-word';
                case 'jpg': case 'jpeg': case 'png': return 'fas fa-file-image';
                case 'zip': case 'rar': return 'fas fa-file-archive';
                default: return 'fas fa-file';
            }
        }
        
        function getViewButton(file) {
            const filename = file.filename || file.name;
            const ext = filename.split('.').pop().toLowerCase();
            
            // For ZIP files, show extract/contents button instead of view
            if (ext === 'zip' || ext === 'rar') {
                return `
                    <button class="btn btn-file btn-warning" onclick="showZipContents('${file.path}', '${file.source || 'local'}')" title="Show ZIP Contents">
                        <i class="fas fa-eye"></i>
                    </button>
                `;
            }
            
            // For viewable files (PDF, images, etc.), show view button
            const viewableTypes = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'txt'];
            if (viewableTypes.includes(ext)) {
                // Use OneDrive URL if available, otherwise use local URL
                const viewUrl = file.url || '/download-inspection-file/?file=' + encodeURIComponent(file.path) + '&source=' + (file.source || 'local');
                return `
                    <a href="${viewUrl}" class="btn btn-file btn-primary" target="_blank" title="View File">
                        <i class="fas fa-eye"></i>
                    </a>
                `;
            }
            
            // For other files (Excel, Word), show download-only
            return `
                <button class="btn btn-file btn-info" onclick="alert('This file type opens best when downloaded')" title="Download to View">
                    <i class="fas fa-info"></i>
                </button>
            `;
        }
        
        async function showZipContents(relativePath, source = 'local') {
            try {
                const response = await fetch('/inspections/zip-contents/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        file_path: relativePath,
                        source: source
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create styled ZIP contents popup matching shipment list design
                    let contentsHtml = `
                        <div class="file-category">
                            <div class="file-category-header">
                                <div class="category-title">
                                    <i class="fas fa-file-archive"></i>
                                    ZIP File Contents: ${result.zip_name}
                                </div>
                                <div class="file-count">${result.total_files}</div>
                            </div>
                            <div class="file-list">
                    `;
                    
                    if (result.contents && result.contents.length > 0) {
                        result.contents.forEach(item => {
                            contentsHtml += `
                                <div class="file-item">
                                    <div class="file-info">
                                        <i class="file-icon ${getFileIcon(item.name)}"></i>
                                        <div class="file-details">
                                            <div class="file-name">${item.name}</div>
                                            <div class="file-size">
                                                <span>${formatFileSize(item.size)}</span>
                                                <span>•</span>
                                                <span>Compressed: ${formatFileSize(item.compressed_size)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        contentsHtml += '<div class="empty-category">No files found in ZIP</div>';
                    }
                    
                    contentsHtml += '</div></div>';
                    
                    // Create modal matching the main files popup style
                    const overlay = document.createElement('div');
                    overlay.className = 'modal';
                    overlay.style.zIndex = '10001';
                    
                    const modalContent = document.createElement('div');
                    modalContent.className = 'modal-content';
                    modalContent.style.maxWidth = '700px';
                    
                    modalContent.innerHTML = 
                        '<div class="modal-header">' +
                            '<div class="modal-title">' +
                                '<i class="fas fa-archive"></i>' +
                                '<span>ZIP File Contents</span>' +
                            '</div>' +
                            '<button class="modal-close" onclick="this.closest(\'.modal\').remove()" title="Close">' +
                                '<i class="fas fa-times"></i>' +
                            '</button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            contentsHtml +
                        '</div>';
                    
                    overlay.appendChild(modalContent);
                    document.body.appendChild(overlay);
                    
                } else {
                    alert('Error reading ZIP contents: ' + result.error);
                }
                
            } catch (error) {
                alert('Network error: ' + error.message);
            }
        }
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }
        
        // Send group documents function
        async function sendGroupDocuments(groupId, clientName, inspectionDate) {
            try {
                // Show confirmation dialog
                const confirmed = confirm('Send all documents for ' + clientName + ' - ' + inspectionDate + '?\n\nThis will send RFI, Invoice, Lab results, and other completed documents.');
                
                if (!confirmed) {
                    return;
                }
                
                // Update button state
                const sendButton = document.getElementById('send-' + groupId);
                const originalText = sendButton.innerHTML;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                sendButton.disabled = true;
                
                // Make API call to send documents
                const response = await fetch('/inspections/send-documents/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        group_id: groupId,
                        client_name: clientName,
                        inspection_date: inspectionDate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Update button to show sent state
                    sendButton.innerHTML = '<i class="fas fa-check"></i> Sent';
                    sendButton.classList.add('sent');
                    sendButton.disabled = false;
                    
                    // Show success message
                    alert('✅ Documents sent successfully!\n\nSent to: ' + result.recipients + '\nDocuments: ' + result.documents_sent + '\nEmail ID: ' + result.email_id || 'N/A');
                } else {
                    // Restore button on error
                    sendButton.innerHTML = originalText;
                    sendButton.disabled = false;
                    alert('❌ Error sending documents: ' + result.error);
                }
                
            } catch (error) {
                // Restore button on network error
                const sendButton = document.getElementById('send-' + groupId);
                sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
                sendButton.disabled = false;
                alert('❌ Network error: ' + error.message);
            }
        }
        
        // Upload status management
        function loadUploadStatus() {
            // Load upload status from localStorage and update button colors
            const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
            
            // First, apply stored upload status immediately for better UX
            Object.keys(uploadStatus).forEach(buttonId => {
                const button = document.getElementById(buttonId);
                if (button && uploadStatus[buttonId]) {
                    button.classList.add('uploaded');
                    console.log('Restored upload status for ' + buttonId);
                }
            });
            
            // Then, verify file existence in the background
            // This ensures buttons stay green if files actually exist
            setTimeout(() => {
                Object.keys(uploadStatus).forEach(buttonId => {
                    if (uploadStatus[buttonId]) {
                        checkFileExists(buttonId, uploadStatus[buttonId]);
                    }
                });
            }, 1000); // Small delay to let page fully load
        }
        
        // RFI status is now handled by file-based checking in the backend
        // No need for separate loadRFIStatus function since template uses shipment.rfi_uploaded
        
        // Load sent status from database on page load
        function loadSentStatus() {
            console.log('🚀 [SENT STATUS] Starting loadSentStatus function');
            console.log('🚀 [SENT STATUS] Function called at:', new Date().toISOString());
            
            // Get all sent status dropdowns and restore their values from the template data
            const sentDropdowns = document.querySelectorAll('.sent-status-dropdown');
            console.log('🔍 [SENT STATUS] Found ' + sentDropdowns.length + ' sent status dropdowns');
            
            // Also check how many rows we have
            const allRows = document.querySelectorAll('tr[data-group-id]');
            console.log('🔍 [SENT STATUS] Found ' + allRows.length + ' rows with data-group-id');
            
            sentDropdowns.forEach((dropdown, index) => {
                const groupId = dropdown.getAttribute('data-group-id');
                const currentValue = dropdown.value;
                console.log('🔍 [SENT STATUS] Processing dropdown ' + index + 1 + '/' + sentDropdowns.length + ': groupId="' + groupId + '", value="' + currentValue + '"');
                
                // Apply visual styling based on current value
                if (currentValue === 'YES') {
                    console.log('✅ [SENT STATUS] Applying YES styling to dropdown for ' + groupId);
                    dropdown.style.backgroundColor = '#10b981';
                    dropdown.style.color = 'white';
                    dropdown.style.borderColor = '#059669';
                    dropdown.classList.remove('sent-no');
                    dropdown.classList.add('sent-yes');
                    
                    // Also mark the row as complete
                    // Note: groupId from dropdown already has the correct format (with hyphens)
                    const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                    console.log('🔍 [SENT STATUS] Looking for row with data-group-id="' + groupId + '":', groupRow ? 'FOUND' : 'NOT FOUND');
                    
                    // Debug: List all available rows with data-group-id
                    const allRows = document.querySelectorAll('tr[data-group-id]');
                    console.log('🔍 [SENT STATUS] Available rows:', Array.from(allRows).map(row => row.getAttribute('data-group-id')));
                    
                    if (groupRow) {
                        groupRow.classList.add('inspection-complete');
                        groupRow.classList.add('row-locked');
                        groupRow.setAttribute('data-locked', 'true');
                        groupRow.setAttribute('data-sent-status', 'yes');
                        groupRow.setAttribute('data-was-sent', 'true');
                        console.log('🎯 [SENT STATUS] SUCCESS: Marked group ' + groupId + ' as complete and LOCKED on page load');
                        
                        // Lock the entire row - disable all interactive elements
                        if (typeof lockRow === 'function') {
                            lockRow(groupRow);
                        } else {
                            console.log('⚠️ [SENT STATUS] lockRow function not available, applying basic styling');
                            // Fallback styling if lockRow function is not available
                            groupRow.style.borderLeft = '4px solid #22c55e';
                        }
                        
                        // Verify the class was added
                        if (groupRow.classList.contains('inspection-complete')) {
                            console.log('✅ [SENT STATUS] VERIFIED: Row ' + groupId + ' has inspection-complete class and is LOCKED');
                        } else {
                            console.log('❌ [SENT STATUS] ERROR: Row ' + groupId + ' does NOT have inspection-complete class');
                        }
                    } else {
                        console.log('❌ [SENT STATUS] ERROR: Could not find row for group ' + groupId);
                        
                        // Let's see what rows we do have
                        const allGroupRows = document.querySelectorAll('tr[data-group-id]');
                        console.log('🔍 [SENT STATUS] Available rows:', Array.from(allGroupRows).map(row => row.getAttribute('data-group-id')));
                    }
                } else if (currentValue === 'NO') {
                    dropdown.style.backgroundColor = '#ef4444';
                    dropdown.style.color = 'white';
                    dropdown.style.borderColor = '#dc2626';
                    dropdown.classList.remove('sent-yes');
                    dropdown.classList.add('sent-no');
                    
                    // Remove complete status from row and unlock it
                    const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                    if (groupRow) {
                        groupRow.classList.remove('inspection-complete');
                        groupRow.classList.remove('row-locked');
                        groupRow.removeAttribute('data-locked');
                        groupRow.removeAttribute('data-sent-status');
                        
                        // Unlock the row if lockRow function is available
                        if (typeof unlockRow === 'function') {
                            unlockRow(groupRow);
                        } else {
                            // Fallback: remove styling
                            groupRow.style.borderLeft = '';
                        }
                    }
                } else {
                    dropdown.style.backgroundColor = 'var(--card-bg)';
                    dropdown.style.color = 'var(--text)';
                    dropdown.style.borderColor = 'var(--border)';
                    dropdown.classList.remove('sent-yes', 'sent-no');
                    
                    // Remove complete status from row and unlock it
                    const groupRow = document.querySelector('tr[data-group-id="' + groupId + '"]');
                    if (groupRow) {
                        groupRow.classList.remove('inspection-complete');
                        groupRow.classList.remove('row-locked');
                        groupRow.removeAttribute('data-locked');
                        groupRow.removeAttribute('data-sent-status');
                        
                        // Unlock the row if lockRow function is available
                        if (typeof unlockRow === 'function') {
                            unlockRow(groupRow);
                        } else {
                            // Fallback: remove styling
                            groupRow.style.borderLeft = '';
                        }
                    }
                }
                
                console.log('Restored sent status for group ' + groupId + ': ' + currentValue);
            });
            
            console.log('🏁 [SENT STATUS] Completed loadSentStatus function');
            console.log('🚀 [SENT STATUS] ===========================================');
        }
        
        // Check all uploaded files on page load to ensure buttons are properly colored
        function checkAllUploadedFiles() {
            console.log('🔍 Checking all uploaded files on page load...');
            
            // Get all upload buttons on the page
            const uploadButtons = document.querySelectorAll('.btn-upload');
            
            uploadButtons.forEach(button => {
                const buttonId = button.id;
                if (buttonId) {
                    // Check if this button is already marked as uploaded
                    if (!button.classList.contains('uploaded')) {
                        // Check if file actually exists
                        checkFileExists(buttonId, null);
                    }
                }
            });
        }
        
        function checkFileExists(buttonId, fileInfo) {
            // Make a lightweight request to check if file exists
            const parts = buttonId.split('-');
            const docType = parts[0]; // Extract document type
            const identifier = parts[1]; // Extract group ID or inspection ID
            
            console.log('Checking file existence for: ' + buttonId + ' (' + docType + ' - ' + identifier + ')');
            
            // Determine if this is a group upload or individual inspection upload
            let url;
            if (docType === 'rfi' || docType === 'invoice') {
                url = '/list-uploaded-files/?group_id=' + identifier;
            } else {
                // For lab and retest, we need both group_id and inspection_id
                // Get the group_id from the button's data attribute or parent row
                const button = document.getElementById(buttonId);
                let groupId = null;
                if (button) {
                    // Try to get group_id from the button's data attribute
                    groupId = button.getAttribute('data-group-id');
                    if (!groupId) {
                        // Try to get it from the parent row
                        const row = button.closest('tr');
                        if (row) {
                            const groupRow = row.previousElementSibling;
                            if (groupRow && groupRow.classList.contains('group-row')) {
                                const groupButton = groupRow.querySelector('.expand-btn');
                                if (groupButton) {
                                    groupId = groupButton.getAttribute('data-group-id');
                                }
                            }
                        }
                    }
                }
                
                if (groupId) {
                    url = '/list-uploaded-files/?group_id=' + groupId + '&inspection_id=' + identifier;
                } else {
                    url = '/list-uploaded-files/?inspection_id=' + identifier;
                }
            }
            
            console.log('Making request to: ' + url);
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    console.log('Response for ' + buttonId + ':', data);
                    if (data.success) {
                        const files = data.files[docType] || [];
                        console.log('Files found for ' + docType + ':', files);
                        if (files.length === 0) {
                            // File doesn't exist, reset button
                            console.log('No files found for ' + buttonId + ', resetting button');
                            const button = document.getElementById(buttonId);
                            if (button) {
                                button.classList.remove('uploaded');
                                // Remove from localStorage
                                const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                delete uploadStatus[buttonId];
                                localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                                console.log('Removed ' + buttonId + ' from localStorage');
                            }
                        } else {
                            // File exists, mark button as uploaded
                            console.log('Files found for ' + buttonId + ', marking button as uploaded');
                            const button = document.getElementById(buttonId);
                            if (button) {
                                button.classList.add('uploaded');
                                // Also save to localStorage for future page loads
                                const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                                uploadStatus[buttonId] = true;
                                localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                                console.log('Added ' + buttonId + ' to localStorage');
                            }
                        }
                    }
                })
                .catch(error => {
                    console.log('Error checking file existence:', error);
                    // On error, assume file doesn't exist and reset button
                    const button = document.getElementById(buttonId);
                    if (button) {
                        button.classList.remove('uploaded');
                        const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                        delete uploadStatus[buttonId];
                        localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                    }
                });
        }
        
        // Make markAsUploaded globally available
        window.markAsUploaded = function markAsUploaded(buttonId) {
            // Mark button as uploaded and save to localStorage
            console.log('🔍 [DEBUG] markAsUploaded called for:', buttonId);
            console.log('🔍 [DEBUG] Button type:', buttonId.startsWith('rfi-') ? 'RFI' : buttonId.startsWith('invoice-') ? 'Invoice' : 'Unknown');
            
            const button = document.getElementById(buttonId);
            console.log('🔍 [DEBUG] Button element found:', button);
            console.log('🔍 [DEBUG] Button current innerHTML:', button ? button.innerHTML : 'N/A');
            console.log('🔍 [DEBUG] Button current disabled state:', button ? button.disabled : 'N/A');
            
            if (button) {
                console.log('🔍 [DEBUG] Button found, updating to show uploaded state');
                
                // Clear the file-deleted flag since a new file has been uploaded
                button.removeAttribute('data-file-deleted');
                console.log('🔍 [DEBUG] Removed data-file-deleted attribute');
                
                // Get current user first name from template context
                const currentUserName = '{{ request.user.first_name|default:request.user.username|escapejs }}';
                console.log('🔍 [DEBUG] Current user first name from template:', currentUserName);
                console.log('🔍 [DEBUG] User name length:', currentUserName.length);
                console.log('🔍 [DEBUG] User name type:', typeof currentUserName);
                
                const currentDate = new Date().toLocaleDateString('en-US', { 
                    month: 'numeric', 
                    day: 'numeric', 
                    year: '2-digit' 
                });
                console.log('🔍 [DEBUG] Current date:', currentDate);
                
                // Store original button state for debugging
                const originalInnerHTML = button.innerHTML;
                const originalDisabled = button.disabled;
                const originalStyle = button.style.cssText;
                
                console.log('🔍 [DEBUG] Original button state:');
                console.log('  - innerHTML:', originalInnerHTML);
                console.log('  - disabled:', originalDisabled);
                console.log('  - style:', originalStyle);
                
                // Update button to show uploaded state with user's name
                console.log('🔍 [DEBUG] Setting button.disabled = true');
                button.disabled = true;
                
                console.log('🔍 [DEBUG] Setting button styles...');
                // Force override any existing styles
                button.style.setProperty('background', '#d4edda', 'important');
                button.style.setProperty('color', '#155724', 'important');
                button.style.setProperty('border', '1px solid #c3e6cb', 'important');
                button.style.setProperty('cursor', 'not-allowed', 'important');
                
                console.log('🔍 [DEBUG] Setting button.innerHTML to user first name:', currentUserName);
                button.innerHTML = currentUserName;
                
                // Verify the change was applied
                console.log('🔍 [DEBUG] After update - button.innerHTML:', button.innerHTML);
                console.log('🔍 [DEBUG] After update - button.disabled:', button.disabled);
                console.log('🔍 [DEBUG] After update - button.style.background:', button.style.background);
                
                // Determine document type from button ID
                let docType = 'document';
                if (buttonId.startsWith('rfi-')) {
                    docType = 'RFI';
                } else if (buttonId.startsWith('invoice-')) {
                    docType = 'Invoice';
                }
                console.log('🔍 [DEBUG] Document type:', docType);
                
                const titleText = `${docType} uploaded by ${currentUserName} on ${currentDate}`;
                console.log('🔍 [DEBUG] Setting button.title to:', titleText);
                button.title = titleText;
                
                // Remove the onclick handler since button is now disabled
                console.log('🔍 [DEBUG] Removing onclick handler');
                button.onclick = null;
                
                // Add uploaded class for any CSS styling
                console.log('🔍 [DEBUG] Adding uploaded class');
                button.classList.add('uploaded');
                
                // Save to localStorage
                const uploadStatus = JSON.parse(localStorage.getItem('uploadStatus') || '{}');
                uploadStatus[buttonId] = true;
                localStorage.setItem('uploadStatus', JSON.stringify(uploadStatus));
                
                console.log('✅ [DEBUG] Button update completed. Final state:');
                console.log('  - innerHTML:', button.innerHTML);
                console.log('  - disabled:', button.disabled);
                console.log('  - title:', button.title);
                console.log('  - classList:', button.classList.toString());
                
            } else {
                console.error('❌ [DEBUG] Button not found for ID:', buttonId);
                console.log('🔍 [DEBUG] Available buttons on page:');
                const allButtons = document.querySelectorAll('button[id]');
                allButtons.forEach(btn => {
                    console.log('  - Button ID:', btn.id);
                });
            }
        };
        
        
        // Function to automatically update all View Files button colors on page load
        async function updateAllViewFilesButtonColors() {
            console.log('🎨 Starting automatic color update for all View Files buttons');
            
            // Show loading state on all View Files buttons - use multiple detection methods
            let allViewFilesButtons = [];
            
            // Method 1: By class
            allViewFilesButtons = document.querySelectorAll('button.btn-view-files, button[class*="btn-view-files"]');
            console.log('🔍 [FRONTEND] Method 1 - Found ' + allViewFilesButtons.length + ' buttons by class');
            
            // Method 2: By onclick attribute (more reliable)
            if (allViewFilesButtons.length === 0) {
                allViewFilesButtons = document.querySelectorAll('button[onclick*="openFilesPopup"]');
                console.log('🔍 [FRONTEND] Method 2 - Found ' + allViewFilesButtons.length + ' buttons by onclick');
            }
            
            // Method 3: By text content as fallback
                if (allViewFilesButtons.length === 0) {
                    const allButtons = document.querySelectorAll('button');
                allViewFilesButtons = Array.from(allButtons).filter(btn => 
                    btn.textContent.includes('View Files') || 
                    btn.textContent.includes('Files') ||
                    btn.onclick && btn.onclick.toString().includes('openFilesPopup')
                );
                console.log('🔍 [FRONTEND] Method 3 - Found ' + allViewFilesButtons.length + ' buttons by text/onclick');
            }
            
            allViewFilesButtons.forEach(button => {
                const icon = button.querySelector('i');
                if (icon) {
                    icon.className = 'fas fa-sync fa-spin';
                    icon.style.color = '#6b7280';
                }
                button.title = 'Checking file status...';
            });
            
            // Get all client data from the current page
            const clientData = getCurrentPageClientData();
            const clientNames = Object.keys(clientData);
            
            console.log('📋 Found ' + clientNames.length + ' unique clients to check:', clientNames);
            console.log('📅 Inspection dates:', clientData);
            
            if (clientNames.length === 0) {
                console.log('⚠️ No clients found to check');
                // Reset loading state
                allViewFilesButtons.forEach(button => {
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-download';
                        icon.style.color = '#6b7280';
                    }
                    button.title = 'View Files';
                });
                return;
            }
            
            if (allViewFilesButtons.length === 0) {
                console.log('⚠️ No View Files buttons found, skipping automatic color update');
                return;
            }
            
            try {
                // Call the bulk status check endpoint
                const response = await fetch('/page-clients-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken()
                    },
                    body: JSON.stringify({
                        client_names: clientNames,
                        inspection_dates: clientData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Received file status data for all clients');
                    
                    // Update button colors for each client
                    Object.entries(result.client_statuses).forEach(([clientName, statusData]) => {
                        console.log('🎨 Updating colors for ' + clientName + ': ' + statusData.file_status);
                        updateViewFilesButtonColor(clientName, statusData.file_status);
                    });
                    
                    console.log('🎨 Completed automatic color update for all buttons');
                } else {
                    console.error('❌ Error getting file status:', result.error);
                }
                
            } catch (error) {
                console.error('❌ Error updating View Files button colors:', error);
                
                // Reset loading state on error
                allViewFilesButtons.forEach(button => {
                    const icon = button.querySelector('i');
                    if (icon) {
                        icon.className = 'fas fa-download';
                        icon.style.color = '#6b7280';
                    }
                    button.title = 'View Files';
                });
            }
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Setup expand buttons function
        function setupExpandButtons() {
            console.log('🔧 Setting up expand button event listeners');
            const expandButtons = document.querySelectorAll('.expand-btn');
            console.log('🔧 Found expand buttons:', expandButtons.length);
            
            if (expandButtons.length === 0) {
                console.warn('⚠️ No expand buttons found!');
                return;
            }
            
            expandButtons.forEach((button, index) => {
                console.log('🔧 Setting up button ' + index + ':', button);
                console.log('🔧 Button group ID:', button.getAttribute('data-group-id'));
                // Remove any existing listeners to avoid duplicates
                button.removeEventListener('click', handleExpandClick);
                button.addEventListener('click', handleExpandClick);
            });
        }
        
        // Handle expand button click
        function handleExpandClick(e) {
            e.preventDefault();
            e.stopPropagation();
            const groupId = this.getAttribute('data-group-id');
            console.log('Expand button clicked for group:', groupId);
            toggleGroup(e, groupId);
        }
        
        // Simple, clean expand button functionality
        document.addEventListener('click', function(e) {
            if (e.target.closest('.expand-btn')) {
                e.preventDefault();
                e.stopPropagation();
                const button = e.target.closest('.expand-btn');
                const groupId = button.getAttribute('data-group-id');
                console.log('🔧 Expand button clicked for group:', groupId);
                toggleGroup(e, groupId);
            }
        });
        
        // Initialize page functionality when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 [FRONTEND] DOM ready, initializing page functionality...');
            
            // Update View Files button colors with delays
            setTimeout(function() {
                console.log('🎨 [FRONTEND] Starting initial automatic color update...');
                updateAllViewFilesButtonColors();
            }, 1000);
            
            setTimeout(function() {
                console.log('🔄 [FRONTEND] Retrying automatic color update...');
                updateAllViewFilesButtonColors();
            }, 3000);
            
            // Fix header positions when expanding
            setupHeaderPositionFix();
        });
        
        // Function to fix header positions when expanding/collapsing
        function setupHeaderPositionFix() {
            console.log('🔧 Setting up header position fix...');
            
            // Add event listeners to all expand buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.expand-btn')) {
                    console.log('🔄 Expand button clicked, fixing header positions...');
                    setTimeout(fixHeaderPositions, 100);
                }
            });
            
            // Also fix on window resize
            window.addEventListener('resize', function() {
                setTimeout(fixHeaderPositions, 100);
            });
        }
        
        // Function to force header positions to stay in place
        function fixHeaderPositions() {
            const table = document.getElementById('shipmentsTable');
            if (!table) return;
            
            const thead = table.querySelector('thead');
            if (!thead) return;
            
            // Force the header to maintain its position
            thead.style.position = 'sticky';
            thead.style.top = '0';
            thead.style.zIndex = '100';
            thead.style.backgroundColor = '#f8f9fa';
            
            // Force all header cells to maintain their width
            const headerCells = thead.querySelectorAll('th');
            headerCells.forEach((cell, index) => {
                cell.style.position = 'sticky';
                cell.style.top = '0';
                cell.style.zIndex = '100';
                cell.style.backgroundColor = '#f8f9fa';
                
                // Force specific widths for problematic columns
                if (cell.classList.contains('col-km')) {
                    cell.style.width = '120px';
                    cell.style.minWidth = '120px';
                    cell.style.maxWidth = '120px';
                }
                if (cell.classList.contains('col-hours')) {
                    cell.style.width = '120px';
                    cell.style.minWidth = '120px';
                    cell.style.maxWidth = '120px';
                }
            });
            
            // Fix detail table width constraints to prevent main table shifting
            const detailTables = document.querySelectorAll('.detail-table');
            detailTables.forEach(detailTable => {
                detailTable.style.maxWidth = '100%';
                detailTable.style.minWidth = '100%';
            });
            
            const detailWrappers = document.querySelectorAll('.detail-table-wrapper');
            detailWrappers.forEach(wrapper => {
                wrapper.style.maxWidth = 'calc(100vw - 100px)';
                wrapper.style.overflowX = 'auto';
            });
            
            console.log('✅ Header positions fixed and detail table constrained');
        }
        // Upload RFI function
        function uploadRFI(groupId) {
            console.log('🔍 uploadRFI called with groupId:', groupId);
            console.log('🔍 Function execution starting...');
            
            try {
                // Create a file input element
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.pdf';
                fileInput.style.display = 'none';
                
                console.log('✅ File input element created successfully');
                
                fileInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Additional client-side PDF validation
                        if (!file.name.toLowerCase().endsWith('.pdf')) {
                            alert('Only PDF files are allowed. Please select a PDF document.');
                            return;
                        }
                        // Create form data
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('group_id', groupId);
                        formData.append('document_type', 'rfi');
                        
                        // Get CSRF token
                        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                         '{{ csrf_token|escapejs }}';
                        formData.append('csrfmiddlewaretoken', csrfToken);
                        
                        // Upload file
                        fetch('/upload-document/', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('✅ RFI uploaded successfully!');
                                markAsUploaded('rfi-' + groupId);
                                
                                // Update View Files button colors after upload with delay to ensure server processing
                                console.log('🎨 Updating button colors after RFI upload...');
                                console.log('⏰ Setting 3-second timer for delayed color update...');
                                setTimeout(() => {
                                    console.log('⏰ Timer fired! Starting delayed color update...');
                                    console.log('🔄 Delayed file status check after RFI upload...');
                                    updateAllViewFilesButtonColors();
                                }, 3000); // 3 second delay to ensure server processing is complete
                                
                                // Auto-open files popup after successful upload
                                const button = document.getElementById('rfi-' + groupId);
                                if (button) {
                                    const clientName = button.getAttribute('data-client-name');
                                    const inspectionDate = button.getAttribute('data-inspection-date');
                                    if (clientName && inspectionDate) {
                                        // Small delay to ensure the upload is processed
                                        setTimeout(() => {
                                            openFilesPopup(groupId, clientName, inspectionDate);
                                        }, 1000);
                                    }
                                }
                            } else {
                                alert('Error uploading RFI: ' + data.error);
                            }
                        })
                        .catch(error => {
                            alert('Error uploading RFI: ' + error.message);
                        });
                    }
                };
                
                console.log('✅ File input onchange handler set');
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                console.log('✅ File input appended to body');
                
                fileInput.click();
                console.log('✅ File input click() triggered - dialog should open now');
                
                document.body.removeChild(fileInput);
                console.log('✅ File input removed from body');
                
            } catch (error) {
                console.error('❌ Error in uploadRFI function:', error);
                alert('Error in upload function: ' + error.message);
            }
        }
        
        // Upload Invoice function
        function uploadInvoice(groupId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Additional client-side PDF validation
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only PDF files are allowed. Please select a PDF document.');
                        return;
                    }
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('group_id', groupId);
                    formData.append('document_type', 'invoice');
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     '{{ csrf_token|escapejs }}';
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    
                    // Upload file
                    fetch('/upload-document/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Invoice uploaded successfully!');
                            console.log('🔧 About to call markAsUploaded for invoice-' + groupId);
                            markAsUploaded('invoice-' + groupId);
                            console.log('🔧 markAsUploaded called for invoice-' + groupId);
                            
                            // Update View Files button colors after upload
                            console.log('🎨 Updating button colors after Invoice upload...');
                            updateAllViewFilesButtonColors();
                            
                            // Auto-open files popup after successful upload
                            const button = document.getElementById('invoice-' + groupId);
                            if (button) {
                                const clientName = button.getAttribute('data-client-name');
                                const inspectionDate = button.getAttribute('data-inspection-date');
                                if (clientName && inspectionDate) {
                                    // Small delay to ensure the upload is processed
                                    setTimeout(() => {
                                        openFilesPopup(groupId, clientName, inspectionDate);
                                    }, 1000);
                                }
                            }
                        } else {
                            alert('Error uploading Invoice: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error uploading Invoice: ' + error.message);
                    });
                }
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Upload Lab function
        function uploadLab(inspectionId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Additional client-side PDF validation
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only PDF files are allowed. Please select a PDF document.');
                        return;
                    }
                    // Get the group_id from the button's data attribute
                    const button = document.getElementById('lab-' + inspectionId);
                    let groupId = null;
                    if (button) {
                        groupId = button.getAttribute('data-group-id');
                    }
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('inspection_id', inspectionId);
                    formData.append('document_type', 'lab');
                    if (groupId) {
                        formData.append('group_id', groupId);
                    }
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     '{{ csrf_token|escapejs }}';
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    
                    // Upload file
                    fetch('/upload-document/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Lab upload response:', data);
                        if (data.success) {
                            console.log('✅ Lab report uploaded successfully!');
                            console.log('Marking lab button as uploaded:', 'lab-' + inspectionId);
                            markAsUploaded('lab-' + inspectionId);
                            
                            // Auto-open files popup after successful upload
                            const button = document.getElementById('lab-' + inspectionId);
                            if (button) {
                                const groupId = button.getAttribute('data-group-id');
                                const clientName = button.getAttribute('data-client-name');
                                const inspectionDate = button.getAttribute('data-inspection-date');
                                if (groupId && clientName && inspectionDate) {
                                    // Small delay to ensure the upload is processed
                                    setTimeout(() => {
                                        openFilesPopup(groupId, clientName, inspectionDate);
                                    }, 1000);
                                }
                            }
                        } else {
                            console.error('❌ Error uploading Lab report:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error uploading Lab report:', error.message);
                    });
                }
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Upload Lab Form function
        function uploadLabForm(inspectionId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Additional client-side PDF validation
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only PDF files are allowed. Please select a PDF document.');
                        return;
                    }
                    // Get the group_id from the button's data attribute
                    const button = document.getElementById('lab-form-' + inspectionId);
                    let groupId = null;
                    if (button) {
                        groupId = button.getAttribute('data-group-id');
                    }
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('inspection_id', inspectionId);
                    formData.append('document_type', 'lab_form');
                    if (groupId) {
                        formData.append('group_id', groupId);
                    }
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     '{{ csrf_token|escapejs }}';
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    
                    // Upload file
                    fetch('/upload-document/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Lab form upload response:', data);
                        if (data.success) {
                            console.log('✅ Lab form submission uploaded successfully!');
                            console.log('Marking lab form button as uploaded:', 'lab-form-' + inspectionId);
                            markAsUploaded('lab-form-' + inspectionId);
                            
                            // Auto-open files popup after successful upload
                            const button = document.getElementById('lab-form-' + inspectionId);
                            if (button) {
                                const groupId = button.getAttribute('data-group-id');
                                const clientName = button.getAttribute('data-client-name');
                                const inspectionDate = button.getAttribute('data-inspection-date');
                                if (groupId && clientName && inspectionDate) {
                                    // Small delay to ensure the upload is processed
                                    setTimeout(() => {
                                        openFilesPopup(groupId, clientName, inspectionDate);
                                    }, 1000);
                                }
                            }
                        } else {
                            console.error('❌ Error uploading Lab form submission:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error uploading Lab form submission:', error.message);
                    });
                }
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        // Upload Retest function
        function uploadRetest(inspectionId) {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf';
            fileInput.style.display = 'none';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Additional client-side PDF validation
                    if (!file.name.toLowerCase().endsWith('.pdf')) {
                        alert('Only PDF files are allowed. Please select a PDF document.');
                        return;
                    }
                    // Get the group_id from the button's data attribute
                    const button = document.getElementById('retest-' + inspectionId);
                    let groupId = null;
                    if (button) {
                        groupId = button.getAttribute('data-group-id');
                    }
                    
                    // Create form data
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('inspection_id', inspectionId);
                    formData.append('document_type', 'retest');
                    if (groupId) {
                        formData.append('group_id', groupId);
                    }
                    
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                     '{{ csrf_token|escapejs }}';
                    formData.append('csrfmiddlewaretoken', csrfToken);
                    
                    // Upload file
                    fetch('/upload-document/', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Retest upload response:', data);
                        if (data.success) {
                            console.log('✅ Retest report uploaded successfully!');
                            console.log('Marking retest button as uploaded:', 'retest-' + inspectionId);
                            markAsUploaded('retest-' + inspectionId);
                            
                            // Auto-open files popup after successful upload
                            const button = document.getElementById('retest-' + inspectionId);
                            if (button) {
                                const groupId = button.getAttribute('data-group-id');
                                const clientName = button.getAttribute('data-client-name');
                                const inspectionDate = button.getAttribute('data-inspection-date');
                                if (groupId && clientName && inspectionDate) {
                                    // Small delay to ensure the upload is processed
                                    setTimeout(() => {
                                        openFilesPopup(groupId, clientName, inspectionDate);
                                    }, 1000);
                                }
                            }
                        } else {
                            console.error('❌ Error uploading Retest report:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('❌ Error uploading Retest report:', error.message);
                    });
                }
            };
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        }
        
        
        // Update test result function
        function updateTestResult(checkbox) {
            const inspectionId = checkbox.getAttribute('data-inspection-id');
            const testType = checkbox.getAttribute('data-test-type');
            const isChecked = checkbox.checked;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('test_type', testType);
            formData.append('test_result', isChecked);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-test-result/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    checkbox.style.backgroundColor = isChecked ? '#d4edda' : '#f8f9fa';
                    setTimeout(() => {
                        checkbox.style.backgroundColor = '';
                    }, 500);
                } else {
                    // Revert checkbox state on error
                    checkbox.checked = !isChecked;
                    alert('Error updating test result: ' + data.error);
                }
            })
            .catch(error => {
                // Revert checkbox state on error
                checkbox.checked = !isChecked;
                alert('Error updating test result: ' + error.message);
            });
        }
        
        // Update needs retest function
        function updateNeedsRetest(dropdown) {
            const inspectionId = dropdown.getAttribute('data-inspection-id');
            const needsRetest = dropdown.value;
            
            // Check if dropdown is disabled (no sample taken)
            if (dropdown.disabled) {
                return; // Don't allow changes if disabled
            }
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('needs_retest', needsRetest);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-needs-retest/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    dropdown.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        dropdown.style.backgroundColor = '';
                    }, 500);
                    
                    // Update button states based on retest selection
                    updateButtonStates(inspectionId, needsRetest);
                } else {
                    // Revert dropdown state on error
                    dropdown.value = '';
                    alert('Error updating needs retest: ' + data.error);
                }
            })
            .catch(error => {
                // Revert dropdown state on error
                dropdown.value = '';
                alert('Error updating needs retest: ' + error.message);
            });
        }
        
        // Update Km Traveled function
        function updateKmTraveled(input) {
            const inspectionId = input.getAttribute('data-inspection-id');
            const kmValue = input.value;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('km_traveled', kmValue);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-km-traveled/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    input.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 500);
                } else {
                    alert('Error updating Km Traveled: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating Km Traveled: ' + error.message);
            });
        }
        
        // Update Bought Sample function
        function updateBoughtSample(input) {
            const inspectionId = input.getAttribute('data-inspection-id');
            const boughtSampleValue = input.value;
            
            // AGGRESSIVELY ensure NO borders are applied
            input.style.border = '0';
            input.style.borderWidth = '0';
            input.style.borderStyle = 'none';
            input.style.borderColor = 'transparent';
            input.style.borderTop = '0';
            input.style.borderRight = '0';
            input.style.borderBottom = '0';
            input.style.borderLeft = '0';
            input.style.outline = 'none';
            input.style.outlineWidth = '0';
            input.style.outlineStyle = 'none';
            input.style.outlineColor = 'transparent';
            input.style.boxShadow = 'none';
            input.style.webkitBoxShadow = 'none';
            input.style.mozBoxShadow = 'none';
            input.style.setProperty('border', '0', 'important');
            input.style.setProperty('outline', 'none', 'important');
            input.style.setProperty('box-shadow', 'none', 'important');
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('bought_sample', boughtSampleValue);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-bought-sample/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    input.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 500);
                } else {
                    alert('Error updating Bought Sample: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating Bought Sample: ' + error.message);
            });
        }
        
        // Initialize bought sample input styling
        function initializeBoughtSampleStyling() {
            console.log('🔍 [BOUGHT SAMPLE] Starting initializeBoughtSampleStyling...');
            
            const boughtSampleInputs = document.querySelectorAll('.clean-bought-sample-input, .col-bought-sample input');
            console.log(`🔍 [BOUGHT SAMPLE] Found ${boughtSampleInputs.length} bought sample inputs`);
            
            // Also check for bought sample column cells
            const boughtSampleCells = document.querySelectorAll('.col-bought-sample');
            console.log(`🔍 [BOUGHT SAMPLE] Found ${boughtSampleCells.length} bought sample column cells`);
            
            // Debug: Check CSS rules affecting bought sample
            console.log('🔍 [BOUGHT SAMPLE] Checking CSS rules and computed styles...');
            boughtSampleCells.forEach((cell, index) => {
                const computedStyle = window.getComputedStyle(cell);
                console.log(`🔍 [BOUGHT SAMPLE] Cell ${index + 1} computed styles:`, {
                    border: computedStyle.border,
                    borderBottom: computedStyle.borderBottom,
                    borderTop: computedStyle.borderTop,
                    borderLeft: computedStyle.borderLeft,
                    borderRight: computedStyle.borderRight,
                    borderWidth: computedStyle.borderWidth,
                    borderStyle: computedStyle.borderStyle,
                    borderColor: computedStyle.borderColor
                });
            });
            
            boughtSampleInputs.forEach((input, index) => {
                console.log(`🔍 [BOUGHT SAMPLE] Processing input ${index + 1}:`, input);
                
                // Log current computed styles before changes
                const computedStyle = window.getComputedStyle(input);
                console.log(`🔍 [BOUGHT SAMPLE] Input ${index + 1} current border:`, {
                    border: computedStyle.border,
                    borderWidth: computedStyle.borderWidth,
                    borderStyle: computedStyle.borderStyle,
                    borderColor: computedStyle.borderColor,
                    borderBottom: computedStyle.borderBottom,
                    outline: computedStyle.outline,
                    boxShadow: computedStyle.boxShadow
                });
                
                // AGGRESSIVELY remove ALL possible border styling
                input.style.border = '0';
                input.style.borderWidth = '0';
                input.style.borderStyle = 'none';
                input.style.borderColor = 'transparent';
                input.style.borderTop = '0';
                input.style.borderRight = '0';
                input.style.borderBottom = '0';
                input.style.borderLeft = '0';
                input.style.outline = 'none';
                input.style.outlineWidth = '0';
                input.style.outlineStyle = 'none';
                input.style.outlineColor = 'transparent';
                input.style.boxShadow = 'none';
                input.style.webkitBoxShadow = 'none';
                input.style.mozBoxShadow = 'none';
                input.style.setProperty('border', '0', 'important');
                input.style.setProperty('outline', 'none', 'important');
                input.style.setProperty('box-shadow', 'none', 'important');
                
                // Log styles after changes
                const newComputedStyle = window.getComputedStyle(input);
                console.log(`✅ [BOUGHT SAMPLE] Input ${index + 1} new border:`, {
                    border: newComputedStyle.border,
                    borderWidth: newComputedStyle.borderWidth,
                    borderStyle: newComputedStyle.borderStyle,
                    borderColor: newComputedStyle.borderColor,
                    borderBottom: newComputedStyle.borderBottom,
                    outline: newComputedStyle.outline,
                    boxShadow: newComputedStyle.boxShadow
                });
            });
            
            // Also process the column cells themselves
            boughtSampleCells.forEach((cell, index) => {
                console.log(`🔍 [BOUGHT SAMPLE] Processing cell ${index + 1}:`, cell);
                
                // Log current computed styles before changes
                const computedStyle = window.getComputedStyle(cell);
                console.log(`🔍 [BOUGHT SAMPLE] Cell ${index + 1} current border:`, {
                    border: computedStyle.border,
                    borderWidth: computedStyle.borderWidth,
                    borderStyle: computedStyle.borderStyle,
                    borderColor: computedStyle.borderColor,
                    borderBottom: computedStyle.borderBottom,
                    backgroundColor: computedStyle.backgroundColor
                });
                
                // AGGRESSIVE border removal - remove ALL possible borders
                cell.style.border = 'none';
                cell.style.borderBottom = 'none';
                cell.style.borderTop = 'none';
                cell.style.borderLeft = 'none';
                cell.style.borderRight = 'none';
                cell.style.borderWidth = '0';
                cell.style.borderStyle = 'none';
                cell.style.borderColor = 'transparent';
                cell.style.outline = 'none';
                cell.style.boxShadow = 'none';
                
                // Use setProperty with !important for maximum override
                cell.style.setProperty('border', 'none', 'important');
                cell.style.setProperty('border-bottom', 'none', 'important');
                cell.style.setProperty('border-top', 'none', 'important');
                cell.style.setProperty('border-left', 'none', 'important');
                cell.style.setProperty('border-right', 'none', 'important');
                cell.style.setProperty('border-width', '0', 'important');
                cell.style.setProperty('border-style', 'none', 'important');
                cell.style.setProperty('border-color', 'transparent', 'important');
                cell.style.setProperty('outline', 'none', 'important');
                cell.style.setProperty('box-shadow', 'none', 'important');
                
                // Also remove any inherited table cell borders
                cell.style.setProperty('border-collapse', 'separate', 'important');
                cell.style.setProperty('border-spacing', '0', 'important');
                
                // Log styles after changes
                const newComputedStyle = window.getComputedStyle(cell);
                console.log(`✅ [BOUGHT SAMPLE] Cell ${index + 1} new border:`, {
                    border: newComputedStyle.border,
                    borderWidth: newComputedStyle.borderWidth,
                    borderStyle: newComputedStyle.borderStyle,
                    borderColor: newComputedStyle.borderColor,
                    borderBottom: newComputedStyle.borderBottom,
                    backgroundColor: newComputedStyle.backgroundColor
                });
            });
            
            console.log('✅ [BOUGHT SAMPLE] Finished initializeBoughtSampleStyling');
            
            // Additional debugging: Check CSS rules affecting bought sample
            debugBoughtSampleCSS();
            
            // Force remove borders as a final step
            console.log('🔧 [BOUGHT SAMPLE] Running final aggressive border removal...');
            forceRemoveBoughtSampleBorders();
        }
        
        // Debug function to check CSS rules affecting bought sample
        function debugBoughtSampleCSS() {
            console.log('🔍 [CSS DEBUG] Checking CSS rules for bought sample...');
            
            const boughtSampleCells = document.querySelectorAll('.col-bought-sample');
            if (boughtSampleCells.length > 0) {
                const firstCell = boughtSampleCells[0];
                const computedStyle = window.getComputedStyle(firstCell);
                
                console.log('🔍 [CSS DEBUG] First bought sample cell computed styles:', {
                    border: computedStyle.border,
                    borderBottom: computedStyle.borderBottom,
                    borderWidth: computedStyle.borderWidth,
                    borderStyle: computedStyle.borderStyle,
                    borderColor: computedStyle.borderColor,
                    backgroundColor: computedStyle.backgroundColor,
                    color: computedStyle.color,
                    padding: computedStyle.padding,
                    margin: computedStyle.margin
                });
                
                // Check if the cell is part of a table row
                const parentRow = firstCell.closest('tr');
                if (parentRow) {
                    const rowStyle = window.getComputedStyle(parentRow);
                    console.log('🔍 [CSS DEBUG] Parent row styles:', {
                        border: rowStyle.border,
                        borderBottom: rowStyle.borderBottom,
                        backgroundColor: rowStyle.backgroundColor
                    });
                }
                
                // Check if the cell is part of a detail table
                const detailTable = firstCell.closest('.detail-table');
                if (detailTable) {
                    const tableStyle = window.getComputedStyle(detailTable);
                    console.log('🔍 [CSS DEBUG] Detail table styles:', {
                        border: tableStyle.border,
                        borderCollapse: tableStyle.borderCollapse,
                        borderSpacing: tableStyle.borderSpacing
                    });
                }
            }
            
            // Check for any CSS rules that might be overriding our styles
            const styleSheets = document.styleSheets;
            console.log(`🔍 [CSS DEBUG] Found ${styleSheets.length} stylesheets`);
            
            for (let i = 0; i < styleSheets.length; i++) {
                try {
                    const sheet = styleSheets[i];
                    if (sheet.cssRules) {
                        for (let j = 0; j < sheet.cssRules.length; j++) {
                            const rule = sheet.cssRules[j];
                            if (rule.selectorText && rule.selectorText.includes('bought-sample')) {
                                console.log('🔍 [CSS DEBUG] Found bought-sample CSS rule:', {
                                    selector: rule.selectorText,
                                    style: rule.style.cssText
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.log('🔍 [CSS DEBUG] Could not access stylesheet', i, e.message);
                }
            }
        }
        
        // Simple test function to check bought sample elements
        window.testBoughtSample = function() {
            console.log('🧪 [TEST] Testing bought sample elements...');
            
            const inputs = document.querySelectorAll('.bought-sample-input, .col-bought-sample input');
            const cells = document.querySelectorAll('.col-bought-sample');
            
            console.log(`🧪 [TEST] Found ${inputs.length} inputs and ${cells.length} cells`);
            
            if (inputs.length > 0) {
                const firstInput = inputs[0];
                const inputStyle = window.getComputedStyle(firstInput);
                console.log('🧪 [TEST] First input border:', inputStyle.border);
                console.log('🧪 [TEST] First input borderBottom:', inputStyle.borderBottom);
            }
            
            if (cells.length > 0) {
                const firstCell = cells[0];
                const cellStyle = window.getComputedStyle(firstCell);
                console.log('🧪 [TEST] First cell border:', cellStyle.border);
                console.log('🧪 [TEST] First cell borderBottom:', cellStyle.borderBottom);
            }
            
            return { inputs: inputs.length, cells: cells.length };
        };
        
        // Manual function to force remove borders
        window.forceRemoveBoughtSampleBorders = function() {
            console.log('🔧 [FORCE] Manually removing bought sample borders...');
            
            const inputs = document.querySelectorAll('.bought-sample-input, .col-bought-sample input, .simple-bought-sample');
            const cells = document.querySelectorAll('.col-bought-sample');
            
            console.log(`🔧 [FORCE] Processing ${inputs.length} inputs and ${cells.length} cells`);
            
            // AGGRESSIVE border removal from inputs
            inputs.forEach((input, index) => {
                console.log(`🔧 [FORCE] Processing input ${index + 1}`);
                
                // Direct style properties
                input.style.border = 'none';
                input.style.borderBottom = 'none';
                input.style.borderTop = 'none';
                input.style.borderLeft = 'none';
                input.style.borderRight = 'none';
                input.style.borderWidth = '0';
                input.style.borderStyle = 'none';
                input.style.borderColor = 'transparent';
                input.style.outline = 'none';
                input.style.boxShadow = 'none';
                
                // setProperty with !important
                input.style.setProperty('border', 'none', 'important');
                input.style.setProperty('border-bottom', 'none', 'important');
                input.style.setProperty('border-top', 'none', 'important');
                input.style.setProperty('border-left', 'none', 'important');
                input.style.setProperty('border-right', 'none', 'important');
                input.style.setProperty('border-width', '0', 'important');
                input.style.setProperty('border-style', 'none', 'important');
                input.style.setProperty('border-color', 'transparent', 'important');
                input.style.setProperty('outline', 'none', 'important');
                input.style.setProperty('box-shadow', 'none', 'important');
            });
            
            // AGGRESSIVE border removal from cells
            cells.forEach((cell, index) => {
                console.log(`🔧 [FORCE] Processing cell ${index + 1}`);
                
                // Direct style properties
                cell.style.border = 'none';
                cell.style.borderBottom = 'none';
                cell.style.borderTop = 'none';
                cell.style.borderLeft = 'none';
                cell.style.borderRight = 'none';
                cell.style.borderWidth = '0';
                cell.style.borderStyle = 'none';
                cell.style.borderColor = 'transparent';
                cell.style.outline = 'none';
                cell.style.boxShadow = 'none';
                
                // setProperty with !important
                cell.style.setProperty('border', 'none', 'important');
                cell.style.setProperty('border-bottom', 'none', 'important');
                cell.style.setProperty('border-top', 'none', 'important');
                cell.style.setProperty('border-left', 'none', 'important');
                cell.style.setProperty('border-right', 'none', 'important');
                cell.style.setProperty('border-width', '0', 'important');
                cell.style.setProperty('border-style', 'none', 'important');
                cell.style.setProperty('border-color', 'transparent', 'important');
                cell.style.setProperty('outline', 'none', 'important');
                cell.style.setProperty('box-shadow', 'none', 'important');
                
                // Also remove any inherited table cell borders
                cell.style.setProperty('border-collapse', 'separate', 'important');
                cell.style.setProperty('border-spacing', '0', 'important');
            });
            
            console.log('✅ [FORCE] Aggressive border removal complete');
        };
        
        // Manual debugging function - can be called from browser console
        window.debugBoughtSample = function() {
            console.log('🔍 [MANUAL DEBUG] Starting bought sample border debug...');
            
            const boughtSampleCells = document.querySelectorAll('.col-bought-sample');
            console.log(`🔍 [MANUAL DEBUG] Found ${boughtSampleCells.length} bought sample cells`);
            
            boughtSampleCells.forEach((cell, index) => {
                const computedStyle = window.getComputedStyle(cell);
                console.log(`🔍 [MANUAL DEBUG] Cell ${index + 1}:`, {
                    element: cell,
                    border: computedStyle.border,
                    borderBottom: computedStyle.borderBottom,
                    borderWidth: computedStyle.borderWidth,
                    borderStyle: computedStyle.borderStyle,
                    borderColor: computedStyle.borderColor,
                    backgroundColor: computedStyle.backgroundColor,
                    classList: cell.classList.toString(),
                    parentElement: cell.parentElement
                });
                
                // Check if there are any inputs inside
                const inputs = cell.querySelectorAll('input');
                inputs.forEach((input, inputIndex) => {
                    const inputStyle = window.getComputedStyle(input);
                    console.log(`🔍 [MANUAL DEBUG] Cell ${index + 1} Input ${inputIndex + 1}:`, {
                        element: input,
                        border: inputStyle.border,
                        borderBottom: inputStyle.borderBottom,
                        borderWidth: inputStyle.borderWidth,
                        borderStyle: inputStyle.borderStyle,
                        borderColor: inputStyle.borderColor,
                        classList: input.classList.toString()
                    });
                });
            });
            
            // Check for any conflicting CSS rules
            const allRules = [];
            for (let i = 0; i < document.styleSheets.length; i++) {
                try {
                    const sheet = document.styleSheets[i];
                    if (sheet.cssRules) {
                        for (let j = 0; j < sheet.cssRules.length; j++) {
                            const rule = sheet.cssRules[j];
                            if (rule.selectorText && (
                                rule.selectorText.includes('bought-sample') ||
                                rule.selectorText.includes('detail-table') ||
                                rule.selectorText.includes('col-bought-sample')
                            )) {
                                allRules.push({
                                    selector: rule.selectorText,
                                    style: rule.style.cssText,
                                    sheet: sheet.href || 'inline'
                                });
                            }
                        }
                    }
                } catch (e) {
                    // Skip external stylesheets that can't be accessed
                }
            }
            
            console.log('🔍 [MANUAL DEBUG] All relevant CSS rules:', allRules);
            
            return {
                cells: boughtSampleCells,
                rules: allRules
            };
        };
        
        // Get CSRF Token function
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            if (!token) {
                console.error('CSRF token not found');
                return '';
            }
            return token;
        }
        
        // Update Group Km Traveled function
        function updateGroupKmTraveled(input) {
            const groupId = input.getAttribute('data-group-id');
            const kmValue = input.value;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('group_id', groupId);
            formData.append('km_traveled', kmValue);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-group-km-traveled/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    input.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 500);
                } else {
                    alert('Error updating Group Km Traveled: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating Group Km Traveled: ' + error.message);
            });
        }
        
        // Update Group Hours function
        function updateGroupHours(input) {
            const groupId = input.getAttribute('data-group-id');
            const hoursValue = input.value;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('group_id', groupId);
            formData.append('hours', hoursValue);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-group-hours/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    input.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 500);
                } else {
                    alert('Error updating Group Hours: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating Group Hours: ' + error.message);
            });
        }
        // Update Hours function
        function updateHours(input) {
            const inspectionId = input.getAttribute('data-inspection-id');
            const hoursValue = input.value;
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('hours', hoursValue);
            formData.append('csrfmiddlewaretoken', csrfToken);
            
            // Send update request
            fetch('/update-hours/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success feedback
                    input.style.backgroundColor = '#d4edda';
                    setTimeout(() => {
                        input.style.backgroundColor = '';
                    }, 500);
                } else {
                    alert('Error updating Hours: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error updating Hours: ' + error.message);
            });
        }
        
        // Update Product Name
        function updateProductName(input) {
            // Check if field is disabled (no sample taken)
            if (input.disabled) {
                console.log('Product name update blocked - no sample taken');
                return;
            }
            
            const inspectionId = input.getAttribute('data-inspection-id');
            const value = input.value;
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('product_name', value);
            fetch('/update-product-name/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(r => r.json()).then(data => {
                if (!data.success) alert('Error updating product name: ' + (data.error || 'Unknown error'));
            }).catch(err => alert('Error updating product name: ' + (err?.message || err)));
        }

        // Update Product Class - Simplified to only handle RAW and PMP
        function updateProductClass(dropdown) {
            // Check if field is disabled (no sample taken)
            if (dropdown.disabled) {
                console.log('Product class update blocked - no sample taken');
                return;
            }

            // If commodity is egg/poultry, block updates and reset to empty
            const commodity = (dropdown.getAttribute('data-commodity') || '').toLowerCase();
            if (['egg', 'eggs', 'poultry', 'chicken'].includes(commodity)) {
                dropdown.value = '';
                alert('Product class is not applicable for Egg/Poultry commodities.');
                return;
            }

            // Simplified logic: Only RAW and PMP are allowed
            const inspectionId = dropdown.getAttribute('data-inspection-id');
            const value = dropdown.value;
            
            // Send update to server
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('product_class', value);
            
            fetch('/update-product-class/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(r => r.json()).then(data => {
                if (!data.success) alert('Error updating product class: ' + (data.error || 'Unknown error'));
            }).catch(err => alert('Error updating product class: ' + (err?.message || err)));
        }

            const rawAllowed = new Set([
                'extra lean mince',
                'lean mince',
                'regular mince',
                'raw flavoured ground meat',
                'raw flavoured ground meat & offal',
                'raw flavoured mixed species ground meat',
                'raw flavoured mixed species ground meat & offal',
                'raw boerewors',
                'raw species sausage / wors',
                'raw mixed species sausage / wors',
                'ground burger / ground patty = extra lean',
                'ground burger / ground patty = lean',
                'ground burger / ground patty = regular',
                'burger / patty / hamburger patty / meatball / frikkadel = extra lean',
                'burger / patty / hamburger patty / meatball / frikkadel = lean',
                'burger / patty / hamburger patty / meatball / frikkadel = regular',
                'value burger / value patty / value hamburger / value meatball / value frikkadel',
                'economy burger / econo burger / economy patty / econo patty / budget burger',
                'raw banger / griller',
                'raw boerewors / sizzle'
            ].map(normalizeLabel));

            const pmpAllowed = new Set([
                'whole muscle, cured, heat treated products',
                'whole muscle, dry cured, heat treated products',
                'whole muscle, uncured and heat / partial treated products',
                'whole muscle, uncured, no or partial heat treated and air dried products',
                'whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)',
                'whole muscle, dry cured, no or partial heat treated products',
                'whole muscle, cured and no or partial heat treated products',
                'whole muscle, cured, no or partial heat treated and air dried products',
                'whole muscle, dry cured, no or partial heat treated and dried products',
                'comminuted, cured and heat treated products',
                'liver spreads, pates and terrines',
                'products in aspic: brawn',
                'product in aspic: suelze',
                'other products containing cured meat pieces in aspic',
                'products made from blood',
                'comminuted, uncured, no or partial heat treated and dried products',
                'comminuted, cured, no or partial heat treated, dried and fermented products',
                'comminuted, uncured and heat treated products',
                'reformed, uncured and no or partial heat treated products',
                'reformed, cured, heat treated products from single species',
                'reformed, cured, heat treated products from mixed species',
                'reformed, cured and no or partial heat treated products',
                'coated processed meat products',
                'unspecified processed meat products'
            ].map(normalizeLabel));

            // Rebuild the options list with only allowed options
            const currentValue = dropdown.value;
            const allOptions = Array.from(dropdown.options).map(opt => ({
                text: opt.text,
                value: opt.value,
                norm: normalizeLabel(opt.text || ''),
            }));
            const placeholder = allOptions[0];
            const allowedSet = isRaw ? rawAllowed : pmpAllowed;
            const filtered = allOptions.slice(1).filter(opt => allowedSet.has(opt.norm));
            // Clear and repopulate
            dropdown.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = placeholder.value || '';
            ph.textContent = placeholder.text || 'Select Class...';
            dropdown.appendChild(ph);
            filtered.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value || opt.text;
                o.textContent = opt.text;
                dropdown.appendChild(o);
            });
            // Restore selection if still present
            if (filtered.some(opt => opt.value === currentValue || opt.text === currentValue)) {
                dropdown.value = currentValue;
            } else {
                dropdown.value = '';
            }
            
            const inspectionId = dropdown.getAttribute('data-inspection-id');
            const value = dropdown.value;
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('product_class', value);
            fetch('/update-product-class/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            }).then(r => r.json()).then(data => {
                if (!data.success) alert('Error updating product class: ' + (data.error || 'Unknown error'));
            }).catch(err => alert('Error updating product class: ' + (err?.message || err)));
        }

        // Filter helper that does NOT submit updates; used on page load to ensure all dropdowns are filtered
        function filterClassOptions(dropdown) {
            const commodity = (dropdown.getAttribute('data-commodity') || '').toLowerCase();
            const isRaw = commodity === 'raw';
            const normalizeLabel = (s) => (s || '')
                .toLowerCase()
                .normalize('NFD').replace(/\p{Diacritic}/gu, '')
                .replace(/\s+/g, ' ')
                .trim();
            const rawAllowed = new Set([
                'extra lean mince','lean mince','regular mince','raw flavoured ground meat','raw flavoured ground meat & offal','raw flavoured mixed species ground meat','raw flavoured mixed species ground meat & offal','raw boerewors','raw species sausage / wors','raw mixed species sausage / wors','ground burger / ground patty = extra lean','ground burger / ground patty = lean','ground burger / ground patty = regular','burger / patty / hamburger patty / meatball / frikkadel = extra lean','burger / patty / hamburger patty / meatball / frikkadel = lean','burger / patty / hamburger patty / meatball / frikkadel = regular','value burger / value patty / value hamburger / value meatball / value frikkadel','economy burger / econo burger / economy patty / econo patty / budget burger','raw banger / griller','raw boerewors / sizzle'
            ].map(normalizeLabel));
            const pmpAllowed = new Set([
                'whole muscle, cured, heat treated products','whole muscle, dry cured, heat treated products','whole muscle, uncured and heat / partial treated products','whole muscle, uncured, no or partial heat treated and air dried products','whole muscle, uncured, no or partial heat treated and air dried products undergoing a lengthy maturation period (minimum 21 days)','whole muscle, dry cured, no or partial heat treated products','whole muscle, cured and no or partial heat treated products','whole muscle, cured, no or partial heat treated and air dried products','whole muscle, dry cured, no or partial heat treated and dried products','comminuted, cured and heat treated products','liver spreads, pates and terrines','products in aspic: brawn','product in aspic: suelze','other products containing cured meat pieces in aspic','products made from blood','comminuted, uncured, no or partial heat treated and dried products','comminuted, cured, no or partial heat treated, dried and fermented products','comminuted, uncured and heat treated products','reformed, uncured and no or partial heat treated products','reformed, cured, heat treated products from single species','reformed, cured, heat treated products from mixed species','reformed, cured and no or partial heat treated products','coated processed meat products','unspecified processed meat products'
            ].map(normalizeLabel));
            
            // Get the current value from the selected option (preserve database value)
            const currentValue = dropdown.value;
            const selectedOption = dropdown.querySelector('option[selected]');
            const databaseValue = selectedOption ? selectedOption.value : currentValue;
            
            // Debug logging
            console.log(`[CLASS FILTER] Inspection ${dropdown.getAttribute('data-inspection-id')}:`, {
                commodity: commodity,
                currentValue: currentValue,
                databaseValue: databaseValue,
                selectedOption: selectedOption ? selectedOption.text : 'none',
                totalOptions: dropdown.options.length
            });
            
            const allOptions = Array.from(dropdown.options).map(opt => ({
                text: opt.text,
                value: opt.value,
                norm: normalizeLabel(opt.text || ''),
                selected: opt.selected
            }));
            const placeholder = allOptions[0];
            const allowedSet = isRaw ? rawAllowed : pmpAllowed;
            const filtered = allOptions.slice(1).filter(opt => allowedSet.has(opt.norm));
            
            // Rebuild dropdown
            dropdown.innerHTML = '';
            const ph = document.createElement('option');
            ph.value = placeholder.value || '';
            ph.textContent = placeholder.text || 'Select Class...';
            dropdown.appendChild(ph);
            
            filtered.forEach(opt => {
                const o = document.createElement('option');
                o.value = opt.value || opt.text;
                o.textContent = opt.text;
                // Preserve the selected state from the original option
                if (opt.value === databaseValue || opt.text === databaseValue) {
                    o.selected = true;
                }
                dropdown.appendChild(o);
            });
            
            // Set the value to the database value if it exists in filtered options
            if (filtered.some(opt => opt.value === databaseValue || opt.text === databaseValue)) {
                dropdown.value = databaseValue;
                console.log(`[CLASS FILTER] Set value to existing option: ${databaseValue}`);
            } else if (databaseValue && databaseValue.trim() !== '') {
                // If database value exists but not in filtered options, add it
                const o = document.createElement('option');
                o.value = databaseValue;
                o.textContent = databaseValue;
                o.selected = true;
                dropdown.appendChild(o);
                dropdown.value = databaseValue;
                console.log(`[CLASS FILTER] Added missing database value: ${databaseValue}`);
            } else {
                dropdown.value = '';
                console.log(`[CLASS FILTER] No database value, cleared selection`);
            }
        }

        // DISABLED: Old filterClassOptions system - replaced by [CLASS DROPDOWN] system
        // The new system is working correctly and handling product class persistence
        /*
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.querySelectorAll('select.product-class-select').forEach(filterClassOptions);
            }, 1000);
            
            const table = document.getElementById('shipmentsTable');
            if (table && 'MutationObserver' in window) {
                const observer = new MutationObserver(() => {
                    setTimeout(() => {
                        document.querySelectorAll('select.product-class-select').forEach(filterClassOptions);
                    }, 100);
                });
                observer.observe(table, { childList: true, subtree: true });
            }
            
            setTimeout(() => {
                document.querySelectorAll('select.product-class-select').forEach(filterClassOptions);
            }, 2000);
        });
        */

        // Update Lab function
        function updateLab(dropdown) {
            const inspectionId = dropdown.getAttribute('data-inspection-id');
            const labValue = dropdown.value;
            
            // Create form data
            const formData = new FormData();
            formData.append('inspection_id', inspectionId);
            formData.append('lab', labValue);

            // Send update request with CSRF header
            fetch('/update-lab/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken') || '',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(async (response) => {
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(text || ('HTTP ' + response.status));
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    dropdown.style.backgroundColor = '#d4edda';
                    setTimeout(() => { dropdown.style.backgroundColor = ''; }, 500);
                } else {
                    alert('Error updating Lab: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('Error updating Lab: ' + (error?.message || error));
            });
        }
        
        // Function to handle sample status changes and update retest accordingly
        function handleSampleStatusChange(inspectionId, isSampleTaken) {
            const dropdown = document.querySelector('select[data-inspection-id="' + inspectionId + '"]');
            if (dropdown) {
                if (!isSampleTaken) {
                    // No sample taken - disable dropdown and set to NO
                    dropdown.disabled = true;
                    dropdown.style.opacity = '0.5';
                    dropdown.style.cursor = 'not-allowed';
                    dropdown.value = 'NO';
                    
                    // Update the database
                    updateNeedsRetest(dropdown);
                    
                    // Disable both buttons
                    updateButtonStates(inspectionId, 'NO');
                } else {
                    // Sample taken - enable dropdown
                    dropdown.disabled = false;
                    dropdown.style.opacity = '';
                    dropdown.style.cursor = '';
                    
                    // Update button states based on current retest value
                    updateButtonStates(inspectionId, dropdown.value);
                }
            }
        }
        
        // Function to update button states based on retest selection
        function updateButtonStates(inspectionId, needsRetest) {
            const labButton = document.getElementById('lab-' + inspectionId);
            const retestButton = document.getElementById('retest-' + inspectionId);
            const needsRetestDropdown = document.querySelector('select[data-inspection-id="' + inspectionId + '"]');
            const labDropdown = document.querySelector('select.lab-dropdown[data-inspection-id="' + inspectionId + '"]');
            
            if (labButton && retestButton) {
                // Check if sample was taken
                const isSampleTaken = needsRetestDropdown && !needsRetestDropdown.disabled;
                
                if (!isSampleTaken) {
                    // No sample taken - disable both buttons and lab dropdown
                    labButton.disabled = true;
                    labButton.style.opacity = '0.5';
                    labButton.style.cursor = 'not-allowed';
                    labButton.onclick = null;
                    labButton.title = 'No sample taken - Lab upload disabled';
                    
                    retestButton.disabled = true;
                    retestButton.style.opacity = '0.5';
                    retestButton.style.cursor = 'not-allowed';
                    retestButton.onclick = null;
                    retestButton.title = 'No sample taken - Retest upload disabled';
                    
                    // Disable lab dropdown
                    if (labDropdown) {
                        labDropdown.disabled = true;
                        labDropdown.style.opacity = '0.5';
                        labDropdown.style.cursor = 'not-allowed';
                        labDropdown.title = 'No sample taken - Lab selection disabled';
                    }
                } else {
                    // Sample taken - enable lab button and lab dropdown
                    labButton.disabled = false;
                    labButton.style.opacity = '';
                    labButton.style.cursor = '';
                    labButton.onclick = function() { uploadLab(inspectionId); };
                    labButton.title = 'Lab result upload available';
                    
                    // Enable lab dropdown
                    if (labDropdown) {
                        labDropdown.disabled = false;
                        labDropdown.style.opacity = '';
                        labDropdown.style.cursor = '';
                        labDropdown.title = 'Select laboratory for sample testing';
                    }
                    
                    // Retest button is enabled ONLY if sample taken AND retest is YES (must upload document)
                    if (isSampleTaken && needsRetest === 'YES') {
                        retestButton.disabled = false;
                        retestButton.style.opacity = '1';
                        retestButton.style.cursor = 'pointer';
                        retestButton.onclick = function() { uploadRetest(inspectionId); };
                        retestButton.title = 'Retest required - Please upload retest document';
                    } else {
                        retestButton.disabled = true;
                        retestButton.style.opacity = '0.5';
                        retestButton.style.cursor = 'not-allowed';
                        retestButton.onclick = null;
                        retestButton.title = needsRetest === 'NO' ? 'No retest required - Upload disabled' : 'Select retest status first';
                    }
                }
            }
        }
        
        // Function to calculate and display OneDrive auto-upload countdown
        function updateOneDriveCountdown() {
            const countdownElements = document.querySelectorAll('.onedrive-countdown');
            
            countdownElements.forEach((element, index) => {
                const sentDateStr = element.getAttribute('data-sent-date');
                const onedriveUploaded = element.getAttribute('data-onedrive-uploaded') === 'true';
                const onedriveUploadDate = element.getAttribute('data-onedrive-upload-date');
                const delayDays = parseFloat(element.getAttribute('data-delay-days')) || 3;
                
                const countdownText = element.querySelector('.countdown-text');
                if (!countdownText) return;
                
                // If no sent date, show default status
                if (!sentDateStr) {
                    countdownText.textContent = 'Not sent';
                    countdownText.style.color = '#6b7280';
                    countdownText.style.fontWeight = 'normal';
                    return;
                }
                
                // Check if files have been uploaded to OneDrive
                if (onedriveUploaded && onedriveUploadDate) {
                    countdownText.textContent = 'Uploaded to OneDrive';
                    countdownText.style.color = '#10b981';
                    countdownText.style.fontWeight = 'bold';
                    return;
                }
                
                try {
                    const sentDate = new Date(sentDateStr);
                    const now = new Date();
                    
                    // Check if date is valid
                    if (isNaN(sentDate.getTime())) {
                        countdownText.textContent = 'Invalid date';
                        countdownText.style.color = '#ef4444';
                        return;
                    }
                    
                    const timeDiff = now - sentDate;
                    const totalMinutesDiff = Math.floor(timeDiff / (1000 * 60));
                    const totalHoursDiff = Math.floor(timeDiff / (1000 * 60 * 60));
                    const totalDaysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
                    
                    // Convert delay days to minutes for precise calculation
                    const delayMinutes = delayDays * 24 * 60;
                    const minutesLeft = Math.max(0, delayMinutes - totalMinutesDiff);
                    
                    if (minutesLeft <= 0) {
                        countdownText.textContent = 'Ready for OneDrive upload';
                        countdownText.style.color = '#10b981';
                        countdownText.style.fontWeight = 'bold';
                    } else {
                        // Calculate remaining time in appropriate units
                        const daysLeft = Math.floor(minutesLeft / (24 * 60));
                        const hoursLeft = Math.floor((minutesLeft % (24 * 60)) / 60);
                        const minsLeft = minutesLeft % 60;
                        
                        let displayText;
                        let color = '#6b7280';
                        
                        if (daysLeft > 0) {
                            if (daysLeft === 1) {
                                displayText = '1 day left until upload';
                                color = '#f59e0b';
                            } else {
                                displayText = daysLeft + ' days left until upload';
                                color = '#6b7280';
                            }
                        } else if (hoursLeft > 0) {
                            if (hoursLeft === 1) {
                                displayText = '1 hour left until upload';
                                color = '#f59e0b';
                            } else {
                                displayText = hoursLeft + ' hours left until upload';
                                color = '#f59e0b';
                            }
                        } else {
                            if (minsLeft <= 1) {
                                displayText = 'Uploading soon...';
                                color = '#ef4444';
                            } else {
                                displayText = minsLeft + ' minutes left until upload';
                                color = '#ef4444';
                            }
                        }
                        
                        countdownText.textContent = displayText;
                        countdownText.style.color = color;
                        countdownText.style.fontWeight = 'normal';
                    }
                } catch (error) {
                    console.error('Error calculating OneDrive countdown:', error);
                    countdownText.textContent = 'Error calculating';
                    countdownText.style.color = '#ef4444';
                }
            });
        }
        
        // Make updateOneDriveCountdown globally available
        window.updateOneDriveCountdown = updateOneDriveCountdown;
        
        // Call countdown function immediately if DOM is already loaded
        if (document.readyState === 'loading') {
            // Will call on DOMContentLoaded
        } else {
            updateOneDriveCountdown();
        }
        
        // Update countdown every minute for real-time updates
        setInterval(updateOneDriveCountdown, 60000); // 60 seconds
        
        // updateSentStatus function now defined at top of script section
        
        // Initialize sample status indicators and apply filtering
        function initializeSampleIndicators() {
            console.log('🔬 Initializing sample indicators...');
            
            // First, temporarily show all detail rows to read sample data
            const detailRows = document.querySelectorAll('.detail-row');
            const originalStates = new Map();
            
            // Save original states and show all detail rows
            detailRows.forEach(row => {
                originalStates.set(row.id, row.style.display);
                row.style.display = '';
            });
            
            // Process each row
            detailRows.forEach(row => {
                const groupId = row.id.replace('detail-', '');
                const indicator = document.querySelector('.sample-indicator[data-group-id="' + groupId + '"]');
                
                // Check if any product in this group has samples
                const sampleBadges = row.querySelectorAll('.sampled-badge.sampled-yes');
                const hasSamples = sampleBadges.length > 0;
                
                console.log(`🔬 Processing ${groupId}: found ${sampleBadges.length} sampled products, hasSamples=${hasSamples}`);
                
                if (indicator) {
                    if (hasSamples) {
                        indicator.innerHTML = '<span class="sampled-badge sampled-yes" style="padding: 1px 3px;" title="Has samples">S</span>';
                    } else {
                        indicator.innerHTML = '<span class="sampled-badge sampled-no" style="padding: 1px 3px;" title="No samples">N</span>';
                    }
                }
                
                // Store sample status as data attribute for filtering
                const mainRow = document.querySelector('[data-group-id="' + groupId + '"]');
                if (mainRow) {
                    mainRow.setAttribute('data-has-samples', hasSamples);
                    console.log(`🔬 Set data-has-samples="${hasSamples}" for ${mainRow.getAttribute('data-client-name')}`);
                } else {
                    console.warn(`🔬 Could not find main row for group ID: ${groupId}`);
                }
            });
            
            // Restore original states
            detailRows.forEach(row => {
                const originalState = originalStates.get(row.id);
                row.style.display = originalState || 'none';
            });
            
            console.log('✅ Sample indicators initialized');
            
            // Apply sample filter if one is selected
            applySampleFilter();
        }
        
        // Apply sample status filtering
        function applySampleFilter() {
            const urlParams = new URLSearchParams(window.location.search);
            const sampleStatus = urlParams.get('sample_status');
            
            console.log('🔬 Checking sample filter. URL param:', sampleStatus);
            
            if (!sampleStatus) {
                console.log('🔬 No sample filter applied, showing all');
                return; // No filter applied
            }
            
            console.log('🔬 Applying sample filter:', sampleStatus);
            
            const allRows = document.querySelectorAll('.group-row.shipment-row');
            let visibleCount = 0;
            let hiddenCount = 0;
            
            allRows.forEach(row => {
                const hasSamples = row.getAttribute('data-has-samples') === 'true';
                const groupId = row.getAttribute('data-group-id');
                const detailRow = document.getElementById('detail-' + groupId);
                const clientName = row.getAttribute('data-client-name');
                
                let shouldShow = false;
                
                if (sampleStatus === 'SAMPLED' && hasSamples) {
                    shouldShow = true;
                } else if (sampleStatus === 'NOT_SAMPLED' && !hasSamples) {
                    shouldShow = true;
                } else if (sampleStatus === '' || !sampleStatus) {
                    shouldShow = true;
                }
                
                console.log(`🔬 ${clientName}: hasSamples=${hasSamples}, filter=${sampleStatus}, shouldShow=${shouldShow}`);
                
                if (shouldShow) {
                    row.style.display = '';
                    if (detailRow) {
                        // Restore original detail row state (hidden by default)
                        if (!detailRow.style.display || detailRow.style.display === 'none') {
                            detailRow.style.display = 'none';
                        }
                    }
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                    if (detailRow) detailRow.style.display = 'none';
                    hiddenCount++;
                }
            });
            
            // Update the inspection count display
            updateInspectionCount(visibleCount);
            
            console.log(`✅ Sample filter applied: showing ${visibleCount}, hidden ${hiddenCount} inspections`);
        }
        
        // Update the inspection count display
        function updateInspectionCount(count) {
            const countElement = document.querySelector('.table-info');
            if (countElement) {
                const currentText = countElement.textContent;
                const newText = currentText.replace(/Showing \d+ of \d+ inspections/, `Showing ${count} of ${count} inspections`);
                countElement.textContent = newText;
            }
        }
        
        // Manual function to trigger sample filter (for debugging)
        function triggerSampleFilter() {
            console.log('🔬 Manually triggering sample filter...');
            initializeSampleIndicators();
        }
        // Debug function to check current page state
        function debugSampleFilter() {
            console.log('🔬 DEBUGGING SAMPLE FILTER STATE');
            console.log('================================');
            
            // Check URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const sampleStatus = urlParams.get('sample_status');
            console.log('📍 URL sample_status parameter:', sampleStatus);
            
            // Check all rows
            const allRows = document.querySelectorAll('.group-row.shipment-row');
            console.log('📋 Total rows found:', allRows.length);
            
            let sampledCount = 0;
            let notSampledCount = 0;
            let unknownCount = 0;
            
            allRows.forEach((row, index) => {
                const clientName = row.getAttribute('data-client-name');
                const groupId = row.getAttribute('data-group-id');
                const hasSamples = row.getAttribute('data-has-samples');
                const isVisible = row.style.display !== 'none';
                
                console.log(`🔍 Row ${index + 1}: ${clientName}`);
                console.log(`   group-id: ${groupId}`);
                console.log(`   data-has-samples: ${hasSamples}`);
                console.log(`   visible: ${isVisible}`);
                
                // Check detail row for actual sample badges
                const detailRow = document.getElementById('detail-' + groupId);
                if (detailRow) {
                    const sampleBadges = detailRow.querySelectorAll('.sampled-badge.sampled-yes');
                    const totalBadges = detailRow.querySelectorAll('.sampled-badge');
                    console.log(`   sample badges: ${sampleBadges.length}/${totalBadges.length} "Yes"`);
                    
                    if (sampleBadges.length > 0) {
                        sampledCount++;
                    } else if (totalBadges.length > 0) {
                        notSampledCount++;
                    } else {
                        unknownCount++;
                    }
                } else {
                    console.log(`   ⚠️ No detail row found for group-id: ${groupId}`);
                    unknownCount++;
                }
                console.log('');
            });
            
            console.log('📊 SUMMARY:');
            console.log(`   Sampled inspections: ${sampledCount}`);
            console.log(`   Not sampled inspections: ${notSampledCount}`);
            console.log(`   Unknown status: ${unknownCount}`);
            console.log(`   Expected sampled (from test): 2 (Nesta Foods Factory, New RMP Producer)`);
            console.log(`   Expected not sampled (from test): 23`);
            
            // Check dropdown state
            const dropdown = document.querySelector('select[name="sample_status"]');
            if (dropdown) {
                console.log(`📋 Dropdown current value: "${dropdown.value}"`);
            }
            
            return {
                totalRows: allRows.length,
                sampledCount,
                notSampledCount,
                unknownCount,
                urlParam: sampleStatus,
                dropdownValue: dropdown ? dropdown.value : null
            };
        }
        
        // Function to force apply filter manually
        function forceApplyFilter(filterType) {
            console.log(`🔧 FORCING filter application: ${filterType}`);
            
            // Update dropdown
            const dropdown = document.querySelector('select[name="sample_status"]');
            if (dropdown) {
                dropdown.value = filterType || '';
            }
            
            // Update URL
            const currentUrl = new URL(window.location);
            if (filterType) {
                currentUrl.searchParams.set('sample_status', filterType);
            } else {
                currentUrl.searchParams.delete('sample_status');
            }
            window.history.replaceState({}, '', currentUrl.toString());
            
            // Apply filter
            initializeSampleIndicators();
        }
        
        // Test function to verify JavaScript is working
        function testFunction() {
            console.log('Test function is working');
        }
        
        // Update countdown on page load and every minute
        document.addEventListener('DOMContentLoaded', function() {
            updateOneDriveCountdown();
            setInterval(updateOneDriveCountdown, 60000); // Update every minute
            
            // Initialize other functions
            initializeButtonStates();
            
            // Initialize sample indicators with delay to ensure DOM is ready
            setTimeout(() => {
                initializeSampleIndicators();
            }, 1000);
            
            // Sample filter now handled by backend - no client-side filtering needed
            // Just let the form submit normally to reload with backend filtering
            
            // Also add listener to the form submission to ensure compatibility
            const filterForm = document.querySelector('form[method="get"]');
            if (filterForm) {
                filterForm.addEventListener('submit', function(e) {
                    // Let form submit normally but also apply client-side filter
                    setTimeout(() => {
                        initializeSampleIndicators();
                    }, 100);
                });
            }
        });
        
        // Function to handle Send button clicks with validation
        function handleSendButtonClick(groupId, clientName, inspectionDate, hasAllDocuments) {
            if (!hasAllDocuments) {
                console.warn('⚠️ Cannot send: Missing required documents. Ensure all compliance documents are downloaded and RFI/Invoice are uploaded.');
                return false;
            }
            
            // If all documents are present, proceed with sending
            sendGroupDocuments(groupId, clientName, inspectionDate);
            return true;
        }
        
        // Function to initialize button states on page load
        function initializeButtonStates() {
            // Get all retest dropdowns
            const dropdowns = document.querySelectorAll('.needs-retest-dropdown');
            
            dropdowns.forEach(dropdown => {
                const inspectionId = dropdown.getAttribute('data-inspection-id');
                const needsRetest = dropdown.value;
                
                // Update button states based on current dropdown value
                updateButtonStates(inspectionId, needsRetest);
            });
        }
    </script>
    <script>
        async function saveManualEmail(clientName, email) {
            try {
                const resp = await fetch('/client/save-manual-email/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ client_name: clientName, email })
                });
                
                // Check if response is JSON
                const contentType = resp.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // If not JSON, likely an HTML error page
                    if (resp.status === 403) {
                        alert('Session expired. Please refresh the page and try again.');
                        window.location.reload();
                        return;
                    } else if (resp.status === 500) {
                        alert('Server error. Please try again.');
                        return;
                    } else {
                        alert('Unexpected response format. Please refresh the page and try again.');
                        return;
                    }
                }
                
                const result = await resp.json();
                if (result.success) {
                    alert('Email saved');
                    window.location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                console.error('Network error:', e);
                alert('Network error: ' + e.message);
            }
        }
        async function deleteClientEmail(clientName, email) {
            if (!confirm('Remove this email?')) return;
            try {
                const resp = await fetch('/client/delete-email/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                    },
                    body: JSON.stringify({ client_name: clientName, email })
                });
                
                // Check if response is JSON
                const contentType = resp.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // If not JSON, likely an HTML error page
                    if (resp.status === 403) {
                        alert('Session expired. Please refresh the page and try again.');
                        window.location.reload();
                        return;
                    } else if (resp.status === 500) {
                        alert('Server error. Please try again.');
                        return;
                    } else {
                        alert('Unexpected response format. Please refresh the page and try again.');
                        return;
                    }
                }
                
                const result = await resp.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                console.error('Network error:', e);
                alert('Network error: ' + e.message);
            }
        }

        // Inspection sync function for shipment list page
        function syncInspectionsFromShipmentList() {
            const btn = document.querySelector('button[onclick="syncInspectionsFromShipmentList()"]');
            const btnText = btn.querySelector('.btn-text');
            const statusDiv = document.getElementById('inspection-sync-status');
            
            // Disable button and show loading state
            btn.disabled = true;
            btnText.textContent = 'Syncing...';
            btn.style.opacity = '0.7';
            statusDiv.innerHTML = '';

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token|escapejs }}';

            fetch('{% url "refresh_inspections" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
            })
            .then(data => {
                if (data.success && data.status === 'started') {
                    // Background sync started - start polling
                    pollInspectionSyncStatus();
                } else if (data.success) {
                    // Immediate success
                    updateInspectionPageAfterSync();
                    resetInspectionButton();
                } else {
                    statusDiv.innerHTML = 
                        '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                            '<i class="fas fa-exclamation-circle mr-2"></i>' +
                            (data.error || 'Failed to start sync') +
                        '</div>';
                    resetInspectionButton();
                }
            })
            .catch(error => {
                console.error('Error starting sync:', error);
                statusDiv.innerHTML = 
                    '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                        '<i class="fas fa-exclamation-circle mr-2"></i>' +
                        'Error: ' + error.message +
                    '</div>';
                resetInspectionButton();
            });

            let pollCount = 0;
            const maxPolls = 60; // 2 minutes max

            function pollInspectionSyncStatus() {
                pollCount++;
                if (pollCount > maxPolls) {
                    statusDiv.innerHTML = `
                        <div class="p-4 mt-4 rounded-lg bg-yellow-50 border border-yellow-200 text-yellow-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            Sync is taking longer than expected. Please check back later.
                        </div>
                    `;
                    resetInspectionButton();
                    return;
                }

                fetch('{% url "check_sync_status" %}', { 
                    method: 'GET', 
                    headers: { 'X-Requested-With': 'XMLHttpRequest' } 
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.message) {
                        // Sync completed successfully
                        updateInspectionPageAfterSync();
                        resetInspectionButton();
                    } else if (data.status === 'running' || !data.success) {
                        // Still running
                        btnText.textContent = 'Syncing...';
                        setTimeout(pollInspectionSyncStatus, 2000);
                    } else {
                        // Error occurred
                        statusDiv.innerHTML = 
                            '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                                '<i class="fas fa-exclamation-circle mr-2"></i>' +
                                (data.error || 'Sync failed') +
                            '</div>';
                        resetInspectionButton();
                    }
                })
                .catch(error => {
                    console.error('Error checking sync status:', error);
                    statusDiv.innerHTML = 
                        '<div class="p-4 mt-4 rounded-lg bg-red-50 border border-red-200 text-red-700">' +
                            '<i class="fas fa-exclamation-circle mr-2"></i>' +
                            'Error checking sync status: ' + error.message +
                        '</div>';
                    resetInspectionButton();
                });
            }

            function resetInspectionButton() {
                btn.disabled = false;
                btnText.textContent = 'Sync Inspections';
                btn.style.opacity = '1';
            }

            function updateInspectionPageAfterSync() {
                // Reload the page to show updated inspection data
                window.location.reload();
            }
        
            console.log('JavaScript finished loading successfully!');
            
            // Test if timer functions are available
            console.log('🔍 Testing timer function availability...');
            console.log('🔍 initializeFifteenMinuteTimers available:', typeof initializeFifteenMinuteTimers);
            console.log('🔍 initializeDisabledRows available:', typeof initializeDisabledRows);
            
            // Try to call timer functions directly
            if (typeof initializeFifteenMinuteTimers === 'function') {
                console.log('🔍 Calling initializeFifteenMinuteTimers directly...');
                try {
                    initializeFifteenMinuteTimers();
                } catch (error) {
                    console.error('❌ Error calling initializeFifteenMinuteTimers:', error);
                }
            } else {
                console.error('❌ initializeFifteenMinuteTimers function not found!');
            }
            
            // Also try to call initializeDisabledRows
            if (typeof initializeDisabledRows === 'function') {
                console.log('🔍 Calling initializeDisabledRows directly...');
                try {
                    initializeDisabledRows();
                } catch (error) {
                    console.error('❌ Error calling initializeDisabledRows:', error);
                }
            } else {
                console.error('❌ initializeDisabledRows function not found!');
            }
        }
    </script>
    
</body>
</html>